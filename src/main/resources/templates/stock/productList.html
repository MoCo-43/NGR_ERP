<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
     xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	 layout:decorate="~{layout/base}">
<head>
  <meta charset="UTF-8">
  <title layout:fragment="title">너 구 름(Your Cloud)</title>
  <th:block layout:fragment="head_extra">
     <!-- Bootstrap CSS -->
  	<!--  base에 있는 버전과 달라서 강제 주입 --> 
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
    rel="stylesheet"
    crossorigin="anonymous"
  />
   <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <!-- AG Grid CSS (Quartz) -->
   <link
     rel="stylesheet"
     href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/styles/ag-grid.css"
    />
   <link
     rel="stylesheet"
     href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/styles/ag-theme-quartz.css"
   />
   <!-- TOASTR -->
   <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.css" integrity="sha512-3pIirOrwegjM6erE5gPSwkUzO+3cTjpnV9lexlNZqvupR64iZBnOOTiiLPb9M36zpMScbmUNIcHUqKD47M719g==" crossorigin="anonymous" referrerpolicy="no-referrer" />
   <style type="text/css">
   .ag-theme-quartz .ag-cell {
	padding-left: 8px;
  	padding-right: 8px;
	}
	.loader-overlay {
	  position: absolute;
	  top: 50%;
	  left: 50%;
	  transform: translate(-50%, -50%); /* 중앙정렬 핵심 */
	  display: flex;
	  align-items: center;
	  justify-content: center;
	  z-index: 10; /* 그리드보다 위로 */
	}
   </style>
  </th:block>
</head>
<body>
<section layout:fragment="content">
<!-- 컨테이너 시작 -->
<div class="card shadow">
  <!-- 마스터 카드 -->
  <!-- <div class="card shadow-sm mb-4"> -->
    <div class="card-header py-3 d-flex align-items-center justify-content-between">
      <h6 class="mb-0 font-weight-bold text-primary">제품 조회 페이지</h6>
    </div>
  <!-- </div>  -->

  <!-- 폼 카드 -->
  <!-- <div class="card shadow-sm">  -->
    <div class="card-body">
    <div class="btn-bar">
    	 <!-- 버튼 영역 (폼 전체 최상단 오른쪽) -->
      <div class="d-flex justify-content-end mb-3">
	    <button type="submit" class="btn btn-dark me-2" id="submitBtn">조회</button>
	    <button type="reset" class="btn btn-danger" form="searchOrderPlan">초기화</button>
       </div>
    </div>
    
      <form class="row g-3" id="searchList" enctype="application/x-www-form-urlencoded">
        <div class="col-md-4">
         <label for="productCode" class="form-label">제품코드</label>
         <input type="text" class="form-control" id="productCode" name="productCode">
        </div>
        <div class="col-md-4">
         <label for="businessPartner" class="form-label">공급처명</label>
         <input type="text" class="form-control" id="businessPartner" name="businessPartner">
        </div>
      	<div class="col-md-4">
         <label for="insDate" class="form-label">등록일자</label>
         <input type="date" class="form-control" id="insDate" name="insDate">
        </div>
      </form>
    </div>
  <!-- </div>  -->
  
<div class="shadow-sm mt-4">
  <div class="card-body">
    <div class="row">
      <!-- 입고 목록 -->
      <div class="col-md-6">
        <div class="card">
          <div class="card-header py-3 d-flex align-items-center justify-content-between">
				<h6 class="m-0 font-weight-bold text-primary">제품 목록</h6>
		  </div>

          <div class="card-body p-0">
            <!-- 로딩바 -->
			<div id="gridWrapper" style="position: relative; width: 100%; height: 500px;">
            <div id="inListGrid" class="ag-theme-quartz" style="width: 100%; height: 500px;"></div>
			     <!-- 로딩 스피너 -->
			  <div id="loader" class="loader-overlay" style="display: none;">
			    <div class="spinner-border text-primary" role="status">
			      <span class="visually-hidden">Loading...</span>
			    </div>
			  </div>
			</div>
			
          </div>
        </div>
      </div>

      <!-- 입고 상세 -->
      <div class="col-md-6">
        <div class="card">
          <div class="card-header py-3 d-flex align-items-center justify-content-between">
				<h6 class="m-0 font-weight-bold text-primary">제품 상세</h6>
		  </div>
          <div class="card-body p-0">
        <!-- 로딩바 + Grid Start -->
		<div id="gridDetailWrapper" style="position: relative; width: 100%; max-height: 500px;">
              <!-- 상세 이미지 카드 (기본 hidden) -->
				  <div id="imageCard" class="card shadow-sm mb-4" style="display: none;">
				    <!-- <div class="card-header bg-secondary text-white">
				      <h6 class="mb-0">이미지 미리보기</h6>
				    </div> -->
				    <div class="card-body text-center">
				      <img id="previewImage" src="" alt="이미지 미리보기" class="img-fluid"  style="max-width: 100px; max-height: 100px;">
				      <p id="imageName" class="mt-2"></p>
				    </div>
				  </div> 
				  <div id="inDetailGrid" class="ag-theme-quartz" style="width: 100%; height: 100%;"></div>
            <!-- 로딩 스피너 -->
				<div id="loaderDetail" class="loader-overlay" style="display: none;">
					<div class="spinner-border text-primary" role="status">
					    <span class="visually-hidden">Loading...</span>
					</div>
				</div>
			</div>
            <!-- 로딩바 + Grid End -->
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

  
  <!-- 컨테이너 종료 -->
</div>

 
</section>
  
<th:block layout:fragment="body_extra">
 <!-- Axios 등록 -->
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
 <!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
 <!-- ag-Grid JS -->
<script src="https://cdn.jsdelivr.net/npm/ag-grid-community@30.2.1/dist/ag-grid-community.min.noStyle.js"></script>
 <!-- toastr -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js" integrity="sha512-VEd+nq25CkR676O+pLBnDW09R7VQX9Mdiij052gVCp5yVH3jGtH70Ho/UUv4mJDsEdTvqRCFZg0NKGiojGnUCw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <!-- 스크립트 -->
<script th:inline="none">
document.addEventListener("DOMContentLoaded", () => {
	/**
	 * 공통 Grid 초기화 함수
	 * @param {Object} config - grid 설정 객체
	 * @param {string} config.el - grid를 붙일 div의 id
	 * @param {Array} config.columnDefs - 컬럼 정의
	 * @param {Function} [config.onRowDoubleClicked] - 행 더블클릭 이벤트 핸들러
	 * @param {Function} [config.onGridReady] - grid ready 이벤트 핸들러
	 * @returns {Object} { gridApi, gridOptions }
	 */
	const searchPartner = document.getElementById('businessPartner');
	const searchProduct = document.getElementById('productCode');
    const imageCard = document.getElementById("imageCard");
    let prevImg = document.getElementById("previewImage");
    let imageName = document.getElementById("imageName");
	let compCode = null; // 회사코드
	let productGrid = null; // 전역 변수
 	let gridOptions = null;
 	let gridCreated = false;
 	let gridApi = null;
 	let inDetailGridOptions = null;
 	let selectedRow = null; // 전역(이벤트 바깥)으로 선언
 	let productCode = null;
 	// 공통 모달 호출 함수
 	function initGrid(config) {
 	    const eGridDiv = document.getElementById(config.el);
 	    if (!eGridDiv) {
 	        console.error(`${config.el} div를 찾을 수 없습니다!`);
 	        return null;
 	    }
 		let gridApi = null;
 	    const gridOptions = {
 	        columnDefs: config.columnDefs || [],
 	        rowSelection: config.rowSelection || "single",
 	        pagination: true,
 	        paginationPageSize: config.paginationPageSize || 12,
 	        domLayout: config.domLayout || "normal",
 	        rowData: [],
 	        defaultColDef: {
 	            resizable: true,
 	            sortable: true,
 	            minWidth: 100,
 	        },
 	        onRowDoubleClicked: (event) => {
 	            if (typeof config.onRowDoubleClicked === "function") {
 	                config.onRowDoubleClicked(event);
 	            }
 	        },
 	       onRowClicked: (event) => {
	            if (typeof config.onRowClicked === "function") {
	                config.onRowClicked(event);
	            }
	        },
 	        onGridReady: (event) => {
 	            if (typeof config.onGridReady === "function") {
 	                config.onGridReady(event);
 	            }
 	            event.api.sizeColumnsToFit();
 	        },
 	    };

 	    new agGrid.Grid(eGridDiv, gridOptions);
 	    return { gridApi: gridOptions.api, gridOptions };
	}// END OF FUNCTION

	// 회사코드 불러오기
	axios.get("/api/v1/stock/getCompId", { withCredentials: true })
	  .then(async (res) => { 
		  compCode = Number(res.data); 
		  console.log(compCode);
			
		  })
	  .catch(err => console.error(err));
	
	// 단위마다 "," 공통함수
	function numberFormatter(params) {
		  if (params.value == null || params.value === "") return "";
		  return Number(params.value).toLocaleString();
	}
	
	
		// 제품 리스트 
		const inListGrid = initGrid({
		    el: "inListGrid",
		    columnDefs: [
		        { headerName: "No.", valueGetter: "node.rowIndex + 1", width: 70 },
		        { headerName: "등록일자", field: "insertDate" },
		        { headerName: "제품코드", field: "productCode" },
		        { headerName: "제품명", field: "productName" },
		        { headerName: "규격", field: "specification" },
		        { headerName: "과세여부", field: "vatType" },
		        { 
		            headerName: "썸네일", 
		            field: "productCode", // 이미지 조회용 key
		            width: 100,
		            cellRenderer: (params) => {
		                if(!params.value) return '';
		                
		                // UUID 기준 URL 생성
		                let imgUrl = `/api/v1/stock/selectProductImg/${compCode}/${params.value}`;
		                return `<img src="${imgUrl}" style="max-width: 28px; max-height: 30px; object-fit: contain;" alt="이미지">`;
		            }
		        }
		    ],
		    paginationPageSize: 20,
		    domLayout: "normal",
		    onRowClicked: async (event) => {
		    	try{
		    		showLoader("gridDetailWrapper","데이터를 불러오고 있습니다...");
		    		console.log(event.data.productCode, event.data.productName);
		    		prevImg.src = "";
			        await loadInDetailData(event.data.productCode, event.data.productName); // 상세 그리드 데이터 로드
		    	}catch(error){
		    		console.log(error);
		    		toastr.error(error);
		    	} finally{
		    		hideLoader("gridDetailWrapper");
		    	}
		        // 여기서 선택된 결산 상세를 불러오는 로직 추가 가능
		    },
		    onGridReady: async (event) => {
		        try {
		        	
		        	showLoader("gridWrapper", "데이터를 불러오는 중입니다...");
		            const res = await axios.get(`/api/v1/stock/productList/${compCode}`, { withCredentials: true });
		            console.log(res.data);
		            event.api.setRowData(res.data); // 마스터 그리드에 데이터 뿌리기
		        } catch (err) {
		            console.error(err);
		            toastr.error('데이터 로드 실패');
		        } finally{
		        	hideLoader("gridWrapper");
		        }
		    }
			});// END OF inListGrid
	
	const inDetailColumnDefs = [
	    { headerName: "No.",valueGetter: "node.rowIndex + 1", field: "no", width: 80},
	    { headerName: "LOT", field: "lotCode" },
	    { headerName: "제품코드", field: "productCode" },
	    { headerName: "제품명", field: "productName" },
	    { headerName: "규격", field: "specification"},
	    { headerName: "거래처코드", field: "businessCode"},
	    { headerName: "거래처명", field: "businessPartner"},
	    { headerName: "잔여수량", field: "remainQty", valueFormatter: numberFormatter },
	    { headerName: "구매단가", field: "purchasePrice", valueFormatter: numberFormatter}
	]; // END OF COLUMN 
	
	
	//그리드 초기화
	function initInboundGrid() {
	    const { gridOptions } = initGrid({
	        el: "inDetailGrid",
	        columnDefs: inDetailColumnDefs,
	        paginationPageSize: 10,
	        domLayout: "autoHeight",
	        onGridReady: (event) => {
	            inDetailGridOptions = event.api;
	        }
	    });
	}

	async function loadInDetailData(productCode, productName){
		showLoader("gridDetailWrapper","데이터를 불러오는 중입니다...");
	     
		
		 try {
		        // 이미지 요청 (선택적)
		        try {
		            const imgRes = await axios.get(`/api/v1/stock/selectProductImg/${compCode}/${productCode}`, 
		                { responseType: 'blob', withCredentials: true });
	
		            const reader = new FileReader();
		            reader.onload = function(e) {
		                prevImg.src = e.target.result;
		                imageName.textContent = productName;
		                imageCard.style.display = 'block';
		            };
		            reader.readAsDataURL(imgRes.data);
	
		        } catch(imgErr) {
		            console.log("이미지 없음:", imgErr);
		            prevImg.src = ""; // 이미지 없으면 초기화
		            imageCard.style.display = 'none';
		        }
	
		        // 상세 데이터 요청 (LOT 정보)
		        const resDetail = await axios.get(`/api/v1/selectProductDetail/${compCode}/${productCode}`, { withCredentials: true });
		        console.log("LOT별 상세 데이터:", resDetail.data);
	
		        if (inDetailGridOptions) {
		            inDetailGridOptions.api.setRowData(resDetail.data);
		        }
	
		    } catch (err) {
		        console.error("상세 데이터 조회 실패:", err);
		        toastr.error("상세 데이터 조회 실패");
		    } finally {
		        hideLoader("gridDetailWrapper");
		    }
	  
	}// END OF loadInDetailData

	initInboundGrid(); // 그리드 초기화 실행 후 그리드에 그리기

});
</script>
</th:block>

</body>
</html>
