<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
     xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	 layout:decorate="~{layout/base}">
<head>
  <meta charset="UTF-8">
  <title layout:fragment="title">너 구 름(Your Cloud)</title>
  <th:block layout:fragment="head_extra">
     <!-- Bootstrap CSS -->
  	<!--  base에 있는 버전과 달라서 강제 주입 --> 
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
    rel="stylesheet"
    crossorigin="anonymous"
  />
   <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <!-- AG Grid CSS (Quartz) -->
   <link
     rel="stylesheet"
     href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/styles/ag-grid.css"
    />
   <link
     rel="stylesheet"
     href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/styles/ag-theme-quartz.css"
   />
   <!-- TOASTR -->
   <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.css" integrity="sha512-3pIirOrwegjM6erE5gPSwkUzO+3cTjpnV9lexlNZqvupR64iZBnOOTiiLPb9M36zpMScbmUNIcHUqKD47M719g==" crossorigin="anonymous" referrerpolicy="no-referrer" />
   
   <!-- CSS(confirm alert + Quartz) -->
   <link rel="stylesheet" href="/style/confirm.css" />
   
  </th:block>
</head>
<body>
<section layout:fragment="content">
<!-- 컨테이너 시작 -->
<div class="card shadow">
  <!-- 마스터 카드 -->
  <!-- <div class="card shadow-sm mb-4"> -->
    <div class="card-header py-3 d-flex align-items-center justify-content-between">
      <h6 class="mb-0 font-weight-bold text-primary">발주 등록 페이지</h6>
    </div>
  <!-- </div>  -->

  <!-- 폼 카드 -->
  <!-- <div class="card shadow-sm">  -->
    <div class="card-body">
    <div class="btn-bar">
    	 <!-- 버튼 영역 (폼 전체 최상단 오른쪽) -->
      <div class="d-flex justify-content-end mb-3">
      	<button type="button" class="btn btn-dark me-2" id="searchBtn">계획조회</button>
	    <button type="submit" class="btn btn-primary me-2" id="submitBtn">등록</button>
	    <button type="reset" class="btn btn-danger" form="insertOrder">초기화</button>
       </div>
    </div>
    
      <form class="row g-3" id="insertOrder" enctype="application/x-www-form-urlencoded">
        <div class="col-md-4">
          <label for="xpCode" class="form-label">계획코드</label>
          <input type="text" class="form-control" id="xpCode" name="xpCode" placeholder="등록한 계획 존재시 기입">
        </div>
        <div class="col-md-4">
          <label for="businessPartner" class="form-label">거래처명</label>
          <input type="text" class="form-control" id="businessPartnerInput" name="businessPartner">
        </div>
        <div class="col-md-4">
          <label for="businessCode" class="form-label">거래처코드</label>
          <input type="text" class="form-control" id="businessCodeInput" name="businessCode">
        </div>
        <div class="col-md-4">
          <label for="compCode" class="form-label">회사코드</label>
          <input type="text" class="form-control" id="compCode" name="compCode">
        </div>
        <div class="col-md-4">
          <label for="empId" class="form-label">담당자명</label>
          <input type="text" class="form-control" id="empId" name="empId">
        </div>
      	<div class="col-md-4">
         <label for="taxType" class="form-label">세율유형</label>
         <select class="form-select"aria-label="Default select example" id="taxType" name="taxType">
          <option value="" selected>선택안함</option>
			<option value="부가세율">부가세율 적용</option>
			<option value="영세율">영세율 적용</option>
			<option value="면세">면세 적용</option>
			</select>
        </div>
        <div class="col-md-4">
          <label for="dueDate" class="form-label">납기일자</label>
          <input type="date" class="form-control" id="dueDate" name="dueDate">
        </div>
      </form>
    </div>
  <!-- </div>  -->
  
  <div class="card shadow-sm mt-4">
  <div class="card-header bg-secondary text-white">
    <h5 class="mb-0">발주 상품 목록</h5>
  </div>
  <div class="card-body">
  	<div class="d-flex justify-content-end mb-2">
  		<button type="button" class="btn btn-outline-primary" id="addRowBtn">행 추가</button>
	</div>
    <table class="table table-bordered" id="orderItemsTable">
      <thead class="table-light">
        <tr style="text-align:center">
          <th>No.</th>
          <th>제품코드</th>
          <th>제품명</th>
          <th>규격</th>
          <th>수량</th>
          <th>구매단가</th>
          <th>공급가액</th>
          <th>세액</th>
          <th>비고</th>
          <th>삭제</th>
        </tr>
      </thead>
      <tbody>
        <!-- JS로 행 추가 -->
      </tbody>
    </table>
  </div>
</div>
  
  
  
  
  <!-- Toast (닫기 버튼 제거) -->
<div class="position-fixed top-0 end-0 p-3" style="z-index: 11">
  <div id="successToast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-body" id="toastMessage">등록 성공!</div>
  </div>
</div>
  
  <!-- 컨테이너 종료 -->
</div>

  <!-- 모달 include              경로             ::  div id 부분  -->   
  <div th:replace="~{stock/modals/businessModal :: businessModal}"></div>
   <!-- 모달 include              경로             ::  div id 부분  -->   
  <div th:replace="~{stock/modals/productModal :: productModal}"></div>
   <!-- 모달 include              경로             ::  div id 부분  -->   
  <div th:replace="~{stock/modals/orderListModal :: orderListModal}"></div>
  
</section>
  
<th:block layout:fragment="body_extra">
 <!-- Axios 등록 -->
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
 <!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
 <!-- ag-Grid JS -->
<script src="https://cdn.jsdelivr.net/npm/ag-grid-community@30.2.1/dist/ag-grid-community.min.noStyle.js"></script>
 <!-- toastr -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js" integrity="sha512-VEd+nq25CkR676O+pLBnDW09R7VQX9Mdiij052gVCp5yVH3jGtH70Ho/UUv4mJDsEdTvqRCFZg0NKGiojGnUCw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
 <!-- cuteAlert js -->
<script src="/js/cuteAlert.js"></script>

  <!-- 스크립트 -->
<script th:inline="none">
document.addEventListener("DOMContentLoaded", () => {
	const addRowBtn = document.getElementById('addRowBtn');
	const tableBody = document.querySelector('#orderItemsTable tbody');
	const taxSelect = document.getElementById('taxType'); // 상단 세율 select
	const searchBtn = document.getElementById('searchBtn'); // 발주계획 조회 버튼
	let realRowCnt = tableBody.rows.length; // 실제 테이블 행 개수
	let rowCount = tableBody.rows.length + 1; // 현재 행 개수 + 1
 	let gridApi = null;
 	let gridOptions = null;
 	
 	
 	
 	
 // 공통 모달 호출 함수
 	function initGrid(config) {
 	    const eGridDiv = document.getElementById(config.el);
 	    if (!eGridDiv) {
 	        console.error(`${config.el} div를 찾을 수 없습니다!`);
 	        return null;
 	    }
 		let gridApi = null;
 	    const gridOptions = {
 	        columnDefs: config.columnDefs || [],
 	        rowSelection: config.rowSelection || "single",
 	        pagination: true,
 	        paginationPageSize: config.paginationPageSize || 12,
 	        domLayout: config.domLayout || "normal",
 	        rowData: [],
 	        defaultColDef: {
 	            resizable: true,
 	            sortable: true,
 	            minWidth: 100,
 	        },
 	        onRowDoubleClicked: (event) => {
 	            if (typeof config.onRowDoubleClicked === "function") {
 	                config.onRowDoubleClicked(event);
 	            }
 	        },
 	       onRowClicked: (event) => {
	            if (typeof config.onRowClicked === "function") {
	                config.onRowClicked(event);
	            }
	        },
 	        onGridReady: (event) => {
 	            if (typeof config.onGridReady === "function") {
 	                config.onGridReady(event);
 	            }
 	            event.api.sizeColumnsToFit();
 	        },
 	    };

 	    new agGrid.Grid(eGridDiv, gridOptions);
 	    return { gridApi: gridOptions.api, gridOptions };
	}// END OF FUNCTION
 	
 	//let gridCreated = false;
 	// withCredentials: true를 추가해야 쿠키 기반 세션을 함께 보내서 로그인 상태를 유지
 	axios.get("/api/v1/stock/getEmpName", { withCredentials: true })
		  .then(res => {
    			document.getElementById("empId").value = res.data;
  			})
  		  .catch(err => console.error(err));
	
 	axios.get("/api/v1/stock/getCompId", { withCredentials: true })
	  .then(res => {
			document.getElementById("compCode").value = res.data;
		})
	  .catch(err => console.error(err));
 	
	// 계산 함수
	function calculateRow(row) {
	  // 변수 지정
	  const qty = parseFloat(row.querySelector('.qty').value) || 0;
	  const price = parseFloat(row.querySelector('.purchasePrice').value) || 0;
	  const supAmt = parseFloat(row.querySelector('.supAmt').value) || 0;
	  let taxRate = 0;
	  
	  // 옵션별 세액 
	  if(taxSelect.value ==="부가세율"){
		taxRate = 0.1;
	  }else if(taxSelect.value ==="영세율" || taxSelect.value ==="면세"){
	  	taxRate = 0;
	  }
	  
	  // 지정한 세액별 계산값 바인딩
	  //row.querySelector('.supAmt').value = Math.floor(qty * price * (1 + taxRate)); // 공급가액
	  row.querySelector('.supAmt').value = Math.floor(qty * price); // 공급가액
	  row.querySelector('.vatAmt').value = Math.floor(qty * price * taxRate); // 공급가액 기준 부가세
	}
	
	 const productCodeInput = document.getElementById('businessCodeInput');
	    // ------------------ 제품코드 클릭 시 모달 ------------------
	    productCodeInput.addEventListener('click', async () => {
			businessModal.show(); // 항상 동일한 인스턴스 사용
	        if (!gridApi) initBusinessGrid();
	        else loadBusinessData();
	    });
	

	// 세율 변경 시 기존 행 모두 업데이트
	taxSelect.addEventListener('change', () => {
	  tableBody.querySelectorAll('tr').forEach(row => calculateRow(row));
	});
	
	// 발주 조회 버튼 클릭시 모달 호출
	let orderListGridApi = null;
	let orderDetailGridApi = null;
	searchBtn.addEventListener('click', async () => {
	    const orderListModalEl = document.getElementById('orderListModal');
	    const orderListModal = bootstrap.Modal.getOrCreateInstance(orderListModalEl);
	    orderListModal.show();
	    
	 //   setTimeout(() => {
	   //     const eGridDiv = document.getElementById('orderListGrid');
	     //   if (!eGridDiv) return console.error("orderListGrid div가 없습니다!");
	      //  new agGrid.Grid(eGridDiv, gridOptions);
	   // }, 100); // 100ms 정도 대기

	    // Grid 초기화 (한 번만)
	    if (!orderListGridApi) {
	        const eGridDiv = document.getElementById('orderListGrid');
	        const columnDefs = [
	            { headerName: "발주계획코드", field: "xpCode" },
	            { headerName: "거래처코드", field: "businessCode" },
	            { headerName: "거래처명", field: "businessPartner" },
	            { headerName: "담당자", field: "empId" },
	            { headerName: "제품명", field: "productName" },
	            { headerName: "수량", field: "amount" },
	            { headerName: "단가", field: "purchasePrice" },
	            { headerName: "공급가액", field: "supAmt" },
	            { headerName: "세율유형", field: "taxType" }
	        ];

	        const gridOptions = {
	            columnDefs,
	            rowSelection: "single",
	            pagination: true,
	            paginationPageSize: 10,
	            defaultColDef: {
	                resizable: true,
	                sortable: true,
	                minWidth: 100
	            },
	            onGridReady: async (event) => {
	                orderListGridApi = event.api;
	                orderListGridApi.sizeColumnsToFit();
	                await loadOrderPlanData();
	            },
	            onRowDoubleClicked: async (event) => {
	                console.log("선택된 발주 계획:", event.data);
	                // 필요하면 선택한 데이터를 상단 input에 반영
	                document.getElementById('xpCode').value = event.data.xpCode;
	                document.getElementById('businessCodeInput').value = event.data.businessCode;
	                document.getElementById('businessPartnerInput').value = event.data.businessPartner;
	                document.getElementById('taxType').value = event.data.taxType;
	                await appendDetailRow(event.data); // 디테일 테이블에 새 row 추가;
	                

	                orderListModal.hide();
	            }
	        };
	        new agGrid.Grid(eGridDiv, gridOptions);
	    } else {
	        orderListGridApi.sizeColumnsToFit();
	        await loadOrderPlanData();
	    }
	    // 상세 그리드 초기화 (한 번만)
	    if (!orderDetailGridApi) {
	        const eDetailGridDiv = document.getElementById('orderDetailGrid');
	        const detailColumnDefs = [
	            { headerName: "제품명", field: "productName" },
	            { headerName: "수량", field: "amount" },
	            { headerName: "공급가액", field: "supAmt" }
	        ];
	        const detailGridOptions = {
	            columnDefs: detailColumnDefs,
	            defaultColDef: { resizable: true, sortable: true, minWidth: 100 }
	        };
	        orderDetailGridApi = new agGrid.Grid(eDetailGridDiv, detailGridOptions).gridOptions.api;
	    }
	});

	// 서버에서 발주 계획 데이터 가져오기
	async function loadOrderPlanData() {
	    try {
	        const res = await axios.get('/api/v1/stock/orderPlans', { withCredentials: true });
	        if (orderListGridApi) {
	            orderListGridApi.setRowData(res.data);
	        }
	    } catch (err) {
	        console.error(err);
	        toastr.error('발주 계획 조회 실패');
	    }
	}

	function appendDetailRow(data) {
	    const detailTbody = document.querySelector('#detailTable tbody'); // 디테일 테이블 tbody
	    const tableBody = document.querySelector('#orderItemsTable tbody');
	    if (!tableBody) {
	        console.error('#orderItemsTable tbody를 찾을 수 없습니다!');
	        return;
	    }
	    data.details.forEach(detail => {
	    	
	    const row = document.createElement('tr');
	    row.innerHTML = `
	        <td class="text-center">${rowCount}</td>
	        <td><input type="text" class="form-control productCode" name="productCode" value="${detail.productCode || ''}"></td>
	        <td><input type="text" class="form-control productName" name="productName" value="${detail.productName || ''}"></td>
	        <td><input type="text" class="form-control specification" name="specification" value="${detail.specification || ''}"></td>
	        <td><input type="number" class="form-control qty" name="qty" value="${detail.amount || 1}" min="1"></td>
	        <td><input type="number" class="form-control purchasePrice" name="purchasePrice" value="${detail.purchasePrice || 0}" min="0"></td>
	        <td><input type="number" class="form-control supAmt" name="supAmt" value="${detail.supAmt || 0}" readonly></td>
	        <td><input type="number" class="form-control vatAmt" name="vatAmt" value="0" readonly></td>
	        <td><button type="button" class="btn btn-sm btn-danger deleteRowBtn">삭제</button></td>
	    `;
		rowCount++;
	   tableBody.appendChild(row);

	    // 삭제 버튼 이벤트
	    row.querySelector('.deleteRowBtn').addEventListener('click', () => {
	        row.remove();
	        updateRowNumbers(tableBody); // row 번호 갱신
	    });
	    
		});
	}

	// row 번호 갱신 함수
	function updateRowNumbers(tbody) {
	    Array.from(tbody.children).forEach((tr, idx) => {
	        tr.querySelector('td:first-child').textContent = idx + 1;
	    });
	}
	
	
	// ------------------ 변수 초기화 ------------------
	let productGridApi = null;
	let productGridOptions = null;
	let selectedProductRow = null; // 클릭한 행 저장용
	const productModalEl = document.getElementById("productModal");
	const productModal = bootstrap.Modal.getOrCreateInstance(productModalEl);
	const businessModalEl = document.getElementById("businessModal");
	const businessModal = bootstrap.Modal.getOrCreateInstance(businessModalEl);
	
	// 행 추가
	addRowBtn.addEventListener('click', () => {
	// const taxRate = parseFloat(taxSelect.value) || 0; // 현재 선택된 세율
	const row = document.createElement('tr');
	
	row.innerHTML = `
		<td class="text-center">${rowCount}</td>
	       <td><input type="text" class="form-control productCode" name="productCode"></td>
	       <td><input type="text" class="form-control productName" name="productName"></td>
	       <td><input type="text" class="form-control specification" name="specification"></td>
	       <td><input type="number" class="form-control qty" name="qty" value="1" min="1"></td>
	       <td><input type="number" class="form-control purchasePrice" name="purchasePrice" value="0" min="0"></td>
	       <td><input type="number" class="form-control supAmt" name="supAmt" value="0" readonly></td>
	       <td><input type="number" class="form-control vatAmt" name="vatAmt" value="0" readonly></td>
	       <td><input type="text" class="form-control note" name="note"></td>
	       <td><button type="button" class="btn btn-sm btn-danger deleteRowBtn">삭제</button></td>
	    `;
	    rowCount++;
	    
	   
	    // 제품코드 클릭 시 모달 호출
	    const productCodeInput = row.querySelector('.productCode');
	    // ------------------ 제품코드 클릭 시 모달 ------------------
	    productCodeInput.addEventListener('click', async () => {
	    	
	        selectedProductRow = row; // 현재 행 저장
	        productModal.show();
	        // Grid 한 번만 생성
	        if (!productGridApi) {
	            productGridOptions = {
	                columnDefs: [
	                    { headerName: "제품코드", field: "productCode" },
	                    { headerName: "제품명", field: "productName" },
	                    { headerName: "규격", field: "specification" },
	                    
	                ],
	                rowData: [],
	                rowSelection: "single",
	                onGridReady: async (event) => {
	                	 productGridApi = event.api;  // <- 반드시 할당
	                	// 모달이 열릴 때 크기 조정         
	                     productGridApi.sizeColumnsToFit();
	                    // 익명 함수로 정의
	                    //const gridApi = event.api;
	                	 await loadProductData();
	                	 
	                },
	                onRowDoubleClicked: (event) => {
	                	if (!selectedProductRow) return;
	                    // 선택한 데이터 현재 행에 반영
	                    //productCodeInput.value = event.data.productCode;
	                    //const row = productCodeInput.closest('tr');
	                    selectedProductRow.querySelector('.productCode').value = event.data.productCode;
	                    selectedProductRow.querySelector('.productName').value = event.data.productName;
	                    selectedProductRow.querySelector('.specification').value = event.data.specification;
	                    productModal.hide();
	                }
	            };
	            new agGrid.Grid(document.querySelector('#productGrid'), productGridOptions);
	        } else {
	            // 모달이 이미 생성된 경우에도 sizeColumnsToFit 호출
	            productGridApi.sizeColumnsToFit();
	            await loadProductData();
	        }
	    });
	    
	    // 수량 또는 단가 변경 시 자동 계산
	    row.querySelectorAll('.qty, .purchasePrice').forEach(input => {
	      input.addEventListener('input', () => calculateRow(row));
	    });

	    // 삭제 버튼
	    row.querySelector('.deleteRowBtn').addEventListener('click', () => row.remove());

	    
	    tableBody.appendChild(row);
	    
	    
 });
	
	// 거래처 그리드 초기화
	function initBusinessGrid() {
	    const eGridDiv = document.getElementById('myGrid');
	    const columnDefs = [
	        { headerName: "거래처코드", field: "cusCode" },
	        { headerName: "거래처명", field: "cusName" },
	        
	        { headerName: "담당자명", field: "empName" },
	        { headerName: "사업자번호", field: "bizNo" },
	        { headerName: "대표명", field: "ceoName" },
	        { headerName: "업태", field: "bizType" },
	        { headerName: "종목", field: "bizCategory" },
	        { headerName: "거래처주소", field: "addr" }
	    ];

	    const gridOptions = {
	        columnDefs,
	        rowSelection: "single",
	        pagination: true,
	        domLayout: 'normal',
	        rowData: [],
	        onGridReady: (event) => {
	            gridApi = event.api;
	            gridApi.sizeColumnsToFit();
	            loadBusinessData();
	        },
	        defaultColDef: {
	            resizable: true,   // 컬럼 너비 조절 가능
	            sortable: true,    // 정렬 가능
	            minWidth: 100,     // 최소 너비
	        },
	        onRowDoubleClicked: (event) => {
	            
	            document.getElementById('businessCodeInput').value = event.data.cusCode;
	            document.getElementById('businessPartnerInput').value = event.data.cusName;
	            bootstrap.Modal.getOrCreateInstance(document.getElementById("businessModal")).hide();
	        }
	    };
	    new agGrid.Grid(eGridDiv, gridOptions);
	}
	// 거래처 데이터 로드
	async function loadBusinessData() {
		const compCode = Number(document.getElementById('compCode').value);
	    try {
	        const res = await axios.get(`/api/v1/stock/cusList/${compCode}`, {
	            
	            withCredentials: true           // 세션 쿠키 포함
	        });
	        if (gridApi) {
	            gridApi.setRowData(res.data);
	            gridApi.sizeColumnsToFit();
	        }
	    } catch (err) { console.error(err); }
	}
	
	// ------------------ Grid 데이터 로드 함수 ------------------
	async function loadProductData() {
		const compCode = Number(document.getElementById('compCode').value); // 회사코드 (세션)
		const businessCode = document.getElementById('businessCodeInput').value;// 거래처코드
	    if (!productGridApi) return;
	    try {
	        const res = await axios.get(`/api/v1/stock/productList/${compCode}`,{ withCredentials: true });
	        productGridApi.setRowData(res.data);
	    } catch(err) {
	        console.error(err);
	    }
	}



	const modalEl = document.getElementById("businessModal");
	const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
  	// CALL MODAL
	//모달 데이터 로드 함수
	async function loadModalData() {

			const eGridDiv = document.querySelector('#myGrid'); // div 선택
			if(!eGridDiv)  return console.error("myGrid div가 존재하지 않습니다!");
			
			 const columnDefs = [
				    { headerName: "거래처코드", field: "cusCode" },
				    { headerName: "거래처명", field: "cusName" },
			        { headerName: "담당자명", field: "empName" },
			        { headerName: "사업자번호", field: "bizNo" },
			        { headerName: "대표명", field: "ceoName" },
			        { headerName: "업태", field: "bizType" },
			        { headerName: "종목", field: "bizCategory" },
			        { headerName: "거래처주소", field: "addr" }
			        
			];
    	if (!gridApi) {
		    const gridOptions = {
		        columnDefs: columnDefs,
		        rowSelection: "single",
		        rowData: [],
		        onGridReady: async function(event) {
		        	gridApi = event.api;
		            
		        },
		        onRowDoubleClicked: function(event) {
		            document.getElementById("businessCode").value = event.data.cusCode;  // 실제 데이터 필드명 확인 필요
		            document.getElementById("businessPartner").value = event.data.cusName;
		            bootstrap.Modal.getOrCreateInstance(document.getElementById("businessModal")).hide();
		            
		          }
		     
		    	};
		    		new agGrid.Grid(eGridDiv, gridOptions);
    	}

		// axios로 데이터 가져오기	  
		try {
				const res = await axios.get("/api/v1/stock/cusList");
				// gridApi가 준비되었는지 확인
				if (gridApi) {
					gridApi.setRowData(res.data);
				} else {
				    // gridApi가 아직 준비 안된 경우 100ms 후 재시도
				    setTimeout(() => loadModalData(), 100);
				}
			} catch (err) {
				 console.error(err);
			}
	}// end of loadModalData
	

	
	

  // Axios 등록 + Toast
	const form = document.getElementById('insertOrder');
	const submitBtn = document.getElementById('submitBtn');
	const toastEl = document.getElementById('successToast');
	const toast = new bootstrap.Toast(toastEl);
	
	submitBtn.addEventListener('click', async (event) => {
		event.preventDefault(); // 페이지 새로고침 방지
		 const rows = tableBody.querySelectorAll('tr');
	        if(rows.length === 0) {
	            toastr.error('행 데이터를 추가해주세요!');
	            return;
	        }
	        // confirm 먼저
	        const res = await cuteAlert({
	        	type: "question",
	            title: "발주 확인",
	            message: "정말 등록하시겠습니까?",
	            imgUrl: 'https://img.icons8.com/?size=100&id=103807&format=png&color=000000',
	            confirmText: "네",
	            cancelText: "아니오"
	        });

	        if(res !== "confirm") {
	            return; // 취소 시 함수 종료
	        }
	        
	     // master + details
	      const details = [];
		  document.querySelectorAll('#orderItemsTable tbody tr').forEach(row => {
			  details.push({
		      productCode: row.querySelector('.productCode').value,
		      productName: row.querySelector('.productName').value,
		      specification: row.querySelector('.specification').value,
		      amount: row.querySelector('.qty').value,
		      purchasePrice: row.querySelector('.purchasePrice').value,
		      supAmt: row.querySelector('.supAmt').value,
		      vatAmt: row.querySelector('.vatAmt').value,
		      companyCode: Number(document.getElementById('compCode').value)
		    });
		  });
		  const payload = {
				  	xpCode: document.getElementById('xpCode').value,
		            empId: document.getElementById('empId').value,
		            businessPartner : document.getElementById('businessPartnerInput').value,
		            businessCode : document.getElementById('businessCodeInput').value,
		            dueDate: document.getElementById('dueDate').value,
		            vatType: document.getElementById('taxType').value,
		            companyCode: Number(document.getElementById('compCode').value),
		            details:details
		        };
		  try {
			    await axios.post('/api/v1/stock/orderInsert', payload, {
			      headers: { 'Content-Type': 'application/json' }
			    });
			    //toast.show();
			    toastr.success('등록성공');
			    form.reset();
			    // 테이블 초기화
        		tableBody.innerHTML = '';
        		rowCount = 1; // 행 번호 초기화
			  } catch (err) {
			    //alert('등록 실패: ' + err.message);
			   
				toastr.error('등록 실패: ' + err.message,{timeOut: 3000});
			  }
	});

});
</script>
</th:block>

</body>
</html>
