<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
     xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	 layout:decorate="~{layout/base}">
<head>
  <meta charset="UTF-8">
  <title layout:fragment="title">너 구 름(Your Cloud)</title>
  <th:block layout:fragment="head_extra">
     <!-- Bootstrap CSS -->
  	<!--  base에 있는 버전과 달라서 강제 주입 --> 
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
    rel="stylesheet"
    crossorigin="anonymous"
  />
   <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <!-- AG Grid CSS (Quartz) -->
   <link
     rel="stylesheet"
     href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/styles/ag-grid.css"
    />
   <link
     rel="stylesheet"
     href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/styles/ag-theme-quartz.css"
   />
   <style type="text/css">
   .ag-theme-quartz .ag-cell {
	padding-left: 8px;
  	padding-right: 8px;
	}
   </style>
  </th:block>
</head>
<body>
<section layout:fragment="content">
<!-- 컨테이너 시작 -->
<div class="py-5">
  <!-- 마스터 카드 -->
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0">발주 계획 등록 페이지</h5>
    </div>
  </div>
	 <!-- 버튼 영역 (폼 전체 최상단 오른쪽) -->
  <div class="d-flex justify-content-end mb-3">
    <button type="submit" class="btn btn-primary me-2" id="submitBtn">등록</button>
    <button type="reset" class="btn btn-danger" form="insertOrderPlan">초기화</button>
  </div>
  <!-- 폼 카드 -->
  <div class="card shadow-sm">
    <div class="card-body">
      <form class="row g-3" id="insertOrderPlan" enctype="application/x-www-form-urlencoded">
        <div class="col-md-4">
         <label for="insDate" class="form-label">등록일자</label>
          <input type="date" class="form-control" id="insDate" name="insDate">
        </div>
        <div class="col-md-4">
          <label for="empId" class="form-label">담당자명</label>
          <input type="text" class="form-control" id="empId" name="empId">
        </div>
      	<div class="col-4">
         <label for="taxType" class="form-label">세율유형</label>
         <select class="form-select"aria-label="Default select example" id="taxType" name="taxType">
          <option value="" selected>선택안함</option>
			<option value="부가세율">부가세율 적용</option>
			<option value="영세율">영세율 적용</option>
			</select>
        </div>
        <!-- 
        <div class="col-md-4">
          <label for="businessCode" class="form-label">거래처코드</label>
          <div class="input-group">
    		<span class="input-group-text"><i class="bi bi-search"></i></span>
    		<input type="text" class="form-control" id="businessCode" name="businessCode" data-bs-toggle="modal" data-bs-target="#businessModal" readonly>
  		  </div>
        </div>
        <div class="col-md-4">
          <label for="businessPartner" class="form-label">거래처명</label>
          <input type="text" class="form-control" id="businessPartner" name="businessPartner">
        </div>
         -->
      </form>
    </div>
  </div>
  <div class="card shadow-sm mt-4">
  <div class="card-header bg-secondary text-white">
    <h5 class="mb-0">발주 상품 목록</h5>
  </div>
  <div class="card-body">
  	<div class="d-flex justify-content-end mb-2">
  		<button type="button" class="btn btn-outline-primary" id="addRowBtn">행 추가</button>
	</div>
    <table class="table table-bordered" id="orderItemsTable">
      <thead class="table-light">
        <tr style="text-align:center">
          <th>No.</th>
          <th>제품코드</th>
          <th>제품명</th>
          <th>규격</th>
          <th>거래처코드</th>
          <th>거래처명</th>
          <th>수량</th>
          <th>구매단가</th>
          <th>공급가액</th>
          <th>세율</th>
          <th>삭제</th>
        </tr>
      </thead>
      <tbody>
        <!-- JS로 행 추가 -->
      </tbody>
    </table>
  </div>
</div>
  
  
  
  
  <!-- Toast (닫기 버튼 제거) -->
<div class="position-fixed top-0 end-0 p-3" style="z-index: 11">
  <div id="successToast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-body" id="toastMessage">등록 성공!</div>
  </div>
</div>
  
  <!-- 컨테이너 종료 -->
</div>

  <!-- 모달 include              경로             ::  div id 부분  -->   
  <div th:replace="~{stock/modals/businessModal :: businessModal}"></div>
   <!-- 모달 include              경로             ::  div id 부분  -->   
  <div th:replace="~{stock/modals/productModal :: productModal}"></div>
  
</section>
  
<th:block layout:fragment="body_extra">
 <!-- Axios 등록 -->
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
 <!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
<!-- ag-Grid JS -->
<script src="https://cdn.jsdelivr.net/npm/ag-grid-community@30.2.1/dist/ag-grid-community.min.noStyle.js"></script>

  <!-- 스크립트 -->
<script th:inline="none">
document.addEventListener("DOMContentLoaded", () => {
	const addRowBtn = document.getElementById('addRowBtn');
	const tableBody = document.querySelector('#orderItemsTable tbody');
	const taxSelect = document.getElementById('taxType'); // 상단 세율 select
	let rowCount = tableBody.rows.length + 1; // 현재 행 개수 + 1
 	let gridApi = null;
 	let gridOptions = null;
 	//let gridCreated = false;
 	
	// 계산 함수
	function calculateRow(row) {
	  const qty = parseFloat(row.querySelector('.qty').value) || 0;
	  const price = parseFloat(row.querySelector('.purchasePrice').value) || 0;
	  if(taxSelect.value == "부가세율"){
		const taxRate = 0.1;
	  }else if(taxSelect.value == "영세율"){
	  	const taxRate = 0;
	  }

	  row.querySelector('.vatAmt').value = Math.floor(price * taxRate); // 단가 기준 부가세
	  row.querySelector('.supAmt').value = Math.floor(qty * price * (1 + taxRate)); // 공급가액
	}

	// 세율 변경 시 기존 행 모두 업데이트
	taxSelect.addEventListener('change', () => {
	  tableBody.querySelectorAll('tr').forEach(row => calculateRow(row));
	});
	
	
	// ------------------ 변수 초기화 ------------------
	let productGridApi = null;
	let productGridOptions = null;
	let selectedProductRow = null; // 클릭한 행 저장용
	const productModalEl = document.getElementById("productModal");
	const productModal = bootstrap.Modal.getOrCreateInstance(productModalEl);
	const businessModalEl = document.getElementById("businessModal");
	const businessModal = bootstrap.Modal.getOrCreateInstance(businessModalEl);
	
	// 행 추가
	addRowBtn.addEventListener('click', () => {
	// const taxRate = parseFloat(taxSelect.value) || 0; // 현재 선택된 세율
	const row = document.createElement('tr');
	
	row.innerHTML = `
		<td class="text-center">${rowCount}</td>
	       <td><input type="text" class="form-control productCode" name="productCode"></td>
	       <td><input type="text" class="form-control productName" name="productName"></td>
	       <td><input type="text" class="form-control specification" name="specification"></td>
	       <td><input type="text" class="form-control partnerCode" name="partnerCode" readonly></td>
	       <td><input type="text" class="form-control partnerName" name="partnerName"></td>
	       <td><input type="number" class="form-control qty" name="qty" value="1" min="1"></td>
	       <td><input type="number" class="form-control purchasePrice" name="purchasePrice" value="0" min="0"></td>
	       <td><input type="number" class="form-control supAmt" name="supAmt" value="0" readonly></td>
	       <td><input type="number" class="form-control vatAmt" name="vatAmt" value="0" readonly></td>
	       <td><button type="button" class="btn btn-sm btn-danger deleteRowBtn">삭제</button></td>
	    `;
	    rowCount++;
	    
	    // 제품코드 클릭 시 모달 호출
	    const productCodeInput = row.querySelector('.productCode');
	    // ------------------ 제품코드 클릭 시 모달 ------------------
	    productCodeInput.addEventListener('click', async () => {
	        //const modalEl = document.getElementById("productModal");
	        //const modal = new bootstrap.Modal(modalEl);
	        selectedProductRow = row; // 현재 행 저장
	        productModal.show();
	        // Grid 한 번만 생성
	        if (!productGridApi) {
	            productGridOptions = {
	                columnDefs: [
	                    { headerName: "제품코드", field: "productCode" },
	                    { headerName: "제품명", field: "productName" },
	                    { headerName: "규격", field: "specification" },
	                    
	                ],
	                rowData: [],
	                rowSelection: "single",
	                onGridReady: async (event) => {
	                	 productGridApi = event.api;  // <- 반드시 할당
	                	// 모달이 열릴 때 크기 조정         
	                     productGridApi.sizeColumnsToFit();
	                    // 익명 함수로 정의
	                    //const gridApi = event.api;
	                	 await loadProductData();
	                	 
	                },
	                onRowDoubleClicked: (event) => {
	                	if (!selectedProductRow) return;
	                    // 선택한 데이터 현재 행에 반영
	                    //productCodeInput.value = event.data.productCode;
	                    //const row = productCodeInput.closest('tr');
	                    selectedProductRow.querySelector('.productCode').value = event.data.productCode;
	                    selectedProductRow.querySelector('.productName').value = event.data.productName;
	                    selectedProductRow.querySelector('.specification').value = event.data.specification;
	                    productModal.hide();
	                }
	            };
	            new agGrid.Grid(document.querySelector('#productGrid'), productGridOptions);
	        } else {
	            // 모달이 이미 생성된 경우에도 sizeColumnsToFit 호출
	            productGridApi.sizeColumnsToFit();
	            await loadProductData();
	        }
	        // 모달에서 선택 후 값 채워주기
	        // 예시: 선택된 데이터
	        // productCodeInput.value = "선택된 코드";
	        // row.querySelector('.productName').value = "선택된 제품명";
	        // row.querySelector('.partnerCode').value = "선택된 거래처 코드";
	        // row.querySelector('.partnerName').value = "선택된 거래처명";
	    });
	    
	    
	    // 수량 또는 단가 변경 시 자동 계산
	    row.querySelectorAll('.qty, .purchasePrice').forEach(input => {
	      input.addEventListener('input', () => calculateRow(row));
	    });

	    // 삭제 버튼
	    row.querySelector('.deleteRowBtn').addEventListener('click', () => row.remove());

	    // 거래처코드 클릭 시 모달
	    row.querySelector('.partnerCode').addEventListener('click', () => {
	        selectedRow = row; // 클릭한 행 저장
	        //const modalEl = document.getElementById("businessModal");
	        //const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
	        //modal.show();
			businessModal.show(); // 항상 동일한 인스턴스 사용
			
	        if (!gridApi) initBusinessGrid();
	        else loadBusinessData();
	    });
	    
	    tableBody.appendChild(row);
	    
	    
 });
	
	// 거래처 그리드 초기화
	function initBusinessGrid() {
	    const eGridDiv = document.getElementById('myGrid');
	    const columnDefs = [
	        { headerName: "거래처코드", field: "cusCode" },
	        { headerName: "거래처명", field: "cusName" },
	        { headerName: "담당자명", field: "empName" },
	        { headerName: "사업자번호", field: "bizNo" },
	        { headerName: "대표명", field: "ceoName" },
	        { headerName: "업태", field: "bizType" },
	        { headerName: "종목", field: "bizCategory" },
	        { headerName: "거래처주소", field: "addr" }
	    ];

	    const gridOptions = {
	        columnDefs,
	        rowSelection: "single",
	        pagination: true,
	        domLayout: 'normal',
	        rowData: [],
	        onGridReady: (event) => {
	            gridApi = event.api;
	            gridApi.sizeColumnsToFit();
	            loadBusinessData();
	        },
	        defaultColDef: {
	            resizable: true,   // 컬럼 너비 조절 가능
	            sortable: true,    // 정렬 가능
	            minWidth: 100,     // 최소 너비
	        },
	        onRowDoubleClicked: (event) => {
	            if (!selectedRow) return;
	            selectedRow.querySelector('.partnerCode').value = event.data.cusCode;
	            selectedRow.querySelector('.partnerName').value = event.data.cusName;
	            bootstrap.Modal.getOrCreateInstance(document.getElementById("businessModal")).hide();
	        }
	    };
	    new agGrid.Grid(eGridDiv, gridOptions);
	}
	// 거래처 데이터 로드
	async function loadBusinessData() {
	    try {
	        const res = await axios.get("/api/v1/stock/cusList");
	        if (gridApi) {
	            gridApi.setRowData(res.data);
	            gridApi.sizeColumnsToFit();
	        }
	    } catch (err) { console.error(err); }
	}
	
	// ------------------ Grid 데이터 로드 함수 ------------------
	async function loadProductData() {
	    if (!productGridApi) return;
	    try {
	        const res = await axios.get("/api/v1/stock/productList");
	        productGridApi.setRowData(res.data);
	    } catch(err) {
	        console.error(err);
	    }
	}



	const modalEl = document.getElementById("businessModal");
	const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
  // CALL MODAL
  //document.querySelector("#businessCode").addEventListener("click",()=>{
	//modal.show();
	  //loadModalData();
  //});
	//모달 데이터 로드 함수
	async function loadModalData() {

			const eGridDiv = document.querySelector('#myGrid'); // div 선택
			if(!eGridDiv)  return console.error("myGrid div가 존재하지 않습니다!");
			
			 const columnDefs = [
				    { headerName: "거래처코드", field: "cusCode" },
				    { headerName: "거래처명", field: "cusName" },
			        { headerName: "담당자명", field: "empName" },
			        { headerName: "사업자번호", field: "bizNo" },
			        { headerName: "대표명", field: "ceoName" },
			        { headerName: "업태", field: "bizType" },
			        { headerName: "종목", field: "bizCategory" },
			        { headerName: "거래처주소", field: "addr" }
			        
			];
    	if (!gridApi) {
		    const gridOptions = {
		        columnDefs: columnDefs,
		        rowSelection: "single",
		        rowData: [],
		        onGridReady: async function(event) {
		        	gridApi = event.api;
		            
		        },
		        onRowDoubleClicked: function(event) {
		            document.getElementById("businessCode").value = event.data.cusCode;  // 실제 데이터 필드명 확인 필요
		            document.getElementById("businessPartner").value = event.data.cusName;
		            bootstrap.Modal.getOrCreateInstance(document.getElementById("businessModal")).hide();
		            
		          }
		     
		    	};
		    		new agGrid.Grid(eGridDiv, gridOptions);
    	}

		// axios로 데이터 가져오기	  
		try {
				const res = await axios.get("/api/v1/stock/cusList");
				// gridApi가 준비되었는지 확인
				if (gridApi) {
					gridApi.setRowData(res.data);
				} else {
				    // gridApi가 아직 준비 안된 경우 100ms 후 재시도
				    setTimeout(() => loadModalData(), 100);
				}
			} catch (err) {
				 console.error(err);
			}
	}// end of loadModalData
	


  // Axios 등록 + Toast
	const form = document.getElementById('insertOrderPlan');
	const submitBtn = document.getElementById('submitBtn');
	const toastEl = document.getElementById('successToast');
	const toast = new bootstrap.Toast(toastEl);
	
	submitBtn.addEventListener('click', async (event) => {
		event.preventDefault(); // 페이지 새로고침 방지
		
		const master = {
			    insDate: document.getElementById('insDate').value,
			    empId: document.getElementById('empId').value,
			    taxType: document.getElementById('taxType').value
			  };
		
		 const details = [];
		  document.querySelectorAll('#orderItemsTable tbody tr').forEach(row => {
		    details.push({
		      productCode: row.querySelector('.productCode').value,
		      productName: row.querySelector('.productName').value,
		      businessPartner: row.querySelector('.businessPartner').value,
		      businessCode: row.querySelector('.businessCode').value,
		      specification: row.querySelector('.specification').value,
		      amount: row.querySelector('.qty').value,
		      purchasePrice: row.querySelector('.purchasePrice').value,
		      supAmt: row.querySelector('.supAmt').value,
		      vatAmt: row.querySelector('.vatAmt').value
		    });
		  });

		  const payload = { master, details };
		  try {
			    await axios.post('/api/v1/stock/orderPlanInsert', payload, {
			      headers: { 'Content-Type': 'application/json' }
			    });
			    toast.show();
			    form.reset();
			  } catch (err) {
			    alert('등록 실패: ' + err.message);
			  }
		
	//    const formData = new FormData(form);
	
	    //axios.post('/api/v1/stock/productInsert', formData, {
	      //  headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
	    //})
	    //.then(response => {
	      //  toast.show(); // Toast 알림
	       // form.reset();  // 폼 초기화
	        //document.getElementById('imageCard').style.display = 'none'; // 미리보기 숨김
	    //})
	    //.catch(error => {
	      //  alert('등록 실패: ' + error.response.data.message || error.message);
	    //});
	});
  
});
</script>
</th:block>

</body>
</html>
