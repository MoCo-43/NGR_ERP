<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/base}">
<head>
  <meta charset="UTF-8">
  <title layout:fragment="title">발주 계획 등록</title>

  <th:block layout:fragment="head_extra">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

    <!-- AG Grid v31.3.1 (CSS+JS 버전 통일) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/styles/ag-grid.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/styles/ag-theme-quartz.css"/>

    <!-- Toastr -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css"/>

    <style>
      .ag-theme-quartz .ag-cell { padding-left: 8px; padding-right: 8px; }
      .btn-slim { padding:.375rem .75rem; }
      .table thead th { text-align:center; }
    </style>
  </th:block>
</head>
<body>
<section layout:fragment="content">
  <div class="card shadow">
    <div class="card-header py-3 d-flex align-items-center justify-content-between">
      <h6 class="mb-0 fw-bold">발주 계획 등록 페이지</h6>
      <div class="d-flex gap-2">
        <button type="button" class="btn btn-primary btn-slim" id="submitBtn">등록</button>
        <button type="reset" class="btn btn-danger btn-slim" form="insertOrderPlan">초기화</button>
      </div>
    </div>

    <div class="card-body">
      <form class="row g-3" id="insertOrderPlan" enctype="application/x-www-form-urlencoded">
        <div class="col-md-4">
          <label for="insDate" class="form-label">등록일자</label>
          <input type="date" class="form-control" id="insDate" name="insDate">
        </div>
        <div class="col-md-4">
          <label for="compCode" class="form-label">회사코드</label>
          <input type="text" class="form-control" id="compCode" name="compCode" readonly>
        </div>
        <div class="col-md-4">
          <label for="empId" class="form-label">담당자명</label>
          <input type="text" class="form-control" id="empId" name="empId">
        </div>
        <!-- 
        <div class="col-md-3">
          <label for="taxType" class="form-label">세율유형</label>
          <select class="form-select" id="taxType" name="taxType">
            <option value="" selected>선택안함</option>
            <option value="부가세율">부가세율 적용</option>
            <option value="영세율">영세율 적용</option>
            <option value="면세">면세 적용</option>
          </select>
        </div>
         -->
      </form>
    </div>
  </div>

  <div class="card shadow-sm mt-4">
    <div class="card-header bg-secondary text-white">
      <h5 class="mb-0">발주 상품 목록</h5>
    </div>
    <div class="card-body">
      <div class="d-flex justify-content-end mb-2">
        <button type="button" class="btn btn-outline-primary" id="addRowBtn">행 추가</button>
      </div>

      <table class="table table-bordered align-middle" id="orderItemsTable">
        <thead class="table-light">
        <tr>
          <th style="width:60px;">No.</th>
          <th style="width:140px;">제품코드</th>
          <th>제품명</th>
          <th style="width:160px;">규격</th>
          <th style="width:140px;">과세여부</th>
          <th style="width:140px;">거래처코드</th>
          <th>거래처명</th>
          <th style="width:110px;">수량</th>
          <th style="width:130px;">구매단가</th>
          <th style="width:130px;">공급가액</th>
          <th style="width:120px;">세액</th>
          <th style="width:90px;">삭제</th>
        </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Toast -->
  <div class="position-fixed top-0 end-0 p-3" style="z-index: 1080">
    <div id="successToast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-body" id="toastMessage">등록 성공!</div>
    </div>
  </div>

  <!-- 모달 include -->
  <div th:replace="~{stock/modals/businessModal :: businessModal}"></div>
  <div th:replace="~{stock/modals/productModal :: productModal}"></div>
</section>

<th:block layout:fragment="body_extra">
  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/dist/ag-grid-community.min.noStyle.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

  <script th:inline="none">
    document.addEventListener("DOMContentLoaded", () => {
    	// 변수 초기 지정
    	const tableBody = document.querySelector('#orderItemsTable tbody');
        const addRowBtn = document.getElementById('addRowBtn');
        //const taxSelect = document.getElementById('taxType');
        const form = document.getElementById('insertOrderPlan');
        const submitBtn = document.getElementById('submitBtn');
        const toast = new bootstrap.Toast(document.getElementById('successToast'));
        const productModalEl = document.getElementById("productModal");
        const productModal = bootstrap.Modal.getOrCreateInstance(productModalEl);
        const businessModalEl = document.getElementById("businessModal");
        const businessModal = bootstrap.Modal.getOrCreateInstance(businessModalEl);
        
    	let compCode = null;
    	
    	// 현재 날짜로 초기 입력
    	function initToday(){
    		const today = new Date();
    		const yyyy = today.getFullYear();
    		const mm = String(today.getMonth() + 1).padStart(2, '0'); // 월은 0~11이므로 +1
    		const dd = String(today.getDate()).padStart(2, '0');
    		document.querySelector('#insDate').value = `${yyyy}-${mm}-${dd}`;
    	}
    	initToday();
    	// 담당자명 셋팅 - 로그인된 세션 사용자명
    	axios.get("/api/v1/stock/getEmpName", { withCredentials: true })
		  .then(res => {
			  console.log(res.data);
  			document.getElementById("empId").value = res.data;
			})
		  .catch(err => console.error(err));
    	
    
      // 회사코드 불러오기
      axios.get("/api/v1/stock/getCompId", { withCredentials: true })
        .then(res => { document.getElementById("compCode").value = res.data; compCode = Number(res.data);})
        .catch(err => console.error(err));

      // ---------- 금액 계산 ----------
      
      function calculateRow(row) {
        const qty   = Number(row.querySelector('.qty').value) || 0;
        const price = Number(row.querySelector('.purchasePrice').value) || 0;

        //const supply = Math.floor(qty * price); // 공급가액
        //row.querySelector('.supAmt').value = supply;
        
        
        let supAmt = qty * price;
        let vatAmt = 0;

        const vatType = row.querySelector('.vatType').value;
        if (vatType === '과세') {
          vatAmt = Math.floor(supAmt * 0.1);
          supAmt = Math.floor(supAmt);
          
        } else { // 면세, 영세
          vatAmt = 0;
        }
          row.querySelector('.supAmt').value = supAmt;
          row.querySelector('.vatAmt').value = vatAmt;
        
//        let taxRate = 0;
//        if (taxSelect.value === "부가세율") taxRate = 0.1;
        // 영세/면세는 0
//        const vat = Math.floor(supply * taxRate);
//        row.querySelector('.vatAmt').value = vat;
      }
      
      // 세율 바뀌면 전체 재계산
      //tableBody.addEventListener('change', () => {
       // tableBody.querySelectorAll('tr').forEach(calculateRow);
        
      //});
	 
      // ---------- 모달/그리드 준비 (1회 초기화) ----------
    

      async function ensureProductGrid() {
        const gridDiv = document.getElementById('productGrid');
        if (!gridDiv) return;

        if (!gridDiv.__agApi) {
          const options = {
            columnDefs: [
              { headerName: "제품코드", field: "productCode", width: 140 },
              { headerName: "제품명", field: "productName", flex: 1, minWidth: 160 },
              { headerName: "규격", field: "specification", width: 160 },
              { headerName: "과세여부", field: "vatType", width: 160 }
            ],
            rowData: [],
            rowSelection: "single",
            defaultColDef: { resizable: true, sortable: true, minWidth: 100 },
            onGridReady: (e) => { gridDiv.__agApi = e.api; e.api.sizeColumnsToFit(); },
          };
          new agGrid.Grid(gridDiv, options);
        }
        await loadProductData(gridDiv.__agApi);
        setTimeout(() => gridDiv.__agApi?.sizeColumnsToFit(), 0);
      }

      async function ensureBusinessGrid() {
        const gridDiv = document.getElementById('myGrid');
        if (!gridDiv) return;

        if (!gridDiv.__agApi) {
          const options = {
            columnDefs: [
              { headerName: "거래처코드", field: "cusCode", width: 140 },
              { headerName: "거래처명", field: "cusName", flex: 1, minWidth: 160 },
              { headerName: "담당자명", field: "empName", width: 120 },
              { headerName: "사업자번호", field: "bizNo", width: 140 },
              { headerName: "대표명", field: "ceoName", width: 110 },
              { headerName: "업태", field: "bizType", width: 110 },
              { headerName: "종목", field: "bizCategory", width: 120 },
              { headerName: "거래처주소", field: "addr", minWidth: 220, flex: 1 }
            ],
            rowData: [],
            rowSelection: "single",
            defaultColDef: { resizable: true, sortable: true, minWidth: 100 },
            onGridReady: (e) => { gridDiv.__agApi = e.api; e.api.sizeColumnsToFit(); },
          };
          new agGrid.Grid(gridDiv, options);
        }
        await loadBusinessData(gridDiv.__agApi);
        setTimeout(() => gridDiv.__agApi?.sizeColumnsToFit(), 0);
      }

      async function loadProductData(api) {
        // console.log(compCode+": dataType > "+typeof(compCode));
        try {
          const { data } = await axios.get(`/api/v1/stock/productList/${compCode}`, { withCredentials: true });
          api?.setRowData(Array.isArray(data) ? data : []);
        } catch (e) {
          console.error("제품목록 조회 실패:", e);
          api?.setRowData([]);
          toastr.error("제품목록 조회 실패");
        }
      }

      async function loadBusinessData(api) {
        // console.log(compCode+": dataType > "+typeof(compCode));
        try {
          const { data } = await axios.get(`/api/v1/stock/cusList/${compCode}`, { withCredentials: true });
          api?.setRowData(Array.isArray(data) ? data : []);
        } catch (e) {
          console.error("거래처목록 조회 실패:", e);
          api?.setRowData([]);
          toastr.error("거래처목록 조회 실패");
        }
      }

      // ---------- 행 추가 / 삭제 / 번호 리시퀀싱 ----------
      function resequence() {
        [...tableBody.querySelectorAll('tr')].forEach((tr, idx) => {
          tr.querySelector('.seq').textContent = String(idx + 1);
        });
      }

      let currentRowForModal = null; // 현재 모달로 값을 넣을 행

      addRowBtn.addEventListener('click', () => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="text-center seq"></td>
          <td><input type="text" class="form-control productCode" readonly></td>
          <td><input type="text" class="form-control productName" readonly></td>
          <td><input type="text" class="form-control specification" readonly></td>
          <td><input type="text" class="form-control vatType" readonly></td>
          <td><input type="text" class="form-control partnerCode" readonly></td>
          <td><input type="text" class="form-control partnerName" readonly></td>
          <td><input type="number" class="form-control qty" value="1" min="1"></td>
          <td><input type="number" class="form-control purchasePrice" value="0" min="0"></td>
          <td><input type="number" class="form-control supAmt" value="0" readonly></td>
          <td><input type="number" class="form-control vatAmt" value="0" readonly></td>
          <td class="text-center">
            <button type="button" class="btn btn-sm btn-danger deleteRowBtn">삭제</button>
          </td>
        `;
        tableBody.appendChild(tr);
        resequence();
        calculateRow(tr);

        // 이벤트 바인딩
        tr.querySelectorAll('.qty, .purchasePrice').forEach(inp => {
          inp.addEventListener('input', () => calculateRow(tr));
        });

        // 제품코드 클릭 -> 제품 모달
        tr.querySelector('.productCode').addEventListener('click', async () => {
          currentRowForModal = tr;
          await ensureProductGrid();
          productModal.show();
        });

        // 거래처코드 클릭 -> 거래처 모달
        tr.querySelector('.partnerCode').addEventListener('click', async () => {
          currentRowForModal = tr;
          await ensureBusinessGrid();
          businessModal.show();
        });

        // 삭제
        tr.querySelector('.deleteRowBtn').addEventListener('click', () => {
          tr.remove();
          resequence();
        });
      });

      // ---------- 모달 내부 더블클릭 선택 처리 ----------
      // 제품 모달 더블클릭
      productModalEl?.addEventListener('shown.bs.modal', () => {
        const gridDiv = document.getElementById('productGrid');
        if (!gridDiv?.__agApi) return;
        gridDiv.__agApi.addEventListener('rowDoubleClicked', (ev) => {
          if (!currentRowForModal) return;
          currentRowForModal.querySelector('.productCode').value = ev.data.productCode ?? '';
          currentRowForModal.querySelector('.productName').value = ev.data.productName ?? '';
          currentRowForModal.querySelector('.specification').value = ev.data.specification ?? '';
          currentRowForModal.querySelector('.vatType').value = ev.data.vatType ?? '';
          productModal.hide();
        });
      });

      // 거래처 모달 더블클릭
      businessModalEl?.addEventListener('shown.bs.modal', () => {
        const gridDiv = document.getElementById('myGrid');
        if (!gridDiv?.__agApi) return;
        gridDiv.__agApi.addEventListener('rowDoubleClicked', (ev) => {
          if (!currentRowForModal) return;
          currentRowForModal.querySelector('.partnerCode').value = ev.data.cusCode ?? '';
          currentRowForModal.querySelector('.partnerName').value = ev.data.cusName ?? '';
          businessModal.hide();
        });
      });

      // ---------- 등록 ----------
      submitBtn.addEventListener('click', async (e) => {
        e.preventDefault();

        const rows = tableBody.querySelectorAll('tr');
        if (!rows.length) return toastr.error('행 데이터를 추가해주세요!');

        const details = [...rows].map(row => ({
          productCode:    row.querySelector('.productCode').value,
          productName:    row.querySelector('.productName').value,
          specification:  row.querySelector('.specification').value,
          businessCode:   row.querySelector('.partnerCode').value,
          businessPartner:row.querySelector('.partnerName').value,
          amount:         Number(row.querySelector('.qty').value || 0),
          purchasePrice:  Number(row.querySelector('.purchasePrice').value || 0),
          supAmt:         Number(row.querySelector('.supAmt').value || 0),
          vatAmt:         Number(row.querySelector('.vatAmt').value || 0),
        }));

        const payload = {
          empId: document.getElementById('empId').value,
          insDate: document.getElementById('insDate').value,
          //taxType: document.getElementById('taxType').value,
          companyCode: Number(document.getElementById('compCode').value || 0),
          details
        };

        try {
          await axios.post('/api/v1/stock/orderPlanInsert', payload, {
            headers: { 'Content-Type': 'application/json' },
            withCredentials: true
          });
          toast.show();
          toastr.success('등록 성공');
          form.reset();
          tableBody.innerHTML = '';
        } catch (err) {
          console.error(err);
          toastr.error('등록 실패: ' + (err?.response?.data?.message || err.message));
        }
      });
    });
  </script>
</th:block>
</body>
</html>
