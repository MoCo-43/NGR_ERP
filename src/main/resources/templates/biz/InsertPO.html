<!DOCTYPE html>
<html
  lang="ko"
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layout/base}"
>
  <head>
    <title layout:fragment="title">ì£¼ë¬¸ì„œ ì…ë ¥</title>

    <th:block layout:fragment="head_extra">
      <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/styles/ag-grid.css"
      />
      <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/styles/ag-theme-quartz.css"
      />

      <style>
        .form-label {
          font-weight: 600;
        }
        .btn-slim {
          padding: 0.375rem 0.75rem;
        }
        .btn-wide {
          min-width: 110px;
        }
        .muted {
          font-size: 12px;
          color: #6b7280;
        }
        #itemGrid.ag-theme-quartz {
          height: 380px;
          width: 100%;
        }
        .rounded-box {
          border: 1px solid #e5e7eb;
          border-radius: 0.75rem;
          padding: 1rem;
        }
        .ag-theme-quartz .ag-row-pinned {
          font-weight: 700;
          background: #fafafa;
        }
      </style>
    </th:block>
  </head>

  <body>
    <section layout:fragment="content">
      <!-- ìƒë‹¨ íˆ´ë°” (8) -->
      <div class="card shadow mb-3">
        <div class="card-body d-flex align-items-center gap-2 flex-wrap">
          <div class="btn-group">
            <button
              id="btnOpenProduct"
              type="button"
              class="btn btn-outline-secondary btn-slim"
              data-bs-toggle="modal"
              data-bs-target="#productModalTwo"
            >
              í’ˆëª©ì½”ë“œ
            </button>
            <button
              id="btnOpenHistory"
              type="button"
              class="btn btn-outline-secondary btn-slim"
              data-bs-toggle="modal"
              data-bs-target="#PoHistoryModal"
            >
              ì£¼ë¬¸ì„œì´ë ¥ì¡°íšŒ
            </button>
          </div>
          <div class="ml-auto"></div>
          <button
            id="btnReset"
            type="button"
            class="btn btn-danger btn-slim btn-wide"
          >
            ì´ˆê¸°í™”
          </button>
          <button
            id="btnSubmit"
            type="button"
            class="btn btn-primary btn-slim btn-wide"
          >
            ë“±ë¡
          </button>
        </div>
      </div>

      <!-- ì…ë ¥ì˜ì—­ (1~7,10) -->
      <div class="card shadow mb-4">
        <div class="card-body">
          <div class="rounded-box">
            <!-- 1 ì‘ì„±ì¼ì / 2 ê±°ë˜ì²˜ -->
            <div class="form-row align-items-center">
              <div class="form-group col-md-3">
                <label class="form-label">ì‘ì„±ì¼ì</label>
                <input id="poStart" type="date" class="form-control" />
              </div>

              <div class="form-group col-md-5">
                <label class="form-label">ê±°ë˜ì²˜</label>
                <div class="input-group">
                  <input id="cusNo" class="form-control" placeholder="ê±°ë˜ì²˜" />
                  <div class="input-group-append">
                    <button
                      id="btnFindCustomer"
                      type="button"
                      class="btn btn-outline-secondary"
                      data-bs-toggle="modal"
                      data-bs-target="#businessModal"
                    >
                      ğŸ”
                    </button>
                  </div>
                  <input
                    id="cusName"
                    class="form-control"
                    placeholder="ê±°ë˜ì²˜ëª…"
                    readonly
                  />
                </div>
              </div>
            </div>

            <!-- 3 ë‹´ë‹¹ì / 4 ê±°ë˜ìœ í˜• -->
            <div class="form-row align-items-center">
              <div class="form-group col-md-4">
                <label class="form-label">ë‹´ë‹¹ì</label>
                <div class="input-group">
                  <input
                    id="creater"
                    class="form-control"
                    placeholder="ì„¸ì…˜ë¡œê·¸ì¸ì‚¬ìš©ì"
                    disabled
                  />
                </div>
              </div>

              <div class="form-group col-md-4">
                <label class="form-label">ê±°ë˜ìœ í˜•</label>
                <select id="bizType" class="form-control">
                  <option value="VAT_INCLUDED">ë¶€ê°€ì„¸ìœ¨ ì ìš©</option>
                  <option value="VAT_EXEMPT">ë¶€ê°€ì„¸ìœ¨ ë¯¸ì ìš©</option>
                </select>
              </div>
            </div>

            <!-- 5 ë‚©ê¸°ì¼ì / 6 ë¶€ê°€ì„¸ìœ í˜• -->
            <div class="form-row align-items-center">
              <div class="form-group col-md-3">
                <label class="form-label">ë‚©ê¸°ì¼ì</label>
                <input id="exDate" type="date" class="form-control" />
              </div>

              <div class="form-group col-md-4">
                <label class="form-label">ë¶€ê°€ì„¸ìœ í˜•</label>
                <select id="vatDocType" class="form-control">
                  <option value="TAX_INVOICE">ì„¸ê¸ˆê³„ì‚°ì„œ</option>
                  <option value="STATEMENT">ëª…ì„¸ì„œ</option>
                </select>
              </div>
            </div>

            <!-- 7 ì§€ë¶ˆë°©ì‹ / 10 ê²°ì œì˜ˆì •ì¼ -->
            <div class="form-row align-items-center">
              <div class="form-group col-md-5">
                <label class="form-label d-block">ì§€ë¶ˆë°©ì‹</label>
                <div class="form-row">
                  <div class="col-auto">
                    <select id="payMethod" class="form-control">
                      <option value="CASH">í˜„ê¸ˆ</option>
                      <option value="BILL">ì–´ìŒ</option>
                      <option value="CASH_BILL">í˜„ê¸ˆ&ì–´ìŒ</option>
                    </select>
                  </div>
                  <div id="billDates" class="col d-none">
                    <div class="form-row">
                      <div class="col">
                        <input
                          id="billStart"
                          type="date"
                          class="form-control"
                          placeholder="ì–´ìŒ ì‹œì‘ì¼"
                        />
                      </div>
                      <div class="col">
                        <input
                          id="billEnd"
                          type="date"
                          class="form-control"
                          placeholder="ì–´ìŒ ë§Œê¸°ì¼"
                        />
                      </div>
                    </div>
                  </div>
                </div>
                <div class="muted mt-1">
                  * ì–´ìŒ ì„ íƒ ì‹œ ì‹œì‘/ë§Œê¸°ì¼ì„ ì…ë ¥í•˜ì„¸ìš”.
                </div>
              </div>

              <div class="form-group col-md-4">
                <label class="form-label">ê²°ì œì˜ˆì •ì¼</label>
                <input id="settleDue" type="date" class="form-control" />
              </div>
            </div>

            <!-- ìƒíƒœ/ë¹„ê³ (ì„¤ê³„ë„ ìš°ì¸¡ ì„¤ëª…ì˜ì—­ì€ ì£¼ì„ ì²˜ë¦¬ë¡œ ëŒ€ì²´) -->
            <div class="form-row">
              <div class="form-group col-md-3">
                <label class="form-label">ì²˜ë¦¬ìƒíƒœ</label>
                <select id="poStatus" class="form-control">
                  <option value="WRITTEN">ì‘ì„±ì™„ë£Œ</option>
                  <option value="DONE">ì²˜ë¦¬ì™„ë£Œ</option>
                </select>
              </div>
              <div class="form-group col-md-9">
                <label class="form-label">ë¹„ê³ </label>
                <input
                  id="notes"
                  class="form-control"
                  placeholder="íŠ¹ì´ì‚¬í•­ ë©”ëª¨"
                />
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- í’ˆëª© ëª©ë¡ (9) -->
      <div class="card shadow">
        <div
          class="card-header d-flex align-items-center justify-content-between"
        >
          <h6 class="m-0 font-weight-bold text-primary">í’ˆëª© ëª©ë¡</h6>
          <div class="btn-group">
            <button
              id="btnAddRow"
              type="button"
              class="btn btn-outline-secondary btn-slim"
            >
              í–‰ ì¶”ê°€
            </button>
            <button
              id="btnRemoveRow"
              type="button"
              class="btn btn-outline-danger btn-slim"
            >
              í–‰ ì‚­ì œ
            </button>
          </div>
        </div>
        <div class="card-body">
          <div id="itemGrid" class="ag-theme-quartz"></div>
        </div>
      </div>

      <!-- ê±°ë˜ì²˜ ê²€ìƒ‰ ëª¨ë‹¬ -->
      <div th:replace="~{stock/modals/businessModal :: businessModal}"></div>

      <!-- í’ˆëª©ì½”ë“œ ëª¨ë‹¬ -->
      <div th:replace="~{biz/modals/productModal :: productModalFr}"></div>

      <!-- ì£¼ë¬¸ì„œì´ë ¥ì¡°íšŒ ëª¨ë‹¬ -->
      <div th:replace="~{biz/modals/PoHistoryModal :: PoHistoryModal}"></div>
    </section>

    <th:block layout:fragment="body_extra">
      <script
        defer
        src="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/dist/ag-grid-community.min.js"
      ></script>
      <script
        defer
        src="https://cdn.jsdelivr.net/npm/axios@1.7.7/dist/axios.min.js"
      ></script>

      <script th:inline="none">
        document.addEventListener("DOMContentLoaded", () => {
          // ===== ê¸°ë³¸ê°’ ì„¸íŒ… =====
          const today = new Date().toISOString().slice(0, 10);
          setVal("poStart", today);
          setVal("exDate", today);
          setVal("settleDue", today);

          // ì§€ë¶ˆë°©ì‹ í† ê¸€
          byId("payMethod").addEventListener("change", () => {
            const show = ["BILL", "CASH_BILL"].includes(getVal("payMethod"));
            byId("billDates").classList.toggle("d-none", !show);
          });

          // ê·¸ë¦¬ë“œ ì •ì˜
          const VAT_RATE = 0.1; // 10%
          const columnDefs = [
            {
              headerName: "í’ˆëª©ì½”ë“œ",
              field: "productCode",
              editable: true,
              width: 120,
            },
            {
              headerName: "í’ˆëª©ëª…",
              field: "dPrdName",
              editable: true,
              flex: 1,
              minWidth: 160,
            },
            {
              headerName: "ë‹¨ê°€",
              field: "unitPrice",
              editable: true,
              width: 110,
              type: "rightAligned",
              valueParser: numberParser,
              valueFormatter: moneyFmt,
            },
            {
              headerName: "ìˆ˜ëŸ‰",
              field: "orderQty",
              editable: true,
              width: 100,
              type: "rightAligned",
              valueParser: numberParser,
            },
            {
              headerName: "ê³µê¸‰ê°€ì•¡",
              field: "supAmt",
              width: 120,
              type: "rightAligned",
              valueGetter: (p) => calcSupply(p.data),
              valueFormatter: moneyFmt,
            },
            {
              headerName: "ë¶€ê°€ê°€ì¹˜ì„¸",
              field: "vatAmt",
              width: 120,
              type: "rightAligned",
              valueGetter: (p) => calcVat(p.data),
              valueFormatter: moneyFmt,
            },
            {
              headerName: "í• ì¸ê¸ˆì•¡",
              field: "dcPrice",
              editable: true,
              width: 120,
              type: "rightAligned",
              valueParser: numberParser,
              valueFormatter: moneyFmt,
            },
            { headerName: "ë¹„ê³ ", field: "notes", editable: true, width: 160 },
          ];

          const gridOptions = {
            columnDefs,
            rowData: [
              {
                productCode: "A01",
                dPrdName: "ë§›ìˆëŠ”ì¿ í‚¤",
                unitPrice: 1000,
                orderQty: 100,
                dcPrice: 5000,
              },
            ],
            defaultColDef: { sortable: true, resizable: true, filter: true },
            rowSelection: "multiRow",
            onGridReady: (p) => {
              gridApi = p.api;
              updatePinned();
            },
            onCellValueChanged: updatePinned,
            onModelUpdated: updatePinned,
          };

          const gridDiv = byId("itemGrid");
          let gridApi;
          if (window.agGrid?.createGrid) {
            gridApi = agGrid.createGrid(gridDiv, gridOptions);
          } else {
            new agGrid.Grid(gridDiv, gridOptions);
            gridApi = gridOptions.api;
          }

          function calcSupply(r) {
            const price = toNum(r.unitPrice),
              qty = toNum(r.orderQty),
              dc = toNum(r.dcPrice);
            const gross = price * qty;
            return Math.max(gross - dc, 0);
          }
          function calcVat(r) {
            const applyVat = getVal("bizType") === "ë¶€ê°€ì„¸ìœ¨ ì ìš©";
            return applyVat ? Math.round(calcSupply(r) * VAT_RATE) : 0;
          }
          function numberParser(p) {
            const n = Number(String(p.newValue || "").replace(/[, ]/g, ""));
            return isNaN(n) ? null : n;
          }
          function moneyFmt(p) {
            const n = toNum(p.value);
            return n ? n.toLocaleString("ko-KR") : n === 0 ? "0" : "";
          }
          const toNum = (v) => Number(String(v ?? 0).replace(/[, ]/g, "")) || 0;

          function updatePinned() {
            let sumSupply = 0,
              sumVat = 0,
              sumDc = 0,
              cnt = 0;
            gridApi.forEachNodeAfterFilterAndSort((n) => {
              const r = n.data || {};
              sumSupply += calcSupply(r);
              sumVat += calcVat(r);
              sumDc += toNum(r.dcPrice);
              cnt++;
            });
            const pinned = [
              {
                dPrdName: `í•©ê³„ (í–‰ ${cnt}ê±´)`,
                supAmt: sumSupply,
                vatAmt: sumVat,
                dcPrice: sumDc,
              },
            ];
            gridApi.setPinnedBottomRowData
              ? gridApi.setPinnedBottomRowData(pinned)
              : gridApi.setGridOption("pinnedBottomRowData", pinned);
          }

          // í–‰ ì¶”ê°€/ì‚­ì œ
          byId("btnAddRow").addEventListener("click", () => {
            const blank = {
              productCode: "",
              dPrdName: "",
              unitPrice: null,
              orderQty: null,
              dcPrice: null,
              notes: "",
            };
            gridApi.applyTransaction
              ? gridApi.applyTransaction({ add: [blank] })
              : gridApi.updateGridOptions({
                  rowData: [...gridOptions.rowData, blank],
                });
            updatePinned();
          });
          byId("btnRemoveRow").addEventListener("click", () => {
            const sel = gridApi.getSelectedRows?.() || [];
            if (!sel.length) return alert("ì‚­ì œí•  í–‰ì„ ì„ íƒí•˜ì„¸ìš”.");
            gridApi.applyTransaction &&
              gridApi.applyTransaction({ remove: sel });
            updatePinned();
          });

          // ===== ë“±ë¡ (í‰íƒ„í™”í•´ì„œ 1í–‰ë§Œ ì „ì†¡) =====
          const submit = async () => {
            try {
              const row =
                gridApi.getDisplayedRowCount() > 0
                  ? gridApi.getDisplayedRowAtIndex(0).data
                  : null;
              if (!row || !row.productCode)
                return alert("ì²« ë²ˆì§¸ í–‰ì˜ í’ˆëª© ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");

              const supAmt = calcSupply(row);
              const vatAmt = calcVat(row);
              const totalPrice = supAmt + vatAmt; // í—¤ë” ì´ì•¡(ì˜ˆì‹œ)

              const body = {
                // PURCHASE_ORDER
                cusNo: getVal("cusNo"),
                creater: getVal("creater"),
                poStart: getVal("poStart"),
                exDate: getVal("exDate"),
                poDate: getVal("poStart"), // ì£¼ë¬¸ì¼ì(PO_DATE)ëŠ” ì‘ì„±ì¼ìì™€ ë™ì¼í•˜ê²Œ ì²˜ë¦¬
                prdName: row.dPrdName, // ëŒ€í‘œ í’ˆëª©ëª…ìœ¼ë¡œ ì²«ë²ˆì§¸ í’ˆëª©ëª… ì‚¬ìš©
                totalPrice: totalPrice,
                poStatus: getVal("poStatus"),
                payMethod: getVal("payMethod"),
                notes: getVal("notes"),
                vatType: getVal("vatDocType"), // ë¶€ê°€ì„¸ìœ í˜•
                poType: getVal("bizType"), // ê±°ë˜ìœ í˜•

                // PO_DETAIL (1í–‰)
                productCode: row.productCode,
                orderQty: toNum(row.orderQty),
                unitPrice: toNum(row.unitPrice),
                dcPrice: toNum(row.dcPrice),
                supAmt: supAmt,
                vatAmt: vatAmt,
                dPrdName: row.dPrdName,
              };

              if (!body.cusNo)
                return alert("ê±°ë˜ì²˜ ë²ˆí˜¸(CUS_NO)ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
              await axios.post("/api/biz/poinsert", body);
              alert("ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
              resetAll();
            } catch (e) {
              console.error(e);
              alert("ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
          };

          byId("btnSubmit").addEventListener("click", submit);
          byId("btnQuickSave").addEventListener("click", submit);

          // ì´ˆê¸°í™”
          function resetAll() {
            setVal("poStart", today);
            setVal("exDate", today);
            setVal("settleDue", today);
            setVal("cusNo", "");
            setVal("cusName", "");
            setVal("creater", "");
            setVal("bizType", "ë¶€ê°€ì„¸ ì ìš©");
            setVal("vatDocType", "TAX_INVOICE");
            setVal("payMethod", "CASH");
            setVal("poStatus", "WRITTEN");
            setVal("notes", "");
            byId("billDates").classList.add("d-none");
            gridApi.setRowData([
              {
                productCode: "",
                dPrdName: "",
                unitPrice: null,
                orderQty: null,
                dcPrice: null,
              },
            ]);
            updatePinned();
          }
          byId("btnReset").addEventListener("click", resetAll);
          byId("btnQuickReset").addEventListener("click", resetAll);

          // ì´ë ¥ì¡°íšŒ ë²„íŠ¼(ì˜ˆì‹œ)
          byId("btnOpenHistory").addEventListener("click", async () => {
            try {
              await axios.get("/api/biz/polist");
              gridApi.setRowData(res.data);
              alert("ì£¼ë¬¸ì„œ ì´ë ¥ì¡°íšŒëŠ” ë³„ë„ ëª¨ë‹¬/í˜ì´ì§€ë¡œ ì—°ê²°í•˜ì„¸ìš”.");
            } catch {
              alert("ì´ë ¥ì¡°íšŒ API í˜¸ì¶œ ì˜ˆì‹œì…ë‹ˆë‹¤.");
            }
          });
          // DOM helpers
          function byId(id) {
            return document.getElementById(id);
          }
          function getVal(id) {
            return byId(id)?.value ?? "";
          }
          function setVal(id, v) {
            const el = byId(id);
            if (el) el.value = v ?? "";
          }
        });

        // ì£¼ë¬¸ì„œì¡°íšŒ ëª¨ë‹¬
        const poHistoryModalEl = document.getElementById("PoHistoryModal");
        let poHistoryGridApi; // ì£¼ë¬¸ ì´ë ¥ ê·¸ë¦¬ë“œ APIë¥¼ ì €ì¥í•  ë³€ìˆ˜

        // ì£¼ë¬¸ ì´ë ¥ ê·¸ë¦¬ë“œì˜ ì»¬ëŸ¼ ì •ì˜
        const poHistoryColumnDefs = [
          { headerName: "ì‘ì„±ì¼ì", field: "poStart", width: 120 },
          { headerName: "ê±°ë˜ì²˜ëª…", field: "cusName", flex: 1, minWidth: 150 },
          { headerName: "ë‹´ë‹¹ì", field: "creater", width: 100 },
          {
            headerName: "ëŒ€í‘œ í’ˆëª©ëª…",
            field: "prdName",
            flex: 1,
            minWidth: 180,
          },
          { headerName: "ë‚©ê¸°ì¼ì", field: "exDate", width: 120 },
          {
            headerName: "ì´ì•¡",
            field: "totalPrice",
            width: 150,
            type: "rightAligned",
            valueFormatter: (p) =>
              p.value ? p.value.toLocaleString("ko-KR") : "",
          },
          {
            cellRenderer: "agCheckboxCellRenderer",
            cellEditor: "agCheckboxCellEditor",
          },
        ];
        // ì£¼ë¬¸ ì´ë ¥ ê·¸ë¦¬ë“œ ì˜µì…˜
        const poHistoryGridOptions = {
          columnDefs: poHistoryColumnDefs,
          rowSelection: {
            mode: "multiRow",
          },
          rowData: [],
          defaultColDef: { sortable: true, resizable: true, filter: true },
          onGridReady: (params) => {
            poHistoryGridApi = params.api;
          },
        };

        // ì„œë²„ì—ì„œ ì£¼ë¬¸ ì´ë ¥ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
        async function fetchPoHistoryData() {
          if (!poHistoryGridApi) return; // ê·¸ë¦¬ë“œê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìœ¼ë©´ ì‹¤í–‰í•˜ì§€ ì•ŠìŒ
          try {
            const response = await axios.get("/api/biz/pohistory");
            poHistoryGridApi.setRowData(response.data);
            poHistoryGridApi.sizeColumnsToFit();
          } catch (error) {
            console.error("ì£¼ë¬¸ ì´ë ¥ ì¡°íšŒ ì‹¤íŒ¨:", error);
            alert("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
          }
        }

        // ëª¨ë‹¬ì´ í™”ë©´ì— ì™„ì „íˆ í‘œì‹œëœ í›„ì— ê·¸ë¦¬ë“œë¥¼ ìƒì„±í•˜ê³  ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜´
        if (poHistoryModalEl) {
          poHistoryModalEl.addEventListener("shown.bs.modal", () => {
            // ê·¸ë¦¬ë“œê°€ ì•„ì§ ìƒì„±ë˜ì§€ ì•Šì•˜ë‹¤ë©´ ìƒì„±
            if (!poHistoryGridApi) {
              const gridDiv = document.getElementById("poHistoryGrid");
              if (window.agGrid?.createGrid) {
                poHistoryGridApi = agGrid.createGrid(
                  gridDiv,
                  poHistoryGridOptions
                );
              } else {
                new agGrid.Grid(gridDiv, poHistoryGridOptions);
                poHistoryGridApi = poHistoryGridOptions.api;
              }
            }
            // ëª¨ë‹¬ì´ ì—´ë¦´ ë•Œë§ˆë‹¤ ìµœì‹  ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜´
            fetchPoHistoryData();
          });
        }
      </script>
    </th:block>
  </body>
</html>
