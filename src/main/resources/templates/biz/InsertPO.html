<!DOCTYPE html>
<html
  lang="ko"
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layout/base}"
>
  <head>
    <title layout:fragment="title">Ï£ºÎ¨∏ÏÑú ÏûÖÎ†•</title>

    <th:block layout:fragment="head_extra">
      <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/styles/ag-grid.css"
      />
      <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/styles/ag-theme-quartz.css"
      />

      <style>
        .form-label {
          font-weight: 600;
        }
        .btn-slim {
          padding: 0.375rem 0.75rem;
        }
        .btn-wide {
          min-width: 110px;
        }
        .muted {
          font-size: 12px;
          color: #6b7280;
        }
        #itemGrid.ag-theme-quartz {
          height: 380px;
          width: 100%;
        }
        .rounded-box {
          border: 1px solid #e5e7eb;
          border-radius: 0.75rem;
          padding: 1rem;
        }
        .ag-theme-quartz .ag-row-pinned {
          font-weight: 700;
          background: #fafafa;
        }
      </style>
    </th:block>
  </head>
  <body>
    <form
      th:action="@{/sales/order/new}"
      th:object="${form}"
      method="post"
    ></form>
    <section layout:fragment="content">
      <!-- ÏÉÅÎã® Ìà¥Î∞î (8) -->
      <div class="card shadow mb-3">
        <div class="card-body d-flex align-items-center gap-2 flex-wrap">
          <div class="btn-group">
            <button
              id="btnOpenProduct"
              type="button"
              class="btn btn-outline-secondary btn-slim"
              data-bs-toggle="modal"
              data-bs-target="#productcodeModal"
            >
              ÌíàÎ™©ÏΩîÎìú
            </button>
            <button
              id="btnOpenHistory"
              type="button"
              class="btn btn-outline-secondary btn-slim"
              data-bs-toggle="modal"
              data-bs-target="#PoHistoryModal"
            >
              Ï£ºÎ¨∏ÏÑúÏù¥Î†•Ï°∞Ìöå
            </button>
          </div>
          <div class="ml-auto"></div>
          <button
            id="btnReset"
            type="button"
            class="btn btn-danger btn-slim btn-wide"
          >
            Ï¥àÍ∏∞Ìôî
          </button>
          <button
            id="btnSubmit"
            type="button"
            class="btn btn-primary btn-slim btn-wide"
          >
            Îì±Î°ù
          </button>
        </div>
      </div>

      <!-- ÏûÖÎ†•ÏòÅÏó≠ (1~7,10) -->
      <div class="card shadow mb-4">
        <div class="card-body">
          <div class="rounded-box">
            <!-- 1 ÏûëÏÑ±ÏùºÏûê / 2 Í±∞ÎûòÏ≤ò -->
            <div class="form-row align-items-center">
              <div class="form-group col-md-3">
                <label class="form-label">ÏûëÏÑ±ÏùºÏûê</label>
                <input id="poStart" type="date" class="form-control" />
              </div>

              <div class="form-group col-md-5">
                <label class="form-label">Í±∞ÎûòÏ≤ò</label>
                <div class="input-group">
                  <input id="cusName" class="form-control" disabled />
                  <div class="input-group-append">
                    <button
                      id="btnFindCustomer"
                      type="button"
                      class="btn btn-outline-secondary"
                      data-bs-toggle="modal"
                      data-bs-target="#customermodal"
                    >
                      üîç
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- 3 Îã¥ÎãπÏûê / 4 Í±∞ÎûòÏú†Ìòï -->
            <div class="form-row align-items-center">
              <div class="form-group col-md-4">
                <label class="form-label">Îã¥ÎãπÏûê</label>
                <div class="input-group">
                  <input
                    id="creater"
                    class="form-control"
                    placeholder="ÏÑ∏ÏÖòÎ°úÍ∑∏Ïù∏ÏÇ¨Ïö©Ïûê"
                    disabled
                  />
                </div>
              </div>

              <div class="form-group col-md-4">
                <label class="form-label">Í±∞ÎûòÏú†Ìòï</label>
                <select id="bizType" class="form-control">
                  <option value="VAT_INCLUDED">Î∂ÄÍ∞ÄÏÑ∏Ïú® Ï†ÅÏö©</option>
                  <option value="VAT_EXEMPT">Î∂ÄÍ∞ÄÏÑ∏Ïú® ÎØ∏Ï†ÅÏö©</option>
                </select>
              </div>
            </div>

            <!-- 5 ÎÇ©Í∏∞ÏùºÏûê / 6 Î∂ÄÍ∞ÄÏÑ∏Ïú†Ìòï -->
            <div class="form-row align-items-center">
              <div class="form-group col-md-3">
                <label class="form-label">ÎÇ©Í∏∞ÏùºÏûê</label>
                <input id="exDate" type="date" class="form-control" />
              </div>

              <div class="form-group col-md-4">
                <label class="form-label">Î∂ÄÍ∞ÄÏÑ∏Ïú†Ìòï</label>
                <select id="vatDocType" class="form-control">
                  <option value="TAX_INVOICE">ÏÑ∏Í∏àÍ≥ÑÏÇ∞ÏÑú</option>
                  <option value="STATEMENT">Î™ÖÏÑ∏ÏÑú</option>
                </select>
              </div>
            </div>

            <!-- 7 ÏßÄÎ∂àÎ∞©Ïãù / 10 Í≤∞Ï†úÏòàÏ†ïÏùº -->
            <div class="form-row align-items-center">
              <div class="form-group col-md-5">
                <label class="form-label d-block">ÏßÄÎ∂àÎ∞©Ïãù</label>
                <div class="form-row">
                  <div class="col-auto">
                    <select id="payMethod" class="form-control">
                      <option value="CASH">ÌòÑÍ∏à</option>
                      <option value="BILL">Ïñ¥Ïùå</option>
                      <option value="CASH_BILL">ÌòÑÍ∏à&Ïñ¥Ïùå</option>
                    </select>
                  </div>
                  <div id="billDates" class="col d-none">
                    <div class="form-row">
                      <div class="col">
                        <input
                          id="billStart"
                          type="date"
                          class="form-control"
                          placeholder="Ïñ¥Ïùå ÏãúÏûëÏùº"
                        />
                      </div>
                      <div class="col">
                        <input
                          id="billEnd"
                          type="date"
                          class="form-control"
                          placeholder="Ïñ¥Ïùå ÎßåÍ∏∞Ïùº"
                        />
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="form-group col-md-4">
                <label class="form-label">Í≤∞Ï†úÏòàÏ†ïÏùº</label>
                <input id="settleDue" type="date" class="form-control" />
              </div>
            </div>

            <!-- ÏÉÅÌÉú/ÎπÑÍ≥†(ÏÑ§Í≥ÑÎèÑ Ïö∞Ï∏° ÏÑ§Î™ÖÏòÅÏó≠ÏùÄ Ï£ºÏÑù Ï≤òÎ¶¨Î°ú ÎåÄÏ≤¥) -->
            <div class="form-row">
              <div class="form-group col-md-9">
                <label class="form-label">ÎπÑÍ≥†</label>
                <input
                  id="notes"
                  class="form-control"
                  placeholder="ÌäπÏù¥ÏÇ¨Ìï≠ Î©îÎ™®"
                />
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ÌíàÎ™© Î™©Î°ù (9) -->
      <div class="card shadow">
        <div
          class="card-header d-flex align-items-center justify-content-between"
        >
          <h6 class="m-0 font-weight-bold text-primary">ÌíàÎ™© Î™©Î°ù</h6>
          <div class="btn-group">
            <button
              id="btnAddRow"
              type="button"
              class="btn btn-outline-secondary btn-slim"
            >
              Ìñâ Ï∂îÍ∞Ä
            </button>
            <button
              id="btnRemoveRow"
              type="button"
              class="btn btn-outline-danger btn-slim"
            >
              Ìñâ ÏÇ≠Ï†ú
            </button>
          </div>
        </div>
        <div class="card-body">
          <div id="itemGrid" class="ag-theme-quartz"></div>
        </div>
      </div>

      <!-- Í±∞ÎûòÏ≤ò Í≤ÄÏÉâ Î™®Îã¨ -->
      <div th:replace="~{biz/modals/PoCustomerModal :: customermodal}"></div>

      <!-- ÌíàÎ™©ÏΩîÎìú Î™®Îã¨ -->
      <div
        th:replace="~{biz/modals/productcodeModal :: productcodeModal}"
      ></div>

      <!-- Ï£ºÎ¨∏ÏÑúÏù¥Î†•Ï°∞Ìöå Î™®Îã¨ -->
      <div th:replace="~{biz/modals/PoHistoryModal :: PoHistoryModal}"></div>
    </section>

    <th:block layout:fragment="body_extra">
      <script
        defer
        src="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/dist/ag-grid-community.min.js"
      ></script>
      <script
        defer
        src="https://cdn.jsdelivr.net/npm/axios@1.7.7/dist/axios.min.js"
      ></script>

      <script th:inline="none">
        document.addEventListener("DOMContentLoaded", () => {
          // DOM helpers
          function byId(id) {
            return document.getElementById(id);
          }
          function getVal(id) {
            return byId(id)?.value ?? "";
          }
          function setVal(id, v) {
            const el = byId(id);
            if (el) el.value = v ?? "";
          }
          const toNum = (v) => Number(String(v ?? 0).replace(/[, ]/g, "")) || 0;

          // ===== Í∏∞Î≥∏Í∞í ÏÑ∏ÌåÖ =====
          const today = new Date().toISOString().slice(0, 10);
          setVal("poStart", today);
          setVal("exDate", today);
          setVal("settleDue", today);

          // ÏßÄÎ∂àÎ∞©Ïãù ÌÜ†Í∏Ä
          byId("payMethod").addEventListener("change", () => {
            const show = ["BILL", "CASH_BILL"].includes(getVal("payMethod"));
            byId("billDates").classList.toggle("d-none", !show);
          });

          // Í±∞ÎûòÏú†Ìòï Î≥ÄÍ≤Ω Ïãú Î∂ÄÍ∞ÄÏÑ∏ Ïû¨Í≥ÑÏÇ∞ Î∞è Í∑∏Î¶¨Îìú ÏóÖÎç∞Ïù¥Ìä∏
          byId("bizType").addEventListener("change", () => {
            if (gridApi) {
              gridApi.refreshCells({ force: true }); // Î™®Îì† ÏÖÄ Í∞ïÏ†ú ÏÉàÎ°úÍ≥†Ïπ®
              updatePinned(); // Ìï©Í≥Ñ Ìñâ ÏóÖÎç∞Ïù¥Ìä∏
            }
          });

          // ===== Main Grid (itemGrid) =====
          let gridApi;
          const VAT_RATE = 0.1; // 10%

          function calcSupply(r) {
            const price = toNum(r.unitPrice),
              qty = toNum(r.orderQty),
              dc = toNum(r.dcPrice);
            const gross = price * qty;
            return Math.max(gross - dc, 0);
          }
          function calcVat(r) {
            const applyVat = getVal("bizType") === "VAT_INCLUDED";
            return applyVat ? Math.round(calcSupply(r) * VAT_RATE) : 0;
          }
          function numberParser(p) {
            const n = Number(String(p.newValue || "").replace(/[, ]/g, ""));
            return isNaN(n) ? null : n;
          }
          function moneyFmt(p) {
            const n = toNum(p.value);
            if (n === 0) return "0";
            return n ? n.toLocaleString("ko-KR") : "";
          }
          function updatePinned() {
            if (!gridApi) return;
            let sumSupply = 0,
              sumVat = 0,
              sumDc = 0,
              cnt = 0;
            gridApi.forEachNodeAfterFilterAndSort((n) => {
              const r = n.data || {};
              sumSupply += calcSupply(r);
              sumVat += calcVat(r);
              sumDc += toNum(r.dcPrice);
              cnt++;
            });
            const pinned = [
              {
                dPrdName: `Ìï©Í≥Ñ (Ìñâ ${cnt}Í±¥)`,
                supAmt: sumSupply,
                vatAmt: sumVat,
                dcPrice: sumDc,
              },
            ];
            gridApi.setPinnedBottomRowData
              ? gridApi.setPinnedBottomRowData(pinned)
              : gridApi.setGridOption("pinnedBottomRowData", pinned);
          }

          const columnDefs = [
            { headerName: "", checkboxSelection: true, width: 50 },
            {
              headerName: "ÌíàÎ™©ÏΩîÎìú",
              field: "productCode",
              editable: true,
              width: 120,
            },
            {
              headerName: "ÌíàÎ™©Î™Ö",
              field: "dPrdName",
              editable: true,
              flex: 1,
              minWidth: 160,
            },
            {
              headerName: "Îã®Í∞Ä",
              field: "unitPrice",
              editable: true,
              width: 110,
              type: "rightAligned",
              valueParser: numberParser,
              valueFormatter: moneyFmt,
            },
            {
              headerName: "ÏàòÎüâ",
              field: "orderQty",
              editable: true,
              width: 100,
              type: "rightAligned",
              valueParser: numberParser,
            },
            {
              headerName: "Í≥µÍ∏âÍ∞ÄÏï°",
              field: "supAmt",
              width: 120,
              type: "rightAligned",
              valueGetter: (p) => calcSupply(p.data),
              valueFormatter: moneyFmt,
            },
            {
              headerName: "Î∂ÄÍ∞ÄÍ∞ÄÏπòÏÑ∏",
              field: "vatAmt",
              width: 120,
              type: "rightAligned",
              valueGetter: (p) => calcVat(p.data),
              valueFormatter: moneyFmt,
            },
            {
              headerName: "Ìï†Ïù∏Í∏àÏï°",
              field: "dcPrice",
              editable: true,
              width: 120,
              type: "rightAligned",
              valueParser: numberParser,
              valueFormatter: moneyFmt,
            },
            {
              headerName: "Ï¥ùÏï°",
              field: "totalPrice",
              editable: false,
              width: 160,
              valueGetter: (p) => calcSupply(p.data) + calcVat(p.data),
              valueFormatter: moneyFmt,
            },
            { headerName: "ÎπÑÍ≥†", field: "notes", editable: true, width: 160 },
          ];

          const gridOptions = {
            columnDefs,
            rowSelection: "multiple",
            rowMultiSelectWithClick: true,
            rowData: [
              {
                productCode: "A01",
                dPrdName: "ÎßõÏûàÎäîÏø†ÌÇ§",
                unitPrice: 1000,
                orderQty: 100,
                dcPrice: 5000,
              },
            ],
            defaultColDef: { sortable: true, resizable: true, filter: true },
            onGridReady: (p) => {
              gridApi = p.api;
              updatePinned();
            },
            onCellValueChanged: updatePinned,
            onModelUpdated: updatePinned,
          };

          const gridDiv = byId("itemGrid");
          if (window.agGrid?.createGrid) {
            gridApi = agGrid.createGrid(gridDiv, gridOptions);
          } else {
            gridApi = gridOptions.api;
          }

          // Ìñâ Ï∂îÍ∞Ä/ÏÇ≠Ï†ú
          byId("btnAddRow").addEventListener("click", () => {
            const blank = {
              productCode: "",
              dPrdName: "",
              unitPrice: null,
              orderQty: null,
              dcPrice: null,
              notes: "",
            };
            gridApi.applyTransaction({ add: [blank] });
            updatePinned();
          });
          byId("btnRemoveRow").addEventListener("click", () => {
            const sel = gridApi.getSelectedRows?.() || [];
            if (!sel.length) return alert("ÏÇ≠Ï†úÌï† ÌñâÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.");
            gridApi.applyTransaction({ remove: sel });
            updatePinned();
          });

          // ===== Îì±Î°ù =====
          const submit = async () => {
            try {
              // 1) ÏÉÅÏÑ∏Ìñâ ÏàòÏßë
              const details = [];
              gridApi.forEachNodeAfterFilterAndSort((n) => {
                const r = n.data || {};
                if (!r.productCode) return; // Í≥µÌñâ skip
                const supAmt = calcSupply(r);
                const vatAmt = calcVat(r);
                details.push({
                  productCode: r.productCode,
                  orderQty: toNum(r.orderQty),
                  unitPrice: toNum(r.unitPrice),
                  dcPrice: toNum(r.dcPrice),
                  supAmt,
                  vatAmt,
                  dPrdName: r.dPrdName,
                });
              });
              if (!details.length)
                return alert("ÏÉÅÏÑ∏ ÌíàÎ™©ÏùÑ 1Í±¥ Ïù¥ÏÉÅ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.");

              // 2) Î≥∏Î¨∏ Í≥ÑÏÇ∞ & Í∞í ÏùΩÍ∏∞
              const totalSupply = details.reduce(
                (s, d) => s + (d.supAmt || 0),
                0
              );
              const totalVat = details.reduce((s, d) => s + (d.vatAmt || 0), 0);

              const cusName = getVal("cusName"); // Í±∞ÎûòÏ≤ò ÏÑ†ÌÉùÏãú ÌëúÏãúÏö© Ïù¥Î¶Ñ
              if (!cusName) return alert("Í±∞ÎûòÏ≤òÎ•º ÏÑ†ÌÉùÌï¥ Ï£ºÏÑ∏Ïöî.");
              const cusCode = getVal("cusCode"); // Í±∞ÎûòÏ≤ò Î™®Îã¨ ÏÑ†ÌÉùÏãú Î≥¥Ïó¨Ï§å

              // ÎÇ†Ïßú: poDate ÏûÖÎ†•Ïù¥ ÏóÜÏúºÎØÄÎ°ú poStartÎ•º Í∑∏ÎåÄÎ°ú ÏÇ¨Ïö©(ÎòêÎäî omit)
              const poStart = getVal("poStart") || undefined;
              const exDate = getVal("exDate") || undefined;
              const poDate = poStart; // Ï†ïÏ±ÖÏÉÅ ÎèôÏùº ÏÇ¨Ïö©

              const payload = {
                cusName,
                cusCode,
                creater: getVal("creater") || "ÏÑ∏ÏÖòÏú†Ï†ÄÏù¥Î¶Ñ",
                poStart,
                exDate,
                poDate,
                prdName: details[0].dPrdName,
                totalPrice: totalSupply + totalVat,
                payMethod: getVal("payMethod"),
                notes: getVal("notes") || undefined,

                // mapping: select#vatDocType ‚Üí VO.vatType
                vatType: getVal("vatDocType"), // TAX_INVOICE | STATEMENT
                poType: getVal("bizType"), // VAT_INCLUDED | VAT_EXEMPT

                poDetails: details,
              };

              await axios.post("/api/biz/poinsert", payload, {
                headers: { "Content-Type": "application/json" },
              });

              alert("Îì±Î°ùÎêòÏóàÏäµÎãàÎã§.");
              resetAll();
            } catch (e) {
              console.error(e);
              const msg =
                e?.response?.data?.message ||
                e.message ||
                "Îì±Î°ù Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.";
              alert(msg);
            }
          };
          byId("btnSubmit").addEventListener("click", submit);

          // ===== Ï¥àÍ∏∞Ìôî =====
          // ÏûÑÏãúÎ°ú Í±∞ÎûòÏú†Ìòï, Î∂ÄÍ∞ÄÏÑ∏Ïú†ÌòïÏùÑ ÌïòÎìúÏΩîÎî©
          function resetAll() {
            setVal("poStart", today);
            setVal("exDate", today);
            setVal("settleDue", today);
            setVal("cusName", "");
            setVal("creater", "");
            setVal("bizType", "VAT_INCLUDED");
            setVal("vatDocType", "TAX_INVOICE");
            setVal("payMethod", "CASH");
            setVal("poStatus", "WRITTEN");
            setVal("notes", "");
            byId("billDates").classList.add("d-none");
            gridApi.setRowData([
              {
                productCode: "",
                dPrdName: "",
                unitPrice: null,
                orderQty: null,
                dcPrice: null,
              },
            ]);
            updatePinned();
          }
          byId("btnReset").addEventListener("click", resetAll);

          /*

                ======================== Ï£ºÎ¨∏ÏÑúÏ°∞Ìöå Î™®Îã¨ ========================


                */
          const poHistoryModalEl = document.getElementById("PoHistoryModal");
          let poHistoryGridApi;
          const poHistoryColumnDefs = [
            { headerName: "", checkboxSelection: true, width: 50 },
            { headerName: "ÏûëÏÑ±ÏùºÏûê", field: "poStart", width: 120 },
            {
              headerName: "Í±∞ÎûòÏ≤òÎ™Ö",
              field: "cusName",
              flex: 1,
              minWidth: 150,
            },
            { headerName: "Îã¥ÎãπÏûê", field: "creater", width: 100 },
            {
              headerName: "ÎåÄÌëú ÌíàÎ™©Î™Ö",
              field: "prdName",
              flex: 1,
              minWidth: 180,
            },
            { headerName: "ÎÇ©Í∏∞ÏùºÏûê", field: "exDate", width: 120 },
            {
              headerName: "Ï¥ùÏï°",
              field: "totalPrice",
              width: 150,
              type: "rightAligned",
              valueFormatter: (p) =>
                p.value ? p.value.toLocaleString("ko-KR") : "",
            },
          ];
          const poHistoryGridOptions = {
            columnDefs: poHistoryColumnDefs,
            rowSelection: "multiple",
            rowMultiSelectWithClick: true,
            rowData: [],
            defaultColDef: { sortable: true, resizable: true, filter: true },
            onGridReady: (params) => {
              poHistoryGridApi = params.api;
            },
          };
          async function fetchPoHistoryData() {
            if (!poHistoryGridApi) return;
            try {
              const response = await axios.get("/api/biz/pohistory");
              poHistoryGridApi.setRowData(response.data);
              poHistoryGridApi.sizeColumnsToFit();
            } catch (error) {
              console.error("Ï£ºÎ¨∏ Ïù¥Î†• Ï°∞Ìöå Ïã§Ìå®:", error);
              alert("Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Îç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.");
            }
          }
          if (poHistoryModalEl) {
            poHistoryModalEl.addEventListener("shown.bs.modal", () => {
              if (!poHistoryGridApi) {
                const gridDiv = document.getElementById("poHistoryGrid");
                if (window.agGrid?.createGrid) {
                  poHistoryGridApi = agGrid.createGrid(
                    gridDiv,
                    poHistoryGridOptions
                  );
                } else {
                  poHistoryGridApi = poHistoryGridOptions.api;
                }
              }
              fetchPoHistoryData();
            });

            const importBtn = document.getElementById("PohImportBtn");
            if (importBtn) {
              importBtn.addEventListener("click", () => {
                const selectedRows = poHistoryGridApi.getSelectedRows();
                if (!selectedRows || selectedRows.length === 0) {
                  return alert("Í∞ÄÏ†∏Ïò¨ Ï£ºÎ¨∏ÏÑúÏùò ÌñâÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.");
                }

                const newItems = selectedRows.map((row) => ({
                  productCode: "",
                  dPrdName: row.prdName,
                  unitPrice: null,
                  orderQty: null,
                  dcPrice: null,
                  notes: `${row.poStart} Ï£ºÎ¨∏ Í±¥ÏóêÏÑú Í∞ÄÏ†∏Ïò¥`,
                }));

                gridApi.applyTransaction({ add: newItems });
                updatePinned();

                const modal = bootstrap.Modal.getInstance(poHistoryModalEl);
                modal?.hide();
              });
            } else {
              console.warn(
                "Í∞ÄÏ†∏Ïò§Í∏∞ Î≤ÑÌäº(#PohImportBtn)ÏùÑ modal HTMLÏóê Ï∂îÍ∞ÄÌï¥Ï£ºÏÑ∏Ïöî."
              );
            }
          }
          /*

                ======================== ÌíàÎ™©ÏΩîÎìú Î™®Îã¨ ========================


          */
          const productModalEl = document.getElementById("productcodeModal");
          let productGridApi;
          const productColumnDefs = [
            { headerName: "", checkboxSelection: true, width: 50 },
            { headerName: "ÌíàÎ™©ÏΩîÎìú", field: "productCode", width: 140 },
            {
              headerName: "ÌíàÎ™©Î™Ö",
              field: "productName",
              flex: 1,
              minWidth: 160,
            },
          ];
          if (productModalEl) {
            productModalEl.addEventListener("shown.bs.modal", () => {
              const gridDiv = document.getElementById("productGrid");
              if (!productGridApi) {
                if (window.agGrid?.createGrid) {
                  productGridApi = agGrid.createGrid(
                    gridDiv,
                    productGridOptions
                  );
                } else {
                  productGridApi = productGridOptions.api;
                }
              }
              fetchProductData();
            });
          }
          const productGridOptions = {
            columnDefs: productColumnDefs,
            rowSelection: "multiple",
            rowMultiSelectWithClick: true,
            rowData: [],
            defaultColDef: { sortable: true, resizable: true, filter: true },
            onGridReady: (p) => {
              productGridApi = p.api;
            },
          };

          async function fetchProductData() {
            if (!productGridApi) return;
            try {
              const { data } = await axios.get("/api/biz/productcode");
              productGridApi.setRowData(data || []);
            } catch (err) {
              console.error("ÌíàÎ™© Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå Ïã§Ìå®:", err);
              alert("ÌíàÎ™© Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Îç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.");
            }
          }

          // ÌíàÎ™©ÏΩîÎìú Î™®Îã¨Ïùò Í∞ÄÏ†∏Ïò§Í∏∞ Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
          const importProductBtn = document.getElementById("PrcImportBtn");
          if (importProductBtn) {
            importProductBtn.addEventListener("click", () => {
              const selectedRows = productGridApi.getSelectedRows();
              if (!selectedRows || selectedRows.length === 0) {
                return alert("Í∞ÄÏ†∏Ïò¨ ÌíàÎ™©ÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.");
              }

              const newItems = selectedRows.map((row) => ({
                productCode: row.productCode,
                dPrdName: row.productName,
                unitPrice: row.unitPrice || null,
                orderQty: null,
                dcPrice: null,
                notes: "",
              }));

              gridApi.applyTransaction({ add: newItems });
              updatePinned();

              const modal = bootstrap.Modal.getInstance(productModalEl);
              modal?.hide();
            });
          } else {
            console.warn(
              "Í∞ÄÏ†∏Ïò§Í∏∞ Î≤ÑÌäº(#PrcImportBtn)ÏùÑ modal HTMLÏóê Ï∂îÍ∞ÄÌï¥Ï£ºÏÑ∏Ïöî."
            );
          }
        });

        /*

                ======================== Í±∞ÎûòÏ≤ò Î™®Îã¨ ========================


        */
        document.addEventListener("DOMContentLoaded", () => {
          const customerCodeModalEl = document.getElementById("customermodal");
          let customerCodeGridApi;
          const customerCodeColumnDefs = [
            { headerName: "", checkboxSelection: true, width: 50 },
            { headerName: "Í±∞ÎûòÏ≤òÏΩîÎìú", field: "cusCode", width: 140 },
            {
              headerName: "Í±∞ÎûòÏ≤òÎ™Ö",
              field: "cusName",
              flex: 1,
              minWidth: 160,
            },
            { headerName: "Ïã†Ïö©Îì±Í∏â", field: "creditGrade", width: 140 },
            { headerName: "ÎØ∏ÏàòÍ∏à", field: "leftPrice", width: 140 },
          ];
          async function fetchCustomerCodeData() {
            if (!customerCodeGridApi) return;
            try {
              const { data } = await axios.get("/api/biz/customercode");
              customerCodeGridApi.setRowData(data || []);
              customerCodeGridApi.sizeColumnsToFit?.();
            } catch (err) {
              console.error("Í±∞ÎûòÏ≤òÏ°∞Ìöå Ïã§Ìå®:", err);
              alert("Í±∞ÎûòÏ≤ò Î∂àÎü¨Ïò§Îäî Îç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.");
            }
          }
          if (customerCodeModalEl) {
            customerCodeModalEl.addEventListener("shown.bs.modal", () => {
              const gridDiv = document.getElementById("customerGrid");
              if (!customerCodeGridApi) {
                if (window.agGrid?.createGrid) {
                  customerCodeGridApi = agGrid.createGrid(
                    gridDiv,
                    customerCodeGridOptions
                  );
                } else {
                  customerCodeGridApi = customerCodeGridOptions.api;
                }
              }
              fetchCustomerCodeData();
            });
          }
          const customerCodeGridOptions = {
            columnDefs: customerCodeColumnDefs,
            rowSelection: "single",
            rowData: [],
            defaultColDef: { sortable: true, resizable: true, filter: true },
            onGridReady: (p) => {
              customerCodeGridApi = p.api;
            },
          };
          // Í±∞ÎûòÏ≤ò Î™®Îã¨Ïùò ÏÑ†ÌÉù Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
          function assignCustomerToForm(row) {
            const cusNameEl = document.getElementById("cusName");
            const cusCodeEl = document.getElementById("cusCode");
            if (cusNameEl) cusNameEl.value = row.cusName ?? "";
            if (cusCodeEl) cusCodeEl.value = row.cusCode ?? "";
          }

          const importCustomerCodeBtn = document.getElementById("CstImportBtn");
          if (importCustomerCodeBtn) {
            importCustomerCodeBtn.addEventListener("click", () => {
              if (!customerCodeGridApi) return alert("Î™©Î°ùÏùÑ Î®ºÏ†Ä Î∂àÎü¨Ïò§ÏÑ∏Ïöî.");
              const selected = customerCodeGridApi.getSelectedRows?.() || [];
              if (!selected.length) return alert("Í±∞ÎûòÏ≤òÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.");

              assignCustomerToForm(selected[0]);

              const modal = bootstrap.Modal.getInstance(customerCodeModalEl);
              modal?.hide();
            });
          } else {
            console.warn(
              "Í∞ÄÏ†∏Ïò§Í∏∞ Î≤ÑÌäº(#CstImportBtn)ÏùÑ modal HTMLÏóê Ï∂îÍ∞ÄÌï¥Ï£ºÏÑ∏Ïöî."
            );
          }
        });

        /*
======= ======= ======= 
======= ÏûÑÏãúÏ°∞Ïπò ======= 
======= ======= ======= 
        */

        // bodyÏóê Í∞ïÏ†ú ÌëúÏãú(z-index Î¨∏Ï†ú ÌöåÌîº)
        ["productcodeModal", "customermodal", "PoHistoryModal"].forEach(
          (id) => {
            const el = document.getElementById(id);
            if (el && el.parentElement !== document.body) {
              document.body.appendChild(el);
            }
          }
        );
      </script>
    </th:block>
  </body>
</html>
