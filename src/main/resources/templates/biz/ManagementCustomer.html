<!DOCTYPE html>
<html
  lang="ko"
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layout/base}"
>
  <head>
    <meta charset="UTF-8" />
    <title layout:fragment="title">거래처 조회</title>

    <th:block layout:fragment="head_extra">
      <!-- AG Grid CSS -->
      <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/styles/ag-grid.css"
      />
      <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/styles/ag-theme-quartz.css"
      />

      <style>
        /* 그리드 영역 */
        #customerGrid.ag-theme-quartz {
          height: 560px;
          width: 100%;
        }

        /* 디자인 보정 (주문서 조회 샘플 톤과 동일) */
        .btn-filter-group .btn {
          min-width: 108px;
        }
        .form-inline .form-control,
        .form-inline .form-select {
          min-width: 180px;
        }
        .muted {
          color: #6b7280;
          font-size: 12px;
        }
        .text-right {
          text-align: right;
        }
      </style>
    </th:block>
  </head>

  <body>
    <section layout:fragment="content">
      <!-- 검색/필터 카드 -->
      <div class="card shadow mb-4">
        <div
          class="card-header py-3 d-flex align-items-center justify-content-between"
        >
          <h6 class="m-0 font-weight-bold text-primary">거래처 조회</h6>
        </div>

        <div class="card-body">
          <!-- 1. 사용여부 버튼 (전체 / Y / N) -->
          <div
            class="btn-filter-group btn-group mb-3"
            role="group"
            aria-label="useYn-filters"
          >
            <button class="btn btn-outline-primary" data-use="">전체</button>
            <button class="btn btn-outline-primary" data-use="Y">사용</button>
            <button class="btn btn-outline-primary" data-use="N">미사용</button>
          </div>

          <!-- 2~5. 검색 조건 (상호/대표자/사업자번호/종목) -->
          <div class="form-inline flex-wrap gap-2">
            <label class="mr-2 mb-2">상호</label>
            <input
              id="qName"
              type="text"
              class="form-control mr-3 mb-2"
              placeholder="거래처명(상호)"
            />

            <label class="mr-2 mb-2">대표자명</label>
            <input
              id="qRep"
              type="text"
              class="form-control mr-3 mb-2"
              placeholder="대표자명"
            />

            <label class="mr-2 mb-2">사업자번호</label>
            <input
              id="qBizNo"
              type="text"
              class="form-control mr-3 mb-2"
              placeholder="000-00-00000"
            />

            <label class="mr-2 mb-2">종목</label>
            <input
              id="qType"
              type="text"
              class="form-control mr-3 mb-2"
              placeholder="업종/종목"
            />

            <button id="btnSearch" class="btn btn-dark mb-2">조회</button>
          </div>
          <div class="muted mt-1">※ 빈값으로 조회하면 전체 검색합니다.</div>
        </div>
      </div>

      <!-- *************** 거래처 리스트(ag-Grid) *************** -->
      <div class="card shadow mb-0">
        <div class="card-header py-3">
          <h6 class="m-0 font-weight-bold text-primary">거래처 리스트</h6>
        </div>
        <div class="card-body">
          <div id="customerGrid" class="ag-theme-quartz"></div>
        </div>
      </div>
    </section>

    <th:block layout:fragment="body_extra">
      <!-- libs -->
      <script
        defer
        src="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/dist/ag-grid-community.min.js"
      ></script>
      <script
        defer
        src="https://cdn.jsdelivr.net/npm/axios@1.7.7/dist/axios.min.js"
      ></script>

      <script th:inline="none">
        document.addEventListener("DOMContentLoaded", () => {
          // ===== ag-Grid 컬럼 (화면설계 기준) =====
          const columnDefs = [
            {
              headerName: "거래처코드",
              field: "cusCode",
              width: 130,
              pinned: "left",
            },
            {
              headerName: "거래처명",
              field: "cusName",
              minWidth: 160,
              flex: 1,
            },
            { headerName: "대표자명", field: "repName", width: 110 },
            { headerName: "전화번호", field: "tel", width: 140 },
            { headerName: "주소", field: "addr", minWidth: 220, flex: 1 },
            {
              headerName: "사용여부",
              field: "useYn",
              width: 100,
              cellClass: "text-center",
              valueFormatter: (p) =>
                p.value === "Y" ? "Y" : p.value === "N" ? "N" : "",
            },
            { headerName: "비고", field: "remark", minWidth: 140, flex: 1 },
          ];

          // ===== Grid 옵션 =====
          const gridDiv = document.getElementById("customerGrid");
          let gridApi;

          const gridOptions = {
            columnDefs,
            rowData: [],
            rowSelection: "single",
            pagination: true,
            paginationPageSize: 12,
            animateRows: true,
            defaultColDef: { sortable: true, resizable: true, filter: true },
            onGridReady: (p) => {
              gridApi = p.api;
              search(); // 최초 로드: 전체
            },
          };

          if (window.agGrid?.createGrid) {
            gridApi = agGrid.createGrid(gridDiv, gridOptions);
          } else {
            new agGrid.Grid(gridDiv, gridOptions);
            gridApi = gridOptions.api;
          }

          // helper (v31의 setGridOption 대응)
          const setRows = (rows) =>
            gridApi?.setGridOption
              ? gridApi.setGridOption("rowData", rows)
              : gridApi.setRowData(rows);

          // ===== DOM =====
          const qName = document.getElementById("qName");
          const qRep = document.getElementById("qRep");
          const qBizNo = document.getElementById("qBizNo");
          const qType = document.getElementById("qType");
          const btnSearch = document.getElementById("btnSearch");

          let useYn = ""; // 버튼 그룹 상태

          // 1) 사용여부 필터 버튼
          document
            .querySelectorAll(".btn-filter-group [data-use]")
            .forEach((btn) => {
              btn.addEventListener("click", () => {
                useYn = btn.getAttribute("data-use") || "";
                search(); // 버튼만 눌러도 즉시 조회
              });
            });

          // 2) 조회 버튼 / Enter로 조회
          btnSearch.addEventListener("click", () => search());
          [qName, qRep, qBizNo, qType].forEach((el) => {
            el.addEventListener("keydown", (e) => {
              if (e.key === "Enter") search();
            });
          });

          // ===== API 호출 =====
          async function search() {
            try {
              const params = {
                useYn,
                name: qName.value?.trim() || "",
                rep: qRep.value?.trim() || "",
                bizNo: qBizNo.value?.trim() || "",
                type: qType.value?.trim() || "",
              };

              // 팀원 코드 스타일에 맞춰 GET + params 사용
              // 필요 시 '/api/v1/cus/list' 로 바꿔도 됨
              const res = await axios.get("/api/sales/customers", {
                params,
                withCredentials: true,
              });

              const rows = Array.isArray(res.data) ? res.data : [];

              // 서버 응답 키 → 화면 키 매핑(유연 매핑)
              const mapped = rows.map((r) => ({
                cusCode: r.cusCode ?? r.code ?? "",
                cusName: r.cusName ?? r.name ?? "",
                repName: r.repName ?? r.ceoName ?? r.ceo ?? "",
                tel: r.tel ?? r.phone ?? "",
                addr:
                  r.addr ?? [r.addr1, r.addr2].filter(Boolean).join(" ") ?? "",
                useYn: r.useYn ?? r.enabled ?? "",
                remark: r.remark ?? r.note ?? "",
              }));

              setRows(mapped);
            } catch (err) {
              console.error(err);
              setRows([]);
            }
          }
        });
      </script>
    </th:block>
  </body>
</html>
