<!DOCTYPE html>
<html
  lang="ko"
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layout/base}"
>
  <head>
    <meta charset="UTF-8" />
    <title layout:fragment="title">ì¶œí•˜ì§€ì‹œì„œ ì…ë ¥</title>

    <th:block layout:fragment="head_extra">
      <!-- Bootstrap -->
      <link
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
        rel="stylesheet"
        crossorigin="anonymous"
      />
      <link
        href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
        rel="stylesheet"
      />

      <!-- AG Grid -->
      <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/styles/ag-grid.css"
      />
      <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/styles/ag-theme-quartz.css"
      />

      <style>
        .form-label {
          font-weight: 600;
        }
        .btn-slim {
          padding: 0.375rem 0.75rem;
        }
        .btn-wide {
          min-width: 110px;
        }
        .muted {
          font-size: 12px;
          color: #6b7280;
        }
        .filter-card {
          border: 1px solid #e5e7eb;
        }
        .toolbar .btn {
          min-width: 96px;
        }
        #itemGrid.ag-theme-quartz {
          height: 360px;
          width: 100%;
        }
        /* ëª¨ë‹¬ ë‚´ë¶€ ê·¸ë¦¬ë“œ ë†’ì´ ë°˜ë“œì‹œ ì§€ì • */
        #poHistoryGrid.ag-theme-quartz,
        #productGrid.ag-theme-quartz,
        #customerGrid.ag-theme-quartz {
          height: 360px;
          width: 100%;
        }
        .summary-bar {
          font-weight: 600;
        }
      </style>
    </th:block>
  </head>

  <body>
    <section layout:fragment="content">
      <div class="card shadow">
        <!-- í—¤ë” -->
        <div
          class="card-header d-flex align-items-center justify-content-between"
        >
          <h5 class="mb-0">ì¶œí•˜ì§€ì‹œì„œ ì…ë ¥</h5>
          <div class="d-flex gap-2">
            <button
              type="button"
              class="btn btn-outline-secondary btn-slim"
              id="btnReset"
            >
              <i class="bi bi-arrow-counterclockwise me-1"></i>ì´ˆê¸°í™”
            </button>
            <button type="button" class="btn btn-primary btn-slim" id="btnSave">
              <i class="bi bi-check2 me-1"></i>ë“±ë¡
            </button>
          </div>
        </div>

        <div class="card-body">
          <!-- ìƒë‹¨ ì…ë ¥ í¼ -->
          <div class="card filter-card p-3 mb-3">
            <div class="row g-3">
              <div class="col-md-3">
                <label class="form-label">ì‘ì„±ì¼ì</label>
                <input type="date" class="form-control" id="writeDate" />
              </div>

              <div class="col-md-3">
                <label class="form-label">ê±°ë˜ì²˜</label>
                <div class="input-group">
                  <input
                    type="text"
                    class="form-control"
                    id="cusName"
                    placeholder="ê±°ë˜ì²˜ëª…"
                  />
                  <input type="text" class="form-control" id="cusCode" />
                  <button
                    type="button"
                    class="btn btn-outline-secondary"
                    id="btnFindCustomer"
                    data-bs-toggle="modal"
                    data-bs-target="#customermodal"
                  >
                    <i class="bi bi-search"></i>
                  </button>
                </div>
              </div>

              <div class="col-md-3">
                <label class="form-label">ë‹´ë‹¹ì</label>
                <div class="input-group">
                  <span
                    class="form-control"
                    id="managerName"
                    th:text="${#authentication.principal.empLoginVO.name}"
                  ></span>
                </div>
              </div>

              <div class="col-md-3">
                <label class="form-label">ì—°ë½ì²˜</label>
                <input
                  type="text"
                  class="form-control"
                  id="tel"
                  placeholder="ì—°ë½ì²˜"
                />
              </div>
            </div>

            <div class="row g-3 mt-1">
              <div class="col-md-3">
                <label class="form-label">ì¶œí•˜ì˜ˆì •ì¼</label>
                <input type="date" class="form-control" id="shipDate" />
              </div>

              <div class="col-md-3">
                <label class="form-label">ë„ë¡œëª…ì£¼ì†Œ</label>
                <div class="input-group">
                  <input
                    type="text"
                    class="form-control"
                    id="sample4_roadAddress"
                    placeholder="ì£¼ì†Œ"
                  />
                  <button
                    type="button"
                    onclick="sample4_execDaumPostcode()"
                    class="btn btn-outline-secondary"
                    id="btnf"
                  >
                    <i class="bi bi-search"></i>
                  </button>
                </div>
              </div>

              <div class="col-md-3">
                <label class="form-label">ìš°í¸ë²ˆí˜¸</label>
                <div class="input-group">
                  <input
                    type="text"
                    class="form-control"
                    id="sample4_postcode"
                    placeholder="ìš°í¸ë²ˆí˜¸"
                  />
                </div>
              </div>

              <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
              <script>
                function sample4_execDaumPostcode() {
                  new daum.Postcode({
                    oncomplete: function (data) {
                      document.getElementById("sample4_postcode").value =
                        data.zonecode;
                      document.getElementById("sample4_roadAddress").value =
                        data.roadAddress;
                    },
                  }).open();
                }
              </script>
            </div>

            <!-- ì¡°íšŒ ë²„íŠ¼ ê·¸ë£¹ -->
            <div class="toolbar d-flex gap-2 mt-3">
              <button
                type="button"
                class="btn btn-outline-secondary btn-slim"
                id="btnFindProduct"
                data-bs-toggle="modal"
                data-bs-target="#productcodeModal"
              >
                í’ˆëª©ì½”ë“œ
              </button>
              <button
                type="button"
                class="btn btn-outline-secondary btn-slim"
                id="btnFindOrder"
                data-bs-toggle="modal"
                data-bs-target="#PoHistoryModal"
              >
                ì£¼ë¬¸ì„œì¡°íšŒ
              </button>
            </div>
          </div>

          <!-- í’ˆëª© Grid -->
          <div id="itemGrid" class="ag-theme-quartz"></div>

          <!-- í•˜ë‹¨ í•©ê³„/í–‰ì¡°ì‘ -->
          <div class="d-flex justify-content-between align-items-center mt-2">
            <div class="d-flex gap-2">
              <button
                type="button"
                class="btn btn-outline-primary btn-slim"
                id="btnAddRow"
              >
                <i class="bi bi-plus-circle me-1"></i>í–‰ ì¶”ê°€
              </button>
              <button
                type="button"
                class="btn btn-outline-danger btn-slim"
                id="btnDelRow"
              >
                <i class="bi bi-dash-circle me-1"></i>ì„ íƒ ì‚­ì œ
              </button>
              <button
                type="button"
                class="btn btn-outline-secondary btn-slim"
                id="btnClearRows"
              >
                <i class="bi bi-trash me-1"></i>ì „ì²´ ë¹„ìš°ê¸°
              </button>
            </div>
            <div class="summary-bar">
              ì´ ìˆ˜ëŸ‰: <span id="sumQty">0</span> | ì´ ê³µê¸‰ê°€ì•¡:
              <span id="sumSupply">0</span> | ì´ ë¶€ê°€ì„¸:
              <span id="sumVat">0</span>
            </div>
          </div>
        </div>
      </div>

      <!-- ëª¨ë‹¬ ëª¨ìŒ -->

      <!-- ê±°ë˜ì²˜ ëª¨ë‹¬ -->
      <div th:replace="~{biz/modals/PoCustomerModal :: customermodal}"></div>

      <!-- í’ˆëª©ì½”ë“œ ëª¨ë‹¬ -->
      <div
        th:replace="~{biz/modals/ProductCodeModal :: productcodeModal}"
      ></div>
      <!-- ì£¼ë¬¸ì„œ ëª¨ë‹¬ -->
      <div th:replace="~{biz/modals/PoHistoryModal :: PoHistoryModal}"></div>
    </section>

    <th:block layout:fragment="body_extra">
      <script
        src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"
      ></script>
      <script
        src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
      ></script>
      <script
        src="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/dist/ag-grid-community.min.noStyle.js"
      ></script>

      <script th:inline="none">
        // ì£¼ë¬¸ì„œì¡°íšŒ ì¬ê·€/ì´ë²¤íŠ¸ ë£¨í”„ ë°©ì§€
        let _selectGuard = false;
        // DOM refs
        const writeDateEl = document.getElementById("writeDate");
        const customerCodeEl = document.getElementById("cusCode");
        const customerNameEl = document.getElementById("cusName");
        const managerNameEl = document.getElementById("managerName");
        const telEl = document.getElementById("tel");
        const shipDateEl = document.getElementById("shipDate");
        const addrEL = document.getElementById("sample4_roadAddress");
        const zipCodeEL = document.getElementById("sample4_postcode");

        // ---------- ê³µí†µ ìœ í‹¸ ----------
        const parseNum = (v) => Number(String(v ?? "").replace(/,/g, "")) || 0;
        // ê³„ì‚°
        const computeRow = (d) => {
          d.supAmt = (d.orderQty || 0) * (d.unitPrice || 0);
          d.vatAmt = Math.round((d.supAmt || 0) * 0.1);
          return d;
        };

        // í•©ê³„
        function updateSummary() {
          if (!itemGridApi) return;
          let tQty = 0,
            tSup = 0,
            tVat = 0;
          itemGridApi.forEachNode((n) => {
            tQty += Number(n.data.orderQty || 0);
            tSup += Number(n.data.supAmt || 0);
            tVat += Number(n.data.vatAmt || 0);
          });
          sumQty.textContent = tQty.toLocaleString();
          sumSupply.textContent = tSup.toLocaleString();
          sumVat.textContent = tVat.toLocaleString();
        }

        // ---------- ë©”ì¸ í’ˆëª© ê·¸ë¦¬ë“œ ----------
        let itemGridApi = null;
        const itemGridOptions = {
          columnDefs: [
            { headerName: "", checkboxSelection: true, width: 50 },
            {
              headerName: "ì£¼ë¬¸ì„œë²ˆí˜¸",
              field: "poCode",
              editable: true,
              width: 120,
            },
            {
              headerName: "í’ˆëª©ì½”ë“œ",
              field: "productCode",
              editable: true,
              width: 120,
            },
            {
              headerName: "í’ˆëª©ëª…",
              field: "productName",
              editable: true,
              flex: 1,
            },
            {
              headerName: "ì§€ë¶ˆë°©ì‹",
              field: "payMethod",
              editable: true,
              width: 120,
              cellEditor: "agSelectCellEditor",
              cellEditorParams: { values: ["í˜„ê¸ˆ", "ì–´ìŒ"] },
            },
            {
              headerName: "ìˆ˜ëŸ‰",
              field: "orderQty",
              editable: true,
              width: 100,
              type: "rightAligned",
              valueParser: (p) => parseNum(p.newValue),
              valueFormatter: (p) => (p.value ?? 0).toLocaleString(),
              onCellValueChanged: (p) => {
                computeRow(p.data);
                p.api.refreshCells({ force: true });
                updateSummary();
              },
            },
            {
              headerName: "ë‹¨ê°€",
              field: "unitPrice",
              editable: true,
              width: 120,
              type: "rightAligned",
              valueParser: (p) => parseNum(p.newValue),
              valueFormatter: (p) => (p.value ?? 0).toLocaleString(),
              onCellValueChanged: (p) => {
                computeRow(p.data);
                p.api.refreshCells({ force: true });
                updateSummary();
              },
            },
            {
              headerName: "ë¶€ê°€ì„¸",
              field: "vatAmt",
              width: 100,
              type: "rightAligned",
            },
            {
              headerName: "ê³µê¸‰ê°€ì•¡",
              field: "supAmt",
              width: 120,
              type: "rightAligned",
            },
            { headerName: "ë¹„ê³ ", field: "note", editable: true, flex: 1 },
          ],
          rowData: [],
          rowSelection: "multiple",
          rowMultiSelectWithClick: true,
          animateRows: true,
          defaultColDef: {
            sortable: true,
            resizable: true,
            filter: false,
            minWidth: 90,
          },
          onGridReady: (e) => {
            itemGridApi = e.api;
            window.itemGridApi = e.api; // ëª¨ë‹¬ì—ì„œ ì ‘ê·¼
            e.api.sizeColumnsToFit();
          },
        };
        new agGrid.Grid(document.getElementById("itemGrid"), itemGridOptions);

        // í•©ê³„ í‘œì‹œ
        const sumQty = document.getElementById("sumQty");
        const sumSupply = document.getElementById("sumSupply");
        const sumVat = document.getElementById("sumVat");
        function updateSummary() {
          if (!itemGridApi) return;
          let tQty = 0,
            tSup = 0,
            tVat = 0;
          itemGridApi.forEachNode((n) => {
            tQty += Number(n.data.qty || 0);
            tSup += Number(n.data.supplyAmt || 0);
            tVat += Number(n.data.vat || 0);
          });
          sumQty.textContent = tQty.toLocaleString();
          sumSupply.textContent = tSup.toLocaleString();
          sumVat.textContent = tVat.toLocaleString();
        }
        window.updateSummary = updateSummary;

        // ë²„íŠ¼ë“¤
        document.getElementById("btnAddRow").onclick = () => {
          itemGridApi.applyTransaction({
            add: [
              {
                productCode: "",
                productName: "",
                payMethod: "í˜„ê¸ˆ",
                orderQty: 0,
                unitPrice: 0,
                vatAmt: 0,
                supAmt: 0,
                note: "",
              },
            ],
          });
        };
        document.getElementById("btnDelRow").onclick = () => {
          const sel = itemGridApi.getSelectedRows();
          if (!sel.length) return toastr.info("ì‚­ì œí•  í–‰ì„ ì„ íƒí•˜ì„¸ìš”");
          itemGridApi.applyTransaction({ remove: sel });
          updateSummary();
        };
        document.getElementById("btnClearRows").onclick = () => {
          itemGridApi.setRowData([]);
          updateSummary();
        };
        document.getElementById("btnReset").onclick = () => {
          [
            "writeDate",
            "customerCode",
            "customerName",
            "managerName",
            "tel",
            "shipDate",
          ].forEach((id) => (document.getElementById(id).value = ""));
          itemGridApi.setRowData([]);
          updateSummary();
        };

        // ì €ì¥
        document.getElementById("btnSave").onclick = async () => {
          const header = {
            writeDate: writeDateEl.value,
            customerCode: customerCodeEl.value,
            customerName: customerNameEl.value,
            managerName: managerNameEl.value,
            tel: telEl.value,
            shipDate: shipDateEl.value,
            addr: addrEL.value,
            zipCode: zipCodeEL.value,
            notes: document.getElementById("notes")?.value || "",
          };
          //if (!header.writeDate) return toastr.error("ì‘ì„±ì¼ìë¥¼ ì…ë ¥í•˜ì„¸ìš”");
          if (!header.customerName) return toastr.error("ê±°ë˜ì²˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”");
          if (!header.shipDate) return toastr.error("ì¶œí•˜ì˜ˆì •ì¼ì„ ì…ë ¥í•˜ì„¸ìš”");

          const lineItems = [];
          itemGridApi.forEachNode((n) =>
            lineItems.push(computeRow({ ...n.data }))
          );
          if (!lineItems.length)
            return toastr.error("í’ˆëª©ì„ 1ê°œ ì´ìƒ ì¶”ê°€í•˜ì„¸ìš”");

          const payload = {
            poCode: header.poCode,
            cusCode: header.customerCode,
            name: header.managerName,
            doCreated: header.writeDate,
            exDate: header.shipDate,
            addr: header.addr,
            zipCode: header.zipCode,
            notes: header.notes ?? "",
            companyCode: 1,
            dodetails: lineItems.map((it) => ({
              productCode: it.productCode,
              orderQty: it.orderQty ?? 0,
              unitPrice: it.unitPrice ?? 0,
              supAmt: it.supAmt ?? 0,
              vatAmt: it.vatAmt ?? 0,
              dcPrice: 0,
              companyCode: it.companyCode,
            })),
          };
          try {
            await axios.post("/api/biz/doinsert", payload);
            toastr.success("ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤");
          } catch (e) {
            console.error(e);
            toastr.error("ë“±ë¡ ì‹¤íŒ¨");
          }
        };

        /*----------



                í’ˆëª©ì½”ë“œ ëª¨ë‹¬





        ----------

                */
        const productModalEl = document.getElementById("productcodeModal");
        let productGridApi;
        const productGridOptions = {
          columnDefs: [
            { headerName: "", checkboxSelection: true, width: 50 },
            { headerName: "í’ˆëª©ì½”ë“œ", field: "productCode", width: 140 },
            {
              headerName: "í’ˆëª©ëª…",
              field: "productName",
              flex: 1,
              minWidth: 160,
            },
          ],
          rowSelection: "multiple",
          rowMultiSelectWithClick: true,
          rowData: [],
          defaultColDef: { sortable: true, resizable: true, filter: true },
          onGridReady: (p) => {
            productGridApi = p.api;
          },
        };
        function ensureProductGrid() {
          const gridDiv = document.getElementById("productGrid");
          if (!gridDiv) return;
          if (!gridDiv.__api) {
            if (window.agGrid?.createGrid)
              gridDiv.__api = agGrid.createGrid(gridDiv, productGridOptions);
            else {
              new agGrid.Grid(gridDiv, productGridOptions);
              gridDiv.__api = productGridOptions.api;
            }
          }
          productGridApi = gridDiv.__api;
        }
        async function fetchProductData() {
          if (!productGridApi) return;
          const { data } = await axios.get("/api/biz/productcode");
          productGridApi.setRowData(Array.isArray(data) ? data : []);
          requestAnimationFrame(() => productGridApi.sizeColumnsToFit?.());
        }
        productModalEl?.addEventListener("shown.bs.modal", async () => {
          ensureProductGrid();
          await fetchProductData();
        });
        document
          .getElementById("PrcImportBtn")
          ?.addEventListener("click", () => {
            const rows = productGridApi?.getSelectedRows?.() || [];
            if (!rows.length) return alert("ê°€ì ¸ì˜¬ í’ˆëª©ì„ ì„ íƒí•˜ì„¸ìš”.");
            const items = rows.map((r) => ({
              poCode: r.poCode,
              productCode: r.productCode,
              productName: r.productName,
              payMethod: r.payMethod,
              orderQty: r.orderQty,
              vatAmt: r.vatAmt,
              supAmt: r.supAmt,
              note: r.note,
            }));
            window.itemGridApi.applyTransaction({ add: items });
            updateSummary();
            (
              bootstrap.Modal.getInstance(productModalEl) ||
              bootstrap.Modal.getOrCreateInstance(productModalEl)
            ).hide();
          });

        /* ----------




                ê±°ë˜ì²˜ ëª¨ë‹¬



        ----------
                */
        const customerModalEl = document.getElementById("customermodal");
        let customerGridApi;
        const customerGridOptions = {
          columnDefs: [
            { headerName: "", checkboxSelection: true, width: 50 },
            { headerName: "ê±°ë˜ì²˜ì½”ë“œ", field: "cusCode", width: 140 },
            {
              headerName: "ê±°ë˜ì²˜ëª…",
              field: "cusName",
              flex: 1,
              minWidth: 160,
            },
            { headerName: "ì‹ ìš©ë“±ê¸‰", field: "creditGrade", width: 140 },
            { headerName: "ë¯¸ìˆ˜ê¸ˆ", field: "leftPrice", width: 140 },
          ],
          rowSelection: "single",
          rowData: [],
          defaultColDef: { sortable: true, resizable: true, filter: true },
          onGridReady: (p) => {
            customerGridApi = p.api;
          },
        };
        function ensureCustomerGrid() {
          const gridDiv = document.getElementById("customerGrid");
          if (!gridDiv) return;
          if (!gridDiv.__api) {
            if (window.agGrid?.createGrid)
              gridDiv.__api = agGrid.createGrid(gridDiv, customerGridOptions);
            else {
              new agGrid.Grid(gridDiv, customerGridOptions);
              gridDiv.__api = customerGridOptions.api;
            }
          }
          customerGridApi = gridDiv.__api;
        }
        async function fetchCustomerData() {
          if (!customerGridApi) return;
          const { data } = await axios.get("/api/biz/customercode");
          customerGridApi.setRowData(Array.isArray(data) ? data : []);
          requestAnimationFrame(() => customerGridApi.sizeColumnsToFit?.());
        }
        customerModalEl?.addEventListener("shown.bs.modal", async () => {
          ensureCustomerGrid();
          await fetchCustomerData();
        });

        // ê°€ì ¸ì˜¤ê¸° ë²„íŠ¼
        document
          .getElementById("CstImportBtn")
          ?.addEventListener("click", () => {
            const sel = customerGridApi?.getSelectedRows?.() || [];
            if (!sel.length) return alert("ê±°ë˜ì²˜ë¥¼ ì„ íƒí•˜ì„¸ìš”.");
            document.getElementById("cusName").value = sel[0].cusName ?? "";
            document.getElementById("cusCode").value = sel[0].cusCode ?? "";
          });

        // ---------- ì£¼ë¬¸ì„œì¡°íšŒ ëª¨ë‹¬ ----------
        const poHistoryModalEl = document.getElementById("PoHistoryModal");
        let poHistoryGridApi;

        const poHistoryGridOptions = {
          columnDefs: [
            { headerName: "", checkboxSelection: true, width: 50 },
            { headerName: "ì£¼ë¬¸ì„œë²ˆí˜¸", field: "poCode", width: 120 },
            { headerName: "ì‘ì„±ì¼ì", field: "poStart", width: 120 },
            {
              headerName: "ê±°ë˜ì²˜ëª…",
              field: "cusName",
              flex: 1,
              minWidth: 150,
            },
            { headerName: "ì œí’ˆì½”ë“œ", field: "productCode", width: 120 },
            { headerName: "ì œí’ˆëª…", field: "productName", width: 150 },
            { headerName: "ë‹´ë‹¹ì", field: "creater", width: 100 },
            { headerName: "ë‚©ê¸°ì¼ì", field: "exDate", width: 120 },
            {
              headerName: "ê³µê¸‰ê°€ì•¡",
              field: "supAmt",
              width: 150,
              type: "rightAligned",
              valueFormatter: (p) =>
                p.value ? Number(p.value).toLocaleString("ko-KR") : "",
            },
          ],
          rowSelection: "multiple",
          rowMultiSelectWithClick: true,
          rowData: [],
          defaultColDef: { sortable: true, resizable: true, filter: true },
          onGridReady: (p) => {
            poHistoryGridApi = p.api;
          },

          // ê°™ì€ ì£¼ë¬¸ì„œë²ˆí˜¸ ì„ íƒ
          onRowSelected: (event) => {
            // if (_selectGuard) return;
            const row = event.data;
            if (!row || !row.poCode) return;

            _selectGuard = true;

            if (event.node.isSelected()) {
              // ğŸ‘‰ ê°™ì€ ì£¼ë¬¸ë²ˆí˜¸ë§Œ ì„ íƒ
              poHistoryGridApi.forEachNode((n) => {
                if (n.data && n.data.poCode === row.poCode) {
                  n.setSelected(true);
                } else {
                  n.setSelected(false);
                }
              });
            } else {
              // í•´ì œ ì‹œì—ëŠ” ê°™ì€ ì£¼ë¬¸ë²ˆí˜¸ ì „ë¶€ í•´ì œ
              poHistoryGridApi.forEachNode((n) => {
                if (n.data && n.data.poCode === row.poCode) {
                  n.setSelected(false);
                }
              });
            }

            _selectGuard = false;
          },
        };
        function ensurePoHistoryGrid(modalRoot) {
          let gridDiv =
            document.getElementById("poHistoryGrid") ||
            modalRoot?.querySelector("#poHistoryGrid");
          if (!gridDiv) return null;
          if (!gridDiv.__api) {
            // ë†’ì´ ë³´ì¥ (í…œí”Œë¦¿ì´ ë°”ë€Œì—ˆì„ ê²½ìš° ëŒ€ë¹„)
            if (!gridDiv.style.height) {
              gridDiv.style.height = "360px";
              gridDiv.style.width = "100%";
            }
            if (window.agGrid?.createGrid)
              gridDiv.__api = agGrid.createGrid(gridDiv, poHistoryGridOptions);
            else {
              new agGrid.Grid(gridDiv, poHistoryGridOptions);
              gridDiv.__api = poHistoryGridOptions.api;
            }
          }
          poHistoryGridApi = gridDiv.__api;
          return gridDiv;
        }
        async function fetchPoHistoryData() {
          if (!poHistoryGridApi) return;
          try {
            const { data } = await axios.get("/api/biz/pohistory");
            const rows = Array.isArray(data) ? data : [];
            poHistoryGridApi.setRowData(rows);
            requestAnimationFrame(() => poHistoryGridApi.sizeColumnsToFit?.());
          } catch (err) {
            console.error("[PoHistory] ì¡°íšŒ ì‹¤íŒ¨", err);
            toastr.error("ì£¼ë¬¸ ì´ë ¥ ì¡°íšŒ ì‹¤íŒ¨");
          }
        }
        // ë¬¸ì„œ ë ˆë²¨ì—ì„œ ëª¨ë‹¬ shownì„ ì¡ì•„ ë°©íƒ„ ì²˜ë¦¬
        document.addEventListener("shown.bs.modal", (ev) => {
          const modal = ev.target;
          if (!modal || modal.id !== "PoHistoryModal") return;
          const gridDiv = ensurePoHistoryGrid(modal);
          if (!gridDiv) {
            console.warn("[PoHistory] poHistoryGrid ìš”ì†Œ ì—†ìŒ");
            return;
          }
          fetchPoHistoryData();
        });

        // ì£¼ë¬¸ì„œ ê°€ì ¸ì˜¤ê¸°
        document
          .getElementById("PohImportBtn")
          ?.addEventListener("click", () => {
            if (!poHistoryGridApi)
              return alert("ê·¸ë¦¬ë“œ ì´ˆê¸°í™”ê°€ ì•„ì§ ì•ˆ ë˜ì—ˆìŠµë‹ˆë‹¤.");
            const selectedRows = poHistoryGridApi.getSelectedRows?.() || [];
            if (!selectedRows.length)
              return alert("ê°€ì ¸ì˜¬ ì£¼ë¬¸ì„œì˜ í–‰ì„ ì„ íƒí•˜ì„¸ìš”.");
            // ê±°ë˜ì²˜ì •ë³´ê°€ì ¸ì˜¤ê¸°
            document.getElementById("cusCode").value = selectedRows[0].cusCode;
            document.getElementById("cusName").value = selectedRows[0].cusName;
            document.getElementById("sample4_roadAddress").value =
              selectedRows[0].addr;
            document.getElementById("sample4_postcode").value =
              selectedRows[0].zipCode;
            document.getElementById("shipDate").value = selectedRows[0].exDate;

            document.getElementById("tel").value = selectedRows[0].tel;
            const newItems = selectedRows.map((row) => ({
              poCode: row.poCode ?? "",
              productCode: row.productCode ?? "",
              productName: row.productName ?? "",
              cusCode: row.cusCode ?? "",
              orderQty: row.orderQty ?? 1,
              unitPrice: row.unitPrice ?? 0,
              supAmt: row.supAmt ?? (row.unitPrice || 0) * (row.orderQty || 1),
              vatAmt: Math.round(
                (row.supAmt ?? (row.unitPrice || 0) * (row.orderQty || 1)) * 0.1
              ),
              note: `${row.poStart || ""} ì£¼ë¬¸ ê±´ì—ì„œ ê°€ì ¸ì˜´`,
              payMethod: "í˜„ê¸ˆ",
            }));

            window.itemGridApi.applyTransaction({ add: newItems });
            window.updateSummary?.();
            (
              bootstrap.Modal.getInstance(poHistoryModalEl) ||
              bootstrap.Modal.getOrCreateInstance(poHistoryModalEl)
            ).hide();
          });
        console.log({
          modalExists: !!document.getElementById("PoHistoryModal"),
          gridExists: !!document.getElementById("poHistoryGrid"),
          button:
            document.querySelector('[data-bs-target="#PoHistoryModal"]')
              ?.outerHTML || null,
        });
      </script>
    </th:block>
  </body>
</html>
