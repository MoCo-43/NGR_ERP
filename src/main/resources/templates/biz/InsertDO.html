<!DOCTYPE html>
<html
  lang="ko"
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layout/base}"
>
  <head>
    <meta charset="UTF-8" />
    <title layout:fragment="title">출하지시서 입력</title>

    <th:block layout:fragment="head_extra">
      <!-- Bootstrap -->
      <link
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
        rel="stylesheet"
        crossorigin="anonymous"
      />
      <link
        href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
        rel="stylesheet"
      />

      <!-- AG Grid -->
      <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/styles/ag-grid.css"
      />
      <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/styles/ag-theme-quartz.css"
      />

      <!-- Toastr -->
      <link
        rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.css"
        crossorigin="anonymous"
        referrerpolicy="no-referrer"
      />

      <style>
        .form-label {
          font-weight: 600;
        }
        .btn-slim {
          padding: 0.375rem 0.75rem;
        }
        .btn-wide {
          min-width: 110px;
        }
        .muted {
          font-size: 12px;
          color: #6b7280;
        }
        .filter-card {
          border: 1px solid #e5e7eb;
        }
        .toolbar .btn {
          min-width: 96px;
        }
        #itemGrid.ag-theme-quartz {
          height: 360px;
          width: 100%;
        }
        .summary-bar {
          font-weight: 600;
        }
      </style>
    </th:block>
  </head>

  <body>
    <section layout:fragment="content">
      <div class="card shadow">
        <!-- 헤더 -->
        <div
          class="card-header d-flex align-items-center justify-content-between"
        >
          <h5 class="mb-0">출하지시서 입력</h5>
          <div class="d-flex gap-2">
            <button
              type="button"
              class="btn btn-outline-secondary btn-slim"
              id="btnReset"
            >
              <i class="bi bi-arrow-counterclockwise me-1"></i>초기화
            </button>
            <button type="button" class="btn btn-primary btn-slim" id="btnSave">
              <i class="bi bi-check2 me-1"></i>등록
            </button>
          </div>
        </div>

        <div class="card-body">
          <!-- 상단 입력 폼 -->
          <div class="card filter-card p-3 mb-3">
            <div class="row g-3">
              <!-- 작성일자 -->
              <div class="col-md-3">
                <label class="form-label">작성일자</label>
                <input type="date" class="form-control" id="writeDate" />
              </div>

              <!-- 거래처 -->
              <div class="col-md-3">
                <label class="form-label">거래처</label>
                <div class="input-group">
                  <input
                    type="text"
                    class="form-control"
                    id="customerName"
                    placeholder="거래처명"
                  />
                  <button
                    type="button"
                    class="btn btn-outline-secondary"
                    id="btnFindCustomer"
                    data-bs-toggle="modal"
                    data-bs-target="#customermodal"
                  >
                    <i class="bi bi-search"></i>
                  </button>
                </div>
                <input type="hidden" id="customerCode" />
              </div>

              <!-- 담당자 -->
              <div class="col-md-3">
                <label class="form-label">담당자</label>
                <div class="input-group">
                  <input
                    type="text"
                    class="form-control"
                    id="managerName"
                    placeholder="담당자명"
                  />
                  <button
                    type="button"
                    class="btn btn-outline-secondary"
                    id="btnFindManager"
                  >
                    <i class="bi bi-search"></i>
                  </button>
                </div>
              </div>

              <!-- 연락처 -->
              <div class="col-md-3">
                <label class="form-label">연락처</label>
                <input
                  type="text"
                  class="form-control"
                  id="phone"
                  placeholder="연락처"
                />
              </div>
            </div>

            <div class="row g-3 mt-1">
              <!-- 출하예정일 -->
              <div class="col-md-3">
                <label class="form-label">출하예정일</label>
                <input type="date" class="form-control" id="shipDate" />
              </div>

              <!-- 다음 주소 API 사용-->
              <!-- 도로명주소 -->
              <div class="col-md-3">
                <label class="form-label">도로명주소</label>
                <div class="input-group">
                  <input
                    type="text"
                    class="form-control"
                    id="sample4_roadAddress"
                    placeholder="주소"
                  />
                  <button
                    type="button"
                    onclick="sample4_execDaumPostcode()"
                    class="btn btn-outline-secondary"
                    id="btnf"
                  >
                    <i class="bi bi-search"></i>
                  </button>
                </div>
              </div>

              <!-- 우편번호 -->
              <div class="col-md-3">
                <label class="form-label">우편번호</label>
                <div class="input-group">
                  <input
                    type="text"
                    class="form-control"
                    id="sample4_postcode"
                    placeholder="우편번호"
                  />
                </div>
              </div>

              <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
              <script>
                function sample4_execDaumPostcode() {
                  new daum.Postcode({
                    oncomplete: function (data) {
                      var roadAddr = data.roadAddress;
                      document.getElementById("sample4_postcode").value =
                        data.zonecode;
                      document.getElementById("sample4_roadAddress").value =
                        roadAddr;
                    },
                  }).open();
                }
              </script>
            </div>

            <!-- 조회 버튼 그룹 -->
            <div class="toolbar d-flex gap-2 mt-3">
              <button
                type="button"
                class="btn btn-outline-secondary btn-slim"
                id="btnFindProduct"
                data-bs-toggle="modal"
                data-bs-target="#productcodeModal"
              >
                품목코드
              </button>
              <button
                type="button"
                class="btn btn-outline-secondary btn-slim"
                id="btnFindOrder"
                data-bs-toggle="modal"
                data-bs-target="#PoHistoryModal"
              >
                주문서조회
              </button>
            </div>
          </div>

          <!-- 품목 Grid -->
          <div id="itemGrid" class="ag-theme-quartz"></div>

          <!-- 하단 합계/행조작 -->
          <div class="d-flex justify-content-between align-items-center mt-2">
            <div class="d-flex gap-2">
              <button
                type="button"
                class="btn btn-outline-primary btn-slim"
                id="btnAddRow"
              >
                <i class="bi bi-plus-circle me-1"></i>행 추가
              </button>
              <button
                type="button"
                class="btn btn-outline-danger btn-slim"
                id="btnDelRow"
              >
                <i class="bi bi-dash-circle me-1"></i>선택 삭제
              </button>
              <button
                type="button"
                class="btn btn-outline-secondary btn-slim"
                id="btnClearRows"
              >
                <i class="bi bi-trash me-1"></i>전체 비우기
              </button>
            </div>
            <div class="summary-bar">
              총 수량: <span id="sumQty">0</span> | 총 공급가액:
              <span id="sumSupply">0</span> | 총 부가세:
              <span id="sumVat">0</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Toast -->
      <div class="position-fixed top-0 end-0 p-3" style="z-index: 1080">
        <div
          id="successToast"
          class="toast align-items-center text-bg-success border-0"
          role="alert"
          aria-live="assertive"
          aria-atomic="true"
        >
          <div class="toast-body" id="toastMessage">처리가 완료되었습니다.</div>
        </div>
      </div>

      <!-- 모달 -->
      <!-- 거래처 모달 -->
      <div th:replace="~{biz/modals/PoCustomerModal :: customermodal}"></div>
      <!-- 품목코드 모달 -->
      <div
        th:replace="~{biz/modals/ProductCodeModal :: productcodeModal}"
      ></div>
      <!-- 주문서 모달 -->
      <div th:replace="~{biz/modals/PoHistoryModal :: PoHistoryModal}"></div>
    </section>

    <!-- 좌측 주문서 조회/우측 출하지시서 입력-->
    <!---->

    <th:block layout:fragment="body_extra">
      <script
        src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"
      ></script>
      <script
        src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
      ></script>
      <script
        src="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/dist/ag-grid-community.min.noStyle.js"
      ></script>
      <script
        src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"
        crossorigin="anonymous"
        referrerpolicy="no-referrer"
      ></script>

      <script th:inline="none">
        // 상단 입력 데이터 DOM
        const writeDateEl = document.getElementById("writeDate");
        const customerCodeEl = document.getElementById("customerCode");
        const customerNameEl = document.getElementById("customerName");
        const managerNameEl = document.getElementById("managerName");
        const phoneEl = document.getElementById("phone");
        const shipDateEl = document.getElementById("shipDate");
        const addrEL = document.getElementById("sample4_roadAddress");
        const zipCodeEL = document.getElementById("sample4_postcode");

        document.addEventListener("DOMContentLoaded", () => {
          /* ==============================
             [1] 유틸 함수
             ============================== */
          const parseNum = (v) =>
            Number(String(v ?? "").replace(/,/g, "")) || 0;
          const computeRow = (d) => {
            d.supplyAmt = (d.qty || 0) * (d.price || 0); // 공급가액 = 수량 * 단가
            d.vat = Math.round(d.supplyAmt * 0.1); // 부가세 = 공급가액 * 10%
            return d;
          };

          /* ==============================
             [2] 메인 품목 그리드 정의
             ============================== */
          let itemGridApi = null; // 전역 변수로 API 보관

          const itemColumnDefs = [
            { headerName: "", checkboxSelection: true, width: 50 },
            {
              headerName: "품목코드",
              field: "code",
              editable: true,
              width: 120,
            },
            { headerName: "품목명", field: "name", editable: true, flex: 1 },
            {
              headerName: "결제방식",
              field: "payType",
              editable: true,
              width: 120,
              cellEditor: "agSelectCellEditor",
              cellEditorParams: { values: ["현금", "어음"] },
            },
            {
              headerName: "수량",
              field: "qty",
              editable: true,
              width: 100,
              type: "rightAligned",
              valueParser: (p) => parseNum(p.newValue),
              valueFormatter: (p) => (p.value ?? 0).toLocaleString(),
              onCellValueChanged: (p) => {
                computeRow(p.data);
                p.api.refreshCells({ force: true }); // 셀 리프레시
                updateSummary();
              },
            },
            {
              headerName: "단가",
              field: "price",
              editable: true,
              width: 120,
              type: "rightAligned",
              valueParser: (p) => parseNum(p.newValue),
              valueFormatter: (p) => (p.value ?? 0).toLocaleString(),
              onCellValueChanged: (p) => {
                computeRow(p.data);
                p.api.refreshCells({ force: true });
                updateSummary();
              },
            },
            {
              headerName: "부가세",
              field: "vat",
              width: 100,
              type: "rightAligned",
            },
            {
              headerName: "공급가액",
              field: "supplyAmt",
              width: 120,
              type: "rightAligned",
            },
            { headerName: "비고", field: "note", editable: true, flex: 1 },
          ];

          const itemGridOptions = {
            columnDefs: itemColumnDefs,
            rowData: [],
            rowSelection: "multiple",
            rowMultiSelectWithClick: true,
            animateRows: true,
            defaultColDef: {
              sortable: true,
              resizable: true,
              filter: false,
              minWidth: 90,
            },
            onGridReady: (e) => {
              itemGridApi = e.api; // API 보관
              window.itemGridApi = e.api; // 모달에서도 쓰도록 전역 등록
              e.api.sizeColumnsToFit();
            },
          };

          // 실제 그리드 생성
          new agGrid.Grid(document.getElementById("itemGrid"), itemGridOptions);

          /* ==============================
             [3] 합계 처리
             ============================== */
          const sumQty = document.getElementById("sumQty"),
            sumSupply = document.getElementById("sumSupply"),
            sumVat = document.getElementById("sumVat");

          function updateSummary() {
            if (!itemGridApi) return;
            let tQty = 0,
              tSup = 0,
              tVat = 0;
            itemGridApi.forEachNode((n) => {
              tQty += Number(n.data.qty || 0);
              tSup += Number(n.data.supplyAmt || 0);
              tVat += Number(n.data.vat || 0);
            });
            sumQty.textContent = tQty.toLocaleString();
            sumSupply.textContent = tSup.toLocaleString();
            sumVat.textContent = tVat.toLocaleString();
          }
          window.updateSummary = updateSummary; // 모달에서도 호출 가능하도록 등록

          /* ==============================
             [4] 버튼 이벤트 (행조작)
             ============================== */
          document.getElementById("btnAddRow").onclick = () => {
            itemGridApi.applyTransaction({
              add: [
                {
                  code: "",
                  name: "",
                  payType: "현금",
                  qty: 0,
                  price: 0,
                  vat: 0,
                  supplyAmt: 0,
                  note: "",
                },
              ],
            });
          };

          document.getElementById("btnDelRow").onclick = () => {
            const sel = itemGridApi.getSelectedRows();
            if (!sel.length) return toastr.info("삭제할 행을 선택하세요");
            itemGridApi.applyTransaction({ remove: sel });
            updateSummary();
          };

          document.getElementById("btnClearRows").onclick = () => {
            itemGridApi.setRowData([]);
            updateSummary();
          };

          document.getElementById("btnReset").onclick = () => {
            [
              "writeDate",
              "customerCode",
              "customerName",
              "managerName",
              "phone",
              "shipDate",
            ].forEach((id) => (document.getElementById(id).value = ""));
            itemGridApi.setRowData([]);
            updateSummary();
          };

          /* ==============================
             [5] 저장 버튼 (서버 전송)
             ============================== */
          document.getElementById("btnSave").onclick = async () => {
            // === 헤더 영역 ===
            const header = {
              writeDate: writeDateEl.value,
              customerCode: customerCodeEl.value,
              customerName: customerNameEl.value,
              managerName: managerNameEl.value,
              phone: phoneEl.value,
              shipDate: shipDateEl.value,
              addr: addrEL.value,
              zipCode: zipCodeEL.value,
              notes: document.getElementById("notes")?.value || "",
            };

            // === 유효성 검사 ===
            if (!header.writeDate) return toastr.error("작성일자를 입력하세요");
            if (!header.customerName)
              return toastr.error("거래처를 입력하세요");
            if (!header.shipDate)
              return toastr.error("출하예정일을 입력하세요");

            // === 품목 데이터 추출 ===
            const lineItems = [];
            itemGridApi.forEachNode((n) =>
              lineItems.push(computeRow({ ...n.data }))
            );
            if (!lineItems.length)
              return toastr.error("품목을 1개 이상 추가하세요");

            // === 서버로 보낼 JSON을 VO 구조에 맞게 변환 ===
            const payload = {
              cusCode: header.customerCode,
              name: header.managerName,
              doCreated: header.writeDate,
              exDate: header.shipDate,
              addr: header.addr,
              zipCode: header.zipCode,
              notes: header.notes ?? "",
              companyCode: 1, // 세션에서 넣는다면 생략 가능
              dodetails: lineItems.map((it) => ({
                productCode: it.code,
                qty: it.qty ?? 0,
                unitPrice: it.price ?? 0,
                supAmt: it.supplyAmt ?? 0,
                vatAmt: it.vat ?? 0,
                dcPrice: 0,
                companyCode: "1", // detail에도 필수라면 넣기
              })),
            };

            // === axios 전송 ===
            try {
              await axios.post("/api/biz/doinsert", payload);
              toastr.success("등록되었습니다");
            } catch (e) {
              console.error(e);
              toastr.error("등록 실패");
            }
          };
        });
        /*

                                                ======================== 품목코드 모달 ========================


                                          */
        const productModalEl = document.getElementById("productcodeModal");
        let productGridApi;

        const productGridOptions = {
          columnDefs: [
            { headerName: "", checkboxSelection: true, width: 50 },
            { headerName: "품목코드", field: "productCode", width: 140 },
            {
              headerName: "품목명",
              field: "productName",
              flex: 1,
              minWidth: 160,
            },
          ],
          rowSelection: "multiple",
          rowMultiSelectWithClick: true,
          rowData: [],
          defaultColDef: { sortable: true, resizable: true, filter: true },
          onGridReady: (p) => {
            productGridApi = p.api;
          },
        };

        function ensureProductGrid() {
          const gridDiv = document.getElementById("productGrid");
          if (!gridDiv) return;
          if (!gridDiv.__agApi) {
            new agGrid.Grid(gridDiv, productGridOptions);
            gridDiv.__agApi = productGridOptions.api;
            productGridApi = gridDiv.__agApi;
          } else {
            productGridApi = gridDiv.__agApi;
          }
        }

        async function fetchProductData() {
          if (!productGridApi) return;
          const { data } = await axios.get("/api/biz/productcode");
          productGridApi.setRowData(Array.isArray(data) ? data : []);
        }

        productModalEl?.addEventListener("shown.bs.modal", async () => {
          ensureProductGrid();
          await fetchProductData();
        });

        document
          .getElementById("PrcImportBtn")
          ?.addEventListener("click", () => {
            const rows = productGridApi?.getSelectedRows?.() || [];
            if (!rows.length) return alert("가져올 품목을 선택하세요.");

            const items = rows.map((r) => ({
              code: r.productCode,
              name: r.productName,
              payType: "현금",
              qty: null,
              price: null,
              vat: 0,
              supplyAmt: 0,
              note: "",
            }));

            window.itemGridApi.applyTransaction({ add: items });
            // 합계 갱신
            function updateSummary() {
              let tQty = 0,
                tSupply = 0,
                tVat = 0;
              itemGridApi.forEachNode((n) => {
                tQty += Number(n.data.qty || 0);
                tSupply += Number(n.data.supplyAmt || 0);
                tVat += Number(n.data.vat || 0);
              });
              document.getElementById("sumQty").textContent =
                tQty.toLocaleString();
              document.getElementById("sumSupply").textContent =
                tSupply.toLocaleString();
              document.getElementById("sumVat").textContent =
                tVat.toLocaleString();
            }
            updateSummary();

            // ★ 인스턴스 한 번만 얻어서 hide
            const modal =
              bootstrap.Modal.getInstance(productModalEl) ||
              bootstrap.Modal.getOrCreateInstance(productModalEl);
            modal.hide();
          });

        /*

                 ======================== 거래처 모달 ========================


                */
        const customerModalEl = document.getElementById("customermodal");
        let customerGridApi = null;

        const customerGridOptions = {
          columnDefs: [
            { headerName: "", checkboxSelection: true, width: 50 },
            { headerName: "거래처코드", field: "cusCode", width: 140 },
            {
              headerName: "거래처명",
              field: "cusName",
              flex: 1,
              minWidth: 160,
            },
            { headerName: "신용등급", field: "creditGrade", width: 140 },
            { headerName: "미수금", field: "leftPrice", width: 140 },
          ],
          rowSelection: "single",
          rowData: [],
          defaultColDef: { sortable: true, resizable: true, filter: true },
          onGridReady: (p) => {
            customerGridApi = p.api;
          },
        };

        function ensureCustomerGrid() {
          const gridDiv = document.getElementById("customerGrid");
          if (!gridDiv) return;
          if (!gridDiv.__agApi) {
            new agGrid.Grid(gridDiv, customerGridOptions);
            gridDiv.__agApi = customerGridOptions.api;
            customerGridApi = gridDiv.__agApi;
          } else {
            customerGridApi = gridDiv.__agApi;
          }
        }

        async function fetchCustomerData() {
          if (!customerGridApi) return;
          const { data } = await axios.get("/api/biz/customercode");
          customerGridApi.setRowData(Array.isArray(data) ? data : []);
          requestAnimationFrame(() => customerGridApi.sizeColumnsToFit());
        }

        customerModalEl?.addEventListener("shown.bs.modal", async () => {
          ensureCustomerGrid();
          await fetchCustomerData();
        });

        document
          .getElementById("CstImportBtn")
          ?.addEventListener("click", () => {
            const sel = customerGridApi?.getSelectedRows?.() || [];
            if (!sel.length) return alert("거래처를 선택하세요.");

            document.getElementById("customerName").value =
              sel[0].cusName ?? "";
            document.getElementById("customerCode").value =
              sel[0].cusCode ?? "";
            console.log("선택된 거래처:", sel[0]);

            // 선택 버튼 누른 후 모달 close지정 해서 필요 없어짐
            // const modal =
            //   bootstrap.Modal.getInstance(customerModalEl) ||
            //   bootstrap.Modal.getOrCreateInstance(customerModalEl);
            // // modal.hide(customerModalEl);
          });

        /*

                                ======================== 주문서조회 모달 ========================


                                */
        const poHistoryModalEl = document.getElementById("PoHistoryModal");
        let poHistoryGridApi;
        const poHistoryColumnDefs = [
          { headerName: "", checkboxSelection: true, width: 50 },
          { headerName: "작성일자", field: "poStart", width: 120 },
          {
            headerName: "거래처명",
            field: "cusName",
            flex: 1,
            minWidth: 150,
          },
          { headerName: "제품코드", field: "prdCode", width: 120 },
          { headerName: "제품명", field: "prdName", width: 150 },
          { headerName: "담당자", field: "creater", width: 100 },
          { headerName: "납기일자", field: "exDate", width: 120 },
          {
            headerName: "총액",
            field: "totalPrice",
            width: 150,
            type: "rightAligned",
            valueFormatter: (p) =>
              p.value ? p.value.toLocaleString("ko-KR") : "",
          },
        ];
        const poHistoryGridOptions = {
          columnDefs: poHistoryColumnDefs,
          rowSelection: "multiple",
          rowMultiSelectWithClick: true,
          rowData: [],
          defaultColDef: { sortable: true, resizable: true, filter: true },
          onGridReady: (params) => {
            poHistoryGridApi = params.api;
          },
        };
        async function fetchPoHistoryData() {
          if (!poHistoryGridApi) return;
          try {
            const response = await axios.get("/api/biz/pohistory");
            poHistoryGridApi.setRowData(response.data);
            poHistoryGridApi.sizeColumnsToFit();
          } catch (error) {
            console.error("주문 이력 조회 실패:", error);
            alert("데이터를 불러오는 데 실패했습니다.");
          }
        }
        if (poHistoryModalEl) {
          poHistoryModalEl.addEventListener("shown.bs.modal", () => {
            if (!poHistoryGridApi) {
              const gridDiv = document.getElementById("poHistoryGrid");
              if (window.agGrid?.createGrid) {
                poHistoryGridApi = agGrid.createGrid(
                  gridDiv,
                  poHistoryGridOptions
                );
              } else {
                poHistoryGridApi = poHistoryGridOptions.api;
              }
            }
            fetchPoHistoryData();
          });

          const importBtn = document.getElementById("PohImportBtn");
          importBtn.addEventListener("click", () => {
            const selectedRows = poHistoryGridApi.getSelectedRows();
            if (!selectedRows || selectedRows.length === 0) {
              return alert("가져올 주문서의 행을 선택하세요.");
            }

            // 주문서 모달(prdCode/prdName/…)-> 출하지시서 그리드(code/name/price/…)
            const newItems = selectedRows.map((row) => ({
              code: row.prdCode ?? row.productCode ?? "", // ← 코드 매핑
              name: row.prdName ?? row.productName ?? "", // ← 명칭 매핑
              payType: "현금",
              qty: 1, // 기본값(필요시 변경)
              price: row.unitPrice ?? row.price ?? 0, // 단가 소스가 어디인지에 따라
              vat: 0,
              supplyAmt: 0,
              note: `${row.poStart || ""} 주문 건에서 가져옴`,
            }));

            poHistoryGridApi.applyTransaction({ add: newItems });
            // 합계 갱신
            updateSummary();

            // 모달 닫기
            const modal =
              bootstrap.Modal.getInstance(poHistoryModalEl) ||
              bootstrap.Modal.getOrCreateInstance(poHistoryModalEl);
            modal.hide();
          });
        }
      </script>
    </th:block>
  </body>
</html>
