<!DOCTYPE html>
<html
  lang="ko"
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layout/base}"
>
  <head>
    <meta charset="UTF-8" />
    <title layout:fragment="title">출하지시서 입력</title>

    <th:block layout:fragment="head_extra">
      <!-- Bootstrap -->
      <link
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
        rel="stylesheet"
        crossorigin="anonymous"
      />
      <link
        href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
        rel="stylesheet"
      />

      <!-- AG Grid -->
      <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/styles/ag-grid.css"
      />
      <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/styles/ag-theme-quartz.css"
      />

      <!-- Toastr -->
      <link
        rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.css"
        crossorigin="anonymous"
        referrerpolicy="no-referrer"
      />

      <style>
        .form-label {
          font-weight: 600;
        }
        .btn-slim {
          padding: 0.375rem 0.75rem;
        }
        .btn-wide {
          min-width: 110px;
        }
        .muted {
          font-size: 12px;
          color: #6b7280;
        }
        .filter-card {
          border: 1px solid #e5e7eb;
        }
        .toolbar .btn {
          min-width: 96px;
        }
        #itemGrid.ag-theme-quartz {
          height: 360px;
          width: 100%;
        }
        .summary-bar {
          font-weight: 600;
        }
      </style>
    </th:block>
  </head>

  <body>
    <section layout:fragment="content">
      <div class="card shadow">
        <!-- 헤더 -->
        <div
          class="card-header d-flex align-items-center justify-content-between"
        >
          <h5 class="mb-0">출하지시서 입력</h5>
          <div class="d-flex gap-2">
            <button
              type="button"
              class="btn btn-outline-secondary btn-slim"
              id="btnReset"
            >
              <i class="bi bi-arrow-counterclockwise me-1"></i>초기화
            </button>
            <button type="button" class="btn btn-primary btn-slim" id="btnSave">
              <i class="bi bi-check2 me-1"></i>등록
            </button>
          </div>
        </div>

        <div class="card-body">
          <!-- 상단 입력 폼 -->
          <div class="card filter-card p-3 mb-3">
            <div class="row g-3">
              <!-- 작성일자 -->
              <div class="col-md-3">
                <label class="form-label">작성일자</label>
                <input type="date" class="form-control" id="writeDate" />
              </div>

              <!-- 거래처 -->
              <div class="col-md-3">
                <label class="form-label">거래처</label>
                <div class="input-group">
                  <input
                    type="text"
                    class="form-control"
                    id="customerName"
                    placeholder="거래처명"
                  />
                  <button
                    type="button"
                    class="btn btn-outline-secondary"
                    id="btnFindCustomer"
                    data-bs-toggle="modal"
                    data-bs-target="#customermodal"
                  >
                    <i class="bi bi-search"></i>
                  </button>
                </div>
                <input type="hidden" id="customerCode" />
              </div>

              <!-- 담당자 -->
              <div class="col-md-3">
                <label class="form-label">담당자</label>
                <div class="input-group">
                  <input
                    type="text"
                    class="form-control"
                    id="managerName"
                    placeholder="담당자명"
                  />
                  <button
                    type="button"
                    class="btn btn-outline-secondary"
                    id="btnFindManager"
                  >
                    <i class="bi bi-search"></i>
                  </button>
                </div>
              </div>

              <!-- 연락처 -->
              <div class="col-md-3">
                <label class="form-label">연락처</label>
                <input
                  type="text"
                  class="form-control"
                  id="phone"
                  placeholder="연락처"
                />
              </div>
            </div>

            <div class="row g-3 mt-1">
              <!-- 출하예정일 -->
              <div class="col-md-3">
                <label class="form-label">출하예정일</label>
                <input type="date" class="form-control" id="shipDate" />
              </div>

              <!-- 다음 주소 API 사용-->
              <!-- 도로명주소 -->
              <div class="col-md-3">
                <label class="form-label">도로명주소</label>
                <div class="input-group">
                  <input
                    type="text"
                    class="form-control"
                    id="sample4_roadAddress"
                    placeholder="주소"
                  />
                  <button
                    type="button"
                    onclick="sample4_execDaumPostcode()"
                    class="btn btn-outline-secondary"
                    id="btnf"
                  >
                    <i class="bi bi-search"></i>
                  </button>
                </div>
              </div>

              <!-- 지번주소 -->
              <div class="col-md-3">
                <label class="form-label">지번주소</label>
                <div class="input-group">
                  <input
                    type="text"
                    class="form-control"
                    id="sample4_jibunAddress"
                    placeholder="지번주소"
                  />
                </div>
              </div>

              <!-- 상세주소 -->
              <div class="col-md-3">
                <label class="form-label">상세주소</label>
                <div class="input-group">
                  <input
                    type="text"
                    class="form-control"
                    id="sample4_detailAddress"
                    placeholder="주소"
                  />
                </div>
              </div>

              <!-- 우편번호 -->
              <div class="col-md-3">
                <label class="form-label">우편번호</label>
                <div class="input-group">
                  <input
                    type="text"
                    class="form-control"
                    id="sample4_postcode"
                    placeholder="우편번호"
                  />
                </div>
              </div>

              <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
              <script>
                function sample4_execDaumPostcode() {
                  new daum.Postcode({
                    oncomplete: function (data) {
                      var roadAddr = data.roadAddress;
                      document.getElementById("sample4_postcode").value =
                        data.zonecode;
                      document.getElementById("sample4_roadAddress").value =
                        roadAddr;
                      document.getElementById("sample4_jibunAddress").value =
                        data.jibunAddress;
                    },
                  }).open();
                }
              </script>
            </div>

            <!-- 조회 버튼 그룹 -->
            <div class="toolbar d-flex gap-2 mt-3">
              <button
                type="button"
                class="btn btn-outline-secondary btn-slim"
                id="btnFindProduct"
                data-bs-toggle="modal"
                data-bs-target="#productcodeModal"
              >
                품목코드
              </button>
              <button
                type="button"
                class="btn btn-outline-secondary btn-slim"
                id="btnFindOrder"
              >
                주문서조회
              </button>
              <button
                type="button"
                class="btn btn-outline-secondary btn-slim"
                id="btnFindHistory"
              >
                거래내역조회
              </button>
            </div>
          </div>

          <!-- 품목 Grid -->
          <div id="itemGrid" class="ag-theme-quartz"></div>

          <!-- 하단 합계/행조작 -->
          <div class="d-flex justify-content-between align-items-center mt-2">
            <div class="d-flex gap-2">
              <button
                type="button"
                class="btn btn-outline-primary btn-slim"
                id="btnAddRow"
              >
                <i class="bi bi-plus-circle me-1"></i>행 추가
              </button>
              <button
                type="button"
                class="btn btn-outline-danger btn-slim"
                id="btnDelRow"
              >
                <i class="bi bi-dash-circle me-1"></i>선택 삭제
              </button>
              <button
                type="button"
                class="btn btn-outline-secondary btn-slim"
                id="btnClearRows"
              >
                <i class="bi bi-trash me-1"></i>전체 비우기
              </button>
            </div>
            <div class="summary-bar">
              총 수량: <span id="sumQty">0</span> | 총 공급가액:
              <span id="sumSupply">0</span> | 총 부가세:
              <span id="sumVat">0</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Toast -->
      <div class="position-fixed top-0 end-0 p-3" style="z-index: 1080">
        <div
          id="successToast"
          class="toast align-items-center text-bg-success border-0"
          role="alert"
          aria-live="assertive"
          aria-atomic="true"
        >
          <div class="toast-body" id="toastMessage">처리가 완료되었습니다.</div>
        </div>
      </div>

      <!-- 모달 -->
      <!-- 거래처 모달 -->
      <div th:replace="~{biz/modals/PoCustomerModal :: customermodal}"></div>
      <!-- 품목코드 모달 -->
      <div
        th:replace="~{biz/modals/ProductCodeModal :: productcodeModal}"
      ></div>
      <!-- 주문서 모달 -->
      <!-- <div th:replace="~{biz/modals/PoHistoryModal :: PoHistoryModal}"></div> -->
    </section>

    <th:block layout:fragment="body_extra">
      <script
        src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"
      ></script>
      <script
        src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
      ></script>
      <script
        src="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/dist/ag-grid-community.min.noStyle.js"
      ></script>
      <script
        src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"
        crossorigin="anonymous"
        referrerpolicy="no-referrer"
      ></script>

      <script th:inline="none">
        document.addEventListener("DOMContentLoaded", () => {
          // ===== 공통 =====
          const numberParser = (v) => {
            const n = Number(String(v ?? "").replaceAll(",", ""));
            return isNaN(n) ? null : n;
          };
          const computeRow = (d) => {
            const qty = Number(d.qty || 0);
            const price = Number(d.price || 0);
            d.supplyAmt = qty * price;
            d.vat = Math.round(d.supplyAmt * 0.1);
          };

          // ===== 폼 =====
          const writeDate = document.getElementById("writeDate");
          const customerCode = document.getElementById("customerCode");
          const customerName = document.getElementById("customerName");
          const managerName = document.getElementById("managerName");
          const phone = document.getElementById("phone");
          const shipDate = document.getElementById("shipDate");

          const zipEl = document.getElementById("sample4_postcode");
          const roadEl = document.getElementById("sample4_roadAddress");
          const detailEl = document.getElementById("sample4_detailAddress");

          const btnReset = document.getElementById("btnReset");
          const btnSave = document.getElementById("btnSave");
          const btnAddRow = document.getElementById("btnAddRow");
          const btnDelRow = document.getElementById("btnDelRow");
          const btnClearRows = document.getElementById("btnClearRows");

          const sumQty = document.getElementById("sumQty");
          const sumSupply = document.getElementById("sumSupply");
          const sumVat = document.getElementById("sumVat");

          // ===== 아이템 그리드 =====
          const itemColumnDefs = [
            { headerName: "", checkboxSelection: true, width: 50 },
            {
              headerName: "품목코드",
              field: "code",
              editable: true,
              width: 120,
            },
            {
              headerName: "품목명",
              field: "name",
              editable: true,
              minWidth: 160,
            },
            {
              headerName: "결제방식",
              field: "payType",
              editable: true,
              width: 120,
              cellEditor: "agSelectCellEditor",
              cellEditorParams: { values: ["현금", "어음"] },
            },
            {
              headerName: "수량",
              field: "qty",
              editable: true,
              width: 110,
              type: "rightAligned",
              valueParser: (p) => numberParser(p.newValue),
              valueFormatter: (p) => (p.value ?? 0).toLocaleString(),
              onCellValueChanged: (p) => {
                computeRow(p.data);
                itemGridOptions.api.refreshCells({ force: true });
                updateSummary();
              },
            },
            {
              headerName: "단가",
              field: "price",
              editable: true,
              width: 120,
              type: "rightAligned",
              valueParser: (p) => numberParser(p.newValue),
              valueFormatter: (p) => (p.value ?? 0).toLocaleString(),
              onCellValueChanged: (p) => {
                computeRow(p.data);
                itemGridOptions.api.refreshCells({ force: true });
                updateSummary();
              },
            },
            {
              headerName: "부가세",
              field: "vat",
              editable: false,
              width: 120,
              type: "rightAligned",
              valueFormatter: (p) => (p.value ?? 0).toLocaleString(),
            },
            {
              headerName: "공급가액",
              field: "supplyAmt",
              editable: false,
              width: 130,
              type: "rightAligned",
              valueFormatter: (p) => (p.value ?? 0).toLocaleString(),
            },
            {
              headerName: "비고",
              field: "note",
              editable: true,
              minWidth: 160,
            },
          ];

          const itemGridOptions = {
            columnDefs: itemColumnDefs,
            rowData: [],
            rowSelection: "multiple",
            rowMultiSelectWithClick: true,
            animateRows: true,
            defaultColDef: {
              sortable: true,
              resizable: true,
              filter: false,
              minWidth: 90,
            },
            onGridReady: (e) => e.api.sizeColumnsToFit(),
          };
          const itemGridDiv = document.getElementById("itemGrid");
          new agGrid.Grid(itemGridDiv, itemGridOptions);

          function updateSummary() {
            let tQty = 0,
              tSupply = 0,
              tVat = 0;
            itemGridOptions.api.forEachNode((n) => {
              tQty += Number(n.data.qty || 0);
              tSupply += Number(n.data.supplyAmt || 0);
              tVat += Number(n.data.vat || 0);
            });
            sumQty.textContent = tQty.toLocaleString();
            sumSupply.textContent = tSupply.toLocaleString();
            sumVat.textContent = tVat.toLocaleString();
          }

          // 행 조작
          btnAddRow.addEventListener("click", () => {
            itemGridOptions.api.applyTransaction({
              add: [
                {
                  code: "",
                  name: "",
                  payType: "현금",
                  qty: null,
                  price: null,
                  vat: 0,
                  supplyAmt: 0,
                  note: "",
                },
              ],
            });
          });
          btnDelRow.addEventListener("click", () => {
            const sel = itemGridOptions.api.getSelectedRows();
            if (!sel.length) return toastr.info("삭제할 행을 선택하세요");
            itemGridOptions.api.applyTransaction({ remove: sel });
            updateSummary();
          });
          btnClearRows.addEventListener("click", () => {
            itemGridOptions.api.setRowData([]);
            updateSummary();
          });

          btnReset.addEventListener("click", () => {
            writeDate.value = "";
            customerCode.value = "";
            customerName.value = "";
            managerName.value = "";
            phone.value = "";
            shipDate.value = "";
            zipEl && (zipEl.value = "");
            roadEl && (roadEl.value = "");
            detailEl && (detailEl.value = "");
            itemGridOptions.api.setRowData([]);
            updateSummary();
          });

          // 저장
          btnSave.addEventListener("click", async () => {
            try {
              const header = {
                writeDate: writeDate.value,
                customerCode: customerCode.value,
                managerName: managerName.value,
                phone: phone.value,
                shipDate: shipDate.value,
                zipCode: zipEl?.value || "",
                address: roadEl?.value || "",
                detailAddress: detailEl?.value || "",
              };
              if (!header.writeDate)
                return toastr.error("작성일자를 입력하세요");
              if (!header.customerName)
                return toastr.error("거래처를 입력하세요");
              if (!header.shipDate)
                return toastr.error("출하예정일을 입력하세요");

              const items = [];
              itemGridOptions.api.forEachNode((n) => {
                const d = { ...n.data };
                computeRow(d);
                items.push(d);
              });
              if (!items.length)
                return toastr.error("품목을 1개 이상 추가하세요");

              await axios.post("/api/biz/doinsert", { header, items });
              toastr.success("등록되었습니다");
            } catch (e) {
              console.error(e);
              toastr.error("등록에 실패했습니다");
            }
          });

          /*

                        ======================== 품목코드 모달 ========================


                  */
          const productModalEl = document.getElementById("productcodeModal");
          let productGridApi;
          const productColumnDefs = [
            { headerName: "", checkboxSelection: true, width: 50 },
            { headerName: "품목코드", field: "productCode", width: 140 },
            {
              headerName: "품목명",
              field: "productName",
              flex: 1,
              minWidth: 160,
            },
          ];
          if (productModalEl) {
            productModalEl.addEventListener("shown.bs.modal", () => {
              const gridDiv = document.getElementById("productGrid");
              if (!productGridApi) {
                if (window.agGrid?.createGrid) {
                  productGridApi = agGrid.createGrid(
                    gridDiv,
                    productGridOptions
                  );
                } else {
                  productGridApi = productGridOptions.api;
                }
              }
              fetchProductData();
            });
          }
          const productGridOptions = {
            columnDefs: productColumnDefs,
            rowSelection: "multiple",
            rowMultiSelectWithClick: true,
            rowData: [],
            defaultColDef: { sortable: true, resizable: true, filter: true },
            onGridReady: (p) => {
              productGridApi = p.api;
            },
          };

          async function fetchProductData() {
            if (!productGridApi) return;
            try {
              const { data } = await axios.get("/api/biz/productcode");
              productGridApi.setRowData(data || []);
            } catch (err) {
              console.error("품목 데이터 조회 실패:", err);
              alert("품목 데이터를 불러오는 데 실패했습니다.");
            }
          }

          // 품목코드 모달의 가져오기 버튼 클릭 이벤트
          const importProductBtn = document.getElementById("PrcImportBtn");
          if (importProductBtn) {
            importProductBtn.addEventListener("click", () => {
              const selectedRows = productGridApi.getSelectedRows();
              if (!selectedRows || selectedRows.length === 0) {
                return alert("가져올 품목을 선택하세요.");
              }

              const newItems = selectedRows.map((row) => ({
                productCode: row.productCode,
                productName: row.productName,
                unitPrice: row.unitPrice || null,
                orderQty: null,
                dcPrice: null,
                notes: "",
              }));

              gridApi.applyTransaction({ add: newItems });
              updatePinned();

              const modal = bootstrap.Modal.getInstance(productModalEl);
              modal?.hide();
            });
          } else {
            console.warn(
              "가져오기 버튼(#PrcImportBtn)을 modal HTML에 추가해주세요."
            );
          }
        });

        /*

                        ======================== 거래처 모달 ========================


                */
        document.addEventListener("DOMContentLoaded", () => {
          const customerCodeModalEl = document.getElementById("customermodal");
          let customerCodeGridApi;
          const customerCodeColumnDefs = [
            { headerName: "", checkboxSelection: true, width: 50 },
            { headerName: "거래처코드", field: "cusCode", width: 140 },
            {
              headerName: "거래처명",
              field: "cusName",
              flex: 1,
              minWidth: 160,
            },
            { headerName: "신용등급", field: "creditGrade", width: 140 },
            { headerName: "미수금", field: "leftPrice", width: 140 },
          ];
          async function fetchCustomerCodeData() {
            if (!customerCodeGridApi) return;
            try {
              const { data } = await axios.get("/api/biz/customercode");
              customerCodeGridApi.setRowData(data || []);
              customerCodeGridApi.sizeColumnsToFit?.();
            } catch (err) {
              console.error("거래처조회 실패:", err);
              alert("거래처 불러오는 데 실패했습니다.");
            }
          }
          if (customerCodeModalEl) {
            customerCodeModalEl.addEventListener("shown.bs.modal", () => {
              const gridDiv = document.getElementById("customerGrid");
              if (!customerCodeGridApi) {
                if (window.agGrid?.createGrid) {
                  customerCodeGridApi = agGrid.createGrid(
                    gridDiv,
                    customerCodeGridOptions
                  );
                } else {
                  customerCodeGridApi = customerCodeGridOptions.api;
                }
              }
              fetchCustomerCodeData();
            });
          }
          const customerCodeGridOptions = {
            columnDefs: customerCodeColumnDefs,
            rowSelection: "single",
            rowData: [],
            defaultColDef: { sortable: true, resizable: true, filter: true },
            onGridReady: (p) => {
              customerCodeGridApi = p.api;
            },
          };

          // 1) 거래처 선택 시 코드/이름 모두 세팅
          function assignCustomerToForm(row) {
            const cusNameEl = document.getElementById("customerName");
            const cusCodeEl = document.getElementById("customerCode");
            if (cusNameEl) cusNameEl.value = row.cusName ?? "";
            if (cusCodeEl) cusCodeEl.value = row.cusCode ?? "";
          }

          // 거래처 모달의 선택 버튼 클릭 이벤트
          const importCustomerCodeBtn = document.getElementById("CstImportBtn");
          if (importCustomerCodeBtn) {
            importCustomerCodeBtn.addEventListener("click", () => {
              if (!customerCodeGridApi) return alert("목록을 먼저 불러오세요.");
              const selected = customerCodeGridApi.getSelectedRows?.() || [];
              if (!selected.length) return alert("거래처를 선택하세요.");

              assignCustomerToForm(selected[0]);

              const modal = bootstrap.Modal.getInstance(customerCodeModalEl);
              modal?.hide();
            });
          } else {
            console.warn(
              "가져오기 버튼(#CstImportBtn)을 modal HTML에 추가해주세요."
            );
          }
        });
      </script>
    </th:block>
  </body>
</html>
