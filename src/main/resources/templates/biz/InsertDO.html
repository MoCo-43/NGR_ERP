<!DOCTYPE html>
<html
  lang="ko"
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layout/base}"
>
  <head>
    <meta charset="UTF-8" />
    <title layout:fragment="title">출하지시서 입력</title>

    <th:block layout:fragment="head_extra">
      <!-- Bootstrap -->
      <link
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
        rel="stylesheet"
        crossorigin="anonymous"
      />
      <link
        href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
        rel="stylesheet"
      />

      <!-- AG Grid -->
      <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/styles/ag-grid.css"
      />
      <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/styles/ag-theme-quartz.css"
      />

      <!-- Toastr -->
      <link
        rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.css"
        crossorigin="anonymous"
        referrerpolicy="no-referrer"
      />

      <style>
        .form-label {
          font-weight: 600;
        }
        .btn-slim {
          padding: 0.375rem 0.75rem;
        }
        .btn-wide {
          min-width: 110px;
        }
        .muted {
          font-size: 12px;
          color: #6b7280;
        }
        .filter-card {
          border: 1px solid #e5e7eb;
        }
        .toolbar .btn {
          min-width: 96px;
        }
        #itemGrid.ag-theme-quartz {
          height: 360px;
          width: 100%;
        }
        .summary-bar {
          font-weight: 600;
        }
      </style>
    </th:block>
  </head>

  <body>
    <section layout:fragment="content">
      <div class="card shadow">
        <!-- 헤더 -->
        <div
          class="card-header d-flex align-items-center justify-content-between"
        >
          <h5 class="mb-0">출하지시서 입력</h5>
          <div class="d-flex gap-2">
            <button
              type="button"
              class="btn btn-outline-secondary btn-slim"
              id="btnReset"
            >
              <i class="bi bi-arrow-counterclockwise me-1"></i>초기화
            </button>
            <button type="button" class="btn btn-primary btn-slim" id="btnSave">
              <i class="bi bi-check2 me-1"></i>등록
            </button>
          </div>
        </div>

        <div class="card-body">
          <!-- 상단 입력 폼 -->
          <div class="card filter-card p-3 mb-3">
            <div class="row g-3">
              <!-- 작성일자 -->
              <div class="col-md-3">
                <label class="form-label">작성일자</label>
                <input type="date" class="form-control" id="writeDate" />
              </div>

              <!-- 거래처 -->
              <div class="col-md-3">
                <label class="form-label">거래처</label>
                <div class="input-group">
                  <input
                    type="text"
                    class="form-control"
                    id="customerName"
                    placeholder="거래처명"
                  />
                  <button
                    type="button"
                    class="btn btn-outline-secondary"
                    id="btnFindCustomer"
                    data-bs-toggle="modal"
                    data-bs-target="#customermodal"
                  >
                    <i class="bi bi-search"></i>
                  </button>
                </div>
                <input type="hidden" id="customerCode" />
              </div>

              <!-- 담당자 -->
              <div class="col-md-3">
                <label class="form-label">담당자</label>
                <div class="input-group">
                  <input
                    type="text"
                    class="form-control"
                    id="managerName"
                    placeholder="담당자명"
                    data-bs-toggle="modal"
                    data-bs-target="#"
                  />
                  <button
                    type="button"
                    class="btn btn-outline-secondary"
                    id="btnFindManager"
                  >
                    <i class="bi bi-search"></i>
                  </button>
                </div>
              </div>

              <!-- 연락처 -->
              <div class="col-md-3">
                <label class="form-label">연락처</label>
                <input
                  type="text"
                  class="form-control"
                  id="phone"
                  placeholder="연락처"
                />
              </div>
            </div>

            <div class="row g-3 mt-1">
              <!-- 출하예정일 -->
              <div class="col-md-3">
                <label class="form-label">출하예정일</label>
                <input type="date" class="form-control" id="shipDate" />
              </div>

              <!-- 다음 주소 API 사용-->
              <!-- 도로명주소 -->
              <div class="col-md-3">
                <label class="form-label">도로명주소</label>
                <div class="input-group">
                  <input
                    type="text"
                    class="form-control"
                    id="sample4_roadAddress"
                    placeholder="주소"
                  />
                  <button
                    type="button"
                    onclick="sample4_execDaumPostcode()"
                    class="btn btn-outline-secondary"
                    id="btnf"
                  >
                    <i class="bi bi-search"></i>
                  </button>
                </div>
              </div>

              <!-- 지번주소 -->
              <div class="col-md-3">
                <label class="form-label">지번주소</label>
                <div class="input-group">
                  <input
                    type="text"
                    class="form-control"
                    id="sample4_jibunAddress"
                    placeholder="지번주소"
                  />
                </div>
              </div>

              <!-- 상세주소 -->
              <div class="col-md-3">
                <label class="form-label">상세주소</label>
                <div class="input-group">
                  <input
                    type="text"
                    class="form-control"
                    id="sample4_detailAddress"
                    placeholder="주소"
                  />
                </div>
              </div>

              <!-- 우편번호 -->
              <div class="col-md-3">
                <label class="form-label">우편번호</label>
                <div class="input-group">
                  <input
                    type="text"
                    class="form-control"
                    id="sample4_postcode"
                    placeholder="우편번호"
                  />
                </div>
              </div>

              <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
              <script>
                //본 예제에서는 도로명 주소 표기 방식에 대한 법령에 따라, 내려오는 데이터를 조합하여 올바른 주소를 구성하는 방법을 설명합니다.
                function sample4_execDaumPostcode() {
                  new daum.Postcode({
                    oncomplete: function (data) {
                      // 팝업에서 검색결과 항목을 클릭했을때 실행할 코드를 작성하는 부분.

                      // 도로명 주소의 노출 규칙에 따라 주소를 표시한다.
                      // 내려오는 변수가 값이 없는 경우엔 공백('')값을 가지므로, 이를 참고하여 분기 한다.
                      var roadAddr = data.roadAddress; // 도로명 주소 변수
                      var extraRoadAddr = ""; // 참고 항목 변수

                      // 법정동명이 있을 경우 추가한다. (법정리는 제외)
                      // 법정동의 경우 마지막 문자가 "동/로/가"로 끝난다.
                      if (
                        data.bname !== "" &&
                        /[동|로|가]$/g.test(data.bname)
                      ) {
                        extraRoadAddr += data.bname;
                      }
                      // 건물명이 있고, 공동주택일 경우 추가한다.
                      if (data.buildingName !== "" && data.apartment === "Y") {
                        extraRoadAddr +=
                          extraRoadAddr !== ""
                            ? ", " + data.buildingName
                            : data.buildingName;
                      }
                      // 표시할 참고항목이 있을 경우, 괄호까지 추가한 최종 문자열을 만든다.
                      if (extraRoadAddr !== "") {
                        extraRoadAddr = " (" + extraRoadAddr + ")";
                      }

                      // 우편번호와 주소 정보를 해당 필드에 넣는다.
                      document.getElementById("sample4_postcode").value =
                        data.zonecode;
                      document.getElementById("sample4_roadAddress").value =
                        roadAddr;
                      document.getElementById("sample4_jibunAddress").value =
                        data.jibunAddress;

                      var guideTextBox = document.getElementById("guide");
                      // 사용자가 '선택 안함'을 클릭한 경우, 예상 주소라는 표시를 해준다.
                      if (data.autoRoadAddress) {
                        var expRoadAddr = data.autoRoadAddress + extraRoadAddr;
                        guideTextBox.innerHTML =
                          "(예상 도로명 주소 : " + expRoadAddr + ")";
                        guideTextBox.style.display = "block";
                      } else if (data.autoJibunAddress) {
                        var expJibunAddr = data.autoJibunAddress;
                        guideTextBox.innerHTML =
                          "(예상 지번 주소 : " + expJibunAddr + ")";
                        guideTextBox.style.display = "block";
                      } else {
                        guideTextBox.innerHTML = "";
                        guideTextBox.style.display = "none";
                      }
                    },
                  }).open();
                }
              </script>
            </div>

            <!-- 조회 버튼 그룹 -->
            <div class="toolbar d-flex gap-2 mt-3">
              <button
                type="button"
                class="btn btn-outline-secondary btn-slim"
                id="btnFindProduct"
              >
                품목코드
              </button>
              <button
                type="button"
                class="btn btn-outline-secondary btn-slim"
                id="btnFindOrder"
              >
                주문서조회
              </button>
              <button
                type="button"
                class="btn btn-outline-secondary btn-slim"
                id="btnFindHistory"
              >
                거래내역조회
              </button>
            </div>
          </div>

          <!-- 품목 Grid -->
          <div id="itemGrid" class="ag-theme-quartz"></div>

          <!-- 하단 합계/행조작 -->
          <div class="d-flex justify-content-between align-items-center mt-2">
            <div class="d-flex gap-2">
              <button
                type="button"
                class="btn btn-outline-primary btn-slim"
                id="btnAddRow"
              >
                <i class="bi bi-plus-circle me-1"></i>행 추가
              </button>
              <button
                type="button"
                class="btn btn-outline-danger btn-slim"
                id="btnDelRow"
              >
                <i class="bi bi-dash-circle me-1"></i>선택 삭제
              </button>
              <button
                type="button"
                class="btn btn-outline-secondary btn-slim"
                id="btnClearRows"
              >
                <i class="bi bi-trash me-1"></i>전체 비우기
              </button>
            </div>
            <div class="summary-bar">
              총 수량: <span id="sumQty">0</span> | 총 공급가액:
              <span id="sumSupply">0</span> | 총 부가세:
              <span id="sumVat">0</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Toast -->
      <div class="position-fixed top-0 end-0 p-3" style="z-index: 1080">
        <div
          id="successToast"
          class="toast align-items-center text-bg-success border-0"
          role="alert"
          aria-live="assertive"
          aria-atomic="true"
        >
          <div class="toast-body" id="toastMessage">처리가 완료되었습니다.</div>
        </div>
      </div>

      <!-- 모달설정 -->

      <!-- 거래처모달 -->
      <div>
        <th:replace
          fragment="customermodal"
          th:replace="~{biz/modals/PoCustomerModal :: customermodal}"
        ></th:replace>
      </div>
      <!-- 품목모달 -->
      <!-- <div th:replace
        fragment="itemmodal"
        th:replace="~{biz/modals/ProductCodeModal :: productcodeModal}"
      ></div th:replace> -->
    </section>

    <th:block layout:fragment="body_extra">
      <script
        src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"
      ></script>
      <script
        src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
      ></script>
      <script
        src="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/dist/ag-grid-community.min.noStyle.js"
      ></script>
      <script
        src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"
        crossorigin="anonymous"
        referrerpolicy="no-referrer"
      ></script>

      <script th:inline="none">
        document.addEventListener("DOMContentLoaded", () => {
          // ===== Header DOM =====
          const writeDate = document.getElementById("writeDate");
          const customerCode = document.getElementById("customerCode");
          const customerName = document.getElementById("customerName");
          const managerName = document.getElementById("managerName");
          const phone = document.getElementById("phone");
          const shipDate = document.getElementById("shipDate");
          const zipCode = document.getElementById("zipCode");
          const address = document.getElementById("address");

          const btnReset = document.getElementById("btnReset");
          const btnSave = document.getElementById("btnSave");
          const btnAddRow = document.getElementById("btnAddRow");
          const btnDelRow = document.getElementById("btnDelRow");
          const btnClearRows = document.getElementById("btnClearRows");

          const sumQty = document.getElementById("sumQty");
          const sumSupply = document.getElementById("sumSupply");
          const sumVat = document.getElementById("sumVat");

          // ===== AG Grid 설정 =====
          const numberParser = (params) => {
            const v = params.newValue ?? params.value ?? "";
            if (v === null || v === undefined || v === "") return null;
            const n = Number(String(v).replaceAll(",", ""));
            return isNaN(n) ? null : n;
          };

          const computeRow = (data) => {
            const qty = Number(data.qty || 0);
            const price = Number(data.price || 0);
            // 공급가액 = 수량 * 단가
            const supplyAmt = qty * price;
            data.supplyAmt = supplyAmt;
            // 부가세 = 공급가액 * 0.1 (VAT 10%) - 프로젝트 정책에 맞게 수정
            data.vat = Math.round(supplyAmt * 0.1);
          };

          const columnDefs = [
            {
              headerName: "품목코드",
              field: "code",
              editable: true,
              width: 120,
              cellEditor: "agTextCellEditor",
            },
            {
              headerName: "품목명",
              field: "name",
              editable: true,
              minWidth: 160,
              cellEditor: "agTextCellEditor",
            },
            {
              headerName: "결제방식",
              field: "payType",
              editable: true,
              width: 120,
              cellEditor: "agSelectCellEditor",
              cellEditorParams: { values: ["현금", "어음"] },
            },
            {
              headerName: "수량",
              field: "qty",
              editable: true,
              width: 110,
              type: "rightAligned",
              valueParser: numberParser,
              valueFormatter: (p) => (p.value ?? 0).toLocaleString(),
              onCellValueChanged: (p) => {
                computeRow(p.data);
                gridOptions.api.refreshCells({ force: true });
                updateSummary();
              },
            },
            {
              headerName: "단가",
              field: "price",
              editable: true,
              width: 120,
              type: "rightAligned",
              valueParser: numberParser,
              valueFormatter: (p) => (p.value ?? 0).toLocaleString(),
              onCellValueChanged: (p) => {
                computeRow(p.data);
                gridOptions.api.refreshCells({ force: true });
                updateSummary();
              },
            },
            {
              headerName: "부가세",
              field: "vat",
              editable: false,
              width: 120,
              type: "rightAligned",
              valueFormatter: (p) => (p.value ?? 0).toLocaleString(),
            },
            {
              headerName: "공급가액",
              field: "supplyAmt",
              editable: false,
              width: 130,
              type: "rightAligned",
              valueFormatter: (p) => (p.value ?? 0).toLocaleString(),
            },
            {
              headerName: "비고",
              field: "note",
              editable: true,
              minWidth: 160,
            },
          ];

          const gridOptions = {
            columnDefs,
            rowData: [],
            rowSelection: "single",
            animateRows: true,
            defaultColDef: { sortable: true, resizable: true },
            onGridReady: () => gridOptions.api.sizeColumnsToFit(),
          };

          /*

                        ======================== 거래처 모달 ========================


                */

          // ===== 공통 Grid 초기화 유틸=====
          function initGrid({
            el,
            columnDefs,
            onGridReady,
            onRowDoubleClicked,
          }) {
            const e = document.getElementById(el);
            if (!e) {
              console.error(`${el} 요소를 찾지 못했습니다.`);
              return null;
            }
            const gridOptions = {
              columnDefs,
              rowData: [],
              rowSelection: "single",
              pagination: true,
              paginationPageSize: 12,
              defaultColDef: {
                resizable: true,
                sortable: true,
                minWidth: 100,
                filter: true,
              },
              onGridReady: (ev) => {
                gridOptions.api = ev.api;
                ev.api.sizeColumnsToFit();
                onGridReady && onGridReady(ev);
              },
              onRowDoubleClicked: (ev) =>
                onRowDoubleClicked && onRowDoubleClicked(ev),
            };
            new agGrid.Grid(e, gridOptions);
            return gridOptions;
          }

          // ===== 거래처 모달 =====
          (function setupCustomerModal() {
            const modalEl = document.getElementById("customermodal");
            if (!modalEl) return;

            // 부트스트랩 인스턴스
            const modal = bootstrap.Modal.getOrCreateInstance(modalEl);

            // 폼 필드 (값 주입 대상) - 네 페이지의 id에 정확히 맞춤
            const cusNameEl = document.getElementById("customerName");
            const cusCodeHiddenEl = document.getElementById("customerCode");

            // 그리드 상태
            let grid; // gridOptions
            let initialized = false;

            // 컬럼 정의 (팀원 스타일)
            const columnDefs = [
              { headerName: "거래처코드", field: "cusCode", width: 140 },
              {
                headerName: "거래처명",
                field: "cusName",
                flex: 1,
                minWidth: 160,
              },
              { headerName: "담당자명", field: "empName", width: 120 },
              { headerName: "사업자번호", field: "bizNo", width: 140 },
              { headerName: "신용등급", field: "creditGrade", width: 120 },
              {
                headerName: "미수금",
                field: "leftPrice",
                width: 120,
                valueFormatter: (p) => (p.value ?? 0).toLocaleString(),
              },
              { headerName: "주소", field: "addr", minWidth: 200, flex: 1 },
            ];

            // 데이터 로드 (엔드포인트는 프로젝트에 맞게 선택)
            async function loadCustomers() {
              try {
                const { data } = await axios.get("/api/biz/customercode");
                grid.api.setRowData(data || []);
                grid.api.sizeColumnsToFit();
              } catch (err) {
                console.error("거래처 로드 실패:", err);
                toastr?.error?.("거래처 목록 조회 실패");
              }
            }

            // 거래처 선택 후 모달창 닫기
            function pick(row) {
              if (!row) return;
              cusNameEl.value = row.cusName ?? "";
              cusCodeHiddenEl.value = row.cusCode ?? "";

              // modal.hide() 대신 close 버튼
              modalEl.querySelector(".btn-close")?.click();
            }

            // 모달 최초 오픈 시 그리드 1회 초기화
            modalEl.addEventListener("shown.bs.modal", () => {
              if (!initialized) {
                grid = initGrid({
                  el: "customerGrid",
                  columnDefs,
                  onGridReady: loadCustomers,
                  onRowDoubleClicked: (ev) => pick(ev.data),
                });
                initialized = true;
              } else {
                loadCustomers(); // 재오픈 시 최신화
              }
            });

            // 가져오기 버튼
            document
              .getElementById("CstImportBtn")
              ?.addEventListener("click", () => {
                const selected = grid?.api?.getSelectedRows?.() || [];
                if (!selected.length)
                  return toastr?.info?.("거래처를 선택하세요");
                pick(selected[0]);
              });
          })();

          new agGrid.Grid(document.getElementById("itemGrid"), gridOptions);

          // ===== 합계 =====
          function updateSummary() {
            let tQty = 0,
              tSupply = 0,
              tVat = 0;
            gridOptions.api.forEachNode((n) => {
              tQty += Number(n.data.qty || 0);
              tSupply += Number(n.data.supplyAmt || 0);
              tVat += Number(n.data.vat || 0);
            });
            sumQty.textContent = tQty.toLocaleString();
            sumSupply.textContent = tSupply.toLocaleString();
            sumVat.textContent = tVat.toLocaleString();
          }

          // ===== 버튼 동작 =====
          btnAddRow.addEventListener("click", () => {
            const newRow = {
              code: "",
              name: "",
              payType: "현금",
              qty: null,
              price: null,
              vat: 0,
              supplyAmt: 0,
              note: "",
            };
            gridOptions.api.applyTransaction({ add: [newRow] });
          });

          btnDelRow.addEventListener("click", () => {
            const sel = gridOptions.api.getSelectedRows();
            if (!sel.length) return toastr.info("삭제할 행을 선택하세요");
            gridOptions.api.applyTransaction({ remove: sel });
            updateSummary();
          });

          btnClearRows.addEventListener("click", () => {
            gridOptions.api.setRowData([]);
            updateSummary();
          });

          btnReset.addEventListener("click", () => {
            // 상단 입력 초기화
            writeDate.value = "";
            customerCode.value = "";
            customerName.value = "";
            managerName.value = "";
            phone.value = "";
            shipDate.value = "";
            zipCode.value = "";
            address.value = "";
            // 그리드 초기화
            gridOptions.api.setRowData([]);
            updateSummary();
          });

          // ===== 등록 =====
          btnSave.addEventListener("click", async () => {
            try {
              const header = {
                writeDate: writeDate.value,
                customerCode: customerCode.value,
                customerName: customerName.value,
                managerName: managerName.value,
                phone: phone.value,
                shipDate: shipDate.value,
                zipCode: zipCode.value,
                address: address.value,
              };

              // 필수값 검증 (프로젝트 정책에 맞게 추가/수정)
              if (!header.writeDate)
                return toastr.error("작성일자를 입력하세요");
              if (!header.customerName)
                return toastr.error("거래처를 입력하세요");
              if (!header.shipDate)
                return toastr.error("출하예정일을 입력하세요");

              const items = [];
              gridOptions.api.forEachNode((n) => {
                const d = { ...n.data };
                // 계산값 보정
                computeRow(d);
                items.push(d);
              });

              if (items.length === 0)
                return toastr.error("품목을 1개 이상 추가하세요");

              const payload = { header, items };

              // DB 등록처리
              await axios.post("/api/biz/doinsert", payload, {
                headers: { "Content-Type": "application/json" },
              });

              toastr.success("등록되었습니다");
            } catch (e) {
              console.error(e);
              toastr.error("등록에 실패했습니다");
            }
          });

          // ===== (선택) 품목 검색 예시 - 프로젝트에 맞게 교체 =====
          document
            .getElementById("btnFindProduct")
            .addEventListener("click", async () => {
              // 여기서는 간단히 데모 데이터 한 줄 추가
              const demo = {
                code: "A01",
                name: "맛있는쿠키",
                payType: "현금",
                qty: 100,
                price: 1000,
              };
              computeRow(demo);
              gridOptions.api.applyTransaction({ add: [demo] });
              updateSummary();
            });

          // 최초 한 줄 넣어 편집 유도(선택)
          btnAddRow.click();
        });
      </script>
    </th:block>
  </body>
</html>
