<!DOCTYPE html>
<html
  lang="ko"
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layout/base}"
>
  <head>
    <meta charset="UTF-8" />
    <title layout:fragment="title">출하지시서 입력</title>

    <th:block layout:fragment="head_extra">
      <!-- Bootstrap -->
      <link
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
        rel="stylesheet"
        crossorigin="anonymous"
      />
      <link
        href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
        rel="stylesheet"
      />

      <!-- AG Grid -->
      <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/styles/ag-grid.css"
      />
      <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/styles/ag-theme-quartz.css"
      />

      <style>
        .form-label {
          font-weight: 600;
        }
        .btn-slim {
          padding: 0.375rem 0.75rem;
        }
        .btn-wide {
          min-width: 110px;
        }
        .muted {
          font-size: 12px;
          color: #6b7280;
        }
        .filter-card {
          border: 1px solid #e5e7eb;
        }
        .toolbar .btn {
          min-width: 96px;
        }
        #itemGrid.ag-theme-quartz {
          height: 360px;
          width: 100%;
        }
        /* 모달 내부 그리드 높이 반드시 지정 */
        #poHistoryGrid.ag-theme-quartz,
        #productGrid.ag-theme-quartz,
        #customerGrid.ag-theme-quartz {
          height: 360px;
          width: 100%;
        }
        .summary-bar {
          font-weight: 600;
        }
      </style>
    </th:block>
  </head>

  <body>
    <section layout:fragment="content">
      <div class="card shadow">
        <!-- 헤더 -->
        <div
          class="card-header d-flex align-items-center justify-content-between"
        >
          <h5 class="mb-0">출하지시서 입력</h5>
          <div class="d-flex gap-2">
            <button
              type="button"
              class="btn btn-outline-secondary btn-slim"
              id="btnReset"
            >
              <i class="bi bi-arrow-counterclockwise me-1"></i>초기화
            </button>
            <button type="button" class="btn btn-primary btn-slim" id="btnSave">
              <i class="bi bi-check2 me-1"></i>등록
            </button>
          </div>
        </div>

        <div class="card-body">
          <!-- 상단 입력 폼 -->
          <div class="card filter-card p-3 mb-3">
            <div class="row g-3">
              <div class="col-md-3">
                <label class="form-label">작성일자</label>
                <input type="date" class="form-control" id="writeDate" />
              </div>

              <div class="col-md-3">
                <label class="form-label">거래처</label>
                <div class="input-group">
                  <input
                    type="text"
                    class="form-control"
                    id="customerName"
                    placeholder="거래처명"
                  />
                  <button
                    type="button"
                    class="btn btn-outline-secondary"
                    id="btnFindCustomer"
                    data-bs-toggle="modal"
                    data-bs-target="#customermodal"
                  >
                    <i class="bi bi-search"></i>
                  </button>
                </div>
                <input type="hidden" id="customerCode" />
              </div>

              <div class="col-md-3">
                <label class="form-label">담당자</label>
                <div class="input-group">
                  <span
                    class="form-control"
                    id="managerName"
                    th:text="${#authentication.principal.empLoginVO.name}"
                  ></span>
                </div>
              </div>

              <div class="col-md-3">
                <label class="form-label">연락처</label>
                <input
                  type="text"
                  class="form-control"
                  id="phone"
                  placeholder="연락처"
                />
              </div>
            </div>

            <div class="row g-3 mt-1">
              <div class="col-md-3">
                <label class="form-label">출하예정일</label>
                <input type="date" class="form-control" id="shipDate" />
              </div>

              <div class="col-md-3">
                <label class="form-label">도로명주소</label>
                <div class="input-group">
                  <input
                    type="text"
                    class="form-control"
                    id="sample4_roadAddress"
                    placeholder="주소"
                  />
                  <button
                    type="button"
                    onclick="sample4_execDaumPostcode()"
                    class="btn btn-outline-secondary"
                    id="btnf"
                  >
                    <i class="bi bi-search"></i>
                  </button>
                </div>
              </div>

              <div class="col-md-3">
                <label class="form-label">우편번호</label>
                <div class="input-group">
                  <input
                    type="text"
                    class="form-control"
                    id="sample4_postcode"
                    placeholder="우편번호"
                  />
                </div>
              </div>

              <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
              <script>
                function sample4_execDaumPostcode() {
                  new daum.Postcode({
                    oncomplete: function (data) {
                      document.getElementById("sample4_postcode").value =
                        data.zonecode;
                      document.getElementById("sample4_roadAddress").value =
                        data.roadAddress;
                    },
                  }).open();
                }
              </script>
            </div>

            <!-- 조회 버튼 그룹 -->
            <div class="toolbar d-flex gap-2 mt-3">
              <button
                type="button"
                class="btn btn-outline-secondary btn-slim"
                id="btnFindProduct"
                data-bs-toggle="modal"
                data-bs-target="#productcodeModal"
              >
                품목코드
              </button>
              <button
                type="button"
                class="btn btn-outline-secondary btn-slim"
                id="btnFindOrder"
                data-bs-toggle="modal"
                data-bs-target="#PoHistoryModal"
              >
                주문서조회
              </button>
            </div>
          </div>

          <!-- 품목 Grid -->
          <div id="itemGrid" class="ag-theme-quartz"></div>

          <!-- 하단 합계/행조작 -->
          <div class="d-flex justify-content-between align-items-center mt-2">
            <div class="d-flex gap-2">
              <button
                type="button"
                class="btn btn-outline-primary btn-slim"
                id="btnAddRow"
              >
                <i class="bi bi-plus-circle me-1"></i>행 추가
              </button>
              <button
                type="button"
                class="btn btn-outline-danger btn-slim"
                id="btnDelRow"
              >
                <i class="bi bi-dash-circle me-1"></i>선택 삭제
              </button>
              <button
                type="button"
                class="btn btn-outline-secondary btn-slim"
                id="btnClearRows"
              >
                <i class="bi bi-trash me-1"></i>전체 비우기
              </button>
            </div>
            <div class="summary-bar">
              총 수량: <span id="sumQty">0</span> | 총 공급가액:
              <span id="sumSupply">0</span> | 총 부가세:
              <span id="sumVat">0</span>
            </div>
          </div>
        </div>
      </div>

      <!-- 모달 모음 -->

      <!-- 거래처 모달 -->
      <div th:replace="~{biz/modals/PoCustomerModal :: customermodal}"></div>

      <!-- 품목코드 모달 -->
      <div
        th:replace="~{biz/modals/ProductCodeModal :: productcodeModal}"
      ></div>
      <!-- 주문서 모달 -->
      <div th:replace="~{biz/modals/PoHistoryModal :: PoHistoryModal}"></div>
    </section>

    <th:block layout:fragment="body_extra">
      <script
        src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"
      ></script>
      <script
        src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
      ></script>
      <script
        src="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/dist/ag-grid-community.min.noStyle.js"
      ></script>

      <script th:inline="none">
        // DOM refs
        const writeDateEl = document.getElementById("writeDate");
        const customerCodeEl = document.getElementById("customerCode");
        const customerNameEl = document.getElementById("customerName");
        const managerNameEl = document.getElementById("managerName");
        const phoneEl = document.getElementById("phone");
        const shipDateEl = document.getElementById("shipDate");
        const addrEL = document.getElementById("sample4_roadAddress");
        const zipCodeEL = document.getElementById("sample4_postcode");

        // ---------- 공통 유틸 ----------
        const parseNum = (v) => Number(String(v ?? "").replace(/,/g, "")) || 0;
        // 계산
        const computeRow = (d) => {
          d.supAmt = (d.orderQty || 0) * (d.unitPrice || 0);
          d.vatAmt = Math.round((d.supAmt || 0) * 0.1);
          return d;
        };

        // 합계
        function updateSummary() {
          if (!itemGridApi) return;
          let tQty = 0,
            tSup = 0,
            tVat = 0;
          itemGridApi.forEachNode((n) => {
            tQty += Number(n.data.orderQty || 0);
            tSup += Number(n.data.supAmt || 0);
            tVat += Number(n.data.vatAmt || 0);
          });
          sumQty.textContent = tQty.toLocaleString();
          sumSupply.textContent = tSup.toLocaleString();
          sumVat.textContent = tVat.toLocaleString();
        }

        // ---------- 메인 품목 그리드 ----------
        let itemGridApi = null;
        const itemGridOptions = {
          columnDefs: [
            { headerName: "", checkboxSelection: true, width: 50 },
            {
              headerName: "품목코드",
              field: "productCode",
              editable: true,
              width: 120,
            },
            {
              headerName: "품목명",
              field: "productName",
              editable: true,
              flex: 1,
            },
            {
              headerName: "지불방식",
              field: "payMethod",
              editable: true,
              width: 120,
              cellEditor: "agSelectCellEditor",
              cellEditorParams: { values: ["현금", "어음"] },
            },
            {
              headerName: "수량",
              field: "orderQty",
              editable: true,
              width: 100,
              type: "rightAligned",
              valueParser: (p) => parseNum(p.newValue),
              valueFormatter: (p) => (p.value ?? 0).toLocaleString(),
              onCellValueChanged: (p) => {
                computeRow(p.data);
                p.api.refreshCells({ force: true });
                updateSummary();
              },
            },
            {
              headerName: "단가",
              field: "unitPrice",
              editable: true,
              width: 120,
              type: "rightAligned",
              valueParser: (p) => parseNum(p.newValue),
              valueFormatter: (p) => (p.value ?? 0).toLocaleString(),
              onCellValueChanged: (p) => {
                computeRow(p.data);
                p.api.refreshCells({ force: true });
                updateSummary();
              },
            },
            {
              headerName: "부가세",
              field: "vatAmt",
              width: 100,
              type: "rightAligned",
            },
            {
              headerName: "공급가액",
              field: "supAmt",
              width: 120,
              type: "rightAligned",
            },
            { headerName: "비고", field: "note", editable: true, flex: 1 },
          ],
          rowData: [],
          rowSelection: "multiple",
          rowMultiSelectWithClick: true,
          animateRows: true,
          defaultColDef: {
            sortable: true,
            resizable: true,
            filter: false,
            minWidth: 90,
          },
          onGridReady: (e) => {
            itemGridApi = e.api;
            window.itemGridApi = e.api; // 모달에서 접근
            e.api.sizeColumnsToFit();
          },
        };
        new agGrid.Grid(document.getElementById("itemGrid"), itemGridOptions);

        // 합계 표시
        const sumQty = document.getElementById("sumQty");
        const sumSupply = document.getElementById("sumSupply");
        const sumVat = document.getElementById("sumVat");
        function updateSummary() {
          if (!itemGridApi) return;
          let tQty = 0,
            tSup = 0,
            tVat = 0;
          itemGridApi.forEachNode((n) => {
            tQty += Number(n.data.qty || 0);
            tSup += Number(n.data.supplyAmt || 0);
            tVat += Number(n.data.vat || 0);
          });
          sumQty.textContent = tQty.toLocaleString();
          sumSupply.textContent = tSup.toLocaleString();
          sumVat.textContent = tVat.toLocaleString();
        }
        window.updateSummary = updateSummary;

        // 버튼들
        document.getElementById("btnAddRow").onclick = () => {
          itemGridApi.applyTransaction({
            add: [
              {
                productCode: "",
                productName: "",
                payMethod: "현금",
                orderQty: 0,
                unitPrice: 0,
                vatAmt: 0,
                supAmt: 0,
                note: "",
              },
            ],
          });
        };
        document.getElementById("btnDelRow").onclick = () => {
          const sel = itemGridApi.getSelectedRows();
          if (!sel.length) return toastr.info("삭제할 행을 선택하세요");
          itemGridApi.applyTransaction({ remove: sel });
          updateSummary();
        };
        document.getElementById("btnClearRows").onclick = () => {
          itemGridApi.setRowData([]);
          updateSummary();
        };
        document.getElementById("btnReset").onclick = () => {
          [
            "writeDate",
            "customerCode",
            "customerName",
            "managerName",
            "phone",
            "shipDate",
          ].forEach((id) => (document.getElementById(id).value = ""));
          itemGridApi.setRowData([]);
          updateSummary();
        };

        // 저장
        document.getElementById("btnSave").onclick = async () => {
          const header = {
            writeDate: writeDateEl.value,
            customerCode: customerCodeEl.value,
            customerName: customerNameEl.value,
            managerName: managerNameEl.value,
            phone: phoneEl.value,
            shipDate: shipDateEl.value,
            addr: addrEL.value,
            zipCode: zipCodeEL.value,
            notes: document.getElementById("notes")?.value || "",
          };
          if (!header.writeDate) return toastr.error("작성일자를 입력하세요");
          if (!header.customerName) return toastr.error("거래처를 입력하세요");
          if (!header.shipDate) return toastr.error("출하예정일을 입력하세요");

          const lineItems = [];
          itemGridApi.forEachNode((n) =>
            lineItems.push(computeRow({ ...n.data }))
          );
          if (!lineItems.length)
            return toastr.error("품목을 1개 이상 추가하세요");

          const payload = {
            cusCode: header.customerCode,
            name: header.managerName,
            doCreated: header.writeDate,
            exDate: header.shipDate,
            addr: header.addr,
            zipCode: header.zipCode,
            notes: header.notes ?? "",
            companyCode: 1,
            dodetails: lineItems.map((it) => ({
              productCode: it.productCode,
              orderQty: it.orderQty ?? 0,
              unitPrice: it.unitPrice ?? 0,
              supAmt: it.supAmt ?? 0,
              vatAmt: it.vatAmt ?? 0,
              dcPrice: 0,
              companyCode: it.companyCode,
            })),
          };
          try {
            await axios.post("/api/biz/doinsert", payload);
            toastr.success("등록되었습니다");
          } catch (e) {
            console.error(e);
            toastr.error("등록 실패");
          }
        };

        /*---------- 
        
        
        
        품목코드 모달 





---------- 

        */
        const productModalEl = document.getElementById("productcodeModal");
        let productGridApi;
        const productGridOptions = {
          columnDefs: [
            { headerName: "", checkboxSelection: true, width: 50 },
            { headerName: "품목코드", field: "productCode", width: 140 },
            {
              headerName: "품목명",
              field: "productName",
              flex: 1,
              minWidth: 160,
            },
          ],
          rowSelection: "multiple",
          rowMultiSelectWithClick: true,
          rowData: [],
          defaultColDef: { sortable: true, resizable: true, filter: true },
          onGridReady: (p) => {
            productGridApi = p.api;
          },
        };
        function ensureProductGrid() {
          const gridDiv = document.getElementById("productGrid");
          if (!gridDiv) return;
          if (!gridDiv.__api) {
            if (window.agGrid?.createGrid)
              gridDiv.__api = agGrid.createGrid(gridDiv, productGridOptions);
            else {
              new agGrid.Grid(gridDiv, productGridOptions);
              gridDiv.__api = productGridOptions.api;
            }
          }
          productGridApi = gridDiv.__api;
        }
        async function fetchProductData() {
          if (!productGridApi) return;
          const { data } = await axios.get("/api/biz/productcode");
          productGridApi.setRowData(Array.isArray(data) ? data : []);
          requestAnimationFrame(() => productGridApi.sizeColumnsToFit?.());
        }
        productModalEl?.addEventListener("shown.bs.modal", async () => {
          ensureProductGrid();
          await fetchProductData();
        });
        document
          .getElementById("PrcImportBtn")
          ?.addEventListener("click", () => {
            const rows = productGridApi?.getSelectedRows?.() || [];
            if (!rows.length) return alert("가져올 품목을 선택하세요.");
            const items = rows.map((r) => ({
              productCode: r.productCode,
              productName: r.productName,
              payMethod: r.payMethod,
              orderQty: r.orderQty,
              vatAmt: r.vatAmt,
              supAmt: r.supAmt,
              note: r.note,
            }));
            window.itemGridApi.applyTransaction({ add: items });
            updateSummary();
            (
              bootstrap.Modal.getInstance(productModalEl) ||
              bootstrap.Modal.getOrCreateInstance(productModalEl)
            ).hide();
          });

        /* ----------
        
        
        
        
        거래처 모달 



----------
        */
        const customerModalEl = document.getElementById("customermodal");
        let customerGridApi;
        const customerGridOptions = {
          columnDefs: [
            { headerName: "", checkboxSelection: true, width: 50 },
            { headerName: "거래처코드", field: "cusCode", width: 140 },
            {
              headerName: "거래처명",
              field: "cusName",
              flex: 1,
              minWidth: 160,
            },
            { headerName: "신용등급", field: "creditGrade", width: 140 },
            { headerName: "미수금", field: "leftPrice", width: 140 },
          ],
          rowSelection: "single",
          rowData: [],
          defaultColDef: { sortable: true, resizable: true, filter: true },
          onGridReady: (p) => {
            customerGridApi = p.api;
          },
        };
        function ensureCustomerGrid() {
          const gridDiv = document.getElementById("customerGrid");
          if (!gridDiv) return;
          if (!gridDiv.__api) {
            if (window.agGrid?.createGrid)
              gridDiv.__api = agGrid.createGrid(gridDiv, customerGridOptions);
            else {
              new agGrid.Grid(gridDiv, customerGridOptions);
              gridDiv.__api = customerGridOptions.api;
            }
          }
          customerGridApi = gridDiv.__api;
        }
        async function fetchCustomerData() {
          if (!customerGridApi) return;
          const { data } = await axios.get("/api/biz/customercode");
          customerGridApi.setRowData(Array.isArray(data) ? data : []);
          requestAnimationFrame(() => customerGridApi.sizeColumnsToFit?.());
        }
        customerModalEl?.addEventListener("shown.bs.modal", async () => {
          ensureCustomerGrid();
          await fetchCustomerData();
        });
        document
          .getElementById("CstImportBtn")
          ?.addEventListener("click", () => {
            const sel = customerGridApi?.getSelectedRows?.() || [];
            if (!sel.length) return alert("거래처를 선택하세요.");
            document.getElementById("customerName").value =
              sel[0].cusName ?? "";
            document.getElementById("customerCode").value =
              sel[0].cusCode ?? "";
          });

        // ---------- 주문서조회 모달 ----------
        const poHistoryModalEl = document.getElementById("PoHistoryModal");
        let poHistoryGridApi;
        const poHistoryGridOptions = {
          columnDefs: [
            { headerName: "", checkboxSelection: true, width: 50 },
            { headerName: "작성일자", field: "poStart", width: 120 },
            {
              headerName: "거래처명",
              field: "cusName",
              flex: 1,
              minWidth: 150,
            },
            { headerName: "제품코드", field: "productCode", width: 120 },
            { headerName: "제품명", field: "productName", width: 150 },
            { headerName: "담당자", field: "creater", width: 100 },
            { headerName: "납기일자", field: "exDate", width: 120 },
            {
              headerName: "공급가액",
              field: "supAmt",
              width: 150,
              type: "rightAligned",
              valueFormatter: (p) =>
                p.value ? Number(p.value).toLocaleString("ko-KR") : "",
            },
          ],
          rowSelection: "multiple",
          rowMultiSelectWithClick: true,
          rowData: [],
          defaultColDef: { sortable: true, resizable: true, filter: true },
          onGridReady: (p) => {
            poHistoryGridApi = p.api;
          },
        };
        function ensurePoHistoryGrid(modalRoot) {
          let gridDiv =
            document.getElementById("poHistoryGrid") ||
            modalRoot?.querySelector("#poHistoryGrid");
          if (!gridDiv) return null;
          if (!gridDiv.__api) {
            // 높이 보장 (템플릿이 바뀌었을 경우 대비)
            if (!gridDiv.style.height) {
              gridDiv.style.height = "360px";
              gridDiv.style.width = "100%";
            }
            if (window.agGrid?.createGrid)
              gridDiv.__api = agGrid.createGrid(gridDiv, poHistoryGridOptions);
            else {
              new agGrid.Grid(gridDiv, poHistoryGridOptions);
              gridDiv.__api = poHistoryGridOptions.api;
            }
          }
          poHistoryGridApi = gridDiv.__api;
          return gridDiv;
        }
        async function fetchPoHistoryData() {
          if (!poHistoryGridApi) return;
          try {
            const { data } = await axios.get("/api/biz/pohistory");
            const rows = Array.isArray(data) ? data : [];
            poHistoryGridApi.setRowData(rows);
            requestAnimationFrame(() => poHistoryGridApi.sizeColumnsToFit?.());
          } catch (err) {
            console.error("[PoHistory] 조회 실패", err);
            toastr.error("주문 이력 조회 실패");
          }
        }
        // 문서 레벨에서 모달 shown을 잡아 방탄 처리
        document.addEventListener("shown.bs.modal", (ev) => {
          const modal = ev.target;
          if (!modal || modal.id !== "PoHistoryModal") return;
          const gridDiv = ensurePoHistoryGrid(modal);
          if (!gridDiv) {
            console.warn("[PoHistory] poHistoryGrid 요소 없음");
            return;
          }
          fetchPoHistoryData();
        });

        document
          .getElementById("PohImportBtn")
          ?.addEventListener("click", () => {
            if (!poHistoryGridApi)
              return alert("그리드 초기화가 아직 안 되었습니다.");
            const selectedRows = poHistoryGridApi.getSelectedRows?.() || [];
            if (!selectedRows.length)
              return alert("가져올 주문서의 행을 선택하세요.");

            const newItems = selectedRows.map((row) => ({
              productCode: row.productCode ?? "",
              productName: row.productName ?? "",
              orderQty: row.orderQty ?? 1,
              unitPrice: row.unitPrice ?? 0,
              supAmt: row.supAmt ?? (row.unitPrice || 0) * (row.orderQty || 1),
              vatAmt: Math.round(
                (row.supAmt ?? (row.unitPrice || 0) * (row.orderQty || 1)) * 0.1
              ),
              note: `${row.poStart || ""} 주문 건에서 가져옴`,
              payMethod: "현금",
            }));

            window.itemGridApi.applyTransaction({ add: newItems });
            window.updateSummary?.();
            (
              bootstrap.Modal.getInstance(poHistoryModalEl) ||
              bootstrap.Modal.getOrCreateInstance(poHistoryModalEl)
            ).hide();
          });
        console.log({
          modalExists: !!document.getElementById("PoHistoryModal"),
          gridExists: !!document.getElementById("poHistoryGrid"),
          button:
            document.querySelector('[data-bs-target="#PoHistoryModal"]')
              ?.outerHTML || null,
        });
      </script>
    </th:block>
  </body>
</html>
