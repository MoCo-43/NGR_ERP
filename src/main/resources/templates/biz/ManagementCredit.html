<!DOCTYPE html>
<html
  lang="ko"
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layout/base}"
>
  <head>
    <meta charset="UTF-8" />
    <title layout:fragment="title">거래처 여신 현황</title>

    <th:block layout:fragment="head_extra">
      <!-- AG Grid -->
      <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/styles/ag-grid.css"
      />
      <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/styles/ag-theme-quartz.css"
      />
      <style>
        #creditGrid.ag-theme-quartz {
          height: 560px;
          width: 100%;
        }
        .btn-filter-group .btn {
          min-width: 108px;
        }
        .search-box .form-control {
          min-width: 240px;
        }
        .search-box .input-group-text {
          cursor: pointer;
        }
        .muted {
          color: #6b7280;
          font-size: 12px;
        }
        .text-center {
          text-align: center;
        }
        .cell-bad {
          background: #fff2f2;
          color: #c62828;
          font-weight: 600;
        }
        .cell-good {
          background: #f2fff4;
          color: #2e7d32;
          font-weight: 600;
        }
      </style>
    </th:block>
  </head>

  <body>
    <section layout:fragment="content">
      <!-- 상단 검색/정렬 박스 -->
      <div class="card shadow mb-3">
        <div class="card-body">
          <div class="d-flex align-items-center gap-2 mb-3">
            <!-- 1. 정렬 버튼: 신용등급 / 상태 -->
            <div
              class="btn-group btn-filter-group"
              role="group"
              aria-label="sorters"
            >
              <button type="button" class="btn btn-primary" id="btnSortGrade">
                신용등급
              </button>
              <button
                type="button"
                class="btn btn-outline-secondary"
                id="btnSortState"
              >
                상태
              </button>
            </div>

            <div class="ms-auto d-flex gap-2">
              <button class="btn btn-outline-secondary" id="btnExport">
                CSV
              </button>
              <button class="btn btn-danger" id="btnReset">초기화</button>
            </div>
          </div>

          <!-- 상호 / 담당자 검색 -->
          <div class="row g-3 align-items-end">
            <div class="col-md-6">
              <label class="form-label">상호</label>
              <input
                type="text"
                id="qName"
                class="form-control"
                placeholder="거래처명(상호)"
              />
            </div>
            <div class="col-md-6">
              <label class="form-label">담당자</label>
              <div class="input-group search-box">
                <input
                  type="text"
                  id="qManager"
                  class="form-control"
                  placeholder="담당자명"
                />
                <span class="input-group-text" id="btnFindManager"
                  ><i class="bi bi-search"></i
                ></span>
              </div>
            </div>
          </div>

          <div class="d-flex mt-3">
            <div class="muted">※ 빈 값 조회 시 전체 검색됩니다.</div>
            <button class="btn btn-dark ms-auto" id="btnSearch">조회</button>
          </div>
        </div>
      </div>

      <!-- 3. 여신 현황 그리드 -->
      <div class="card shadow">
        <div class="card-header py-3">
          <h6 class="m-0 font-weight-bold text-primary">거래처 여신 현황</h6>
        </div>
        <div class="card-body">
          <div id="creditGrid" class="ag-theme-quartz"></div>
        </div>
      </div>
    </section>

    <th:block layout:fragment="body_extra">
      <script
        defer
        src="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/dist/ag-grid-community.min.js"
      ></script>
      <script
        defer
        src="https://cdn.jsdelivr.net/npm/axios@1.7.7/dist/axios.min.js"
      ></script>

      <script th:inline="none">
        document.addEventListener("DOMContentLoaded", () => {
          // ===== 포맷터 & 헬퍼 =====
          const fmtMoney = (p) => {
            const v = Number(p.value ?? 0);
            return isNaN(v) ? "" : v.toLocaleString("ko-KR");
          };
          const asNum = (v) => (isNaN(Number(v)) ? 0 : Number(v));

          // ===== 컬럼 정의 (설계서 순서) =====
          const columnDefs = [
            {
              headerName: "거래처코드",
              field: "cusCode",
              width: 130,
              pinned: "left",
            },
            {
              headerName: "거래처명",
              field: "cusName",
              minWidth: 160,
              flex: 1,
            },
            {
              headerName: "신용등급",
              field: "creditGrade",
              width: 100,
              cellClass: "text-center",
            },
            {
              headerName: "여신한도",
              field: "creditLimit",
              width: 130,
              type: "numericColumn",
              valueFormatter: fmtMoney,
            },
            { headerName: "적용시작일", field: "startDate", width: 120 },
            { headerName: "적용만료일", field: "endDate", width: 120 },
            {
              headerName: "잔여한도",
              field: "remainLimit",
              width: 130,
              type: "numericColumn",
              valueFormatter: fmtMoney,
              cellClass: (p) =>
                asNum(p.value) <= 0 ? "cell-bad" : "cell-good",
            },
            { headerName: "담당자", field: "managerName", width: 140 },
            {
              headerName: "할인잔여횟수",
              field: "discountRemainCnt",
              width: 120,
              type: "numericColumn",
              cellClass: (p) => (Number(p.value ?? 0) === 0 ? "cell-bad" : ""),
            },
          ];

          // ===== Grid 생성 =====
          const gridDiv = document.getElementById("creditGrid");
          let gridApi;
          const gridOptions = {
            columnDefs,
            rowData: [],
            pagination: true,
            paginationPageSize: 12,
            animateRows: true,
            defaultColDef: { sortable: true, resizable: true, filter: true },
            overlayLoadingTemplate:
              '<span class="ag-overlay-loading-center">불러오는 중…</span>',
            overlayNoRowsTemplate:
              '<span class="ag-overlay-no-rows-center">데이터가 없습니다</span>',
            onGridReady: (p) => {
              gridApi = p.api;
              fetchAndRender(); // 최초 로드
            },
          };
          if (window.agGrid?.createGrid) {
            gridApi = agGrid.createGrid(gridDiv, gridOptions);
          } else {
            new agGrid.Grid(gridDiv, gridOptions);
            gridApi = gridOptions.api;
          }
          const setRows = (rows) =>
            gridApi?.setGridOption
              ? gridApi.setGridOption("rowData", rows)
              : gridApi.setRowData(rows);

          // ===== DOM 요소 =====
          const qName = document.getElementById("qName");
          const qManager = document.getElementById("qManager");
          const btnSearch = document.getElementById("btnSearch");
          const btnReset = document.getElementById("btnReset");
          const btnSortGrade = document.getElementById("btnSortGrade");
          const btnSortState = document.getElementById("btnSortState");
          const btnFindManager = document.getElementById("btnFindManager");
          const btnExport = document.getElementById("btnExport");

          // ===== 이벤트 =====
          btnSearch.addEventListener("click", fetchAndRender);
          [qName, qManager].forEach((el) =>
            el.addEventListener(
              "keydown",
              (e) => e.key === "Enter" && fetchAndRender()
            )
          );
          btnFindManager.addEventListener("click", fetchAndRender);

          btnReset.addEventListener("click", () => {
            qName.value = "";
            qManager.value = "";
            gridApi.showLoadingOverlay();
            fetchAndRender();
          });

          // 정렬: 신용등급 / 상태(잔여한도 desc → 등급 asc)
          btnSortGrade.addEventListener("click", () => {
            btnSortGrade.classList.replace(
              "btn-outline-secondary",
              "btn-primary"
            );
            btnSortState.classList.replace(
              "btn-primary",
              "btn-outline-secondary"
            );
            gridApi.setGridOption("sortModel", [
              { colId: "creditGrade", sort: "asc" },
            ]);
          });
          btnSortState.addEventListener("click", () => {
            btnSortState.classList.replace(
              "btn-outline-secondary",
              "btn-primary"
            );
            btnSortGrade.classList.replace(
              "btn-primary",
              "btn-outline-secondary"
            );
            gridApi.setGridOption("sortModel", [
              { colId: "remainLimit", sort: "desc" },
              { colId: "creditGrade", sort: "asc" },
            ]);
          });

          // CSV 내보내기
          btnExport.addEventListener("click", () => {
            gridApi.exportDataAsCsv({
              fileName: "credit-status.csv",
              columnKeys: columnDefs.map((c) => c.field),
            });
          });

          // ===== 데이터 조회 =====
          async function fetchAndRender() {
            try {
              gridApi.showLoadingOverlay();
              const res = await axios.get("/api/biz/crdlist", {
                params: {
                  name: qName.value?.trim() || "",
                  manager: qManager.value?.trim() || "",
                },
                withCredentials: true,
              });
              const list = Array.isArray(res.data) ? res.data : [];

              // 서버키 → 화면키 매핑(유연 매핑)
              const rows = list.map((r) => ({
                cusCode: r.cusCode ?? r.code ?? "",
                cusName: r.cusName ?? r.name ?? "",
                creditGrade: r.creditGrade ?? r.grade ?? "",
                creditLimit: asNum(r.creditLimit ?? r.limit),
                startDate: r.startDate ?? r.applyStart ?? "",
                endDate: r.endDate ?? r.applyEnd ?? "",
                remainLimit: asNum(r.remainLimit ?? r.balance),
                managerName: r.managerName ?? r.manager ?? "",
                discountRemainCnt: Number(
                  r.discountRemainCnt ?? r.discountLeft ?? 0
                ),
              }));

              rows.length ? setRows(rows) : gridApi.showNoRowsOverlay();
            } catch (err) {
              console.error(err);
              gridApi.showNoRowsOverlay();
              setRows([]);
              alert("여신 현황 조회 중 오류가 발생했습니다.");
            }
          }
        });
      </script>
    </th:block>
  </body>
</html>
