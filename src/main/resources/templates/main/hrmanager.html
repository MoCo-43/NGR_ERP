<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/base}">
<head>
    <title layout:fragment="title">사원계정관리</title>

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.3/styles/ag-grid.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.3/styles/ag-theme-quartz.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.3/dist/ag-grid-community.min.noStyle.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <style>
        .container {
            max-width: 1200px;
            margin: auto;
        }
    </style>
</head>

<body>
<th:block layout:fragment="content">
    <div class="container">
        <h4 class="mb-3">사원 계정 관리</h4>

        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <select id="dept-filter" class="form-select d-inline-block w-auto">
                    <option value="">전체 부서</option>
                    <option value="D001">인사</option> 
                    <option value="D002">재고</option>
                    <option value="D003">회계</option>
                </select>
                <button id="search-btn" class="btn btn-primary">검색</button>
            </div>
            <div>
                <button id="create-btn" class="btn btn-success">생성</button>
                <button id="send-btn" class="btn btn-info">초기 비번 전송</button>
            </div>
        </div>

        <div id="employee-grid" class="ag-theme-quartz" style="height: 600px;"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const gridDiv = document.querySelector('#employee-grid');

            // AG Grid 컬럼 정의
            const columnDefs = [
                { headerName: '', checkboxSelection: true, headerCheckboxSelection: true, maxWidth: 50 },
                { field: 'name', headerName: '사원이름' }, // EmpVO 필드명에 맞게 수정 (예: name -> empName)
                { field: 'empId', headerName: '사번 (로그인ID)' },
                { field: 'deptCode', headerName: '부서번호' }, // EmpVO 필드명에 맞게 수정 (예: deptName -> deptCode)
                { field: 'email', headerName: '이메일' }
            ];

            // AG Grid 옵션
            const gridOptions = {
                columnDefs: columnDefs,
                rowData: [],
                rowSelection: 'multiple',
                suppressRowClickSelection: true, // 체크박스 클릭으로만 선택되도록 설정
                defaultColDef: { sortable: true, filter: true, resizable: true },
                pagination: true,
                paginationPageSize: 20,
                overlayLoadingTemplate: '<span class="ag-overlay-loading-center">불러오는 중...</span>',
                overlayNoRowsTemplate: '<span class="ag-overlay-no-rows-center">데이터가 없습니다.</span>'
            };

            // AG Grid 생성
            new agGrid.Grid(gridDiv, gridOptions);

            /**
             * 사원 목록을 서버에서 불러와 그리드에 표시하는 함수
             * @param {string} deptCode - 검색할 부서 코드 (없으면 전체 조회)
             */
            function loadEmployees(deptCode = '') {
                gridOptions.api.showLoadingOverlay();
                // Controller의 getEmployees 메소드 호출
                axios.get(`/hrLists?deptCode=${deptCode}`)
                    .then(response => {
                        if (response.data && response.data.length > 0) {
                            gridOptions.api.setRowData(response.data);
                        } else {
                            gridOptions.api.setRowData([]); // 기존 데이터 비우기
                            gridOptions.api.showNoRowsOverlay();
                        }
                    })
                    .catch(error => {
                        console.error('사원 목록 로딩 오류:', error);
                        gridOptions.api.showNoRowsOverlay();
                        alert('데이터를 불러오는 중 오류가 발생했습니다.');
                    });
            }

            // '검색' 버튼 클릭 이벤트
            document.getElementById('search-btn').addEventListener('click', () => {
                const selectedDept = document.getElementById('dept-filter').value;
                loadEmployees(selectedDept);
            });

            // '초기 비번 전송' 버튼 클릭 이벤트
            document.getElementById('send-btn').addEventListener('click', () => {
                const selectedNodes = gridOptions.api.getSelectedNodes();
                if (selectedNodes.length === 0) {
                    alert('계정을 활성화할 사원을 선택해주세요.');
                    return;
                }

                const selectedEmpIds = selectedNodes.map(node => node.data.empId);

                if (confirm(`선택된 ${selectedEmpIds.length}명의 사원 계정을 [사번]으로 활성화하고 초기 비밀번호를 전송하시겠습니까?`)) {
                    // Controller의 activateDefaultLogins 메소드 호출
                    axios.post('/activate-default', selectedEmpIds)
                        .then(response => {
                            alert(response.data); // 성공 메시지 출력
                            gridOptions.api.deselectAll(); // 선택 해제
                        })
                        .catch(error => {
                            console.error('초기 비밀번호 전송 오류:', error);
                            alert('오류가 발생했습니다: ' + (error.response?.data || error.message));
                        });
                }
            });

            // '생성' 버튼 클릭 이벤트
            document.getElementById('create-btn').addEventListener('click', () => {
                const selectedNodes = gridOptions.api.getSelectedNodes();
                if (selectedNodes.length === 0) {
                    alert('신규 계정을 생성할 사원을 선택해주세요.');
                    return;
                }

                const selectedEmpIds = selectedNodes.map(node => node.data.empId);

                if (confirm(`선택된 ${selectedEmpIds.length}명의 사원 계정을 [신규 ID]로 생성하고 초기 비밀번호를 전송하시겠습니까?`)) {
                    // Controller의 activateCustomLogins 메소드 호출
                    axios.post('/activate-custom', selectedEmpIds)
                        .then(response => {
                            alert(response.data); // 성공 메시지 출력
                            gridOptions.api.deselectAll(); // 선택 해제
                        })
                        .catch(error => {
                            console.error('신규 계정 생성 오류:', error);
                            alert('오류가 발생했습니다: ' + (error.response?.data || error.message));
                        });
                }
            });

            // 페이지 최초 로드 시 전체 사원 목록 조회
            loadEmployees();
        });
    </script>
</th:block>
</body>
</html>