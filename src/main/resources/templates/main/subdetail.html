<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>구독 상세</title>
<script src="https://js.tosspayments.com/v2/standard"></script>
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
	rel="stylesheet"
	integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
	crossorigin="anonymous">
<link
	href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap"
	rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons"
	rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script
	src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<style>

/* 기본 스타일 */
body {
	font-family: 'Malgun Gothic', '맑은 고딕', sans-serif;
	background-color: #f8f9fa;
	color: #333;
	margin: 0;
}

main {
	display: flex;
	justify-content: center;
	padding: 30px 20px;
	width: 100%;
	box-sizing: border-box;
}

.content-wrapper {
	width: 1400px;
	background-color: #fff;
	border: 1px solid #dee2e6;
	padding: 24px;
}

.page-title {
	text-align: center;
	font-size: 28px;
	font-weight: bold;
	margin-bottom: 20px;
}

.steps {
	display: flex;
	list-style: none;
	padding: 0 0 20px 0;
	margin: 0 0 24px 0;
	justify-content: space-evenly;
	border-bottom: 1px solid #e9ecef;
}

.steps .step {
	display: flex;
	align-items: center;
	color: #888;
}

.steps .step .number {
	width: 28px;
	height: 28px;
	border-radius: 50%;
	background-color: #adb5bd;
	color: white;
	display: flex;
	justify-content: center;
	align-items: center;
	margin-right: 8px;
	font-weight: bold;
	font-size: 14px;
}

.steps .step.active .number {
	background-color: #e53935;
}

.steps .step.completed .number {
	background-color: #3498db;
}

.steps .step.active span {
	color: #e53935;
	font-weight: bold;
}

.steps .step.completed span {
	color: #3498db;
}

.inner-layout {
	display: flex;
	gap: 32px;
}

.main-form, .subscription-form {
	flex: 2;
}

.sidebar {
	flex: 1;
	padding: 24px;
	background-color: #f8f9fa;
	border-radius: 4px;
}

.sidebar h3 {
	font-size: 18px;
	margin-top: 0;
	margin-bottom: 16px;
	padding-bottom: 12px;
	border-bottom: 1px solid #e9ecef;
}

.sidebar ul {
	padding-left: 20px;
	margin: 10px 0;
	line-height: 1.8;
	color: #495057;
}

.sidebar p {
	line-height: 1.8;
	color: #495057;
}

.form-section-label {
	font-size: 14px;
	font-weight: bold;
	color: #495057;
	margin-bottom: 8px;
	display: block;
}

.form-section-title {
	font-size: 18px;
	font-weight: bold;
	color: #333;
	margin-bottom: 24px;
	padding-bottom: 12px;
	border-bottom: 2px solid #e9ecef;
}

.form-group {
	margin-bottom: 24px;
}

.input-field {
	width: 100%;
	padding: 12px;
	border: 1px solid #ced4da;
	border-radius: 4px;
	font-size: 16px;
	box-sizing: border-box;
}

.input-field:read-only {
	background-color: #e9ecef;
	cursor: default;
}

.summary-box {
	border: 1px solid #e9ecef;
	border-radius: 4px;
}

.summary-box .summary-item {
	display: flex;
	justify-content: space-between;
	padding: 16px;
	border-bottom: 1px solid #e9ecef;
}

.summary-box .summary-item:last-child {
	border-bottom: none;
}

.summary-box .item-label {
	color: #495057;
}

.summary-box .item-value {
	font-weight: bold;
}

.summary-box .total {
	background-color: #f8f9fa;
	font-size: 18px;
}

.summary-box .total .item-value {
	color: #e53935;
}

.options-group {
	display: flex;
	gap: 12px;
	margin-bottom: 20px;
}

.service-display-box {
	flex: 1;
	padding: 16px;
	border: 1px solid #ced4da;
	background-color: #f8f9fa;
	text-align: center;
	border-radius: 4px;
	color: #495057;
}

.option-button, .payment-option {
	flex: 1;
	padding: 16px;
	border: 1px solid #ced4da;
	background-color: #fff;
	text-align: center;
	cursor: pointer;
	transition: all 0.2s;
	border-radius: 4px;
}

.option-button:hover, .payment-option:hover {
	border-color: #495057;
}

.option-button.selected, .payment-option.selected {
	border-color: #e53935;
	background-color: #fff3f2;
	color: #e53935;
	font-weight: bold;
}

.custom-select {
	width: 100%;
	padding: 12px;
	border: 1px solid #ced4da;
	border-radius: 4px;
	font-size: 16px;
	background-color: #fff;
	-webkit-appearance: none;
	-moz-appearance: none;
	appearance: none;
	background-image:
		url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
	background-repeat: no-repeat;
	background-position: right 0.75rem center;
	background-size: 16px 12px;
}

.premium-section {
	display: flex;
	justify-content: space-between;
	align-items: center;
	padding: 16px;
	border: 1px solid #dee2e6;
	margin-top: 24px;
}

.premium-section .label {
	font-weight: bold;
}

.premium-section .price {
	font-size: 18px;
	font-weight: bold;
	color: #e53935;
}

.form-navigation {
	display: flex;
	justify-content: space-between;
	margin-top: 32px;
}

.nav-btn {
	padding: 12px 24px;
	border: none;
	cursor: pointer;
	font-size: 16px;
	border-radius: 4px;
}

.prev-btn {
	background-color: #6c757d;
	color: white;
}

.next-btn {
	background-color: #e53935;
	color: white;
}

.completion-container {
	text-align: center;
	padding: 60px 20px;
}

.completion-container h2 {
	font-size: 24px;
	margin-bottom: 16px;
	color: #e53935;
}

.completion-container p {
	font-size: 16px;
	color: #495057;
	margin-bottom: 32px;
}

.completion-container .home-btn {
	background-color: #e53935;
	color: white;
	padding: 14px 40px;
	font-size: 18px;
	text-decoration: none;
	border-radius: 4px;
}

.step-section {
	display: none;
}

.step-section.active {
	display: block;
}

/* 전자 계약서 스타일 */
#contract-document-wrapper {
	border: 1px solid #dee2e6;
	padding: 10px;
	height: 500px;
	overflow-y: auto;
	margin-bottom: 20px;
	background-color: #fff;
}

#contract-document {
	padding: 20px;
	line-height: 1.7;
	font-size: 14px;
	color: #333;
}

#contract-document h1 {
	text-align: center;
	font-size: 22px;
	margin-bottom: 24px;
	font-weight: bold;
}

#contract-document h2 {
	font-size: 18px;
	margin-top: 32px;
	margin-bottom: 16px;
	padding-bottom: 8px;
	border-bottom: 1px solid #e0e0e0;
	font-weight: bold;
}

#contract-document h3 {
	font-size: 16px;
	margin-bottom: 12px;
	font-weight: bold;
}

#contract-document p, #contract-document ul, #contract-document ol {
	margin-bottom: 16px;
}

#contract-document .introduction {
	text-align: center;
	margin-bottom: 32px;
	color: #555;
}

#contract-document ul, #contract-document ol {
	padding-left: 20px;
}

#contract-document strong {
	color: #000;
}

#contract-document .sub-list {
	margin-top: 8px;
	padding-left: 20px;
}
</style>
</head>
<body>
	<input type="hidden" id="base-users-hidden"
		th:value="${subPlan.baseSalary}">
	<input type="hidden" id="max-users-hidden"
		th:value="${subPlan.maxUsers}">
	<input type="hidden" id="min-users-hidden"
		th:value="${subPlan.minUsers}">
	<div th:replace="~{layout/main_header :: headerFragment}"></div>
	<div th:replace="~{modal/signModal :: signModal}"></div>
	<main>
		<div class="content-wrapper">
			<h1 class="page-title">구독상세</h1>

			<ol class="steps">
				<li id="step-ui-1" class="step active"><div class="number">1</div>
					<span>구독정보</span></li>
				<li id="step-ui-2" class="step"><div class="number">2</div> <span>사용자정보</span></li>
				<li id="step-ui-3" class="step"><div class="number">3</div> <span>전자
						계약서</span></li>
				<li id="step-ui-4" class="step"><div class="number">4</div> <span>결제
						및 결제완료</span></li>
			</ol>

			<div id="step-1" class="step-section active">
				<div class="inner-layout">
					<div class="subscription-form">
						<div class="form-group">
							<label class="form-section-label">제공 서비스</label>
							<div
								th:each="svc : ${#strings.arraySplit(subPlan.avaiModules, ',')}"
								class="service-display-box">
								<div th:text="${svc}"></div>
							</div>
						</div>
						<div class="form-group">
							<label class="form-section-label">구독기간</label>
							<div class="options-group" id="duration-options">
								<div class="option-button" data-duration="3개월">
									<div class="icon">📅</div>
									<div>3개월</div>
								</div>
								<div class="option-button selected" data-duration="6개월">
									<div class="icon">📅</div>
									<div>6개월</div>
								</div>
								<div class="option-button" data-duration="12개월">
									<div class="icon">📅</div>
									<div>12개월</div>
								</div>
							</div>
						</div>
						<div class="form-group">
							<label for="user-count-input" class="form-section-label">사용자
								수(규모)</label> <input type="text" id="user-count-input"
								class="input-field" value="0" min="1"
								placeholder="사용할 인원 수를 입력하세요.">
						</div>
						<div class="premium-section">
							<span class="label">프리미엄 12개월 구독 금액</span> <span class="price"
								th:text="${subPlan.baseSalary}"></span></span>
						</div>
						<div class="form-navigation">
							<button type="button" class="nav-btn prev-btn" disabled>이전단계</button>
							<button type="button" class="nav-btn next-btn"
								onclick="goToStep(2)">다음단계</button>
						</div>
					</div>
					<aside class="sidebar">
						<h3>제품에 대한 설명</h3>
						<p>
							<strong>구독 안내</strong>
						</p>
						<ul>
							<li>원하는 구독 기간과 회사 규모(사용자 수)에 맞는 플랜을 선택하세요.</li>
							<li><strong>12개월</strong> 구독 시 <strong>10% 할인</strong>이
								적용됩니다.</li>
						</ul>
						<p>
							<strong>초과 요금 정책</strong>
						</p>
						<ul>
							<li>선택한 플랜의 최대 인원을 초과하여 사용자를 추가할 경우, 인당 추가 요금이 발생합니다.</li>
						</ul>
						<p>
							<strong>다음 단계</strong>
						</p>
						<ul>
							<li>선택 완료 후 '다음단계'를 누르면 전자 계약 페이지로 이동합니다.</li>
						</ul>
					</aside>
				</div>
			</div>

			<div id="step-2" class="step-section">
				<div class="inner-layout">
					<div class="main-form">
						<h3 class="form-section-title">회사 정보 (자동 입력)</h3>
						<div class="form-group">
							<label for="company-name" class="form-section-label">회사명</label>
							<input type="text" id="compName" class="input-field"
								th:value="${company.compName}" readonly>
						</div>
						<div class="form-group">
							<label for="biz-reg-number" class="form-section-label">사업자
								등록번호</label> <input type="text" id="brm" class="input-field"
								th:value="${company.brm}" readonly>
						</div>
						<div class="form-group">
							<label for="ceo-name" class="form-section-label">대표자명</label> <input
								type="text" id="ceo" class="input-field"
								th:value="${company.ceo}" readonly>
						</div>
						<div class="form-group">
							<label class="form-section-label">회사 주소</label> <input
								type="text" id="compAddr" class="form-control"
								placeholder="도로명주소" th:value="${company.compAddr}" readonly>
							<input type="text" id="compDelAddr" class="form-control"
								placeholder="상세주소" th:value="${company.compDelAddr}" readonly>
						</div>

						<h3 class="form-section-title" style="margin-top: 48px;">관리자
							정보 (자동 입력)</h3>
						<div class="form-group">
							<label for="admin-name" class="form-section-label">관리자 이름</label>
							<input type="text" id="matName" class="input-field"
								th:value="${company.matName}" readonly>
						</div>
						<div class="form-group">
							<label for="admin-email" class="form-section-label">관리자
								이메일 (ID)</label> <input type="email" id="matMail" class="input-field"
								th:value="${company.matMail}" readonly>
						</div>

						<div class="form-navigation">
							<button type="button" class="nav-btn prev-btn"
								onclick="goToStep(1)">이전단계</button>
							<button type="button" class="nav-btn next-btn"
								onclick="goToStep(3)">정보 확인 및 다음단계</button>
						</div>
					</div>

					<aside class="sidebar">
						<h3>선택한 구독 정보</h3>
						<div class="summary-box">
							<div class="summary-item">
								<span class="item-label">구독 기간</span> <span class="item-value"
									id="summary-duration">6개월</span>
							</div>
							<div class="summary-item">
								<span class="item-label">사용자 수</span> <span class="item-value"
									id="summary-user-count">50명</span>
							</div>
							<div class="summary-item total">
								<span class="item-label">기본 결제금액</span> <span class="price"
									th:text="${subPlan.baseSalary}"></span>
							</div>
						</div>
						<h3 style="margin-top: 24px;">안내</h3>
						<ul>
							<li>사용자 정보는 현재 로그인된 계정을 기준으로 자동 입력됩니다.</li>
							<li>정보 변경이 필요한 경우, 마이페이지에서 수정해 주세요.</li>
						</ul>
					</aside>
				</div>
				<script>
				   document.addEventListener('DOMContentLoaded', function() {
					   // 실제 comCode 값을 어떻게 가져올지에 대한 로직 필요
					   // 예: const companyCode = 'some-company-code'; 
					   // fetch('/api/subDetail?comCode=' + companyCode) ...
				   });
				</script>
			</div>

			<div id="step-3" class="step-section">
				<div id="contract-document-wrapper">
					<div id="contract-document">
						<h1>NGR_ERP 서비스 이용계약서</h1>
						<p class="introduction">본 계약서는 NGR_ERP 서비스 이용과 관련하여 필요한 제반 사항을
							규정함을 목적으로 합니다.</p>

						<h2>제1장 총칙</h2>
						<article>
							<h3>제1조 (목적)</h3>
							<p>본 약관은 엔지알(이하 "회사")이 제공하는 NGR_ERP 서비스(이하 "서비스")의 이용과 관련하여
								회사와 이용자(이하 "고객")의 권리, 의무 및 책임사항, 기타 필요한 사항을 규정함을 목적으로 합니다.</p>
						</article>
						<article>
							<h3>제2조 (용어의 정의)</h3>
							<div class="article-content">
								<ul>
									<li><strong>서비스:</strong> 회사가 고객에게 제공하는 전사적자원관리(ERP) 시스템 및
										관련 부가 서비스를 의미합니다.</li>
									<li><strong>고객:</strong> 회사와 서비스 이용계약을 체결하고 회사가 제공하는 서비스를
										이용하는 법인 또는 개인사업자를 의미합니다.</li>
									<li><strong>이용요금:</strong> 고객이 서비스를 이용하는 대가로 회사에 지불해야 하는
										비용을 의미합니다.</li>
								</ul>
							</div>
						</article>
						<article>
							<h3>제3조 (약관의 효력 및 변경)</h3>
							<div class="article-content">
								<ol>
									<li>본 약관은 서비스를 신청한 고객이 동의함으로써 효력이 발생합니다.</li>
									<li>회사는 합리적인 사유가 발생할 경우 관련 법령에 위배되지 않는 범위에서 본 약관을 개정할 수
										있습니다.</li>
									<li>회사가 약관을 개정할 경우에는 적용일자 및 개정사유를 명시하여 현행약관과 함께 서비스 홈페이지에
										그 적용일자 7일 이전부터 적용일자 전일까지 공지합니다.</li>
								</ol>
							</div>
						</article>
						<h2>제2장 서비스 이용계약</h2>
						<article>
							<h3>제4조 (이용계약의 성립)</h3>
							<p>이용계약은 고객이 회사가 정한 소정의 절차에 따라 이용신청을 하고, 회사가 이에 대해 승낙함으로써
								체결됩니다.</p>
						</article>
						<article>
							<h3>제5조 (서비스의 제공 및 변경)</h3>
							<div class="article-content">
								<ol>
									<li>회사는 계약에서 정한 바에 따라 안정적인 서비스를 지속적으로 제공할 의무가 있습니다.</li>
									<li>서비스의 내용에 변경이 있을 경우, 회사는 이를 고객에게 사전에 공지하여야 합니다.</li>
									<li>회사는 정기점검, 시스템 개선 등의 사유로 서비스 제공을 일시적으로 중단할 수 있으며, 이 경우
										사전에 공지합니다.</li>
								</ol>
							</div>
						</article>
						<h2>제3장 당사자의 의무</h2>
						<article>
							<h3>제6조 (회사의 의무)</h3>
							<div class="article-content">
								<ol>
									<li>회사는 고객의 정보 보안을 위해 최선을 다하며, 개인정보처리방침을 준수합니다.</li>
									<li>회사는 서비스 이용과 관련하여 고객으로부터 제기된 의견이나 불만이 정당하다고 인정될 경우에는 이를
										신속하게 처리하여야 합니다.</li>
								</ol>
							</div>
						</article>
						<article>
							<h3>제7조 (고객의 의무)</h3>
							<div class="article-content">
								<ol>
									<li>고객은 서비스 이용에 따른 이용요금을 지정된 기일에 납부하여야 합니다.</li>
									<li>고객은 부여받은 아이디와 비밀번호의 관리 소홀로 인해 발생하는 모든 책임은 고객 본인에게
										있습니다.</li>
									<li>고객은 서비스 이용과 관련하여 다음 각 호의 행위를 하여서는 안 됩니다.
										<ul class="sub-list">
											<li>타인의 정보를 도용하는 행위</li>
											<li>서비스를 이용하여 얻은 정보를 회사의 사전 승낙 없이 복제, 유통하거나 상업적으로 이용하는
												행위</li>
											<li>회사의 지적재산권을 침해하는 행위</li>
										</ul>
									</li>
								</ol>
							</div>
						</article>
						<h2>제4장 계약의 해지 및 이용 제한</h2>
						<article>
							<h3>제8조 (계약의 해지)</h3>
							<p>고객 또는 회사는 부득이한 사유가 있는 경우 상대방에게 서면 통보함으로써 본 계약을 해지할 수 있습니다.</p>
						</article>
						<article>
							<h3>제9조 (이용 제한)</h3>
							<p>회사는 고객이 본 약관의 의무를 위반하거나 서비스의 정상적인 운영을 방해한 경우, 서비스 이용을
								제한하거나 계약을 해지할 수 있습니다.</p>
						</article>
						<h2>제5장 손해배상 및 면책</h2>
						<article>
							<h3>제10조 (손해배상)</h3>
							<p>당사자 일방이 본 계약상의 의무를 위반하여 상대방에게 손해를 입힌 경우, 귀책사유 있는 당사자는 상대방이
								입은 손해를 배상하여야 합니다.</p>
						</article>
						<article>
							<h3>제11조 (면책)</h3>
							<div class="article-content">
								<ol>
									<li>천재지변 또는 이에 준하는 불가항력으로 인하여 서비스를 제공할 수 없는 경우에는 서비스 제공에
										관한 책임이 면제됩니다.</li>
									<li>회사는 고객의 귀책사유로 인한 서비스 이용의 장애에 대하여는 책임을 지지 않습니다.</li>
								</ol>
							</div>
						</article>
					</div>
				</div>
				<div class="form-navigation">
					<button type="button" class="nav-btn prev-btn"
						onclick="goToStep(2)">이전단계</button>
					<button type="button" class="nav-btn next-btn" id="signbtn">계약에
						동의 및 다음단계</button>
				</div>
			</div>
			<script>
                document.getElementById("signbtn").addEventListener("click", () => {
                    openSignModal('main', saveSign);
                });

                async function saveSign(signPath) {
                    if (signMode === "main") {
                        const dataToSend = {
                            filePath: signPath,
                            docName: "전자 서명"
                        };
                        try {
                            await axios.post('/api/main/sign', dataToSend);
                            bootstrap.Modal.getOrCreateInstance(document.getElementById('signModal')).hide();
                            goToStep(4);
                        } catch (error) {
                            console.error("서명 저장에 실패했습니다:", error);
                            alert("서명 저장 중 오류가 발생했습니다. 다시 시도해주세요.");
                        }
                    }
                }
            </script>
			
			<div id="step-4" class="step-section">
				<div class="inner-layout">
					<div class="main-form">
						<div class="form-group">
							<label class="form-section-label">최종 결제 정보</label>
							<div class="summary-box">
								<div class="summary-item">
									<span class="item-label">구독 기간</span> <span class="item-value"
										id="summary-duration-final">6개월</span>
								</div>
								<div class="summary-item">
									<span class="item-label">사용자 수</span> <span class="item-value"
										id="summary-user-count-final">50명</span>
								</div>
								<div class="summary-item">
									<span class="item-label">구독플랜 금액</span> <span class="price"
										th:text="${subPlan.baseSalary}"></span>
								</div>
								<div class="summary-item">
									<span class="item-label">기본 금액</span> <span class="price"
										id="base-price-display"></span>
								</div>
								<div class="summary-item">
									<span class="item-label">할인 금액</span> <span class="item-value"
										id="summary-discount-price">- 0원</span>
								</div>
								<div class="summary-item">
									<span class="item-label">초과 금액</span> <span class="item-value"
										id="summary-excess-price">+ 0원</span>
								</div>
								<div class="summary-item">
									<span class="item-label">미만 금액</span> <span class="item-value"
										id="summary-underage-price">- 0원</span>
								</div>
								<div class="summary-item total">
									<span class="item-label">총 결제 금액</span> <span
										class="item-value" id="summary-total-payment">0원</span>
								</div>
							</div>
						</div>

						<div class="form-group">
							<label class="form-section-label">결제 방식 선택</label>
							<div class="options-group" id="payment-type-options">
								<div class="payment-option selected" data-type="NORMAL">
									<span class="fw-bold">일반결제</span>
									<div class="form-text">선택한 기간만큼 한 번에 결제</div>
								</div>
								<div class="payment-option" data-type="RECURRING">
									<span class="fw-bold">정기결제</span>
									<div class="form-text">매월 자동 결제를 위한 카드 등록</div>
								</div>
							</div>
						</div>
						
						<div class="form-navigation">
							<button type="button" class="nav-btn prev-btn"
								onclick="goToStep(3)">이전단계</button>
							<button type="button" class="nav-btn next-btn"
								id="payment-button">결제하기</button>
						</div>
					</div>
					<aside class="sidebar">
						<h3>결제 안내</h3>
						<ul>
							<li>결제는 안전한 PG사를 통해 진행됩니다.</li>
							<li>결제 완료 후 즉시 서비스를 이용할 수 있습니다.</li>
							<li>결제 관련 문의는 고객센터(1234-5678)로 연락주시기 바랍니다.</li>
						</ul>
					</aside>
				</div>
			</div>
			
			<div id="step-5" class="step-section">
				<div class="completion-container">
					<h2>결제가 성공적으로 완료되었습니다!</h2>
					<p>
						이제 모든 서비스를 정상적으로 이용하실 수 있습니다.<br>관리자 계정으로 로그인하여 서비스를 시작해 보세요.
					</p>
					<div class="summary-box"
						style="width: 500px; margin: 0 auto 40px auto; text-align: left;">
						<div class="summary-item">
							<span class="item-label">구독 플랜</span> <span class="item-value">프리미엄</span>
						</div>
						<div class="summary-item">
							<span class="item-label">구독 기간</span> <span class="item-value">2025-09-29
								~ 2026-03-28</span>
						</div>
					</div>
					<a href="/dashboard" class="home-btn">서비스 시작하기</a>
				</div>
			</div>
		</div>
	</main>
	
	<div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
	    <div class="modal-dialog modal-lg">
	        <div class="modal-content">
	            <div class="modal-header">
	                <h5 class="modal-title" id="paymentModalLabel">결제 진행</h5>
	                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
	            </div>
	            <div class="modal-body">
	                <div id="payment-method-widget-modal" style="min-height: 400px;"></div>
	                <div id="agreement-widget-modal" style="margin-top: 16px;"></div>
	            </div>
	            <div class="modal-footer">
	                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
	                <button type="button" class="nav-btn next-btn" id="modal-payment-button">결제하기</button>
	            </div>
	        </div>
	    </div>
	</div>

	<div th:replace="~{layout/main_footer :: footerFragment}"></div>

<script>
    // ------------------------------------
    //  1. 전역 변수 설정
    // ------------------------------------
    let currentStep = 1;
    let selectedDuration = 6;
    let selectedDurationText = "6개월";
    let selectedUserCount = 0;
    let basePriceFromDB = 0;
    let maxUsers = 0;
    let minUsers = 0;
    const USER_UNIT_PRICE = 5000;
    let finalPayment = 0;
    let adjustmentCharge = 0;

    // ✨ [수정됨] Toss Payments 키를 기능별로 분리하여 정의
    const widgetClientKey = "test_gck_docs_Ovk5rk1EwkEbP0W43n07xlzm"; // 일반결제(결제위젯)용 클라이언트 키
    const billingClientKey = "test_ck_D5GePWvyJnrK0W0k6q8gLzN97Eoq"; // 정기결제(API)용 토스 테스트용 키
    const customerKey = "USER_ERP_1001"; // 실제 로그인한 사용자 고유 ID로 변경

    // ✨ [수정됨] 기능별 TossPayments 인스턴스를 저장할 변수
    let tossWidgetPayments; // 일반결제용
    let tossBillingPayments; // 정기결제용
    let widgets; // 위젯 객체를 담을 변수

    // ------------------------------------
    //  2. 결제 계산 함수 (변경 없음)
    // ------------------------------------
    function calculatePayment() {
        const unitPricePerUser = basePriceFromDB;
        const duration = selectedDuration;
        const userCount = parseInt(selectedUserCount) || 0;
        const maxCount = maxUsers;

        let baseUserInputPrice = unitPricePerUser * userCount * duration;
        let localAdjustmentCharge = 0;

        if (userCount > maxCount) {
            localAdjustmentCharge = (userCount - maxCount) * USER_UNIT_PRICE * duration;
        } else if (userCount < maxCount) {
            localAdjustmentCharge = -(maxCount - userCount) * USER_UNIT_PRICE * duration;
        }

        let discount = 0;
        if (duration === 12) {
            discount = Math.round(baseUserInputPrice * 0.1);
        }

        adjustmentCharge = localAdjustmentCharge;
        finalPayment = baseUserInputPrice - discount + adjustmentCharge;
        finalPayment = Math.max(0, finalPayment);

        document.getElementById('base-price-display').textContent = baseUserInputPrice.toLocaleString() + '원';
        document.getElementById('summary-discount-price').textContent = '- ' + discount.toLocaleString() + '원';

        if (adjustmentCharge > 0) {
            document.getElementById('summary-excess-price').textContent = '+' + adjustmentCharge.toLocaleString() + '원';
            document.getElementById('summary-underage-price').textContent = '- 0원';
        } else if (adjustmentCharge < 0) {
            document.getElementById('summary-excess-price').textContent = '+ 0원';
            document.getElementById('summary-underage-price').textContent = adjustmentCharge.toLocaleString() + '원';
        } else {
            document.getElementById('summary-excess-price').textContent = '+ 0원';
            document.getElementById('summary-underage-price').textContent = '- 0원';
        }

        document.getElementById('summary-total-payment').textContent = finalPayment.toLocaleString() + '원';
    }

    // ------------------------------------
    //  3. UI 업데이트 및 페이지 이동 함수 (변경 없음)
    // ------------------------------------
    function updateSummary() {
        const durationElements = document.querySelectorAll('#summary-duration, #summary-duration-final');
        durationElements.forEach(el => el.textContent = selectedDurationText);

        const userCountElements = document.querySelectorAll('#summary-user-count, #summary-user-count-final');
        const formattedCount = (parseInt(selectedUserCount) || 0).toLocaleString() + "명";
        userCountElements.forEach(el => el.textContent = formattedCount);
    }

    function goToStep(stepNumber) {
        document.querySelectorAll('.step-section').forEach(el => el.classList.remove('active'));
        document.getElementById(`step-${stepNumber}`).classList.add('active');

        updateStepUI(stepNumber);
        currentStep = stepNumber;

        if (stepNumber >= 2 && stepNumber <= 4) {
            updateSummary();
            if (basePriceFromDB > 0) {
                calculatePayment();
            }
        }
    }
    
    function updateStepUI(targetStep) {
        const steps = document.querySelectorAll('.steps .step');
        const uiTargetStep = targetStep > 4 ? 4 : targetStep;

        steps.forEach((step, index) => {
            const stepIndex = index + 1;
            step.classList.remove('active', 'completed');
            if (stepIndex < uiTargetStep) {
                step.classList.add('completed');
            } else if (stepIndex === uiTargetStep) {
                step.classList.add('active');
            }
        });

        if (targetStep === 5) {
            const step4UI = document.getElementById('step-ui-4');
            if (step4UI) {
                step4UI.classList.remove('active');
                step4UI.classList.add('completed');
            }
        }
    }

    // ------------------------------------
    //  4. 결제 처리 함수들
    // ------------------------------------

    /**
     * "일반 결제" 모달을 열고 위젯을 렌더링합니다.
     */
    async function openPaymentModal() {
        try {
            // ✨ [수정됨] 일반결제용 인스턴스(tossWidgetPayments) 사용
            widgets = tossWidgetPayments.widgets({ customerKey });

            await widgets.setAmount({
                currency: "KRW",
                value: finalPayment,
            });

            await Promise.all([
                widgets.renderPaymentMethods({
                    selector: "#payment-method-widget-modal",
                    variantKey: "DEFAULT",
                }),
                widgets.renderAgreement({
                    selector: "#agreement-widget-modal",
                    variantKey: "AGREEMENT"
                }),
            ]);

            const paymentModal = new bootstrap.Modal(document.getElementById('paymentModal'));
            paymentModal.show();

        } catch (error) {
            console.error("Toss Payments 위젯 렌더링 실패:", error);
            alert("결제창을 여는 중 오류가 발생했습니다. 다시 시도해 주세요.");
        }
    }

    /**
     * "정기 결제(빌링)"를 위한 카드 등록창을 요청합니다.
     */
    async function requestBillingAuth() {
        const customerName = document.getElementById('matName').value || "김토스";
        const customerEmail = document.getElementById('matMail').value || "customer@example.com";

        try {
            // ✨ [수정됨] 정기결제용 인스턴스(tossBillingPayments) 사용
            const payment = tossBillingPayments.payment({ customerKey });
            await payment.requestBillingAuth({
              method: "CARD",
              successUrl: window.location.origin + "/payment/billing-success",
              failUrl: window.location.origin + "/payment/fail",
              customerEmail: customerEmail,
              customerName: customerName,
            });
        } catch (error) {
            console.error("정기결제 카드 등록 요청 실패:", error);
            alert("카드 등록창을 여는 중 오류가 발생했습니다. 다시 시도해 주세요.");
        }
    }

    /**
     * 선택된 결제 방식에 따라 적절한 함수를 호출합니다.
     */
    function handlePaymentRequest() {
        const selectedOption = document.querySelector('#payment-type-options .payment-option.selected');
        const paymentType = selectedOption.getAttribute('data-type');

        if (paymentType === 'NORMAL') {
            openPaymentModal();
        } else if (paymentType === 'RECURRING') {
            requestBillingAuth();
        }
    }

    // ------------------------------------
    //  5. DOMContentLoaded 이벤트 핸들러
    // ------------------------------------
    document.addEventListener('DOMContentLoaded', async function() {

        // ✨ [수정됨] 페이지 로드 시 각 기능에 맞는 키로 TossPayments 인스턴스를 생성
        tossWidgetPayments = TossPayments(widgetClientKey);
        tossBillingPayments = TossPayments(billingClientKey);

        // --- (이하 코드는 이전과 동일) ---
    	const basePriceElement = document.querySelector('.premium-section .price');
    	if (basePriceElement && basePriceElement.textContent) {
    	    const rawValue = basePriceElement.textContent.replace(/[^0-9]/g, '');
    	    basePriceFromDB = parseInt(rawValue, 10) || 0;
    	}

    	const maxUsersHidden = document.getElementById('max-users-hidden');
    	if (maxUsersHidden) maxUsers = parseInt(maxUsersHidden.value, 10) || 0;

    	const minUsersHidden = document.getElementById('min-users-hidden');
    	if (minUsersHidden) minUsers = parseInt(minUsersHidden.value, 10) || 0;

        document.getElementById(`step-${currentStep}`).classList.add('active');

        const durationButtons = document.querySelectorAll('#duration-options .option-button');
        durationButtons.forEach(button => {
            button.addEventListener('click', () => {
                durationButtons.forEach(btn => btn.classList.remove('selected'));
                button.classList.add('selected');
                selectedDurationText = button.getAttribute('data-duration');
                selectedDuration = parseInt(selectedDurationText.replace(/[^0-9]/g, '')) || 1;
                calculatePayment();
            });
        });

        const initialSelectedDuration = document.querySelector('#duration-options .option-button.selected');
        if (initialSelectedDuration) {
            selectedDurationText = initialSelectedDuration.getAttribute('data-duration');
            selectedDuration = parseInt(selectedDurationText.replace(/[^0-9]/g, '')) || 1;
        }

        const userCountInput = document.getElementById('user-count-input');
        if (userCountInput) {
            selectedUserCount = userCountInput.value.replace(/[^0-9]/g, '');
            userCountInput.addEventListener('input', () => {
                selectedUserCount = userCountInput.value.replace(/[^0-9]/g, '');
                calculatePayment();
            });
        }

        const paymentTypeOptions = document.querySelectorAll('#payment-type-options .payment-option');
        paymentTypeOptions.forEach(option => {
            option.addEventListener('click', () => {
                paymentTypeOptions.forEach(opt => opt.classList.remove('selected'));
                option.classList.add('selected');
            });
        });

        calculatePayment();

        document.getElementById('payment-button').addEventListener('click', handlePaymentRequest);

        document.getElementById('modal-payment-button').addEventListener('click', async function () {
            if (!widgets) {
                alert("결제 위젯이 초기화되지 않았습니다. 잠시 후 다시 시도해 주세요.");
                return;
            }

            const requestData = {
                subPlanNo: 1,
                userCount: selectedUserCount,
                duration: selectedDuration,
                finalAmount: finalPayment,
                adjustmentCharge: adjustmentCharge
            };

            try {
                const response = await axios.post('/payment/api/payment/prepare', requestData);
                const { orderId, orderName } = response.data;

                await widgets.requestPayment({
                    orderId: orderId,
                    orderName: orderName,
                    successUrl: window.location.origin + "/payment/success",
                    failUrl: window.location.origin + "/payment/fail",
                });

            } catch (error) {
                console.error("결제 요청 중 오류 발생:", error);
                alert("결제를 진행하는 중 문제가 발생했습니다. 콘솔을 확인해 주세요.");
            }
        });
    });
</script>
</body>
</html>