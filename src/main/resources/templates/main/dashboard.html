<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/base}">
<head>
<title>대시보드</title>
<link
	href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap"
	rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons"
	rel="stylesheet">
<th:block layout:fragment="head_extra">
	<script
		src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
	<style>
/* 1. 기본 레이아웃 재정의 */
    html, body {
        height: 100%;
        margin: 0;
        background-color: #f4f7f6; /* 배경색 추가 */
    }

    /* 2. 대시보드 전체 컨테이너 */
    .dashboard-container {
        height: calc(100vh - 120px); /* 헤더 등을 제외한 높이 */
        padding: 24px;
        display: flex;
        flex-direction: column;
        gap: 24px;
        overflow: hidden;
    }

    /* 3. 상단 통계 카드 그룹 */
    .stat-container {
        display: flex;
        gap: 24px;
        flex-wrap: wrap;
    }

    /* 개별 스탯 카드 */
    .stat-card {
        background-color: #ffffff;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        padding: 24px;
        flex: 1; /* 모든 카드가 동일한 너비를 가짐 */
        min-width: 250px;
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        display: flex;
        align-items: center;
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
    }

    /* 라벨과 (아이콘+값) 그룹을 포함하는 헤더 */
    .stat-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
    }

    .stat-label {
        font-size: 16px;
        font-weight: 500;
        color: #555;
    }
    
    /* ⭐ [수정] 아이콘과 값을 묶는 그룹 */
    .stat-data {
        display: flex;
        align-items: center;
        gap: 8px; /* << 아이콘과 값 사이의 간격을 조절합니다 */
    }

    .material-icons {
        font-size: 36px;
        color: #4a69bd;
    }
    
    .stat-value {
        font-size: 32px; /* 폰트 크기 미세 조정 */
        font-weight: 700;
        color: #333;
    }

    /* 4. 하단 모듈 그룹 */
    .modules-group {
        flex-grow: 1;
        display: grid;
        grid-template-columns: 1fr 1fr;
        grid-template-rows: 1fr 1fr;
        gap: 24px;
        overflow: hidden;
    }

    .module-card {
        background-color: #ffffff;
        padding: 16px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .module-title {
        font-size: 1.1em;
        font-weight: bold;
        margin-bottom: 15px;
        color: #333;
        flex-shrink: 0;
    }
/* Chart.js 캔버스 스타일 */
canvas {
	flex-grow: 1;
	width: 100% !important;
	height: 100% !important;
	max-height: 100%;
}
</style>
</th:block>
</head>
<body>
	<section layout:fragment="content">

		<div class="dashboard-container">

			<div class="stat-container">
				<div class="stat-card">
					<div class="stat-header">
						<span class="stat-label">근무 중 인원</span> <span
							class="material-icons">group</span>
							<div class="stat-value">10명</div>
					</div>
				</div>

				<div class="stat-card">
					<div class="stat-header">
						<span class="stat-label">이번 날 매출</span> <span
							class="material-icons">trending_up</span>
						<div class="stat-value">₩ 0</div>
					</div>
				</div>

				<div class="stat-card">
					<div class="stat-header">
						<span class="stat-label">재고 현황</span> <span class="material-icons">inventory_2</span>
					<div class="stat-value">0개</div>
					</div>
				</div>
			</div>

			<div class="modules-group">

				<div class="module-card">
					<div class="module-title">영업 모듈</div>
					<canvas id="salesChart"></canvas>
				</div>

				<div class="module-card">
					<div class="module-title">인사 모듈</div>
					<canvas id="inventoryChart"></canvas>
					<!-- ⭐️ 이 캔버스 ID에 DB 데이터를 로드합니다. -->
				</div>

				<div class="module-card">
					<div class="module-title">재고 모듈</div>
					<canvas id="hrChart"></canvas>
				</div>

				<div class="module-card">
					<div class="module-title">회계 모듈</div>
					<canvas id="accountingChart"></canvas>
				</div>

			</div>

		</div>


		<script th:inline="javascript">
  // Chart.js 공통 생성 함수
  function createChart(canvasId, type, data, extraOptions = {}) {
    const ctx = document.getElementById(canvasId);
    if (!ctx) return;

    new Chart(ctx.getContext('2d'), {
      type: type,
      data: data,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        indexAxis: extraOptions.indexAxis || 'x',
        plugins: {
          legend: { display: true, position: 'top', labels: { font: { size: 10 } } },
          title: extraOptions.title || {}
        },
        scales: {
          y: {
            ticks: { font: { size: 10 } },
            beginAtZero: true
          },
          x: {
            ticks: { font: { size: 10 }, callback: v => v.toLocaleString() + '원' },
            beginAtZero: true
          }
        }
      }
    });
  }

  // --- 1. 영업 모듈 ---
  const salesData = {
    labels: ['1Q', '2Q', '3Q', '4Q'],
    datasets: [{
      label: '분기 매출',
      data: [12, 19, 3, 5],
      backgroundColor: 'rgba(75, 192, 192, 0.8)',
      borderWidth: 1
    }]
  };

  // --- 2. 인사 모듈 (재고 영역 차용) ---
  const hrData = {
    labels: ['월', '화', '수', '목', '금'],
    datasets: [{
      label: '휴가 사용률',
      data: [1, 3, 2, 4, 1],
      fill: false,
      borderColor: 'rgb(255, 99, 132)',
      tension: 0.1
    }]
  };

  // --- 3. 손익 데이터 크롤링 ---
 async function fetchProfitValue() {
  try {
    const res = await fetch('/api/dashboard/account');
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();

    const profitLabel = data.profitLabel || '당기순손익';
    const curProfit = Number(data.curProfit || 0);
    const prvProfit = Number(data.prvProfit || 0);

    console.log("📊 손익 데이터:", { profitLabel, curProfit, prvProfit });
    return { profitLabel, curProfit, prvProfit };
  } catch (err) {
    console.error('❌ 손익 데이터 로드 실패:', err);
    return { profitLabel: '당기순손익', curProfit: 0, prvProfit: 0 };
  }
}


  // --- 4. 회계 모듈 (가로 막대 차트) ---
 async function renderAccountingChart() {
  const { profitLabel, curProfit, prvProfit } = await fetchProfitValue();

  const accountingData = {
    labels: ['전월', '당월'],
    datasets: [{
      label: profitLabel,
      data: [prvProfit, curProfit],
      backgroundColor: [
        'rgba(255, 99, 132, 0.7)',  // 전월
        'rgba(54, 162, 235, 0.7)'   // 당월
      ],
      borderWidth: 1
    }]
  };

  createChart('accountingChart', 'bar', accountingData, {
    indexAxis: 'y', // 가로 막대
    title: {
      display: true,
      text: '당기순손익 (전월 vs 당월)',
      font: { size: 13 }
    }
  });
}

  // --- 5. 인사 모듈 데이터 로드 ---
  async function fetchHrMembersChart() {
    const canvasId = 'inventoryChart';
    try {
      const response = await fetch('/api/dashboard/empmembers');
      if (!response.ok) throw new Error(`HTTP 요청 실패: ${response.status}`);
      const dataList = await response.json();

      const labels = dataList.map(item => item.deptName);
      const memberCounts = dataList.map(item => item.memberCount);

      const dynamicHrData = {
        labels,
        datasets: [{
          label: '부서별 재직 인원수',
          data: memberCounts,
          backgroundColor: [
            'rgba(255, 99, 132, 0.8)',
            'rgba(54, 162, 235, 0.8)',
            'rgba(255, 206, 86, 0.8)',
            'rgba(75, 192, 192, 0.8)',
            'rgba(153, 102, 255, 0.8)',
            'rgba(255, 159, 64, 0.8)'
          ],
          borderWidth: 1
        }]
      };

      createChart(canvasId, 'doughnut', dynamicHrData);
    } catch (error) {
      console.error("인사 모듈 데이터를 가져오는데 실패했습니다:", error);
      const errorData = {
        labels: ['로딩 실패'],
        datasets: [{ data: [1], backgroundColor: ['#ccc'] }]
      };
      createChart(canvasId, 'doughnut', errorData);
    }
  }

  // --- 6. 모든 차트 렌더링 ---
  createChart('salesChart', 'bar', salesData);
  fetchHrMembersChart();
  createChart('hrChart', 'line', hrData);
  renderAccountingChart(); // ✅ 회계 모듈은 비동기 렌더링
</script>

	</section>
</body>
</html>
