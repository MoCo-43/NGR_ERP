<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/base}">
<head>
<title>ëŒ€ì‹œë³´ë“œ</title>

<th:block layout:fragment="head_extra">
	<script
		src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
	<style>
/* 1. ê¸°ë³¸ ë ˆì´ì•„ì›ƒ ì¬ì •ì˜ (í•„ìš”í•œ ê²½ìš°) */
html, body {
	height: 100%;
	margin: 0;
}

/* 2. ëŒ€ì‹œë³´ë“œ ì „ì²´ ì»¨í…Œì´ë„ˆ ì„¤ì • */
.dashboard-container {
	height: calc(100vh - 120px); /* ë·°í¬íŠ¸ ì „ì²´ ë†’ì´ì—ì„œ ìƒë‹¨ ë©”ë‰´ë°” ë“±ì„ ê³ ë ¤í•´ 120px ì œì™¸ */
	padding: 20px;
	display: flex;
	flex-direction: column;
	gap: 20px;
	overflow: hidden;
}

/* 3. ìƒë‹¨ í†µê³„ íƒ€ì¼ ê·¸ë£¹ */
.stats-group {
	display: grid;
	grid-template-columns: repeat(3, 1fr);
	gap: 20px;
	flex-shrink: 0;
}

.stat-card {
	background-color: #f7f7f7;
	padding: 15px 20px;
	border-radius: 4px;
	border: 1px solid #ddd;
	height: 90px;
}

.stat-label {
	font-size: 0.9em;
	color: #666;
	display: flex;
	justify-content: space-between;
	align-items: center;
	margin-bottom: 5px;
}

.stat-value {
	font-size: 2em;
	font-weight: bold;
	color: #333;
}

.stat-icon {
	font-size: 24px;
}

/* 4. í•˜ë‹¨ ëª¨ë“ˆ ê·¸ë£¹ (2x2 Layout) */
.modules-group {
	flex-grow: 1;
	display: grid;
	grid-template-columns: 1fr 1fr;
	grid-template-rows: 1fr 1fr;
	gap: 20px;
	overflow: hidden;
}

.module-card {
	background-color: #ffffff;
	padding: 10px;
	border-radius: 4px;
	border: 1px solid #ddd;
	display: flex;
	flex-direction: column;
	overflow: hidden;
}

.module-title {
	font-size: 1.1em;
	font-weight: bold;
	margin-bottom: 10px;
	padding: 5px;
	color: #333;
	background-color: #f0f0f0;
	flex-shrink: 0;
}

/* Chart.js ìº”ë²„ìŠ¤ ìŠ¤íƒ€ì¼ */
canvas {
	flex-grow: 1;
	width: 100% !important;
	height: 100% !important;
	max-height: 100%;
}
</style>
</th:block>
</head>
<body>
	<section layout:fragment="content">

		<div class="dashboard-container">

			<div class="stats-group">

				<div class="stat-card">
					<div class="stat-label">
						<span>ê·¼ë¬´ ì¤‘ ì¸ì›</span><span class="stat-icon">ğŸ‘¥</span>
						<div class="stat-value">10ëª…</div>
					</div>
				</div>

				<div class="stat-card">
					<div class="stat-label">
						<span>ì´ë²ˆ ë‚  ë§¤ì¶œ</span><span class="stat-icon">ğŸ“ˆ</span>
						<div class="stat-value">â‚© 0</div>
					</div>
				</div>

				<div class="stat-card">
					<div class="stat-label">
						<span>ì¬ê³  í˜„í™©</span><span class="stat-icon">ğŸ›ï¸</span>
						<div class="stat-value">0ê°œ</div>
					</div>
				</div>

			</div>

			<div class="modules-group">

				<div class="module-card">
					<div class="module-title">ì˜ì—… ëª¨ë“ˆ</div>
					<canvas id="salesChart"></canvas>
				</div>

				<div class="module-card">
					<div class="module-title">ì¸ì‚¬ ëª¨ë“ˆ</div>
					<canvas id="inventoryChart"></canvas>
					<!-- â­ï¸ ì´ ìº”ë²„ìŠ¤ IDì— DB ë°ì´í„°ë¥¼ ë¡œë“œí•©ë‹ˆë‹¤. -->
				</div>

				<div class="module-card">
					<div class="module-title">ì¬ê³  ëª¨ë“ˆ</div>
					<canvas id="hrChart"></canvas>
				</div>

				<div class="module-card">
					<div class="module-title">íšŒê³„ ëª¨ë“ˆ</div>
					<canvas id="accountingChart"></canvas>
				</div>

			</div>

		</div>


		<script th:inline="javascript">
  // Chart.js ê³µí†µ ìƒì„± í•¨ìˆ˜
  function createChart(canvasId, type, data, extraOptions = {}) {
    const ctx = document.getElementById(canvasId);
    if (!ctx) return;

    new Chart(ctx.getContext('2d'), {
      type: type,
      data: data,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        indexAxis: extraOptions.indexAxis || 'x',
        plugins: {
          legend: { display: true, position: 'top', labels: { font: { size: 10 } } },
          title: extraOptions.title || {}
        },
        scales: {
          y: {
            ticks: { font: { size: 10 } },
            beginAtZero: true
          },
          x: {
            ticks: { font: { size: 10 }, callback: v => v.toLocaleString() + 'ì›' },
            beginAtZero: true
          }
        }
      }
    });
  }

  // --- 1. ì˜ì—… ëª¨ë“ˆ ---
  const salesData = {
    labels: ['1Q', '2Q', '3Q', '4Q'],
    datasets: [{
      label: 'ë¶„ê¸° ë§¤ì¶œ',
      data: [12, 19, 3, 5],
      backgroundColor: 'rgba(75, 192, 192, 0.8)',
      borderWidth: 1
    }]
  };

  // --- 2. ì¸ì‚¬ ëª¨ë“ˆ (ì¬ê³  ì˜ì—­ ì°¨ìš©) ---
  const hrData = {
    labels: ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ'],
    datasets: [{
      label: 'íœ´ê°€ ì‚¬ìš©ë¥ ',
      data: [1, 3, 2, 4, 1],
      fill: false,
      borderColor: 'rgb(255, 99, 132)',
      tension: 0.1
    }]
  };

  // --- 3. ì†ìµ ë°ì´í„° í¬ë¡¤ë§ ---
 async function fetchProfitValue() {
  try {
    const res = await fetch('/api/dashboard/account');
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();

    const profitLabel = data.profitLabel || 'ë‹¹ê¸°ìˆœì†ìµ';
    const curProfit = Number(data.curProfit || 0);
    const prvProfit = Number(data.prvProfit || 0);

    console.log("ğŸ“Š ì†ìµ ë°ì´í„°:", { profitLabel, curProfit, prvProfit });
    return { profitLabel, curProfit, prvProfit };
  } catch (err) {
    console.error('âŒ ì†ìµ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', err);
    return { profitLabel: 'ë‹¹ê¸°ìˆœì†ìµ', curProfit: 0, prvProfit: 0 };
  }
}


  // --- 4. íšŒê³„ ëª¨ë“ˆ (ê°€ë¡œ ë§‰ëŒ€ ì°¨íŠ¸) ---
 async function renderAccountingChart() {
  const { profitLabel, curProfit, prvProfit } = await fetchProfitValue();

  const accountingData = {
    labels: ['ì „ì›”', 'ë‹¹ì›”'],
    datasets: [{
      label: profitLabel,
      data: [prvProfit, curProfit],
      backgroundColor: [
        'rgba(255, 99, 132, 0.7)',  // ì „ì›”
        'rgba(54, 162, 235, 0.7)'   // ë‹¹ì›”
      ],
      borderWidth: 1
    }]
  };

  createChart('accountingChart', 'bar', accountingData, {
    indexAxis: 'y', // ê°€ë¡œ ë§‰ëŒ€
    title: {
      display: true,
      text: 'ë‹¹ê¸°ìˆœì†ìµ (ì „ì›” vs ë‹¹ì›”)',
      font: { size: 13 }
    }
  });
}

  // --- 5. ì¸ì‚¬ ëª¨ë“ˆ ë°ì´í„° ë¡œë“œ ---
  async function fetchHrMembersChart() {
    const canvasId = 'inventoryChart';
    try {
      const response = await fetch('/api/dashboard/empmembers');
      if (!response.ok) throw new Error(`HTTP ìš”ì²­ ì‹¤íŒ¨: ${response.status}`);
      const dataList = await response.json();

      const labels = dataList.map(item => item.deptName);
      const memberCounts = dataList.map(item => item.memberCount);

      const dynamicHrData = {
        labels,
        datasets: [{
          label: 'ë¶€ì„œë³„ ì¬ì§ ì¸ì›ìˆ˜',
          data: memberCounts,
          backgroundColor: [
            'rgba(255, 99, 132, 0.8)',
            'rgba(54, 162, 235, 0.8)',
            'rgba(255, 206, 86, 0.8)',
            'rgba(75, 192, 192, 0.8)',
            'rgba(153, 102, 255, 0.8)',
            'rgba(255, 159, 64, 0.8)'
          ],
          borderWidth: 1
        }]
      };

      createChart(canvasId, 'doughnut', dynamicHrData);
    } catch (error) {
      console.error("ì¸ì‚¬ ëª¨ë“ˆ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤:", error);
      const errorData = {
        labels: ['ë¡œë”© ì‹¤íŒ¨'],
        datasets: [{ data: [1], backgroundColor: ['#ccc'] }]
      };
      createChart(canvasId, 'doughnut', errorData);
    }
  }

  // --- 6. ëª¨ë“  ì°¨íŠ¸ ë Œë”ë§ ---
  createChart('salesChart', 'bar', salesData);
  fetchHrMembersChart();
  createChart('hrChart', 'line', hrData);
  renderAccountingChart(); // âœ… íšŒê³„ ëª¨ë“ˆì€ ë¹„ë™ê¸° ë Œë”ë§
</script>

	</section>
</body>
</html>
