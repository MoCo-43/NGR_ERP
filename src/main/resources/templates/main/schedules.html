<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/base}">

<th:block layout:fragment="head_extra">
    <title>일정 관리</title>

    <!-- FullCalendar -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/main.min.css" rel="stylesheet" />
    <!-- Flatpickr (순수 JS datepicker) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://npmcdn.com/flatpickr/dist/l10n/ko.css">

    <style>
        html, body { height: 100%; }
        #content-wrapper { min-height: 100vh; }
        #content { flex: 1 0 auto; }

        .schedule-container { display: flex; gap: 20px; }
        .schedule-main { flex: 3; }
        #calendar { min-height: 700px; max-width: 1100px; margin: 0 auto; }
    </style>
</th:block>

<th:block layout:fragment="content">
    <!-- 일정 추가/수정 모달 -->
    <div class="modal fade" id="scheduleModal" tabindex="-1" aria-labelledby="scheduleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="addScheduleForm">
                    <div class="modal-header">
                        <h5 class="modal-title" id="scheduleModalLabel">일정 추가/수정</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="plan-no">
                        <div class="mb-3">
                            <label for="schedule-title" class="form-label">제목</label>
                            <input type="text" class="form-control" id="schedule-title" required>
                        </div>
                        <div class="mb-3">
                            <label for="schedule-type" class="form-label">일정유형</label>
                            <select class="form-select" id="schedule-type" required>
                                <option value="">선택</option>
                                <option value="회의">회의</option>
                                <option value="출장">출장</option>
                                <option value="프로젝트 마감">프로젝트 마감</option>
                                <option value="기타">기타</option>
                            </select>
                        </div>
                        <div class="mb-3 row g-2">
                            <div class="col">
                                <label for="schedule-start" class="form-label">시작일</label>
                                <input type="text" class="form-control" id="schedule-start" required placeholder="YYYY-MM-DD">
                            </div>
                            <div class="col">
                                <label for="schedule-end" class="form-label">종료일</label>
                                <input type="text" class="form-control" id="schedule-end" required placeholder="YYYY-MM-DD">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="schedule-details" class="form-label">내용</label>
                            <textarea class="form-control" id="schedule-details"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary">저장</button>
                        <button type="button" class="btn btn-danger" id="delete-btn">삭제</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="schedule-container">
        <div class="schedule-main">
            <div id="calendar"></div>
        </div>
    </div>
</th:block>

<th:block layout:fragment="body_extra">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/ko.js"></script>

    <script type="module">
    document.addEventListener('DOMContentLoaded', () => {
        const calendarEl = document.getElementById('calendar');
        const modalEl = document.getElementById('scheduleModal');
        const modal = new bootstrap.Modal(modalEl);

        const form = document.getElementById('addScheduleForm');
        const deleteBtn = document.getElementById('delete-btn');
        const planNoInput = document.getElementById('plan-no');

        const titleInput = document.getElementById('schedule-title');
        const typeInput = document.getElementById('schedule-type');
        const startInput = document.getElementById('schedule-start');
        const endInput = document.getElementById('schedule-end');
        const detailsInput = document.getElementById('schedule-details');

        const colorMap = { "회의": "#ff9f89", "출장": "#4caf50", "프로젝트 마감": "#2196f3", "기타": "#9c27b0" };

        // Flatpickr 초기화
        flatpickr(startInput, { dateFormat: "Y-m-d", locale: "ko" });
        flatpickr(endInput, { dateFormat: "Y-m-d", locale: "ko" });

        // FullCalendar 초기화
        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,timeGridDay' },
            locale: 'ko',
            selectable: true,
            select: (info) => {
                planNoInput.value = '';
                titleInput.value = '';
                typeInput.value = '';
                detailsInput.value = '';
                startInput.value = info.startStr;
                const endDate = new Date(info.endStr);
                endDate.setDate(endDate.getDate() - 1);
                endInput.value = endDate.toISOString().split('T')[0];
                deleteBtn.style.display = 'none';
                modal.show();
            },
            eventClick: (info) => {
                planNoInput.value = info.event.id;
                const [type, title] = info.event.title.split(' - ');
                titleInput.value = title;
                typeInput.value = type;
                detailsInput.value = info.event.extendedProps.details || '';
                startInput.value = info.event.startStr;
                const endDate = new Date(info.event.endStr);
                endDate.setDate(endDate.getDate() - 1);
                endInput.value = endDate.toISOString().split('T')[0];
                deleteBtn.style.display = 'inline-block';
                modal.show();
            }
        });

        // DB에서 일정 불러오기
        fetch('/plan')
            .then(res => res.json())
            .then(plans => {
                const events = plans.map(plan => {
                    const endDate = new Date(plan.endDate);
                    endDate.setDate(endDate.getDate() + 1);
                    return {
                        id: plan.planNo,
                        title: `${plan.category} - ${plan.title}`,
                        start: plan.startDate,
                        end: endDate.toISOString().split('T')[0],
                        color: colorMap[plan.category] || '#999',
                        details: plan.description
                    };
                });
                calendar.addEventSource(events);
            });

        calendar.render();

        // 저장 (등록/수정)
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const data = {
                title: titleInput.value,
                category: typeInput.value,
                startDate: startInput.value,
                endDate: endInput.value,
                description: detailsInput.value,
                empIdNo: 1001 // TODO: 세션값으로 교체
            };
            const planNo = planNoInput.value;

            if (planNo) { // 수정
                fetch(`/plan/${planNo}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                }).then(res => res.json())
                .then(updated => {
                    const ev = calendar.getEventById(planNo);
                    ev.setProp('title', `${updated.category} - ${updated.title}`);
                    ev.setStart(updated.startDate);
                    const endDate = new Date(updated.endDate);
                    endDate.setDate(endDate.getDate() + 1);
                    ev.setEnd(endDate.toISOString().split('T')[0]);
                    ev.setExtendedProp('details', updated.description);
                });
            } else { // 추가
                fetch('/plan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                }).then(res => res.json())
                .then(created => {
                    if (created.planNo) {
                        const endDate = new Date(created.endDate);
                        endDate.setDate(endDate.getDate() + 1);
                        calendar.addEvent({
                            id: created.planNo,
                            title: `${created.category} - ${created.title}`,
                            start: created.startDate,
                            end: endDate.toISOString().split('T')[0],
                            color: colorMap[created.category] || '#999',
                            details: created.description
                        });
                    } else {
                        alert('등록 실패');
                    }
                });
            }

            modal.hide();
            form.reset();
        });

        // 삭제
        deleteBtn.addEventListener('click', () => {
            const planNo = planNoInput.value;
            const empIdNo = 1001;
            if (!planNo) return;
            if (!confirm('정말 삭제하시겠습니까?')) return;

            fetch(`/plan/${planNo}?empIdNo=${empIdNo}`, { method: 'DELETE' })
                .then(res => {
                    if (res.ok) {
                        const ev = calendar.getEventById(planNo);
                        if (ev) ev.remove();
                    } else if (res.status === 403) {
                        alert('삭제 권한이 없습니다.');
                    } else {
                        alert('삭제 실패');
                    }
                });
            modal.hide();
        });
    });
    </script>
</th:block>
</html>
