<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/base}">

<th:block layout:fragment="head_extra">
    <title>마이페이지</title>

    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/main.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-datepicker@1.10.0/dist/css/bootstrap-datepicker.min.css" rel="stylesheet"/>

    <style>
        html, body { height: 100%; }
        #content-wrapper { min-height: 100vh; }
        #content { flex: 1 0 auto; }

        .schedule-container { display: flex; gap: 20px; }
        .schedule-main { flex: 3; }
        .schedule-sidebar { flex: 1; background-color: #f8f9fa; padding: 20px; border-radius: 8px; height: fit-content; }
        #calendar { min-height: 700px; max-width: 1100px; margin: 0 auto; }
    </style>
</th:block>

<th:block layout:fragment="content">
    <!-- 모달 -->
    <div class="modal fade" id="scheduleModal" tabindex="-1" aria-labelledby="scheduleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="addScheduleForm">
                    <div class="modal-header">
                        <h5 class="modal-title" id="scheduleModalLabel">일정 추가/수정</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="plan-no">
                        <div class="mb-3">
                            <label for="schedule-title" class="form-label">제목</label>
                            <input type="text" class="form-control" id="schedule-title" required>
                        </div>
                        <div class="mb-3">
                            <label for="schedule-type" class="form-label">일정유형</label>
                            <select class="form-select" id="schedule-type" required>
                                <option value="">선택</option>
                                <option value="회의">회의</option>
                                <option value="출장">출장</option>
                                <option value="프로젝트 마감">프로젝트 마감</option>
                                <option value="기타">기타</option>
                            </select>
                        </div>
                        <div class="mb-3 row g-2">
                            <div class="col">
                                <label for="schedule-start" class="form-label">시작일</label>
                                <input type="text" class="form-control" id="schedule-start" required placeholder="YYYY-MM-DD">
                            </div>
                            <div class="col">
                                <label for="schedule-end" class="form-label">종료일</label>
                                <input type="text" class="form-control" id="schedule-end" required placeholder="YYYY-MM-DD">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="schedule-details" class="form-label">내용</label>
                            <textarea class="form-control" id="schedule-details"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary">저장</button>
                        <button type="button" class="btn btn-danger" id="delete-btn">삭제</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="schedule-container">
        <div class="schedule-main">
            <div id="calendar"></div>
        </div>
    </div>
</th:block>

<th:block layout:fragment="body_extra">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-datepicker@1.10.0/dist/js/bootstrap-datepicker.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-datepicker@1.10.0/dist/locales/bootstrap-datepicker.ko.min.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const calendarEl = document.getElementById('calendar');
        const scheduleForm = document.getElementById('addScheduleForm');
        const scheduleModalEl = document.getElementById('scheduleModal');
        const scheduleModal = new bootstrap.Modal(scheduleModalEl);
        const deleteBtn = document.getElementById('delete-btn');

        const startInput = document.getElementById('schedule-start');
        const endInput = document.getElementById('schedule-end');
        const planNoInput = document.getElementById('plan-no');

        const colorMap = { "회의": "#ff9f89", "출장": "#4caf50", "프로젝트 마감": "#2196f3", "기타": "#9c27b0" };

        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,timeGridDay' },
            locale: 'ko',
            selectable: true,
            select: function(info) {
                planNoInput.value = '';
                document.getElementById('schedule-title').value = '';
                document.getElementById('schedule-type').value = '';
                document.getElementById('schedule-details').value = '';
                startInput.value = info.startStr;
                const endDate = new Date(info.endStr);
                endDate.setDate(endDate.getDate() - 1);
                endInput.value = endDate.toISOString().split('T')[0];
                deleteBtn.style.display = 'none';
                scheduleModal.show();
            },
            eventClick: function(info) {
                planNoInput.value = info.event.id;
                const [type, title] = info.event.title.split(' - ');
                document.getElementById('schedule-title').value = title;
                document.getElementById('schedule-type').value = type;
                document.getElementById('schedule-details').value = info.event.extendedProps.details || '';
                startInput.value = info.event.startStr;
                const endDate = new Date(info.event.endStr);
                endDate.setDate(endDate.getDate() - 1);
                endInput.value = endDate.toISOString().split('T')[0];
                deleteBtn.style.display = 'inline-block';
                scheduleModal.show();
            }
        });

        // DB에서 일정 불러오기
        fetch('/plan')
            .then(res => res.json())
            .then(plans => {
                const events = plans.map(plan => {
                    const endDate = new Date(plan.endDate);
                    endDate.setDate(endDate.getDate() + 1);
                    return {
                        id: plan.planNo,
                        title: `${plan.category} - ${plan.title}`,
                        start: plan.startDate,
                        end: endDate.toISOString().split('T')[0],
                        color: colorMap[plan.category] || '#999',
                        details: plan.description
                    };
                });
                calendar.addEventSource(events);
            });

        calendar.render();

        // Datepicker 초기화
        $(startInput).datepicker({ format: "yyyy-mm-dd", todayHighlight: true, autoclose: true, language: "ko" });
        $(endInput).datepicker({ format: "yyyy-mm-dd", todayHighlight: true, autoclose: true, language: "ko" });

        // 일정 등록/수정
        scheduleForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const planData = {
                title: document.getElementById('schedule-title').value,
                category: document.getElementById('schedule-type').value,
                startDate: startInput.value,
                endDate: endInput.value,
                description: document.getElementById('schedule-details').value,
                empIdNo: 1001 // TODO: 로그인 세션에서 본인 empIdNo로 가져오기
            };

            const planNo = planNoInput.value;
            if(planNo){ // 수정
                fetch(`/plan/${planNo}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(planData)
                }).then(res => res.json())
                  .then(updatedPlan => {
                      const event = calendar.getEventById(planNo);
                      event.setProp('title', `${updatedPlan.category} - ${updatedPlan.title}`);
                      event.setStart(updatedPlan.startDate);
                      const endDate = new Date(updatedPlan.endDate);
                      endDate.setDate(endDate.getDate() + 1);
                      event.setEnd(endDate.toISOString().split('T')[0]);
                      event.setExtendedProp('details', updatedPlan.description);
                  });
            } else { // 추가
                fetch('/plan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(planData)
                }).then(res => res.json())
                  .then(createdPlan => {
                      if(createdPlan.planNo){
                          const endDate = new Date(createdPlan.endDate);
                          endDate.setDate(endDate.getDate() + 1);
                          calendar.addEvent({
                              id: createdPlan.planNo,
                              title: `${createdPlan.category} - ${createdPlan.title}`,
                              start: createdPlan.startDate,
                              end: endDate.toISOString().split('T')[0],
                              color: colorMap[createdPlan.category] || '#999',
                              details: createdPlan.description
                          });
                      } else {
                          alert('등록 실패');
                      }
                  });
            }

            scheduleModal.hide();
            scheduleForm.reset();
        });

        // 일정 삭제 (Map 기반 empIdNo 포함)
        deleteBtn.addEventListener('click', function() {
            const planNo = planNoInput.value;
            const empIdNo = 1001; // TODO: 로그인 세션에서 가져오기
            if(!planNo || !empIdNo) return;
            if(!confirm('정말 삭제하시겠습니까?')) return;

            fetch(`/plan/${planNo}?empIdNo=${empIdNo}`, { method: 'DELETE' })
                .then(res => {
                    if(res.ok){
                        const event = calendar.getEventById(planNo);
                        if(event) event.remove();
                    } else if(res.status === 403){
                        alert('삭제 권한이 없습니다.');
                    } else {
                        alert('삭제 실패');
                    }
                });

            scheduleModal.hide();
        });
    });
    </script>
</th:block>
