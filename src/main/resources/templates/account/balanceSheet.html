<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/base}">
<head>
<title layout:fragment="title">재무상태표</title>

<th:block layout:fragment="head_extra">
<link rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/styles/ag-grid.css" />
<link rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/styles/ag-theme-quartz.css" />

<!-- 📦 jsPDF + AutoTable + CSV -->
<script src="https://cdn.jsdelivr.net/npm/axios@1.7.7/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style scoped>
.btn-bar { display:flex; align-items:center; gap:0.5rem; margin-bottom:0.75rem; }
.ag-theme-quartz {
  --ag-header-background-color:#f9fafb;
  --ag-odd-row-background-color:#fafafa;
  --ag-border-color:#e5e7eb;
}
#bsGrid.ag-theme-quartz { height:38rem; width:100%; }
.row-header { background:#e5e7eb!important; font-weight:800; }
.row-subtotal { background:#f8fafc!important; font-weight:700; }
.row-total { background:#374151!important; color:#fff; font-weight:800; border-top:2px solid #111827; }
.indent-0 {padding-left:0;}
.indent-1 {padding-left:20px;}
.note {color:#9ca3af; font-size:.85rem;}
</style>
</th:block>
</head>

<body>
<section layout:fragment="content">
  <div class="card shadow mb-3">
    <div class="card-header py-3 d-flex align-items-center justify-content-between">
      <h6 class="m-0 font-weight-bold text-primary">재무상태표</h6>
    </div>

    <div class="card-body">
      <div class="btn-bar">
        <label class="form-label">기준월</label>
        <input type="month" id="srchYear" class="form-control form-control-sm" style="max-width:180px" />
        <button id="btnRecalc" class="btn btn-dark btn-sm">조회</button>
        <button id="btnCsv" class="btn btn-outline-success btn-sm">CSV</button>
        <button id="btnPdf" class="btn btn-outline-danger btn-sm">PDF</button>
      </div>
      <div id="bsGridWrapper" style="position:relative;">
      <div id="bsGrid" class="ag-theme-quartz"></div>
      </div>
    </div>
  </div>
</section>

<th:block layout:fragment="body_extra">
<script src="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/dist/ag-grid-community.min.noStyle.js"></script>
<script th:inline="none">

// ======================= 헬퍼 ==========================
let gridApi;
const fmt = n => (n ?? n === 0) ? n.toLocaleString('ko-KR') : "";
const sum = arr => arr.reduce((a,b)=>a+b,0);

// ======================= 데이터 구조 ==========================
function convertApiToTree(apiData) {
  const tree = { asset:{cur:{},non:{}}, liab:{cur:{},non:{}}, equity:{} };
  apiData.forEach(it => {
    const { acctKwan, acctHang, acctName, amount } = it;
    const h = Number(acctHang||0);
    if (acctKwan === 1) (h <= 4 ? tree.asset.cur : tree.asset.non)[acctName] = amount;
    else if (acctKwan === 2) (h <= 6 ? tree.liab.cur : tree.liab.non)[acctName] = amount;
    else if (acctKwan === 3) tree.equity[acctName] = amount;
  });
  return tree;
}

function buildRows(t) {
  const curAssetSum = sum(Object.values(t.asset.cur));
  const nonAssetSum = sum(Object.values(t.asset.non));
  const assetTotal = curAssetSum + nonAssetSum;
  const curLiabSum = sum(Object.values(t.liab.cur));
  const nonLiabSum = sum(Object.values(t.liab.non));
  const liabTotal = curLiabSum + nonLiabSum;
  const equitySum = sum(Object.values(t.equity));

  const rows = [];
  rows.push({rowType:"header", label:"자산"});
  rows.push({rowType:"subtotal", label:"Ⅰ. 유동자산", amount:curAssetSum});
  for(const [k,v] of Object.entries(t.asset.cur)) rows.push({label:k, amount:v, level:1});
  rows.push({rowType:"subtotal", label:"Ⅱ. 비유동자산", amount:nonAssetSum});
  for(const [k,v] of Object.entries(t.asset.non)) rows.push({label:k, amount:v, level:1});
  rows.push({rowType:"total", label:"자산총계", amount:assetTotal});

  rows.push({rowType:"header", label:"부채"});
  rows.push({rowType:"subtotal", label:"Ⅰ. 유동부채", amount:curLiabSum});
  for(const [k,v] of Object.entries(t.liab.cur)) rows.push({label:k, amount:v, level:1});
  rows.push({rowType:"subtotal", label:"Ⅱ. 비유동부채", amount:nonLiabSum});
  for(const [k,v] of Object.entries(t.liab.non)) rows.push({label:k, amount:v, level:1});
  rows.push({rowType:"total", label:"부채총계", amount:liabTotal});

  rows.push({rowType:"header", label:"자본"});
  for(const [k,v] of Object.entries(t.equity)) rows.push({label:k, amount:v, level:1});
  rows.push({rowType:"subtotal", label:"자본총계", amount:equitySum});
  rows.push({rowType:"total", label:"부채와자본총계", amount:liabTotal+equitySum});
  return { rows };
}

// ======================= 데이터 로드 ==========================
async function loadBalanceSheet(yearMonth) {
  try {
    const res = await axios.get(`/api/account/balance-sheet`, { params:{ yearMonth }});
    const tree = convertApiToTree(res.data);
    const { rows } = buildRows(tree);
    gridApi.setGridOption('rowData', rows);
  } catch (err) {
    console.error('❌ 재무상태표 로드 실패:', err);
    alert('데이터를 불러오는 중 오류가 발생했습니다.');
  }
}

// ======================= CSV ==========================
function exportCsv() {
  const data = [];
  for(let i=0;i<gridApi.getDisplayedRowCount();i++){
    const row = gridApi.getDisplayedRowAtIndex(i)?.data;
    if(row) data.push({계정과목:row.label, 금액:row.amount||0});
  }
  const csv = Papa.unparse(data);
  const blob = new Blob([csv], { type:"text/csv;charset=utf-8" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `재무상태표_${document.getElementById('srchYear').value}.csv`;
  a.click();
}

// ======================= PDF ==========================
const KR_FONT_URL = '/fonts/NotoSansKR-Regular.ttf';
let __krFontBase64 = null;

async function fetchAsBase64(url) {
  const res = await fetch(url, { cache: 'force-cache' });
  if (!res.ok) throw new Error('Font fetch failed: ' + res.status);
  const buf = await res.arrayBuffer();
  let binary = '';
  const bytes = new Uint8Array(buf);
  for (let i = 0; i < bytes.byteLength; i++) binary += String.fromCharCode(bytes[i]);
  return btoa(binary);
}

async function ensureKoreanFont() {
  if (__krFontBase64) return __krFontBase64;
  __krFontBase64 = await fetchAsBase64(KR_FONT_URL);
  return __krFontBase64;
}

async function exportPdf() {
  const jsPDFCtor = (window.jspdf && window.jspdf.jsPDF) || window.jsPDF;
  if (!jsPDFCtor) return alert('jsPDF가 로드되지 않았습니다.');
  if (!('autoTable' in (jsPDFCtor.API || {}))) return alert('jspdf-autotable이 로드되지 않았습니다.');

  const val = document.getElementById('srchYear').value;
  const ym = val.replace('-', '');
  const label = `${val} 말`;

  const rowData = gridApi.getDisplayedRowAtIndex
    ? Array.from({ length: gridApi.getDisplayedRowCount() }, (_, i) => gridApi.getDisplayedRowAtIndex(i).data)
    : [];
  const table = rowData.map(r => [
    `${'　'.repeat(r.level || 0)}${r.label}`,
    r.amount ? Number(r.amount).toLocaleString() : ''
  ]);

  const doc = new jsPDFCtor({ orientation: 'portrait', unit: 'pt', format: 'a4' });
  try {
    const base64 = await ensureKoreanFont();
    doc.addFileToVFS('NotoSansKR-Regular.ttf', base64);
    doc.addFont('NotoSansKR-Regular.ttf', 'NotoSansKR', 'normal');
    doc.setFont('NotoSansKR');

    // 제목
    doc.setFontSize(16);
    doc.text(`재무상태표 (${label})`, 40, 50);
    
	// 단위
    doc.setFontSize(10);
    doc.text('(단위 : 원)', 500, 85, { align: 'right' });
    // 표
    doc.autoTable({
      startY: 100,
      head: [['계정과목', '금액']],
      body: table,
      theme: 'striped',
      styles: { font: 'NotoSansKR', fontSize: 9, cellPadding: 4 },
      headStyles: { font: 'NotoSansKR', fillColor: [55, 65, 81], textColor: 255 },
      bodyStyles: { font: 'NotoSansKR' },
      columnStyles: { 0: { cellWidth: 320 }, 1: { halign: 'right' } }
    });

    doc.save(`재무상태표_${ym}.pdf`);
  } catch (e) {
    console.error(e);
    alert('폰트 로드 오류가 발생했습니다.');
  }
}

// ======================= 초기화 ==========================
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('srchYear').value = new Date().toISOString().slice(0, 7);
  const columnDefs = [
    { headerName: '계정과목', field: 'label', flex: 2,
      cellRenderer: p => `<span class="indent-${p.data.level || 0}">${p.value}</span>` },
    { headerName: '금액', field: 'amount', flex: 1, valueFormatter: p => fmt(p.value) }
  ];
  const gridOptions = {
    columnDefs,
    rowData: [],
    getRowClass: p => {
      if (p.data?.rowType === "header") return "row-header";
      if (p.data?.rowType === "subtotal") return "row-subtotal";
      if (p.data?.rowType === "total") return "row-total";
    },
    defaultColDef: { resizable: true }
  };
  gridApi = agGrid.createGrid(document.getElementById('bsGrid'), gridOptions);

  document.getElementById('btnRecalc').addEventListener('click', async () => {
    const val = document.getElementById('srchYear').value;
    if (!val) return alert('조회 기준월을 선택하세요.');
    showLoader("bsGridWrapper", "재무상태표를 불러오는 중입니다...");
    await loadBalanceSheet(val.replace('-', ''));
    hideLoader("bsGridWrapper");
  });
  document.getElementById('btnCsv').addEventListener('click', exportCsv);
  document.getElementById('btnPdf').addEventListener('click', exportPdf);

  
  loadBalanceSheet(document.getElementById('srchYear').value.replace('-', ''));
  
});
</script>
</th:block>
</body>
</html>
