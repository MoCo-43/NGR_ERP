<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/base}">
<head>
<title layout:fragment="title">ìê¸ˆì „í‘œ</title>

<th:block layout:fragment="head_extra">
	<!-- AG Grid -->
	<link rel="stylesheet"
		href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/styles/ag-grid.css" />
	<link rel="stylesheet"
		href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/styles/ag-theme-quartz.css" />
	<style>
h6 {
	margin: 0.5rem 0;
	font-weight: bold;
}

.btn-bar {
	display: flex;
	align-items: center;
	gap: 0.5rem;
	margin-bottom: 0.75rem;
}

.ag-theme-quartz {
	--ag-header-background-color: #f9fafb;
	--ag-odd-row-background-color: #fafafa;
	--ag-border-color: #e5e7eb;
}

/* âœ… êµ¬ë¶„ ë°°ì§€ (ë§¤ì…/ë§¤ì¶œ) */
.badge-type {
	display: inline-block;
	padding: 0.15rem 0.5rem;
	border-radius: 9999px;
	font-weight: 600;
	font-size: 0.8rem;
	line-height: 1.2;
}

.badge-sales {
	background: #fee2e2;
	color: #b91c1c;
}

.badge-purchase {
	background: #dbeafe;
	color: #1d4ed8;
}

/* âœ… ì ìš©ë‚´ì—­ ê·¸ë¦¬ë“œ */
#applyGrid.ag-theme-quartz {
	height: 14rem;
	width: 100%;
	margin-top: 1rem;
}

/* âœ… í—¤ë” ì¹´ë“œ */
.card-header h6 {
	font-weight: bold;
}
h6 {
	margin: 0.5rem 0;
	font-weight: bold;
	color: black;
}
/* âœ… ì˜¤ë¥¸ìª½ ë²„íŠ¼ ë„ìš°ê¸°ìš© */
.text-end {
  text-align: right !important;
}

.btn-bar {
	display: flex;
	align-items: center;
	gap: 0.5rem;
	margin-bottom: 0.75rem;
}
</style>
</th:block>
</head>

<body>
	<section layout:fragment="content">
		<div class="card shadow mb-3">
			<div
				class="card-header py-3 d-flex align-items-center justify-content-between">
				<h6 class="m-0 font-weight-bold text-primary">ìê¸ˆì „í‘œ ê´€ë¦¬</h6>
			</div>

			<div class="card-body">
				<!-- ğŸ”¹ í•„í„°/ë²„íŠ¼ ë°” -->
				<div class="btn-bar">
					<input type="date" id="fromDate"
						class="form-control form-control-sm" style="max-width: 180px" />
					<span>~</span> <input type="date" id="toDate"
						class="form-control form-control-sm" style="max-width: 180px" />
					<select id="typeSelect" class="form-select form-select-sm"
						style="max-width: 120px">
						<option value="">ì „ì²´</option>
						<option value="S">ë§¤ì¶œì „í‘œ</option>
						<option value="P">ë§¤ì…ì „í‘œ</option>
					</select> <input type="text" id="searchCus" placeholder="ê±°ë˜ì²˜ëª…"
						class="form-control form-control-sm" style="max-width: 180px" />
					<button id="btnSearch" class="btn btn-dark btn-sm">ì¡°íšŒ</button>

				</div>

				<!-- ğŸ”¹ ë¯¸ê²°ì „í‘œ ëª©ë¡ -->
				<div class="row">
					<!-- ì™¼ìª½: ë¯¸ê²°ì „í‘œ ëª©ë¡ -->
					<div class="col-md-7">
						<h6>ë¯¸ê²°ì „í‘œ ëª©ë¡</h6>
						<div id="unpaidGrid" class="ag-theme-quartz"
							style="height: 24rem; width: 100%;"></div>
					</div>

					<!-- ì˜¤ë¥¸ìª½: ê²°ì œ ë“±ë¡ í¼ -->
					<div class="col-md-5">
						<h6>ê²°ì œ ë“±ë¡</h6>
						<form id="paymentForm" class="border rounded p-3 bg-light">
							<div class="mb-2">
								<label class="form-label">ê±°ë˜ì²˜ëª…</label> <input type="text"
									id="formCusName" class="form-control form-control-sm" readonly>
							</div>

							<div class="mb-2">
								<label class="form-label">ê²°ì œë°©ì‹</label> <select id="formMethod"
									class="form-select form-select-sm">
									<option value="í˜„ê¸ˆ">í˜„ê¸ˆ</option>
									<option value="ì´ì²´">ì–´ìŒ</option>
									<option value="ì¹´ë“œ">í˜„ê¸ˆ&ì–´ìŒ</option>
								</select>
							</div>

							<div class="mb-2">
								<label class="form-label">ê³„ì¢Œë²ˆí˜¸</label> <input type="text"
									id="formAccount" class="form-control form-control-sm">
							</div>

							<div class="mb-2">
								<label class="form-label">ê²°ì œê¸ˆì•¡</label> <input type="number"
									id="formAmount" class="form-control form-control-sm text-end">
							</div>

							<div class="mb-2">
								<label class="form-label">ë¹„ê³ </label> <input type="text"
									id="formMemo" class="form-control form-control-sm">
							</div>

							<!-- âœ… ë²„íŠ¼ ì¤‘ì•™ ì •ë ¬ + ì´ˆê¸°í™” ë²„íŠ¼ ì¶”ê°€ -->
							<div class="d-flex justify-content-center gap-2 mt-3">
								<button type="button" id="btnSavePayment"
									class="btn btn-primary btn-sm px-4">ì €ì¥</button>
								<button type="button" id="btnResetForm"
									class="btn btn-danger btn-sm px-4 ml-2">ì´ˆê¸°í™”</button>
							</div>
						</form>
					</div>

					<!-- ğŸ”¹ ìê¸ˆì „í‘œ ì ìš©ë‚´ì—­ -->
				</div>
					<h6 class="mt-3">ì ìš©ë‚´ì—­</h6>
					<div class="d-flex justify-content-end gap-2 my-2">
						<button type="button" id="btnRegisterJournal"
							class="btn btn-success btn-sm">ì¼ë°˜ì „í‘œë“±ë¡</button>
							
					</div>
					
					<div id="journalPreviewGrid" class="ag-theme-quartz"
						style="height: 16rem; width: 100%;"></div>
			</div>
	</section>

	<th:block layout:fragment="body_extra">
		<script
			src="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/dist/ag-grid-community.min.js"></script>
		<script
			src="https://cdn.jsdelivr.net/npm/axios@1.7.7/dist/axios.min.js"></script>
		<script th:inline="none">

let journalPreviewApi;
let unpaidApi;
let selectedInvoice = null;

// âœ… í˜ì´ì§€ ì´ˆê¸°í™”
document.addEventListener("DOMContentLoaded", () => {
	const today = new Date();
	const yyyy = today.getFullYear();
	const mm = String(today.getMonth()+1).padStart(2,'0');
	const dd = String(today.getDate()).padStart(2,'0');
	document.getElementById("fromDate").value = `${yyyy}-${mm}-01`;
	document.getElementById("toDate").value   = `${yyyy}-${mm}-${dd}`;

	initUnpaidGrid();
	loadUnpaidList();
	initJournalPreviewGrid();
	
	document.getElementById("btnSearch").addEventListener("click", loadUnpaidList);
	document.getElementById("btnSavePayment").addEventListener("click", savePayment);
});

// === ë¯¸ê²°ì „í‘œ Grid ===
function initUnpaidGrid() {
	const cols = [
		{ headerName: "ì „í‘œë²ˆí˜¸", field: "invoiceNo", flex: 1 },
		{ headerName: "ìœ í˜•", field: "type", flex: .8,
		  cellRenderer: p => {
			const cls = p.value === 'S' ? 'badge-sales' : 'badge-purchase';
			const txt = p.value === 'S' ? 'ë§¤ì¶œ' : 'ë§¤ì…';
			return `<span class="badge-type ${cls}">${txt}</span>`;
		  }
		},
		{ headerName: "ê±°ë˜ì²˜ëª…", field: "cusName", flex: 1 },
		{ headerName: "ì „í‘œê¸ˆì•¡", field: "totalAmt", valueFormatter: v => v.value?.toLocaleString(), flex: 1 },
		{ headerName: "ë¯¸ê²°ê¸ˆì•¡", field: "unpaidAmt", valueFormatter: v => v.value?.toLocaleString(), flex: 1 },
		{ headerName: "ê²°ì œë°©ì‹", field: "payMethod", flex: 1 },
		{ headerName: "ê³„ì¢Œë²ˆí˜¸", field: "cashAccount", flex: 1 },
		{ headerName: "ë¹„ê³ ", field: "memo", flex: 1 },
		{ headerName: "ì „í‘œì¼ì", field: "invoiceDate", valueFormatter: v => v.value?.substring(0,10), flex: 1 }
	];

	unpaidApi = agGrid.createGrid(document.getElementById("unpaidGrid"), {
		columnDefs: cols,
		rowData: [],
		rowSelection: "single",
		defaultColDef: { resizable: true, sortable: true },
		onRowClicked: e => fillPaymentForm(e.data) // âœ… í´ë¦­ ì‹œ í¼ ì±„ìš°ê¸°
	});
}

// === ì˜¤ë¥¸ìª½ í¼ ì±„ìš°ê¸° ===
function fillPaymentForm(data) {
	selectedInvoice = data;

	document.getElementById("formCusName").value = data.cusName || "";
	document.getElementById("formMethod").value   = data.method || "í˜„ê¸ˆ";
	document.getElementById("formAccount").value  = data.cashAccount || "";
	document.getElementById("formMemo").value     = data.memo || "";
	document.getElementById("formAmount").value   = data.unpaidAmt || 0;
}

// === ë°ì´í„° ë¡œë“œ ===
async function loadUnpaidList() {
	const type = document.getElementById("typeSelect").value;
	const fromDate = document.getElementById("fromDate").value;
	const toDate = document.getElementById("toDate").value;
	const searchCus = document.getElementById("searchCus").value;

	try {
		const { data } = await axios.get("/api/account/unpaidList", { params: { type, fromDate, toDate, searchCus } });
		unpaidApi.setGridOption("rowData", data || []);
		selectedInvoice = null;
		document.getElementById("paymentForm").reset(); // ì´ì „ í¼ ì´ˆê¸°í™”
	} catch (err) {
		console.error(err);
		alert("ë¯¸ê²°ì „í‘œ ì¡°íšŒ ì‹¤íŒ¨");
	}
}

async function savePayment() {
	  if (!selectedInvoice) {
	    alert("ì „í‘œë¥¼ ì„ íƒí•˜ì„¸ìš”.");
	    return;
	  }

	  const payAmount = Number(document.getElementById("formAmount").value || 0);
	  if (payAmount <= 0) {
	    alert("ê²°ì œê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”.");
	    return;
	  }
	  const backupInvoice = { ...selectedInvoice };
	  const header = {
	    payDate: new Date().toISOString().substring(0,10),
	    payType: selectedInvoice.type === 'S' ? 'IN' : 'OUT',
	    cusCode: selectedInvoice.cusCode,
	    cusName: selectedInvoice.cusName,
	    method: document.getElementById("formMethod").value,
	    cashAccount: document.getElementById("formAccount").value,
	    amount: payAmount,
	    memo: document.getElementById("formMemo").value
	  };

	  const apply = {
	    type: selectedInvoice.type,
	    invoiceNo: selectedInvoice.invoiceNo,
	    applyAmount: payAmount,
	    payNo: null
	  };

	  try {
	    // âœ… ì„œë²„ì— ì €ì¥
	    const payment = { ...header, applies: [apply] }
	    const {data} = await axios.post("/api/account/payment/save",payment);
	   
	 // âœ… ì„œë²„ì—ì„œ payCode ë°˜í™˜ë°›ê¸°
	    const payCode = data.payCode;
	    selectedInvoice = { ...selectedInvoice, payCode }; // ì—¬ê¸°ì— ì €ì¥!
	    
	    console.log(selectedInvoice);
	    // âœ… ë¯¸ë¦¬ë³´ê¸° ë¶„ê°œ ìë™ ìƒì„±
	    const journalPreview = buildJournalPreview(selectedInvoice, header);
	    journalPreviewApi.setGridOption("rowData", journalPreview);
		
	    alert("ìê¸ˆì „í‘œ ì €ì¥ ë° íšŒê³„ì²˜ë¦¬ ìƒì„± ì™„ë£Œ!");

	  } catch (err) {
	    console.error(err);
	    alert("ì €ì¥ ì‹¤íŒ¨");
	  }
	}


//=== íšŒê³„ì²˜ë¦¬ ë¯¸ë¦¬ë³´ê¸° Grid ì´ˆê¸°í™” ===
function initJournalPreviewGrid() {
	const cols = [
	 { headerName: "êµ¬ë¶„", field: "gbn", flex: .8 },
	 { headerName: "ê³„ì •ì½”ë“œ", field: "acctCode", flex: 1 },
	 { headerName: "ê³„ì •ëª…", field: "acctName", flex: 1 },
	 { headerName: "ê±°ë˜ì²˜ëª…", field: "cusName", flex: 1 },
	 { headerName: "ì°¨ë³€", field: "debit", valueFormatter: v => v.value?.toLocaleString(), flex: 1 },
	 { headerName: "ëŒ€ë³€", field: "credit", valueFormatter: v => v.value?.toLocaleString(), flex: 1 },
	 { headerName: "ì ìš”", field: "note", flex: 1.5, editable: true }
	];
	journalPreviewApi = agGrid.createGrid(document.getElementById("journalPreviewGrid"), {
	 columnDefs: cols,
	 rowData: [],
	 defaultColDef: { resizable: true }
	});
}

// ë¶„ê°œ ë¯¸ë¦¬ë³´ê¸°
function buildJournalPreview(invoice, header) {
	  const rows = [];
	  const amt = Number(header.amount || 0);
	  const cus = header.cusName;

	  // âœ… ë§¤ì¶œì „í‘œ (ìˆ˜ê¸ˆ)
	  if (invoice.type === "S") {
	    rows.push({
	      gbn: "ì°¨ë³€",
	      acctCode: "101",
	      acctName: "ë³´í†µì˜ˆê¸ˆ",
	      cusName: cus,
	      debit: amt,
	      credit: null,
	      note: "ë§¤ì¶œ ìˆ˜ê¸ˆ"
	    });
	    rows.push({
	      gbn: "ëŒ€ë³€",
	      acctCode: "108",
	      acctName: "ì™¸ìƒë§¤ì¶œê¸ˆ",
	      cusName: cus,
	      debit: null,
	      credit: amt,
	      note: "ì™¸ìƒëŒ€ê¸ˆ ê²°ì œ"
	    });
	  }

	  // âœ… ë§¤ì…ì „í‘œ (ì§€ê¸‰)
	  else if (invoice.type === "P") {
	    rows.push({
	      gbn: "ì°¨ë³€",
	      acctCode: "251",
	      acctName: "ì™¸ìƒë§¤ì…ê¸ˆ",
	      cusName: cus,
	      debit: amt,
	      credit: null,
	      note: "ì™¸ìƒëŒ€ê¸ˆ ì§€ê¸‰"
	    });
	    rows.push({
	      gbn: "ëŒ€ë³€",
	      acctCode: "101",
	      acctName: "ë³´í†µì˜ˆê¸ˆ",
	      cusName: cus,
	      debit: null,
	      credit: amt,
	      note: "ë§¤ì…ëŒ€ê¸ˆ ì¶œê¸ˆ"
	    });
	  }

	  return rows;
	}
	
//=== ì¼ë°˜ì „í‘œ ë“±ë¡ ===
document.getElementById("btnRegisterJournal").addEventListener("click", async () => {
  const rows = [];
  journalPreviewApi.forEachNode(node => rows.push(node.data));

  if (rows.length === 0) {
    alert("íšŒê³„ ë¶„ê°œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }
  // âœ… ìƒˆ ì „í‘œë²ˆí˜¸ ë°œê¸‰
  const { data: newNo } = await axios.get("/api/account/nextJrnNo");

  // âœ… ì „í‘œ payload êµ¬ì„±
  const payload = rows.map((r, idx) => ({
    jrnNo: newNo,
    lineNo: idx + 1,
    jrnDate: new Date().toISOString().substring(0, 10),
    acctCode: r.acctCode,
    acctName: r.acctName,
    dcType: r.gbn === "ì°¨ë³€" ? "D" : "C",
    amount: r.debit ? r.debit : r.credit,
    remarks: r.note,
    cusCode: selectedInvoice.cusCode,
    cusName: selectedInvoice.cusName,
    status: "open"
  }));
	
  try {
    // âœ… ì¼ë°˜ì „í‘œ ì €ì¥
    await axios.post("/api/account/journalList", payload);

    // âœ… ìê¸ˆì „í‘œ ìƒíƒœ ì—…ë°ì´íŠ¸
    await axios.put(`/api/account/payment/${selectedInvoice.payCode}/posted`, {
      postedFlag: "Y"
    });
	
    alert("ì¼ë°˜ì „í‘œ ë“±ë¡ ì™„ë£Œ!");
    loadUnpaidList();
  } catch (err) {
    console.error(err);
    alert("ì¼ë°˜ì „í‘œ ë“±ë¡ ì‹¤íŒ¨");
  }
});
</script>
	</th:block>
</body>
</html>
