<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/base}">
<head>
<title layout:fragment="title">자금전표</title>

<th:block layout:fragment="head_extra">
	<!-- AG Grid -->
	<link rel="stylesheet"
		href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/styles/ag-grid.css" />
	<link rel="stylesheet"
		href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/styles/ag-theme-quartz.css" />
	<style>
h6 {
	margin: 0.5rem 0;
	font-weight: bold;
}

.btn-bar {
	display: flex;
	align-items: center;
	gap: 0.5rem;
	margin-bottom: 0.75rem;
}

.ag-theme-quartz {
	--ag-header-background-color: #f9fafb;
	--ag-odd-row-background-color: #fafafa;
	--ag-border-color: #e5e7eb;
}

/* ✅ 구분 배지 (매입/매출) */
.badge-type {
	display: inline-block;
	padding: 0.15rem 0.5rem;
	border-radius: 9999px;
	font-weight: 600;
	font-size: 0.8rem;
	line-height: 1.2;
}

.badge-sales {
	background: #fee2e2;
	color: #b91c1c;
}

.badge-purchase {
	background: #dbeafe;
	color: #1d4ed8;
}

/* ✅ 적용내역 그리드 */
#applyGrid.ag-theme-quartz {
	height: 14rem;
	width: 100%;
	margin-top: 1rem;
}

/* ✅ 헤더 카드 */
.card-header h6 {
	font-weight: bold;
}

h6 {
	margin: 0.5rem 0;
	font-weight: bold;
	color: black;
}
/* ✅ 오른쪽 버튼 띄우기용 */
.text-end {
	text-align: right !important;
}

.btn-bar {
	display: flex;
	align-items: center;
	gap: 0.5rem;
	margin-bottom: 0.75rem;
}

#formAmount {
	text-align: left !important;
}
</style>
</th:block>
</head>

<body>
	<section layout:fragment="content">
		<div class="card shadow mb-3">
			<div
				class="card-header py-3 d-flex align-items-center justify-content-between">
				<h6 class="m-0 font-weight-bold text-primary">자금전표 관리</h6>
			</div>

			<div class="card-body">
				<!-- 🔹 필터/버튼 바 -->
				<div class="btn-bar">
					<input type="date" id="fromDate"
						class="form-control form-control-sm" style="max-width: 180px" />
					<span>~</span> <input type="date" id="toDate"
						class="form-control form-control-sm" style="max-width: 180px" />
					<select id="typeSelect" class="form-select form-select-sm"
						style="max-width: 120px">
						<option value="">전체</option>
						<option value="S">매출전표</option>
						<option value="P">매입전표</option>
					</select> <input type="text" id="searchCus" placeholder="거래처명"
						class="form-control form-control-sm" style="max-width: 180px" />
					<button id="btnSearch" class="btn btn-dark btn-sm">조회</button>

				</div>

				<!-- 🔹 미결전표 목록 -->
				<div class="row">
					<!-- 왼쪽: 미결전표 목록 -->
					<div class="col-md-7">
						<h6>미결전표 목록</h6>
						<div id="unpaidGridWrapper" style="position:relative;">
						<div id="unpaidGrid" class="ag-theme-quartz"
							style="height: 24rem; width: 100%;"></div>
							</div>
					</div>

					<!-- 오른쪽: 결제 등록 폼 -->
					<div class="col-md-5">
						<h6>결제 등록</h6>
						<form id="paymentForm" class="border rounded p-3 bg-light">
							<div class="mb-2">
								<label class="form-label">거래처명</label> <input type="text"
									id="formCusName" class="form-control form-control-sm" readonly>
							</div>

							<div class="mb-2">
								<label class="form-label">결제방식</label> <input type="text"
									id="formMethod" class="form-control form-control-sm" readonly>
							</div>

							<div class="mb-2">
								<label class="form-label">계좌 정보</label>
								<div class="d-flex align-items-center" style="gap: 1rem;"> 
									<input type="text" id="formAccount"
										class="form-control form-control-sm" placeholder="계좌번호"
										style="flex: 0.8;" readonly> <input type="text"
										id="formBank" class="form-control form-control-sm"
										placeholder="은행명" style="flex: 0.8;" readonly>
								</div>
							</div>

							<div class="mb-2">
								<label class="form-label">결제금액</label> <input type="text"
									id="formAmount" class="form-control form-control-sm text-end">
							</div>

							<div class="mb-2">
								<label class="form-label">비고</label> <input type="text"
									id="formMemo" class="form-control form-control-sm">
							</div>

							<!-- ✅ 버튼 중앙 정렬 + 초기화 버튼 추가 -->
							<div class="d-flex justify-content-center gap-2 mt-3">
								<button type="button" id="btnSavePayment"
									class="btn btn-primary btn-sm px-4">저장</button>
								<button type="button" id="btnResetForm"
									class="btn btn-danger btn-sm px-4 ml-2">초기화</button>
							</div>
						</form>
					</div>

					<!-- 🔹 자금전표 적용내역 -->
				</div>
				<h6 class="mt-3">적용내역</h6>


				<div id="journalPreviewGrid" class="ag-theme-quartz"
					style="height: 16rem; width: 100%;"></div>
			</div>
			
	</section>

	<th:block layout:fragment="body_extra">
		<script
			src="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/dist/ag-grid-community.min.js"></script>
		<script
			src="https://cdn.jsdelivr.net/npm/axios@1.7.7/dist/axios.min.js"></script>
		<script th:inline="none">

let journalPreviewApi;
let unpaidApi;
let selectedInvoice = null;


// ✅ 페이지 초기화
document.addEventListener("DOMContentLoaded", () => {
	const today = new Date();
	const yyyy = today.getFullYear();
	const mm = String(today.getMonth()+1).padStart(2,'0');
	const dd = String(today.getDate()).padStart(2,'0');
	document.getElementById("fromDate").value = `${yyyy}-${mm}-01`;
	document.getElementById("toDate").value   = `${yyyy}-${mm}-${dd}`;

	initUnpaidGrid();
	loadUnpaidList();
	initJournalPreviewGrid();
	
	document.getElementById("btnSearch").addEventListener("click", loadUnpaidList);
	document.getElementById("btnSavePayment").addEventListener("click", savePayment);
	document.getElementById("btnResetForm").addEventListener("click", resetPaymentForm);
	
});

// === 미결전표 Grid ===
function initUnpaidGrid() {
	showLoader("unpaidGridWrapper", "입고 데이터를 불러오는 중입니다...");
	const cols = [
		{ headerName: "전표번호", field: "invoiceNo", flex: 1 },
		{ headerName: "유형", field: "type", flex: .8,
		  cellRenderer: p => {
			const cls = p.value === 'S' ? 'badge-sales' : 'badge-purchase';
			const txt = p.value === 'S' ? '매출' : '매입';
			return `<span class="badge-type ${cls}">${txt}</span>`;
		  }
		},
		{ headerName: "거래처명", field: "cusName", flex: 1 },
		{ headerName: "전표금액", field: "totalAmt", valueFormatter: v => v.value?.toLocaleString(), flex: 1 },
		{ headerName: "미결금액", field: "unpaidAmt", valueFormatter: v => v.value?.toLocaleString(), flex: 1 },
		{ headerName: "결제방식", field: "payMethod", flex: 1 },
		{ headerName: "계좌번호", field: "cashAccount", flex: 1 },
		{ headerName: "비고", field: "memo", flex: 1 },
		{ headerName: "전표일자", field: "invoiceDate", valueFormatter: v => v.value?.substring(0,10), flex: 1 }
	];

	unpaidApi = agGrid.createGrid(document.getElementById("unpaidGrid"), {
		columnDefs: cols,
		rowData: [],
		rowSelection: "single",
		defaultColDef: { resizable: true, sortable: true },
		onRowClicked: e =>fillPaymentForm(e.data) // ✅ 클릭 시 폼 채우기
		
	});
	hideLoader("unpaidGridWrapper");
}

// === 오른쪽 폼 채우기 ===
function fillPaymentForm(data) {
	selectedInvoice = data;

	document.getElementById("formCusName").value = data.cusName || "";
	document.getElementById("formMethod").value   = data.payMethod || "현금";
	document.getElementById("formAccount").value  = data.cashAccount || "";
	document.getElementById("formBank").value  = data.bankName || "";
	document.getElementById("formMemo").value     = data.memo || "";
	document.getElementById("formAmount").value   =  data.unpaidAmt.toLocaleString("ko-KR") || 0;
}

// === 데이터 로드 ===
async function loadUnpaidList() {
	const type = document.getElementById("typeSelect").value;
	const fromDate = document.getElementById("fromDate").value;
	const toDate = document.getElementById("toDate").value;
	const searchCus = document.getElementById("searchCus").value;

	try {
		const { data } = await axios.get("/api/account/unpaidList", { params: { type, fromDate, toDate, searchCus } });
		unpaidApi.setGridOption("rowData", data || []);
		selectedInvoice = null;
		document.getElementById("paymentForm").reset(); // 이전 폼 초기화
	} catch (err) {
		console.error(err);
		alert("미결전표 조회 실패");
	}
}

async function savePayment() {
	  if (!selectedInvoice) {
		  toastr.info("전표를 선택하세요");
	    return;
	  }
	
	  const payAmount = Number( document.getElementById("formAmount").value.replace(/[^0-9]/g, "") || 0);
	  if (payAmount <= 0) {
		  toastr.info("결제금액을 선택하세요");
	    return;
	  }
	  // ✅ 초과 결제 방지
	  unpaidAmt = selectedInvoice.unpaidAmt;
	  console.log(payAmount);
	  console.log(unpaidAmt);
	  // 커서 밖으로 나가야 막힘
	  if (payAmount > unpaidAmt) {
	    toastr.warning(`결제금액은 미결금액(${unpaidAmt.toLocaleString()}원)을 초과할 수 없습니다.`);
	    document.getElementById("formAmount").value = unpaidAmt; // 자동으로 미결금액으로 맞춰줌 (선택사항)
	    return;
	  }
	  let methodText = document.getElementById("formMethod").value?.trim();
	  let methodCode = "CASH"; // 기본값
	  if (methodText === "현금") methodCode = "CASH";
	  else if (methodText === "어음") methodCode = "BILL";
	  else if (methodText === "이체") methodCode = "BANK"; // 혹시 나중을 위해 추가
	  
	  const header = {
	    payDate: new Date().toISOString().substring(0,10),
	    payType: selectedInvoice.type === 'S' ? 'IN' : 'OUT',
	    cusCode: selectedInvoice.cusCode,
	    cusName: selectedInvoice.cusName,
	    method: methodCode, // ✅ 변환된 코드로 전달
	    cashAccount: document.getElementById("formAccount").value,
	    amount: payAmount,
	    memo: document.getElementById("formMemo").value
	  };

	  const apply = {
	    type: selectedInvoice.type,
	    invoiceNo: selectedInvoice.invoiceNo,
	    applyAmount: payAmount
	  };

	  try {
	    const payment = { ...header, applies: [apply] };
	    console.log(payment);
	    const { data } = await axios.post("/api/account/payment/save", payment);
		
	    // ✅ 서버에서 분개 데이터(journals)까지 반환되도록 설정했을 경우
	    if (data.journals && data.journals.length > 0) {
	      journalPreviewApi.setGridOption("rowData", data.journals.map(j => ({
	        gbn: j.dcType === "D" ? "차변" : "대변",
	        acctCode: j.acctCode,
	        acctName: j.acctName || "",
	        cusName: selectedInvoice.cusName,
	        debit: j.dcType === "D" ? j.amount : null,
	        credit: j.dcType === "C" ? j.amount : null,
	        note: j.remarks
	      })));
	    }

	    toastr.success("자금전표 및 일반전표 자동반영 완료!");
	    loadUnpaidList();
	  } catch (err) {
	    console.error(err);
	    toastr.error("저장 실패: " + (err.response?.data?.message || err.message));
	  }
	}


//=== 회계처리 미리보기 Grid 초기화 ===
function initJournalPreviewGrid() {
	const cols = [
	 { headerName: "구분", field: "gbn", flex: .8 },
	 { headerName: "계정코드", field: "acctCode", flex: 1 },
	 { headerName: "거래처명", field: "cusName", flex: 1 },
	 { headerName: "차변", field: "debit", valueFormatter: v => v.value?.toLocaleString(), flex: 1 },
	 { headerName: "대변", field: "credit", valueFormatter: v => v.value?.toLocaleString(), flex: 1 },
	 { headerName: "적요", field: "note", flex: 1.5, editable: true }
	];
	journalPreviewApi = agGrid.createGrid(document.getElementById("journalPreviewGrid"), {
	 columnDefs: cols,
	 rowData: [],
	 defaultColDef: { resizable: true }
	});
}

//=== 폼 & 미리보기 초기화 ===
function resetPaymentForm() {
  // 폼 리셋
  const form = document.getElementById("paymentForm");
  if (form) form.reset();

  // 선택된 전표 해제
  selectedInvoice = null;

  // 하단 미리보기 그리드 비우기
  if (journalPreviewApi) {
    journalPreviewApi.setGridOption("rowData", []);
  }

  // 피드백 메시지
  toastr.info("초기화되었습니다.");
}


//=== 결제금액 입력 시 원화 단위로 자동 포맷 ===
const amountInput = document.getElementById("formAmount");

if (amountInput) {
  amountInput.addEventListener("input", (e) => {
    let value = e.target.value.replace(/[^0-9]/g, ""); // 숫자만 남기기
    if (!value) {
      e.target.value = "";
      return;
    }

    // 원화 단위 포맷 적용
    const formatted = Number(value).toLocaleString("ko-KR");
    e.target.value = `₩${formatted}`;
  });

  // 커서 포커스 시 '₩' 제거하고 숫자만 편집 가능하게
  amountInput.addEventListener("focus", (e) => {
    e.target.value = e.target.value.replace(/[^0-9]/g, "");
  });

  // 포커스 아웃 시 다시 포맷 적용
  amountInput.addEventListener("blur", (e) => {
    const value = e.target.value.replace(/[^0-9]/g, "");
    e.target.value = value ? `₩${Number(value).toLocaleString("ko-KR")}` : "";
  });
}
</script>
	</th:block>
</body>
</html>
