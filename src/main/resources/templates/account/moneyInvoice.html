<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/base}">
<head>
<title layout:fragment="title">ìê¸ˆì „í‘œ</title>

<th:block layout:fragment="head_extra">
	<!-- AG Grid -->
	<link rel="stylesheet"
		href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/styles/ag-grid.css" />
	<link rel="stylesheet"
		href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/styles/ag-theme-quartz.css" />
	<style>
h6 {
	margin: 0.5rem 0;
	font-weight: bold;
}

.btn-bar {
	display: flex;
	align-items: center;
	gap: 0.5rem;
	margin-bottom: 0.75rem;
}

.ag-theme-quartz {
	--ag-header-background-color: #f9fafb;
	--ag-odd-row-background-color: #fafafa;
	--ag-border-color: #e5e7eb;
}

/* âœ… êµ¬ë¶„ ë°°ì§€ (ë§¤ì…/ë§¤ì¶œ) */
.badge-type {
	display: inline-block;
	padding: 0.15rem 0.5rem;
	border-radius: 9999px;
	font-weight: 600;
	font-size: 0.8rem;
	line-height: 1.2;
}

.badge-sales {
	background: #fee2e2;
	color: #b91c1c;
}

.badge-purchase {
	background: #dbeafe;
	color: #1d4ed8;
}

/* âœ… ì ìš©ë‚´ì—­ ê·¸ë¦¬ë“œ */
#applyGrid.ag-theme-quartz {
	height: 14rem;
	width: 100%;
	margin-top: 1rem;
}

/* âœ… í—¤ë” ì¹´ë“œ */
.card-header h6 {
	font-weight: bold;
}

h6 {
	margin: 0.5rem 0;
	font-weight: bold;
	color: black;
}
/* âœ… ì˜¤ë¥¸ìª½ ë²„íŠ¼ ë„ìš°ê¸°ìš© */
.text-end {
	text-align: right !important;
}

.btn-bar {
	display: flex;
	align-items: center;
	gap: 0.5rem;
	margin-bottom: 0.75rem;
}

#formAmount {
	text-align: left !important;
}
</style>
</th:block>
</head>

<body>
	<section layout:fragment="content">
		<div class="card shadow mb-3">
			<div
				class="card-header py-3 d-flex align-items-center justify-content-between">
				<h6 class="m-0 font-weight-bold text-primary">ìê¸ˆì „í‘œ ê´€ë¦¬</h6>
			</div>

			<div class="card-body">
				<!-- ğŸ”¹ í•„í„°/ë²„íŠ¼ ë°” -->
				<div class="btn-bar">
					<input type="date" id="fromDate"
						class="form-control form-control-sm" style="max-width: 180px" />
					<span>~</span> <input type="date" id="toDate"
						class="form-control form-control-sm" style="max-width: 180px" />
					<select id="typeSelect" class="form-select form-select-sm"
						style="max-width: 120px">
						<option value="">ì „ì²´</option>
						<option value="S">ë§¤ì¶œì „í‘œ</option>
						<option value="P">ë§¤ì…ì „í‘œ</option>
					</select> <input type="text" id="searchCus" placeholder="ê±°ë˜ì²˜ëª…"
						class="form-control form-control-sm" style="max-width: 180px" />
					<button id="btnSearch" class="btn btn-dark btn-sm">ì¡°íšŒ</button>

				</div>

				<!-- ğŸ”¹ ë¯¸ê²°ì „í‘œ ëª©ë¡ -->
				<div class="row">
					<!-- ì™¼ìª½: ë¯¸ê²°ì „í‘œ ëª©ë¡ -->
					<div class="col-md-7">
						<h6>ë¯¸ê²°ì „í‘œ ëª©ë¡</h6>
						<div id="unpaidGridWrapper" style="position:relative;">
						<div id="unpaidGrid" class="ag-theme-quartz"
							style="height: 24rem; width: 100%;"></div>
							</div>
					</div>

					<!-- ì˜¤ë¥¸ìª½: ê²°ì œ ë“±ë¡ í¼ -->
					<div class="col-md-5">
						<h6>ê²°ì œ ë“±ë¡</h6>
						<form id="paymentForm" class="border rounded p-3 bg-light">
							<div class="mb-2">
								<label class="form-label">ê±°ë˜ì²˜ëª…</label> <input type="text"
									id="formCusName" class="form-control form-control-sm" readonly>
							</div>

							<div class="mb-2">
								<label class="form-label">ê²°ì œë°©ì‹</label> <input type="text"
									id="formMethod" class="form-control form-control-sm" readonly>
							</div>

							<div class="mb-2">
								<label class="form-label">ê³„ì¢Œ ì •ë³´</label>
								<div class="d-flex align-items-center" style="gap: 1rem;"> 
									<input type="text" id="formAccount"
										class="form-control form-control-sm" placeholder="ê³„ì¢Œë²ˆí˜¸"
										style="flex: 0.8;" readonly> <input type="text"
										id="formBank" class="form-control form-control-sm"
										placeholder="ì€í–‰ëª…" style="flex: 0.8;" readonly>
								</div>
							</div>

							<div class="mb-2">
								<label class="form-label">ê²°ì œê¸ˆì•¡</label> <input type="text"
									id="formAmount" class="form-control form-control-sm text-end">
							</div>

							<div class="mb-2">
								<label class="form-label">ë¹„ê³ </label> <input type="text"
									id="formMemo" class="form-control form-control-sm">
							</div>

							<!-- âœ… ë²„íŠ¼ ì¤‘ì•™ ì •ë ¬ + ì´ˆê¸°í™” ë²„íŠ¼ ì¶”ê°€ -->
							<div class="d-flex justify-content-center gap-2 mt-3">
								<button type="button" id="btnSavePayment"
									class="btn btn-primary btn-sm px-4">ì €ì¥</button>
								<button type="button" id="btnResetForm"
									class="btn btn-danger btn-sm px-4 ml-2">ì´ˆê¸°í™”</button>
							</div>
						</form>
					</div>

					<!-- ğŸ”¹ ìê¸ˆì „í‘œ ì ìš©ë‚´ì—­ -->
				</div>
				<h6 class="mt-3">ì ìš©ë‚´ì—­</h6>


				<div id="journalPreviewGrid" class="ag-theme-quartz"
					style="height: 16rem; width: 100%;"></div>
			</div>
			
	</section>

	<th:block layout:fragment="body_extra">
		<script
			src="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/dist/ag-grid-community.min.js"></script>
		<script
			src="https://cdn.jsdelivr.net/npm/axios@1.7.7/dist/axios.min.js"></script>
		<script th:inline="none">

let journalPreviewApi;
let unpaidApi;
let selectedInvoice = null;


// âœ… í˜ì´ì§€ ì´ˆê¸°í™”
document.addEventListener("DOMContentLoaded", () => {
	const today = new Date();
	const yyyy = today.getFullYear();
	const mm = String(today.getMonth()+1).padStart(2,'0');
	const dd = String(today.getDate()).padStart(2,'0');
	document.getElementById("fromDate").value = `${yyyy}-${mm}-01`;
	document.getElementById("toDate").value   = `${yyyy}-${mm}-${dd}`;

	initUnpaidGrid();
	loadUnpaidList();
	initJournalPreviewGrid();
	
	document.getElementById("btnSearch").addEventListener("click", loadUnpaidList);
	document.getElementById("btnSavePayment").addEventListener("click", savePayment);
	document.getElementById("btnResetForm").addEventListener("click", resetPaymentForm);
	
});

// === ë¯¸ê²°ì „í‘œ Grid ===
function initUnpaidGrid() {
	showLoader("unpaidGridWrapper", "ì…ê³  ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...");
	const cols = [
		{ headerName: "ì „í‘œë²ˆí˜¸", field: "invoiceNo", flex: 1 },
		{ headerName: "ìœ í˜•", field: "type", flex: .8,
		  cellRenderer: p => {
			const cls = p.value === 'S' ? 'badge-sales' : 'badge-purchase';
			const txt = p.value === 'S' ? 'ë§¤ì¶œ' : 'ë§¤ì…';
			return `<span class="badge-type ${cls}">${txt}</span>`;
		  }
		},
		{ headerName: "ê±°ë˜ì²˜ëª…", field: "cusName", flex: 1 },
		{ headerName: "ì „í‘œê¸ˆì•¡", field: "totalAmt", valueFormatter: v => v.value?.toLocaleString(), flex: 1 },
		{ headerName: "ë¯¸ê²°ê¸ˆì•¡", field: "unpaidAmt", valueFormatter: v => v.value?.toLocaleString(), flex: 1 },
		{ headerName: "ê²°ì œë°©ì‹", field: "payMethod", flex: 1 },
		{ headerName: "ê³„ì¢Œë²ˆí˜¸", field: "cashAccount", flex: 1 },
		{ headerName: "ë¹„ê³ ", field: "memo", flex: 1 },
		{ headerName: "ì „í‘œì¼ì", field: "invoiceDate", valueFormatter: v => v.value?.substring(0,10), flex: 1 }
	];

	unpaidApi = agGrid.createGrid(document.getElementById("unpaidGrid"), {
		columnDefs: cols,
		rowData: [],
		rowSelection: "single",
		defaultColDef: { resizable: true, sortable: true },
		onRowClicked: e =>fillPaymentForm(e.data) // âœ… í´ë¦­ ì‹œ í¼ ì±„ìš°ê¸°
		
	});
	hideLoader("unpaidGridWrapper");
}

// === ì˜¤ë¥¸ìª½ í¼ ì±„ìš°ê¸° ===
function fillPaymentForm(data) {
	selectedInvoice = data;

	document.getElementById("formCusName").value = data.cusName || "";
	document.getElementById("formMethod").value   = data.payMethod || "í˜„ê¸ˆ";
	document.getElementById("formAccount").value  = data.cashAccount || "";
	document.getElementById("formBank").value  = data.bankName || "";
	document.getElementById("formMemo").value     = data.memo || "";
	document.getElementById("formAmount").value   =  data.unpaidAmt.toLocaleString("ko-KR") || 0;
}

// === ë°ì´í„° ë¡œë“œ ===
async function loadUnpaidList() {
	const type = document.getElementById("typeSelect").value;
	const fromDate = document.getElementById("fromDate").value;
	const toDate = document.getElementById("toDate").value;
	const searchCus = document.getElementById("searchCus").value;

	try {
		const { data } = await axios.get("/api/account/unpaidList", { params: { type, fromDate, toDate, searchCus } });
		unpaidApi.setGridOption("rowData", data || []);
		selectedInvoice = null;
		document.getElementById("paymentForm").reset(); // ì´ì „ í¼ ì´ˆê¸°í™”
	} catch (err) {
		console.error(err);
		alert("ë¯¸ê²°ì „í‘œ ì¡°íšŒ ì‹¤íŒ¨");
	}
}

async function savePayment() {
	  if (!selectedInvoice) {
		  toastr.info("ì „í‘œë¥¼ ì„ íƒí•˜ì„¸ìš”");
	    return;
	  }
	
	  const payAmount = Number( document.getElementById("formAmount").value.replace(/[^0-9]/g, "") || 0);
	  if (payAmount <= 0) {
		  toastr.info("ê²°ì œê¸ˆì•¡ì„ ì„ íƒí•˜ì„¸ìš”");
	    return;
	  }
	  // âœ… ì´ˆê³¼ ê²°ì œ ë°©ì§€
	  unpaidAmt = selectedInvoice.unpaidAmt;
	  console.log(payAmount);
	  console.log(unpaidAmt);
	  // ì»¤ì„œ ë°–ìœ¼ë¡œ ë‚˜ê°€ì•¼ ë§‰í˜
	  if (payAmount > unpaidAmt) {
	    toastr.warning(`ê²°ì œê¸ˆì•¡ì€ ë¯¸ê²°ê¸ˆì•¡(${unpaidAmt.toLocaleString()}ì›)ì„ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
	    document.getElementById("formAmount").value = unpaidAmt; // ìë™ìœ¼ë¡œ ë¯¸ê²°ê¸ˆì•¡ìœ¼ë¡œ ë§ì¶°ì¤Œ (ì„ íƒì‚¬í•­)
	    return;
	  }
	  let methodText = document.getElementById("formMethod").value?.trim();
	  let methodCode = "CASH"; // ê¸°ë³¸ê°’
	  if (methodText === "í˜„ê¸ˆ") methodCode = "CASH";
	  else if (methodText === "ì–´ìŒ") methodCode = "BILL";
	  else if (methodText === "ì´ì²´") methodCode = "BANK"; // í˜¹ì‹œ ë‚˜ì¤‘ì„ ìœ„í•´ ì¶”ê°€
	  
	  const header = {
	    payDate: new Date().toISOString().substring(0,10),
	    payType: selectedInvoice.type === 'S' ? 'IN' : 'OUT',
	    cusCode: selectedInvoice.cusCode,
	    cusName: selectedInvoice.cusName,
	    method: methodCode, // âœ… ë³€í™˜ëœ ì½”ë“œë¡œ ì „ë‹¬
	    cashAccount: document.getElementById("formAccount").value,
	    amount: payAmount,
	    memo: document.getElementById("formMemo").value
	  };

	  const apply = {
	    type: selectedInvoice.type,
	    invoiceNo: selectedInvoice.invoiceNo,
	    applyAmount: payAmount
	  };

	  try {
	    const payment = { ...header, applies: [apply] };
	    console.log(payment);
	    const { data } = await axios.post("/api/account/payment/save", payment);
		
	    // âœ… ì„œë²„ì—ì„œ ë¶„ê°œ ë°ì´í„°(journals)ê¹Œì§€ ë°˜í™˜ë˜ë„ë¡ ì„¤ì •í–ˆì„ ê²½ìš°
	    if (data.journals && data.journals.length > 0) {
	      journalPreviewApi.setGridOption("rowData", data.journals.map(j => ({
	        gbn: j.dcType === "D" ? "ì°¨ë³€" : "ëŒ€ë³€",
	        acctCode: j.acctCode,
	        acctName: j.acctName || "",
	        cusName: selectedInvoice.cusName,
	        debit: j.dcType === "D" ? j.amount : null,
	        credit: j.dcType === "C" ? j.amount : null,
	        note: j.remarks
	      })));
	    }

	    toastr.success("ìê¸ˆì „í‘œ ë° ì¼ë°˜ì „í‘œ ìë™ë°˜ì˜ ì™„ë£Œ!");
	    loadUnpaidList();
	  } catch (err) {
	    console.error(err);
	    toastr.error("ì €ì¥ ì‹¤íŒ¨: " + (err.response?.data?.message || err.message));
	  }
	}


//=== íšŒê³„ì²˜ë¦¬ ë¯¸ë¦¬ë³´ê¸° Grid ì´ˆê¸°í™” ===
function initJournalPreviewGrid() {
	const cols = [
	 { headerName: "êµ¬ë¶„", field: "gbn", flex: .8 },
	 { headerName: "ê³„ì •ì½”ë“œ", field: "acctCode", flex: 1 },
	 { headerName: "ê±°ë˜ì²˜ëª…", field: "cusName", flex: 1 },
	 { headerName: "ì°¨ë³€", field: "debit", valueFormatter: v => v.value?.toLocaleString(), flex: 1 },
	 { headerName: "ëŒ€ë³€", field: "credit", valueFormatter: v => v.value?.toLocaleString(), flex: 1 },
	 { headerName: "ì ìš”", field: "note", flex: 1.5, editable: true }
	];
	journalPreviewApi = agGrid.createGrid(document.getElementById("journalPreviewGrid"), {
	 columnDefs: cols,
	 rowData: [],
	 defaultColDef: { resizable: true }
	});
}

//=== í¼ & ë¯¸ë¦¬ë³´ê¸° ì´ˆê¸°í™” ===
function resetPaymentForm() {
  // í¼ ë¦¬ì…‹
  const form = document.getElementById("paymentForm");
  if (form) form.reset();

  // ì„ íƒëœ ì „í‘œ í•´ì œ
  selectedInvoice = null;

  // í•˜ë‹¨ ë¯¸ë¦¬ë³´ê¸° ê·¸ë¦¬ë“œ ë¹„ìš°ê¸°
  if (journalPreviewApi) {
    journalPreviewApi.setGridOption("rowData", []);
  }

  // í”¼ë“œë°± ë©”ì‹œì§€
  toastr.info("ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
}


//=== ê²°ì œê¸ˆì•¡ ì…ë ¥ ì‹œ ì›í™” ë‹¨ìœ„ë¡œ ìë™ í¬ë§· ===
const amountInput = document.getElementById("formAmount");

if (amountInput) {
  amountInput.addEventListener("input", (e) => {
    let value = e.target.value.replace(/[^0-9]/g, ""); // ìˆ«ìë§Œ ë‚¨ê¸°ê¸°
    if (!value) {
      e.target.value = "";
      return;
    }

    // ì›í™” ë‹¨ìœ„ í¬ë§· ì ìš©
    const formatted = Number(value).toLocaleString("ko-KR");
    e.target.value = `â‚©${formatted}`;
  });

  // ì»¤ì„œ í¬ì»¤ìŠ¤ ì‹œ 'â‚©' ì œê±°í•˜ê³  ìˆ«ìë§Œ í¸ì§‘ ê°€ëŠ¥í•˜ê²Œ
  amountInput.addEventListener("focus", (e) => {
    e.target.value = e.target.value.replace(/[^0-9]/g, "");
  });

  // í¬ì»¤ìŠ¤ ì•„ì›ƒ ì‹œ ë‹¤ì‹œ í¬ë§· ì ìš©
  amountInput.addEventListener("blur", (e) => {
    const value = e.target.value.replace(/[^0-9]/g, "");
    e.target.value = value ? `â‚©${Number(value).toLocaleString("ko-KR")}` : "";
  });
}
</script>
	</th:block>
</body>
</html>
