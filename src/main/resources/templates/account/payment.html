<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/base}">
<head>
<meta charset="UTF-8" />
<title layout:fragment="title">자동 전표 처리</title>

<th:block layout:fragment="head_extra">
	<!-- AG Grid -->
	<link rel="stylesheet"
		href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/styles/ag-grid.css" />
	<link rel="stylesheet"
		href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/styles/ag-theme-quartz.css" />
	<style>
.btn-bar {
	display: flex;
	gap: .5rem;
	margin-bottom: 1rem;
}

.section-title {
	margin: .75rem 0;
	font-weight: 700;
}

.grid-sm {
	height: 300px;
	width: 100%;
}

.grid-full {
	height: 260px;
	width: 100%;
	margin-top: 1rem;
}
</style>
</th:block>
</head>

<body>
	<section layout:fragment="content">
		<div class="card shadow mb-3">
			<div class="card-header py-3">
				<h6 class="m-0 font-weight-bold text-primary">자동 전표 처리</h6>
			</div>
			<div class="card-body">

				<!-- 조회조건 -->
				<div class="btn-bar">
					<input type="month" id="srchMonth"
						class="form-control form-control-sm" style="max-width: 180px"
						placeholder="귀속연월">
					<button class="btn btn-dark btn-sm" id="btnSearch">조회</button>
					<button class="btn btn-primary btn-sm" id="btnRegister">등록</button>
				</div>

				<!-- 상단 3단 Grid -->
				<div class="row">
					<div class="col-md-4">
						<div class="section-title">기본정보</div>
						<div id="baseGrid" class="ag-theme-quartz grid-sm"></div>
					</div>
					<div class="col-md-4">
						<div class="section-title">지급항목(차변)</div>
						<div id="debitGrid" class="ag-theme-quartz grid-sm"></div>
					</div>
					<div class="col-md-4">
						<div class="section-title">공제항목(대변)</div>
						<div id="creditGrid" class="ag-theme-quartz grid-sm"></div>
					</div>
				</div>

				<!-- 하단 결과 -->
				<div class="section-title">전표결과</div>
				<div id="journalGrid" class="ag-theme-quartz grid-full"></div>
			</div>
		</div>
	</section>

	<th:block layout:fragment="body_extra">
		<script
			src="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/dist/ag-grid-community.min.js"></script>
		<script
			src="https://cdn.jsdelivr.net/npm/axios@1.7.7/dist/axios.min.js"></script>
		<script th:inline="none">
    let baseApi, debitApi, creditApi, journalApi;
    let baseCache = [];  // ✅ 원본 데이터 캐시
    
    document.addEventListener("DOMContentLoaded", () => {
      // === Grid 초기화 ===
      baseApi = agGrid.createGrid(document.getElementById("baseGrid"), {
        columnDefs: [
          { headerName:'귀속연월', field:'period', flex:1 },
          { headerName:'지급일', field:'payDate', flex:1 },
          { headerName:'부서', field:'dept', flex:1 },
          { headerName:'전표발생일', field:'jrnDate', flex:1,valueFormatter:p=>p.value?.substring(0,10) },
          { headerName:'전표번호', field:'jrn', flex:1 }
        ],
        rowData: [],
        defaultColDef:{resizable:true},
        onGridReady: () => initBaseGrid(getThisMonthYM()),
        onRowClicked: async (event) => {
            console.log("=== baseGrid Row Clicked ===", event.data);

            const { period, deptCode } = event.data;
            if (!period || !deptCode) {
              alert("yearMonth 또는 deptCode가 없습니다.");
              return;
            }

            try {
              const { data } = await axios.get("/api/account/payment/lines", {
                params: { yearMonth: period, deptCode }
              });

              console.log("=== payment lines ===", data);
           // 지급/공제 그리드
              debitApi.setGridOption("rowData", data.debit || []);
              creditApi.setGridOption("rowData", data.credit || []);

              // 전표결과 그리드
              journalApi.setGridOption("rowData", data.journal || []);
            } catch (err) {
              console.error("지급/공제 항목 조회 실패", err);
              debitApi.setGridOption("rowData", []);
              creditApi.setGridOption("rowData", []);
              journalApi.setGridOption("rowData", []);
            }
          }
      });

      debitApi = agGrid.createGrid(document.getElementById("debitGrid"), {
        columnDefs: [
        	  { headerName:'지급항목', field:'itemLabel', flex:1 },
              { headerName:'코드', field:'acctCode', width:100 },
              { headerName:'계정과목명', field:'acctName', flex:1 },
              { headerName:'금액', field:'amount', width:120, type:'numericColumn', valueFormatter:p=>p.value?.toLocaleString() }
        ],
        rowData: [],
        defaultColDef:{resizable:true}
      });

      creditApi = agGrid.createGrid(document.getElementById("creditGrid"), {
        columnDefs: [
          { headerName:'공제항목', field:'itemLabel', flex:1 },
          { headerName:'코드', field:'acctCode', width:100 },
          { headerName:'계정과목명', field:'acctName', flex:1 },
          { headerName:'금액', field:'amount', width:120, type:'numericColumn', valueFormatter:p=>p.value?.toLocaleString() }
        ],
        rowData: [],
        defaultColDef:{resizable:true}
      });

      journalApi = agGrid.createGrid(document.getElementById("journalGrid"), {
        columnDefs: [
          { headerName:'구분', field:'gbn', width:90 },
          { headerName:'코드', field:'code', width:100 },
          { headerName:'계정과목', field:'acct', flex:1 },
          { headerName:'거래처코드', field:'partnerCode', width:120 },
          { headerName:'거래처', field:'partner', flex:1 },
          { headerName:'차변(출금)', field:'debit', width:120, type:'numericColumn', valueFormatter:p=>p.value?.toLocaleString() },
          { headerName:'대변(입금)', field:'credit', width:120, type:'numericColumn', valueFormatter:p=>p.value?.toLocaleString() },
          { headerName:'적요', field:'note', flex:1 }
        ],
        rowData: [],
        defaultColDef:{resizable:true},
        onRowClicked:()=>{
        	console.log()
        }
      });
   // 이번 달 YM 계산
      function getThisMonthYM(){
        const now = new Date();
        return `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}`;
      }

      document.getElementById("btnSearch").addEventListener("click", () => {
    	  const monthVal = document.getElementById("srchMonth").value; // yyyy-MM
    	  if (monthVal) {
    	    const ym = monthVal.replace("-", "");  // "2025-10" → "202510"
    	    initBaseGrid(ym);
    	  } else {
    	    initBaseGrid(getThisMonthYM());
    	  }
    	});
  });

 // === baseGrid 데이터 로드 함수 ===
    async function initBaseGrid(yearMonth) {
      try {
        const { data } = await axios.get("/api/hr/payroll", { params: { yearMonth } });
		console.log(data);
        const rows = (Array.isArray(data) ? data : []).map(item => ({
          deptCode: item.deptCode,   // ✅ 부서코드	
          jrn: "",
          period: item.yearMonth || "",
          dept: item.deptName || item.dept_name || "",
          jrnDate: item.jrnDate,
          payDate: `${yearMonth.slice(0,4)}-${yearMonth.slice(4)}-29` // 지급일 하드코딩
        }));

        baseApi.setGridOption("rowData", rows);
      } catch (err) {
        console.error("급여대장 조회 실패", err);
        baseApi.setGridOption("rowData", []);
      }
    }
  </script>
	</th:block>
</body>
</html>
