<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/base}">
<head>
<title layout:fragment="title">매입 매출 전표</title>
<th:block layout:fragment="head_extra">

	<th:block
		th:replace="~{account/taxInvoiceModal :: taxInvoiceModalStyles}"></th:block>
	<!-- AG Grid -->
	<link rel="stylesheet"
		href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/styles/ag-grid.css" />
	<link rel="stylesheet"
		href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/styles/ag-theme-quartz.css" />
	<style>
#invoiceModal .voucher-switch {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  font-weight: 700;
  font-size: 1.1rem;  /* ✅ 글자 크기 키움 */
  margin-bottom: 0.75rem;
}

#invoiceModal .voucher-switch .label {
  min-width: 48px;
  text-align: center;
  transition: color 0.3s ease;
}

#invoiceModal .voucher-switch .label.purchase { 
  color: #1d4ed8;   /* 파랑 */
}

#invoiceModal .voucher-switch .label.sales { 
  color: #b91c1c;   /* 빨강 */
}

/* ✅ 선택 상태일 때 색 더 진하게 */
#invoiceModal .switch input:not(:checked) ~ .label.purchase {
  color: #1d4ed8;
}
#invoiceModal .switch input:checked ~ .label.sales {
  color: #dc2626;
}

#invoiceModal .switch {
  position: relative;
  display: inline-block;
  width: 54px;   /* 스위치 약간 키움 */
  height: 28px;
}

#invoiceModal .switch input { display: none; }

#invoiceModal .slider {
  position: absolute;
  cursor: pointer;
  inset: 0;
  background-color: #dbeafe;
  border-radius: 28px;
  transition: 0.3s;
}

#invoiceModal .slider::before {
  position: absolute;
  content: "";
  height: 22px;
  width: 22px;
  left: 3px;
  bottom: 3px;
  background-color: white;
  border-radius: 50%;
  transition: 0.3s;
}

/* 체크 시 매출 */
#invoiceModal .switch input:checked + .slider {
  background-color: #fee2e2;
}
#invoiceModal .switch input:checked + .slider::before {
  transform: translateX(26px);
}
#voucherGrid.ag-theme-quartz {
	height: 32rem;
	width: 100%;
}

#detailGrid.ag-theme-quartz {
	height: 14rem;
	width: 100%;
	margin-top: 1rem;
	display: none;
}

#invoiceGrid.ag-theme-quartz {
	height: 20rem;
	width: 100%;
	margin-top: 1rem;
}

#salesGrid.ag-theme-quartz {
	height: 20rem;
	width: 100%;
	margin-top: 1rem;
}

.btn-bar {
	display: flex;
	gap: 0.5rem;
	margin-bottom: 0.75rem;
}

/* ✅ '유형' 컬럼만 배지 스타일로 강조 */
.badge-type {
	display: inline-block;
	padding: 0.125rem 0.5rem;
	border-radius: 9999px;
	font-weight: 700;
	font-size: 0.875rem;
	line-height: 1.2;
}

.badge-sales {
	background: #fee2e2;
	color: #b91c1c;
} /* 매출(S) 빨강 */
.badge-purchase {
	background: #dbeafe;
	color: #1d4ed8;
} /* 매입(P) 파랑 */
#btnRegisterDetail {
	display: none;
}
</style>
</th:block>
</head>
<body>
	<section layout:fragment="content">
		<div class="card shadow mb-3">
			<div
				class="card-header py-3 d-flex align-items-center justify-content-between">
				<h6 class="m-0 font-weight-bold text-primary">매출/매입 전표</h6>
			</div>
			<div class="card-body">
				<!-- 버튼 영역 -->
				<div class="btn-bar">
					<button class="btn btn-primary btn-sm" data-bs-toggle="modal"
						data-bs-target="#invoiceModal">등록</button>
					<button id="openTaxInvoiceBtn" class="btn btn-success btn-sm">
						전자세금</button>
				</div>

				<!-- 전표 목록 Grid -->
				<div id="voucherGrid" class="ag-theme-quartz"></div>
				<div id="actionBar" class="d-flex justify-content-end gap-2 my-2">
					<button id="btnRegisterDetail" type="button"
						class="btn btn-primary btn-sm">등록</button>
				</div>
				<!-- 분개 상세 Grid -->
				<div id="detailGrid" class="ag-theme-quartz"></div>
			</div>
		</div>
		<!-- ✅ 모달 fragment include -->

		<div th:replace="~{account/invoiceModal :: invoiceModal}"></div>
		<div th:replace="~{account/taxInvoiceModal :: taxInvoiceModal}"></div>
		<div th:replace="~{stock/modals/businessModal :: businessModal}"></div>
		<div th:replace="~{hr/codeLookup :: codeLookupModal}"></div>

	</section>

	<th:block layout:fragment="body_extra">
		<script
			src="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/dist/ag-grid-community.min.js"></script>
		<script
			src="https://cdn.jsdelivr.net/npm/axios@1.7.7/dist/axios.min.js"></script>
		<script th:inline="none">
  let voucherApi, detailApi;
  let selectedInvoice = null; // ✅ 현재 선택한 상단 전표행 저장
  
  
  // compCode받아놓기
  axios.get("/api/v1/stock/getCompId", { withCredentials: true })
  .then(res => {
  		document.getElementById("compCode").value = res.data;
  	})
    .catch(err => console.error(err));
    
  // === 전표 데이터 불러오기 ===
  async function loadAndRenderVoucher() {
    try {
      const { data } = await axios.get("/api/account/headers");
      voucherApi.setGridOption("rowData", Array.isArray(data) ? data : []);
    } catch (err) {
      console.error(err);
      alert("전표 데이터를 불러오지 못했습니다.");
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    // === voucherGrid 정의 ===
    const voucherColumnDefs = [
      { headerName: "월", valueGetter: p => p.data?.invoiceDate ? new Date(p.data.invoiceDate).getMonth() + 1 : "", flex: .5 },
      { headerName: "일", valueGetter: p => p.data?.invoiceDate ? new Date(p.data.invoiceDate).getDate() : "", flex: .5 },
      { headerName: "전표번호", field: "invoiceNo", flex: 1 },

      // ✅ 유형 컬럼만 배지로 렌더링
      {
        headerName: "유형",
        field: "type",
        flex: 1,
        cellRenderer: params => {
          const isSales = params.value === 'S';
          const text = isSales ? '매출' : '매입';
          const cls  = isSales ? 'badge-sales' : 'badge-purchase';
          return `<span class="badge-type ${cls}">${text}</span>`;
        }
      },

      { headerName: "거래처명", field: "cusName", flex: 1 },
      { headerName: "공급가액", field: "subtotalAmt", valueFormatter: p => p.value ? p.value.toLocaleString() : "", flex: 1 },
      { headerName: "부가세", field: "vatAmt", valueFormatter: p => p.value ? p.value.toLocaleString() : "", flex: 1 },
      { headerName: "합계", field: "totalAmt", valueFormatter: p => p.value ? p.value.toLocaleString() : "", flex: 1 }
    ];

    voucherApi = agGrid.createGrid(document.querySelector("#voucherGrid"), {
      columnDefs: voucherColumnDefs,
      rowData: [],
      rowSelection: "single",
      pagination: true,
      paginationPageSize: 12,
      defaultColDef: { filter: true, resizable: true },
      // ❌ 행 전체 강조 없음

      onRowClicked: e => {
    	selectedInvoice = e.data;  
        const details = createDetailsFromInvoice(e.data);
        detailApi.setGridOption("rowData", details);
        document.getElementById("detailGrid").style.display = "block";
        document.getElementById("btnRegisterDetail").style.display = "block";
     
      }
    });

    // === detailGrid 정의 ===
    const detailColumnDefs = [
      { headerName: "구분", field: "gbn", flex: 1 },
      { headerName: "코드", field: "code", flex: 1 },
      { headerName: "계정과목", field: "acctName", flex: 1 },
      { headerName: "거래처코드", field: "partnerCode", flex: 1 },
      { headerName: "거래처", field: "partner", flex: 1 },
      { headerName: "차변(출금)", field: "debit", flex: 1,valueFormatter: p => p.value ? p.value.toLocaleString() : "" },
      { headerName: "대변(입금)", field: "credit", flex: 1,valueFormatter: p => p.value ? p.value.toLocaleString() : "" },
      { headerName: "적요", field: "note", flex: 1 }
    ];

    detailApi = agGrid.createGrid(document.querySelector("#detailGrid"), {
      columnDefs: detailColumnDefs,
      rowData: [],
      defaultColDef: { resizable: true }
    });

    // === 자동 분개 함수 ===
    function createDetailsFromInvoice(invoice) {
      let details = [];

      if (invoice.type === "S") { // 매출
        details.push({ gbn: "차변", code: "108", acctName: "외상매출금", partnerCode: invoice.cusCode, partner: invoice.cusName, debit: invoice.totalAmt, credit: null, note: `${invoice.cusName} 매출` });
        details.push({ gbn: "대변", code: "401", acctName: "상품매출", partnerCode: invoice.cusCode, partner: invoice.cusName, debit: null, credit: invoice.subtotalAmt, note: `${invoice.invoiceNo} 매출액` });
        if (invoice.vatAmt && invoice.vatAmt > 0) {
          details.push({ gbn: "대변", code: "255", acctName: "부가세예수금", partnerCode: invoice.cusCode, partner: invoice.cusName, debit: null, credit: invoice.vatAmt, note: "부가세" });
        }
      } else if (invoice.type === "P") { // 매입
        details.push({ gbn: "차변", code: "146", acctName: "상품", partnerCode: invoice.cusCode, partner: invoice.cusName, debit: invoice.subtotalAmt, credit: null, note: `${invoice.invoiceNo} 매입` });
        if (invoice.vatAmt && invoice.vatAmt > 0) {
          details.push({ gbn: "차변", code: "135", acctName: "부가세대급금", partnerCode: invoice.cusCode, partner: invoice.cusName, debit: invoice.vatAmt, credit: null, note: "부가세" });
        }
        details.push({ gbn: "대변", code: "251", acctName: "외상매입금", partnerCode: invoice.cusCode, partner: invoice.cusName, debit: null, credit: invoice.totalAmt, note: `${invoice.cusName} 외상` });
      }

      return details;
    }

    loadAndRenderVoucher();
  });
  


// 오늘 날짜
const todayStr = () => {
	  const d = new Date();
	  const mm = String(d.getMonth()+1).padStart(2,'0');
	  const dd = String(d.getDate()).padStart(2,'0');
	  return `${d.getFullYear()}-${mm}-${dd}`;
	};

// 디테일 그리드 등록 버튼 -> 일반 전표
document.getElementById("btnRegisterDetail").addEventListener("click", async (data) => {
	 if (selectedInvoice?.postedFlag === 'Y') {
		    alert("이미 등록된 전표입니다.");
		    return;
		  }
  // detailGrid 데이터 수집
  const details = [];
  detailApi.forEachNode(node => {
    details.push(node.data);
  });

  if (details.length === 0) {
    alert("분개 데이터가 없습니다.");
    return;
  }
  
	const { data: newNo } = await axios.get("/api/account/nextJrnNo"); 
    data.jrnNo = newNo;

  // payload 구성
  const payload = details.map((d, idx) => ({
  	
	jrnNo:data.jrnNo,
	lineNo:data.lineNo || null,
	jrnDate: data.jrnDate || todayStr(),
    acctCode: d.code,
    acctName: d.acctName,
    dcType: d.gbn === "차변" ? "D" : "C",
    amount: d.debit ? d.debit : d.credit,
    remarks: d.note,
    cusCode: d.partnerCode,
    cusName: d.cusName,
    status: "open"
    
  }));
  try {
	    await axios.post("/api/account/journalList", payload);

	    // ✅ 전표 상태 업데이트 (posted_flag -> Y)
	    await axios.put(`/api/account/invoice/${selectedInvoice.invoiceCode}/posted`, {
	      postedFlag: "Y"
	    });

	    alert("저장 완료!");
	    // 화면도 리프레시
	    loadAndRenderVoucher();
	  } catch (err) {
	    console.error(err);
	    alert("저장 실패");
	  }

});


</script>

		<!-- 부서 모달 -->
		<script th:inline="none">
document.addEventListener('DOMContentLoaded', () => {
	
	
  const invoiceModalEl = document.getElementById('invoiceModal');
  const btn = invoiceModalEl?.querySelector('#btnDeptLookup');
  if (!btn) return;

  // 중복 바인딩 방지
  if (btn.dataset.bound === '1') return;
  btn.dataset.bound = '1';

  btn.addEventListener('click', (e) => {
    e.preventDefault();
    e.stopPropagation();

    CodeLookup.open({
      source: 'dept',
      title:  '부서 선택',
      // 필요한대로 지정
      // targetId: 'deptCodeInput',
      targetNameId: 'deptNameInput',
    });
  });
});

document.addEventListener('DOMContentLoaded', () => {
	  const invoiceModalEl = document.getElementById('invoiceModal');
	  const btn = invoiceModalEl?.querySelector('#btnBankLookup');
	  if (!btn) return;

	  // 중복 바인딩 방지
	  if (btn.dataset.bound === '1') return;
	  btn.dataset.bound = '1';

	  btn.addEventListener('click', (e) => {
	    e.preventDefault();
	    e.stopPropagation();

	    CodeLookup.open({
	      groupId: 'BK',
	      title:  '은행 선택',
	      // 필요한대로 지정
	      // targetId: 'deptCodeInput',
	      targetNameId: 'bankNameInput',
	    });
	  });
	});
	
	
	// 모달 오픈 버튼
	document.getElementById("openTaxInvoiceBtn")?.addEventListener("click", async () => {
  if (!selectedInvoice) {
    alert("전표를 선택하세요.");
    return;
  }

  const invoiceCode = selectedInvoice.invoiceCode;

  try {
    const res = await axios.get(`/api/account/invoice/${invoiceCode}`);
    const { header, lines } = res.data;
    
	if(header.type === "P"){
	 // ✅ 헤더 정보 세팅
	    document.getElementById("tiApprovalNo").textContent = header.bizNo || "-";
	    document.getElementById("tiWriteDate").value = header.invoiceDate?.substring(0,10);
		
	    // 공급자
	    document.getElementById("tiSuppBizNo").value = header.cusCode || "";
	    document.getElementById("tiSuppName").value  = header.cusName || "";
	    document.getElementById("tiSuppCeo").value  = header.buyerCeoName || "";
	    document.getElementById("tiSuppAddr").value  = header.buyerAddr || "";
	    document.getElementById("tiSuppType").value  = header.buyerBizType || "";
	    document.getElementById("tiSuppBiz").value  = header.buyerBizCategory || "";
	    document.getElementById("tiSuppEmail").value  = header.buyerEmail || "";
	    // ✅ 합계
	    document.getElementById("tiTotalAmt").value  = header.totalAmt || 0;
	    document.getElementById("tiClaim").value     = header.totalAmt || 0;
	 // ✅ 라인 세팅
	    const tbody = document.getElementById("tiLines");
	    tbody.innerHTML = "";
	
	    (lines || []).forEach(line => {
	      const tr = document.createElement("tr");
	      tr.innerHTML = `
	        <td class="center">${new Date(header.invoiceDate).getMonth()+1}</td>
	        <td class="center">${new Date(header.invoiceDate).getDate()}</td>
	        <td>${line.productName || ""}</td>
	        <td>${line.specification || ""}</td>
	        <td class="right"><input type="number" value="${line.qty || 0}" style="width:100%;border:none;text-align:right"></td>
	        <td class="right"><input type="number" value="${line.unitPrice || 0}" style="width:100%;border:none;text-align:right"></td>
	        <td class="right ti-sup">${(line.supAmt || 0).toLocaleString()}</td>
	        <td class="right ti-vat">${(line.vatAmt || 0).toLocaleString()}</td>
	        <td>${line.note || ""}</td>
	      `;
	      tbody.appendChild(tr);
	    });
	}//end if
	
	
    // ✅ 데이터 세팅 끝난 후 모달 열기
    bootstrap.Modal.getOrCreateInstance(document.getElementById("taxInvoiceModal")).show();

  } catch (err) {
    console.error("세금계산서 데이터 조회 실패", err);
    alert("세금계산서 조회 실패");
  }
});
</script>

	</th:block>
</body>
</html>
