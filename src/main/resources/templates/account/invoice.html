<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/base}">
<head>
<title layout:fragment="title">ë§¤ì… ë§¤ì¶œ ì „í‘œ</title>
<th:block layout:fragment="head_extra">
	<th:block
		th:replace="~{account/taxInvoiceModal :: taxInvoiceModalStyles}"></th:block>
	<!-- AG Grid -->
	<link rel="stylesheet"
		href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/styles/ag-grid.css" />
	<link rel="stylesheet"
		href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/styles/ag-theme-quartz.css" />
	<style>
#voucherGrid.ag-theme-quartz {
	height: 32rem;
	width: 100%;
}

#detailGrid.ag-theme-quartz {
	height: 20rem;
	width: 100%;
	margin-top: 1rem;
	display: none;
}

#invoiceGrid.ag-theme-quartz {
	height: 20rem;
	width: 100%;
	margin-top: 1rem;
}

.btn-bar {
	display: flex;
	gap: 0.5rem;
	margin-bottom: 0.75rem;
}

/* âœ… 'ìœ í˜•' ì»¬ëŸ¼ë§Œ ë°°ì§€ ìŠ¤íƒ€ì¼ë¡œ ê°•ì¡° */
.badge-type {
	display: inline-block;
	padding: 0.125rem 0.5rem;
	border-radius: 9999px;
	font-weight: 700;
	font-size: 0.875rem;
	line-height: 1.2;
}

.badge-sales {
	background: #fee2e2;
	color: #b91c1c;
} /* ë§¤ì¶œ(S) ë¹¨ê°• */
.badge-purchase {
	background: #dbeafe;
	color: #1d4ed8;
} /* ë§¤ì…(P) íŒŒë‘ */
</style>
</th:block>
</head>
<body>
	<section layout:fragment="content">
		<div class="card shadow mb-3">
			<div
				class="card-header py-3 d-flex align-items-center justify-content-between">
				<h6 class="m-0 font-weight-bold text-primary">ë§¤ì… ë§¤ì¶œ ì „í‘œ</h6>
			</div>
			<div class="card-body">
				<!-- ë²„íŠ¼ ì˜ì—­ -->
				<div class="btn-bar">
					<button class="btn btn-danger btn-sm open-invoice"
						data-bs-toggle="modal" data-bs-target="#invoiceModal"
						data-type="S">ë§¤ì¶œ</button>
					<button class="btn btn-primary btn-sm open-invoice"
						data-bs-toggle="modal" data-bs-target="#invoiceModal"
						data-type="P">ë§¤ì…</button>
					<button class="btn btn-success btn-sm open-taxinvoice"
						data-bs-toggle="modal" data-bs-target="#taxInvoiceModal">ì „ìì„¸ê¸ˆ</button>
				</div>

				<!-- ì „í‘œ ëª©ë¡ Grid -->
				<div id="voucherGrid" class="ag-theme-quartz"></div>

				<!-- ë¶„ê°œ ìƒì„¸ Grid -->
				<div id="detailGrid" class="ag-theme-quartz"></div>
			</div>
		</div>
		<!-- âœ… ëª¨ë‹¬ fragment include -->
		<div th:replace="~{account/invoiceModal :: invoiceModal}"></div>
		<div th:replace="~{account/taxInvoiceModal :: taxInvoiceModal}"></div>
		<div th:replace="~{stock/modals/businessModal :: businessModal}"></div>
		<div th:replace="~{account/deptModal :: deptModal}"></div>
	</section>

	<th:block layout:fragment="body_extra">
		<script
			src="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/dist/ag-grid-community.min.js"></script>
		<script
			src="https://cdn.jsdelivr.net/npm/axios@1.7.7/dist/axios.min.js"></script>
		<script th:inline="none">
  let voucherApi, detailApi;

  // === ì „í‘œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ===
  async function loadAndRenderVoucher() {
    try {
      const { data } = await axios.get("/api/account/invoice");
      voucherApi.setGridOption("rowData", Array.isArray(data) ? data : []);
    } catch (err) {
      console.error(err);
      alert("ì „í‘œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    // === voucherGrid ì •ì˜ ===
    const voucherColumnDefs = [
      { headerName: "ì›”", valueGetter: p => p.data?.invoiceDate ? new Date(p.data.invoiceDate).getMonth() + 1 : "", flex: .5 },
      { headerName: "ì¼", valueGetter: p => p.data?.invoiceDate ? new Date(p.data.invoiceDate).getDate() : "", flex: .5 },

      // âœ… ìœ í˜• ì»¬ëŸ¼ë§Œ ë°°ì§€ë¡œ ë Œë”ë§
      {
        headerName: "ìœ í˜•",
        field: "type",
        flex: 1,
        cellRenderer: params => {
          const isSales = params.value === 'S';
          const text = isSales ? 'ë§¤ì¶œ' : 'ë§¤ì…';
          const cls  = isSales ? 'badge-sales' : 'badge-purchase';
          return `<span class="badge-type ${cls}">${text}</span>`;
        }
      },

      { headerName: "ì „í‘œë²ˆí˜¸", field: "invoiceNo", flex: 1 },
      { headerName: "ì‚¬ì—…ìë²ˆí˜¸", field: "bizNo", flex: 1 },
      { headerName: "ê±°ë˜ì²˜ëª…", field: "cusName", flex: 1 },
      { headerName: "ê³µê¸‰ê°€ì•¡", field: "subtotalAmt", valueFormatter: p => p.value ? p.value.toLocaleString() : "", flex: 1 },
      { headerName: "ë¶€ê°€ì„¸", field: "vatAmt", valueFormatter: p => p.value ? p.value.toLocaleString() : "", flex: 1 },
      { headerName: "í•©ê³„", field: "totalAmt", valueFormatter: p => p.value ? p.value.toLocaleString() : "", flex: 1 }
    ];

    voucherApi = agGrid.createGrid(document.querySelector("#voucherGrid"), {
      columnDefs: voucherColumnDefs,
      rowData: [],
      rowSelection: "single",
      pagination: true,
      paginationPageSize: 12,
      defaultColDef: { filter: true, resizable: true },
      // âŒ í–‰ ì „ì²´ ê°•ì¡° ì—†ìŒ

      onRowClicked: e => {
        const details = createDetailsFromInvoice(e.data);
        detailApi.setGridOption("rowData", details);
        document.getElementById("detailGrid").style.display = "block";
      }
    });

    // === detailGrid ì •ì˜ ===
    const detailColumnDefs = [
      { headerName: "êµ¬ë¶„", field: "gbn", flex: 1 },
      { headerName: "ì½”ë“œ", field: "code", flex: 1 },
      { headerName: "ê³„ì •ê³¼ëª©", field: "acctName", flex: 1 },
      { headerName: "ê±°ë˜ì²˜ì½”ë“œ", field: "partnerCode", flex: 1 },
      { headerName: "ê±°ë˜ì²˜", field: "partner", flex: 1 },
      { headerName: "ì°¨ë³€(ì¶œê¸ˆ)", field: "debit", flex: 1 },
      { headerName: "ëŒ€ë³€(ì…ê¸ˆ)", field: "credit", flex: 1 },
      { headerName: "ì ìš”", field: "note", flex: 1 }
    ];

    detailApi = agGrid.createGrid(document.querySelector("#detailGrid"), {
      columnDefs: detailColumnDefs,
      rowData: [],
      defaultColDef: { resizable: true }
    });

    // === ìë™ ë¶„ê°œ í•¨ìˆ˜ ===
    function createDetailsFromInvoice(invoice) {
      let details = [];

      if (invoice.type === "S") { // ë§¤ì¶œ
        details.push({ gbn: "ì°¨ë³€", code: "108", acctName: "ì™¸ìƒë§¤ì¶œê¸ˆ", partnerCode: invoice.cusCode, partner: invoice.cusName, debit: invoice.totalAmt, credit: null, note: `${invoice.cusName} ë§¤ì¶œ` });
        details.push({ gbn: "ëŒ€ë³€", code: "401", acctName: "ìƒí’ˆë§¤ì¶œ", partnerCode: invoice.cusCode, partner: invoice.cusName, debit: null, credit: invoice.subtotalAmt, note: `${invoice.invoiceNo} ë§¤ì¶œì•¡` });
        if (invoice.vatAmt && invoice.vatAmt > 0) {
          details.push({ gbn: "ëŒ€ë³€", code: "255", acctName: "ë¶€ê°€ì„¸ì˜ˆìˆ˜ê¸ˆ", partnerCode: invoice.cusCode, partner: invoice.cusName, debit: null, credit: invoice.vatAmt, note: "ë¶€ê°€ì„¸" });
        }
      } else if (invoice.type === "P") { // ë§¤ì…
        details.push({ gbn: "ì°¨ë³€", code: "146", acctName: "ìƒí’ˆ", partnerCode: invoice.cusCode, partner: invoice.cusName, debit: invoice.subtotalAmt, credit: null, note: `${invoice.invoiceNo} ë§¤ì…` });
        if (invoice.vatAmt && invoice.vatAmt > 0) {
          details.push({ gbn: "ì°¨ë³€", code: "135", acctName: "ë¶€ê°€ì„¸ëŒ€ê¸‰ê¸ˆ", partnerCode: invoice.cusCode, partner: invoice.cusName, debit: invoice.vatAmt, credit: null, note: "ë¶€ê°€ì„¸" });
        }
        details.push({ gbn: "ëŒ€ë³€", code: "251", acctName: "ì™¸ìƒë§¤ì…ê¸ˆ", partnerCode: invoice.cusCode, partner: invoice.cusName, debit: null, credit: invoice.totalAmt, note: `${invoice.cusName} ì™¸ìƒ` });
      }

      return details;
    }

    loadAndRenderVoucher();
  });
  

//âœ… ì´ˆê¸°í™” ë²„íŠ¼ ë™ì‘
document.getElementById("resetInvoiceBtn")?.addEventListener("click", () => {
 const modalEl = document.getElementById("invoiceModal");

 // ëª¨ë“  input, textarea, select ì´ˆê¸°í™”
 modalEl.querySelectorAll("input, textarea, select").forEach(el => {
   if (el.type === "date") {
     el.value = ""; // ë‚ ì§œëŠ” ê³µë°± ì²˜ë¦¬
   } else if (el.tagName === "SELECT") {
     el.selectedIndex = 0; // ì²«ë²ˆì§¸ ì˜µì…˜ìœ¼ë¡œ
   } else {
     el.value = "";
   }
 });

 // ag-grid ì´ˆê¸°í™”
 const gridDiv = document.getElementById("invoiceGrid");
 if (gridDiv && gridDiv.api) {
   gridDiv.api.setRowData([]); // í–‰ ë¹„ìš°ê¸°
 }
});

</script>

<!--  ë§¤ì…ë§¤ì¶œ ëª¨ë‹¬ -->
<script th:inline="none">

document.addEventListener("DOMContentLoaded", () => {
  const modalEl = document.getElementById('invoiceModal');
  let invoiceGridApi;
  let invoiceGridCreated = false;

  modalEl.addEventListener('shown.bs.modal', () => {
    const gridDiv = document.querySelector("#invoiceGrid");

    if (!invoiceGridCreated) {
      const gridOptions = {
        columnDefs: [
          { headerName: "í’ˆëª©ì½”ë“œ", field: "itemCode", flex: 1 },
          { headerName: "í’ˆëª©ëª…",   field: "itemName", flex: 1 },
          { headerName: "ë‹¨ê°€",     field: "price",    flex: 1,
            valueFormatter: p => p.value ? p.value.toLocaleString() : "" },
          { headerName: "ìˆ˜ëŸ‰",     field: "qty",      flex: 1 },
          { headerName: "ê³µê¸‰ê°€ì•¡", field: "supply",   flex: 1,
            valueFormatter: p => p.value ? p.value.toLocaleString() : "" },
          { headerName: "ë¶€ê°€ì„¸",   field: "vat",      flex: 1,
            valueFormatter: p => p.value ? p.value.toLocaleString() : "" },
          { headerName: "ë¹„ê³ ",     field: "note",     flex: 1 }
        ],
        rowData: /*[[${invoiceItems}]]*/ [],
        defaultColDef: { resizable: true },
        pinnedBottomRowData: [
          {
            itemName: "í•©ê³„",
            supply: /*[[${invoiceHeader?.subtotalAmt}]]*/ 0,
            vat: /*[[${invoiceHeader?.vatAmt}]]*/ 0
          }
        ]
      };
      invoiceGridApi = agGrid.createGrid(gridDiv, gridOptions);
      invoiceGridCreated = true;
    } else {
      invoiceGridApi.resetRowHeights();
    }
  });
});
</script>

<!--  invoice ëª¨ë‹¬ì•ˆì—ì„œ  ëª¨ë‹¬ -->
<script th:inline="none">
let businessGridApi = null;

async function loadBusinessData() {
  try {
    const res = await axios.get("/api/v1/stock/cusList");
    if (businessGridApi) {
      businessGridApi.setRowData(res.data);
      businessGridApi.sizeColumnsToFit();
    }
  } catch (err) {
    console.error("cusList ë¡œë“œ ì‹¤íŒ¨:", err);
  }
}

function initBusinessGrid() {
  const gridDiv = document.querySelector("#businessModal #myGrid") || document.querySelector("#myGrid");
  if (!gridDiv) {
    console.error("ê±°ë˜ì²˜ ê·¸ë¦¬ë“œ ì»¨í…Œì´ë„ˆ(#myGrid)ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  const columnDefs = [
    { headerName: "ê±°ë˜ì²˜ì½”ë“œ", field: "cusCode" },
    { headerName: "ê±°ë˜ì²˜ëª…", field: "cusName" },
    { headerName: "ë‹´ë‹¹ìëª…", field: "empName" },
    { headerName: "ì‚¬ì—…ìë²ˆí˜¸", field: "bizNo" },
    { headerName: "ëŒ€í‘œëª…", field: "ceoName" },
    { headerName: "ì—…íƒœ", field: "bizType" },
    { headerName: "ì¢…ëª©", field: "bizCategory" },
    { headerName: "ê±°ë˜ì²˜ì£¼ì†Œ", field: "addr" }
  ];

  const gridOptions = {
    columnDefs,
    rowSelection: "single",
    pagination: true,
    rowData: [],
    defaultColDef: { resizable: true, sortable: true, minWidth: 100 },
    onGridReady: (e) => {
      businessGridApi = e.api;
      businessGridApi.sizeColumnsToFit();
      loadBusinessData();
    },
    onRowDoubleClicked: (e) => {
      // ê°’ ë°˜ì˜
      document.getElementById("cusCodeInput").value = e.data.cusCode ?? "";
      document.getElementById("cusNameInput").value = e.data.cusName ?? "";

      // ê±°ë˜ì²˜ ëª¨ë‹¬ ë‹«ê³  â†’ ì „í‘œ ëª¨ë‹¬ ë‹¤ì‹œ ì—´ê¸°
      const businessModal = bootstrap.Modal.getOrCreateInstance(document.getElementById("businessModal"));
      businessModal.hide();

      const invoiceModal = bootstrap.Modal.getOrCreateInstance(document.getElementById("invoiceModal"));
      invoiceModal.show();
    }
  };

  new agGrid.Grid(gridDiv, gridOptions);
}

// DOM ë Œë”ë§ì‹œ 
document.addEventListener("DOMContentLoaded", () => {
  const invoiceModalEl = document.getElementById("invoiceModal");
  const businessModalEl = document.getElementById("businessModal");
  const deptModalEl = document.getElementById("deptModal");
  
  if (!invoiceModalEl || !businessModalEl) {
    console.error("invoiceModal ë˜ëŠ” businessModal ìš”ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  const invoiceModal = bootstrap.Modal.getOrCreateInstance(invoiceModalEl);
  const businessModal = bootstrap.Modal.getOrCreateInstance(businessModalEl);
  const deptModal = bootstrap.Modal.getOrCreateInstance(deptModalEl);
  
  // ë²„íŠ¼ í´ë¦­ â†’ ì „í‘œëª¨ë‹¬ ë‹«ê³  â†’ ë‹«íŒ í›„ ê±°ë˜ì²˜ ëª¨ë‹¬ ì—´ê¸° (ì—°ì‡„)
  document.getElementById("openBusinessModalBtn").addEventListener("click", () => {
    const openBusinessAfterHide = () => {
      // í•œ ë²ˆë§Œ ì‹¤í–‰í•˜ê³  í•¸ë“¤ëŸ¬ ì œê±°
      invoiceModalEl.removeEventListener("hidden.bs.modal", openBusinessAfterHide);

      // ê±°ë˜ì²˜ ëª¨ë‹¬ ì—´ê¸°
      businessModal.show();
    };

    // ì „í‘œ ëª¨ë‹¬ì´ ì™„ì „íˆ ë‹«íŒ ë’¤ ì‹¤í–‰
    invoiceModalEl.addEventListener("hidden.bs.modal", openBusinessAfterHide);
    invoiceModal.hide(); // ë¨¼ì € ë‹«ëŠ”ë‹¤
  });

  // ê±°ë˜ì²˜ ëª¨ë‹¬ì´ ë³´ì—¬ì§ˆ ë•Œ ê·¸ë¦¬ë“œ ì¤€ë¹„/ë¦¬ì‚¬ì´ì¦ˆ/ë¡œë”©
  businessModalEl.addEventListener("shown.bs.modal", () => {
    if (!businessGridApi) initBusinessGrid();
    else {
      businessGridApi.sizeColumnsToFit();
      loadBusinessData();
    }
  });
});
</script>

<!-- ë¶€ì„œ ëª¨ë‹¬ -->
<script th:inline="none">
document.addEventListener("DOMContentLoaded", () => {
  const invoiceModalEl = document.getElementById("invoiceModal");
  const deptModalEl    = document.getElementById("deptModal");

  if (!invoiceModalEl || !deptModalEl) return;

  // âœ… invoiceModal, deptModal ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
  const invoiceModal = bootstrap.Modal.getOrCreateInstance(invoiceModalEl);
  const deptModal    = new bootstrap.Modal(deptModalEl, { backdrop: false }); // ğŸ”‘ ë™ì‹œì— ë„ìš¸ ìˆ˜ ìˆê²Œ

  // ====== ë¶€ì„œ ë²„íŠ¼ í´ë¦­ ì‹œ â†’ invoiceModal ë‹«ì§€ ì•Šê³  deptModal ê°•ì œë¡œ ì—´ê¸° ======
  invoiceModalEl.addEventListener("click", (e) => {
    const btn = e.target.closest("#openDeptModalBtn");
    if (!btn) return;
    deptModal.show();
  });

  // ====== ë¶€ì„œ ê·¸ë¦¬ë“œ ======
  let deptGridApi = null;
  const deptData = [
   
  ];

  function initDeptGrid() {
    if (deptGridApi) return;
    const gridDiv = document.getElementById("deptGrid");
    const gridOptions = {
      columnDefs: [
        { headerName: "ë¶€ì„œì½”ë“œ", field: "deptCode", flex: 1 },
        { headerName: "ë¶€ì„œëª…",   field: "deptName", flex: 1 },
        { headerName: "ê´€ë¦¬ì",   field: "managerEmpId", flex: 1 }
      ],
      rowData: deptData,
      rowSelection: "single",
      defaultColDef: { resizable: true, sortable: true, minWidth: 30 },
      onGridReady: (e) => {
          loadDeptData();
        },
      onRowDoubleClicked: (e) => {
        // ì„ íƒí•œ ë¶€ì„œ â†’ invoiceModal inputì— ë°˜ì˜
        document.getElementById("deptNameInput").value = e.data.deptName;
        // deptCodeInput ì´ ìˆë‹¤ë©´ ë°˜ì˜
        if (document.getElementById("deptCodeInput")) {
          document.getElementById("deptCodeInput").value = e.data.deptCode;
        }

        // ë¶€ì„œ ëª¨ë‹¬ë§Œ ë‹«ê³  invoiceModalì€ ê·¸ëŒ€ë¡œ ë‘”ë‹¤
        deptModal.hide();
      }
    };
    deptGridApi = agGrid.createGrid(gridDiv, gridOptions);
  }

  // ëª¨ë‹¬ì´ ì—´ë¦¬ë©´ ê·¸ë¦¬ë“œ ì¤€ë¹„ + ë¦¬ì‚¬ì´ì¦ˆ
  deptModalEl.addEventListener("shown.bs.modal", () => {
    initDeptGrid();
    setTimeout(() => deptGridApi?.sizeColumnsToFit(), 0);
  });

  // ê²€ìƒ‰
  document.getElementById("deptSearchBtn")?.addEventListener("click", () => {
    const kw = (document.getElementById("deptSearchInput")?.value || "").toLowerCase();
    const filtered = deptData.filter(r => r.deptName.toLowerCase().includes(kw));
    deptGridApi?.setRowData(filtered);
  });
  document.getElementById("deptResetBtn")?.addEventListener("click", () => {
    deptGridApi?.setRowData(deptData);
  });
});

async function loadDeptData() {
	  try {
	    const res = await axios.get("/api/hr/dept");
	    if (deptGridApi) {
	    	deptGridApi.setRowData(res.data);
	    	deptGridApi.sizeColumnsToFit();
	    }
	  } catch (err) {
	    console.error("dept ë¡œë“œ ì‹¤íŒ¨:", err);
	  }
	}
</script>

	</th:block>
</body>
</html>
