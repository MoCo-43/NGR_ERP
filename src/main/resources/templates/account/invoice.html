<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/base}">
<head>
<title layout:fragment="title">매입 매출 전표</title>
<th:block layout:fragment="head_extra">

	<th:block
		th:replace="~{account/taxInvoiceModal :: taxInvoiceModalStyles}"></th:block>
	<!-- AG Grid -->
	<link rel="stylesheet"
		href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/styles/ag-grid.css" />
	<link rel="stylesheet"
		href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/styles/ag-theme-quartz.css" />
	<style>
#voucherGrid.ag-theme-quartz {
	height: 32rem;
	width: 100%;
}

#detailGrid.ag-theme-quartz {
	height: 14rem;
	width: 100%;
	margin-top: 1rem;
	display: none;
}

#invoiceGrid.ag-theme-quartz {
	height: 20rem;
	width: 100%;
	margin-top: 1rem;
}

.btn-bar {
	display: flex;
	gap: 0.5rem;
	margin-bottom: 0.75rem;
}

/* ✅ '유형' 컬럼만 배지 스타일로 강조 */
.badge-type {
	display: inline-block;
	padding: 0.125rem 0.5rem;
	border-radius: 9999px;
	font-weight: 700;
	font-size: 0.875rem;
	line-height: 1.2;
}

.badge-sales {
	background: #fee2e2;
	color: #b91c1c;
} /* 매출(S) 빨강 */
.badge-purchase {
	background: #dbeafe;
	color: #1d4ed8;
} /* 매입(P) 파랑 */

#btnRegisterDetail{
	display: none;
}

</style>
</th:block>
</head>
<body>
	<section layout:fragment="content">
		<div class="card shadow mb-3">
			<div
				class="card-header py-3 d-flex align-items-center justify-content-between">
				<h6 class="m-0 font-weight-bold text-primary">매입 매출 전표</h6>
			</div>
			<div class="card-body">
				<!-- 버튼 영역 -->
				<div class="btn-bar">
					<button class="btn btn-danger btn-sm open-invoice"
						data-bs-toggle="modal" data-bs-target=""
						data-type="S">매출</button>
					<button class="btn btn-primary btn-sm open-invoice"
						data-bs-toggle="modal" data-bs-target="#invoiceModal"
						data-type="P">매입</button>
					<button class="btn btn-success btn-sm open-taxinvoice"
						data-bs-toggle="modal" data-bs-target="#taxInvoiceModal">전자세금</button>
				</div>

				<!-- 전표 목록 Grid -->
				<div id="voucherGrid" class="ag-theme-quartz"></div>
				<div id="actionBar" class="d-flex justify-content-end gap-2 my-2"
					>
					<button id="btnRegisterDetail" type="button"
						class="btn btn-primary btn-sm">등록</button>
				</div>
				<!-- 분개 상세 Grid -->
				<div id="detailGrid" class="ag-theme-quartz"></div>
			</div>
		</div>
		<!-- ✅ 모달 fragment include -->
		<div th:replace="~{account/invoiceModal :: invoiceModal}"></div>
		<div th:replace="~{account/taxInvoiceModal :: taxInvoiceModal}"></div>
		<div th:replace="~{stock/modals/businessModal :: businessModal}"></div>
		<div th:replace="~{hr/codeLookup :: codeLookupModal}"></div>

	</section>

	<th:block layout:fragment="body_extra">
		<script
			src="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/dist/ag-grid-community.min.js"></script>
		<script
			src="https://cdn.jsdelivr.net/npm/axios@1.7.7/dist/axios.min.js"></script>
		<script th:inline="none">
  let voucherApi, detailApi;
  let selectedInvoice = null; // ✅ 현재 선택한 상단 전표행 저장
  
  // compCode받아놓기
  axios.get("/api/v1/stock/getCompId", { withCredentials: true })
  .then(res => {
  		document.getElementById("compCode").value = res.data;
  	})
    .catch(err => console.error(err));
    
  // === 전표 데이터 불러오기 ===
  async function loadAndRenderVoucher() {
    try {
      const { data } = await axios.get("/api/account/headers");
      voucherApi.setGridOption("rowData", Array.isArray(data) ? data : []);
    } catch (err) {
      console.error(err);
      alert("전표 데이터를 불러오지 못했습니다.");
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    // === voucherGrid 정의 ===
    const voucherColumnDefs = [
      { headerName: "월", valueGetter: p => p.data?.invoiceDate ? new Date(p.data.invoiceDate).getMonth() + 1 : "", flex: .5 },
      { headerName: "일", valueGetter: p => p.data?.invoiceDate ? new Date(p.data.invoiceDate).getDate() : "", flex: .5 },

      // ✅ 유형 컬럼만 배지로 렌더링
      {
        headerName: "유형",
        field: "type",
        flex: 1,
        cellRenderer: params => {
          const isSales = params.value === 'S';
          const text = isSales ? '매출' : '매입';
          const cls  = isSales ? 'badge-sales' : 'badge-purchase';
          return `<span class="badge-type ${cls}">${text}</span>`;
        }
      },

      { headerName: "전표번호", field: "invoiceNo", flex: 1 },
      { headerName: "사업자번호", field: "bizNo", flex: 1 },
      { headerName: "거래처명", field: "cusName", flex: 1 },
      { headerName: "공급가액", field: "subtotalAmt", valueFormatter: p => p.value ? p.value.toLocaleString() : "", flex: 1 },
      { headerName: "부가세", field: "vatAmt", valueFormatter: p => p.value ? p.value.toLocaleString() : "", flex: 1 },
      { headerName: "합계", field: "totalAmt", valueFormatter: p => p.value ? p.value.toLocaleString() : "", flex: 1 }
    ];

    voucherApi = agGrid.createGrid(document.querySelector("#voucherGrid"), {
      columnDefs: voucherColumnDefs,
      rowData: [],
      rowSelection: "single",
      pagination: true,
      paginationPageSize: 12,
      defaultColDef: { filter: true, resizable: true },
      // ❌ 행 전체 강조 없음

      onRowClicked: e => {
    	selectedInvoice = e.data;  
        const details = createDetailsFromInvoice(e.data);
        detailApi.setGridOption("rowData", details);
        document.getElementById("detailGrid").style.display = "block";
        document.getElementById("btnRegisterDetail").style.display = "block";
      }
    });

    // === detailGrid 정의 ===
    const detailColumnDefs = [
      { headerName: "구분", field: "gbn", flex: 1 },
      { headerName: "코드", field: "code", flex: 1 },
      { headerName: "계정과목", field: "acctName", flex: 1 },
      { headerName: "거래처코드", field: "partnerCode", flex: 1 },
      { headerName: "거래처", field: "partner", flex: 1 },
      { headerName: "차변(출금)", field: "debit", flex: 1 },
      { headerName: "대변(입금)", field: "credit", flex: 1 },
      { headerName: "적요", field: "note", flex: 1 }
    ];

    detailApi = agGrid.createGrid(document.querySelector("#detailGrid"), {
      columnDefs: detailColumnDefs,
      rowData: [],
      defaultColDef: { resizable: true }
    });

    // === 자동 분개 함수 ===
    function createDetailsFromInvoice(invoice) {
      let details = [];

      if (invoice.type === "S") { // 매출
        details.push({ gbn: "차변", code: "108", acctName: "외상매출금", partnerCode: invoice.cusCode, partner: invoice.cusName, debit: invoice.totalAmt, credit: null, note: `${invoice.cusName} 매출` });
        details.push({ gbn: "대변", code: "401", acctName: "상품매출", partnerCode: invoice.cusCode, partner: invoice.cusName, debit: null, credit: invoice.subtotalAmt, note: `${invoice.invoiceNo} 매출액` });
        if (invoice.vatAmt && invoice.vatAmt > 0) {
          details.push({ gbn: "대변", code: "255", acctName: "부가세예수금", partnerCode: invoice.cusCode, partner: invoice.cusName, debit: null, credit: invoice.vatAmt, note: "부가세" });
        }
      } else if (invoice.type === "P") { // 매입
        details.push({ gbn: "차변", code: "146", acctName: "상품", partnerCode: invoice.cusCode, partner: invoice.cusName, debit: invoice.subtotalAmt, credit: null, note: `${invoice.invoiceNo} 매입` });
        if (invoice.vatAmt && invoice.vatAmt > 0) {
          details.push({ gbn: "차변", code: "135", acctName: "부가세대급금", partnerCode: invoice.cusCode, partner: invoice.cusName, debit: invoice.vatAmt, credit: null, note: "부가세" });
        }
        details.push({ gbn: "대변", code: "251", acctName: "외상매입금", partnerCode: invoice.cusCode, partner: invoice.cusName, debit: null, credit: invoice.totalAmt, note: `${invoice.cusName} 외상` });
      }

      return details;
    }

    loadAndRenderVoucher();
  });
  


// 오늘 날짜
const todayStr = () => {
	  const d = new Date();
	  const mm = String(d.getMonth()+1).padStart(2,'0');
	  const dd = String(d.getDate()).padStart(2,'0');
	  return `${d.getFullYear()}-${mm}-${dd}`;
	};

// 디테일 그리드 등록 버튼 -> 일반 전표

 
document.getElementById("btnRegisterDetail").addEventListener("click", async (data) => {
	 if (selectedInvoice?.postedFlag === 'Y') {
		    alert("이미 등록된 전표입니다.");
		    return;
		  }
  // detailGrid 데이터 수집
  const details = [];
  detailApi.forEachNode(node => {
    details.push(node.data);
  });

  if (details.length === 0) {
    alert("분개 데이터가 없습니다.");
    return;
  }
  
	const { data: newNo } = await axios.get("/api/account/nextJrnNo"); 
    data.jrnNo = newNo;

  // payload 구성
  const payload = details.map((d, idx) => ({
  	
	jrnNo:data.jrnNo,
	lineNo:data.lineNo || null,
	jrnDate: data.jrnDate || todayStr(),
    acctCode: d.code,
    acctName: d.acctName,
    dcType: d.gbn === "차변" ? "D" : "C",
    amount: d.debit ? d.debit : d.credit,
    remarks: d.note,
    cusCode: d.partnerCode,
    cusName: d.cusName,
    status: "open"
    
  }));
  try {
	    await axios.post("/api/account/journalList", payload);
	    alert("저장 완료!");
	  } catch (err) {
	    console.error(err);
	    alert("저장 실패");
	  }

});


</script>

	<!-- 부서 모달 -->
<script th:inline="none">
document.addEventListener('DOMContentLoaded', () => {
  const invoiceModalEl = document.getElementById('invoiceModal');
  const btn = invoiceModalEl?.querySelector('#btnDeptLookup');
  if (!btn) return;

  // 중복 바인딩 방지
  if (btn.dataset.bound === '1') return;
  btn.dataset.bound = '1';

  btn.addEventListener('click', (e) => {
    e.preventDefault();
    e.stopPropagation();

    CodeLookup.open({
      source: 'dept',
      title:  '부서 선택',
      // 필요한대로 지정
      // targetId: 'deptCodeInput',
      targetNameId: 'deptNameInput',
    });
  });
});

document.addEventListener('DOMContentLoaded', () => {
	  const invoiceModalEl = document.getElementById('invoiceModal');
	  const btn = invoiceModalEl?.querySelector('#btnBankLookup');
	  if (!btn) return;

	  // 중복 바인딩 방지
	  if (btn.dataset.bound === '1') return;
	  btn.dataset.bound = '1';

	  btn.addEventListener('click', (e) => {
	    e.preventDefault();
	    e.stopPropagation();

	    CodeLookup.open({
	      groupId: 'BK',
	      title:  '은행 선택',
	      // 필요한대로 지정
	      // targetId: 'deptCodeInput',
	      targetNameId: 'bankNameInput',
	    });
	  });
	});
</script>

</th:block>
</body>
</html>
