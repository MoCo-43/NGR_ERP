<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/base}">
<head>
<meta charset="UTF-8" />
<title layout:fragment="title">일반 전표 마감</title>

<th:block layout:fragment="head_extra">
	<!-- AG Grid -->
	<link rel="stylesheet"
		href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/styles/ag-grid.css" />
	<link rel="stylesheet"
		href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/styles/ag-theme-quartz.css" />
	<style>
.btn-bar {
	display: flex;
	gap: 0.5rem;
	margin-bottom: 0.75rem;
}

.section-title {
	margin-top: 0.5rem;
	margin-bottom: .5rem;
	color: black;
	font-weight: bold;
}

.grid-sm {
	height: 220px;
	width: 100%;
}

.grid-md {
	height: 100%;
	width: 100%;
}

.voucher-section {
	display: flex;
	gap: 1rem;
	align-items: stretch;
}

.voucher-left, .voucher-right {
	flex: 1;
	display: flex;
	flex-direction: column;
}

.voucher-left .ag-theme-quartz {
	flex: 1;
}

.voucher-right .detail-form {
	margin-bottom: 0.5rem;
}

.voucher-right .ag-theme-quartz {
	flex: 1;
}

.badge-status-open {
	background: #dcfce7; /* 연한 초록 */
	color: #15803d; /* 진한 초록 */
	font-weight: 600;
	border-radius: 8px;
	padding: 2px 8px;
}

.badge-status-closed {
	background: #fee2e2; /* 차변과 동일 */
	color: #b91c1c;
	font-weight: 600;
	border-radius: 8px;
	padding: 2px 8px;
}

.badge-status-submit {
	background: #fef9c3; /* 연노랑 */
	color: #ca8a04; /* 진한 노랑/주황 */
	font-weight: 600;
	border-radius: 8px;
	padding: 2px 8px;
}

.badge-status-reverse {
	background: #dbeafe; /* 연한 파랑 */
	color: #1d4ed8; /* 진한 파랑 */
	font-weight: 600;
	border-radius: 8px;
	padding: 2px 8px;
}
</style>
</th:block>
</head>
<script th:inline="javascript">
  const loginUser = /*[[${loginId}]]*/ "";
</script>
<body>
	<section layout:fragment="content">
		<div class="card shadow mb-3">
			<div
				class="card-header py-3 d-flex align-items-center justify-content-between">
				<h6 class="m-0 font-weight-bold text-primary">일반 전표 마감</h6>
			</div>
			<div class="card-body">

				<div class="btn-bar d-flex justify-content-between">
					<div class="d-flex gap-2 ml-2">
						<input type="date" id="searchDate"
							class="form-control form-control-sm" style="width: 150px" />
						<button class="btn btn-dark btn-sm ml-3" id="btnSearch">조회</button>
					</div>

					<div class="d-flex gap-2 mr-2">
						<button id="btnSubmit" class="btn btn-success btn-sm mr-2">제출</button>
						<button id="btnApprove" class="btn btn-warning btn-sm mr-2">승인</button>
						<button id="btnReverse" class="btn btn-danger btn-sm">역분개</button>
					</div>
				</div>


				<!-- 전표 리스트 + 전표 상세 -->
				<div class="voucher-section" style="min-height: 400px;">
					<!-- 좌측: 전표 리스트 -->
					<div class="voucher-left">
						<div class="section-title">전표 리스트</div>
						<div id="voucherGrid" class="ag-theme-quartz grid-md"></div>
					</div>

					<!-- 우측: 전표 상세 -->
					<div class="voucher-right">
						<div class="section-title">전표 상세</div>
						<div class="row mb-2 detail-form">
							<div class="col-md-6">
								<label class="form-label">전표번호</label> <input id="detailNo"
									class="form-control form-control-sm" readonly />
							</div>
							<div class="col-md-6">
								<label class="form-label">작성자</label> <input id="detailWriter"
									class="form-control form-control-sm" readonly />
							</div>
							<div class="col-md-6 mt-2">
								<label class="form-label">전표일자</label> <input id="detailDate"
									class="form-control form-control-sm" readonly />
							</div>
							<div class="col-md-6 mt-2">
								<label class="form-label">적요</label> <input id="detailDesc"
									class="form-control form-control-sm" readonly />
							</div>
						</div>
						<div id="detailGrid" class="ag-theme-quartz grid-md"></div>
					</div>
				</div>

				<!-- 액션 버튼 -->

				<div
					class="d-flex justify-content-between align-items-center section-title">
					<span>마감 로그</span>
				</div>
				<div id="logGrid" class="ag-theme-quartz grid-sm"></div>

			</div>
			<div th:replace="~{modal/signModal :: signModal}"></div>

		</div>

		<!-- Script -->
		<script
			src="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/dist/ag-grid-community.min.noStyle.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

		</script>
		<script th:inline="javascript">
    // ✅ 로그인 사용자 이름/ID 전역 변수로 선언
    const loginId = /*[[${#authentication.principal.empLoginVO.empId}]]*/ "";
    const loginName = /*[[${#authentication.principal.empLoginVO.name}]]*/ "";
    console.log(loginName);
  </script>
		<script>
    let voucherApi, detailApi, logApi;
    let selected = null;

    function todayStr() {
      const d = new Date();
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const dd = String(d.getDate()).padStart(2, '0');
      return `${d.getFullYear()}-${mm}-${dd}`;
    }

    document.addEventListener('DOMContentLoaded', async () => {
      document.getElementById('searchDate').value = todayStr();

      // 전표 리스트
      voucherApi = agGrid.createGrid(document.getElementById('voucherGrid'), {
        columnDefs: [
          { checkboxSelection: true, headerCheckboxSelection: true, flex:0.3 },
          { headerName: '전표번호', field: 'jrnNo', flex: 1 },
          { headerName: '전표일자', field: 'jrnDate', flex: 1,
        	  valueFormatter: p => p.value ? p.value.substring(0,10):""},
          { headerName: '거래처', field: 'cusName', flex: 1 },
          { headerName: '상태', field: 'status', flex: 1,
        	  cellRenderer: p => {
        	        const v = (p.value || "").toLowerCase();
        	        if (v === "open")     return `<span class="badge-status-open">OPEN</span>`;
        	        if (v === "submit")   return `<span class="badge-status-submit">SUBMIT</span>`;
        	        if (v === "closed")    return `<span class="badge-status-closed">CLOSED</span>`;
        	        if (v === "reverse")  return `<span class="badge-status-reverse">REVERSE</span>`;
        	        return v || "";
        	      }}
        ],
        rowData: [],
        rowSelection: 'multiple',
        defaultColDef: { sortable: true, filter: true, resizable: true },
        onRowClicked: e =>loadDetail(e.data.jrnNo),  //
        onGridReady: loadVoucherList // ✅ 초기 로드
      });

      // 전표 상세
      detailApi = agGrid.createGrid(document.getElementById('detailGrid'), {
        columnDefs: [
          { headerName: '코드', field: 'acctCode', flex: 1 },
          { headerName: '계정과목', field: 'acctName', flex: 1 },
          { headerName: '적요', field: 'remarks', flex: 1 },
          { 
              headerName: '차변', 
              field : 'debit',
              flex: 1, 
              valueFormatter: p => p.value ? Number(p.value).toLocaleString() : "" 
            },
            { 
              headerName: '대변', 
              field : 'credit',
              flex: 1, 
              valueFormatter: p => p.value ? Number(p.value).toLocaleString() : "" 
            }
        ],
        rowData: [],
        defaultColDef: { resizable:true }
      });

      // 마감 로그
      logApi = agGrid.createGrid(document.getElementById('logGrid'), {
        columnDefs: [
          { headerName: '마감일자', field: 'actionDate', flex: 1,
        	  valueFormatter: p => p.value ? p.value.substring(0,10):""},
          { headerName: '전표범위', field: 'jrnRange', flex: 1 },
          { headerName: '건수', field: 'count', flex: 1 },
          { 
              headerName: '차변', 
              field:'debitSum',
              flex: 1, 
              valueFormatter: p => p.value ? Number(p.value).toLocaleString() : 0
            },
            { 
              headerName: '대변', 
              field:'creditSum',
              flex: 1, 
              valueFormatter: p => p.value ? Number(p.value).toLocaleString() : 0 
            },
          { headerName: '작성자', field: 'createdBy', flex: 1 },
          { headerName: '상태', field: 'actionType', flex: 1 }
        ],
        rowData: [],
        defaultColDef: { resizable:true },
        onRowClicked:(data)=>{
        	console.log(data);	
        }
      });

      // 조회 버튼
      document.getElementById('btnSearch').addEventListener('click', loadVoucherList);
    });

 // 전표 리스트 조회 (전체 불러온 뒤 날짜 필터링)
    async function loadVoucherList() {
      try {
        const searchDate = document.getElementById('searchDate').value;
        const { data } = await axios.get('/api/account/journalClose');

        let rows = Array.isArray(data) ? data : [];

        // ✅ 날짜 필터링 (프론트에서만)
        if (searchDate) {
          rows = rows.filter(r => r.jrnDate && r.jrnDate.substring(0,10) === searchDate);
        }

        voucherApi.setGridOption("rowData", rows);
        logApi.setGridOption("rowData", []);
        
      } catch (err) {
        console.error(err);
        alert('전표 리스트 조회 실패');
      }
      
    }
    
 
    document.getElementById('searchDate').value = todayStr();
 // 전표 상세 조회 (마감용 API)
   async function loadDetail(jrnNo) {
  try {
    const { data } = await axios.get(`/api/account/journalClose/${jrnNo}`);
    console.log(data);
    document.getElementById('detailNo').value     = data?.[0]?.jrnNo || '';
    document.getElementById('detailWriter').value = data?.[0]?.createdBy|| '';
    document.getElementById('detailDate').value   = data?.[0]?.jrnDate?.substring(0,10) || '';
    document.getElementById('detailDesc').value   = data?.[0]?.remarks || '';

    // ✅ 바뀐 문법
    detailApi.setGridOption("rowData", data || []);

    // 로그도 같이 조회
    loadLogByJrn(jrnNo);

  } catch (err) {
    console.error(err);
    alert('전표 상세 조회 실패');
  }
}

// 로그 조회 후 바인딩
   async function loadLogByJrn(jrnNo) {
     try {
       const { data } = await axios.get(`/api/account/journalClose/logs/${jrnNo}`);
       let rows = Array.isArray(data) ? data : [];

       // ✅ 건수 계산
       rows = rows.map(r => {
         if (r.jrnRange) {
           const [start, end] = r.jrnRange.split("~").map(x => parseInt(x, 10));
           if (!isNaN(start) && !isNaN(end)) {
             r.count = (end - start + 1);   // ex) 003~007 → 5건
           } else {
             r.count = 1; // fallback
           }
         } else {
           r.count = 0;
         }
         return r;
       });

       logApi.setGridOption("rowData", rows); // ✅ 최신 방식
     } catch (e) {
       console.error(e);
       alert("마감 로그 조회 실패");
     }
   }
 // 제출 버튼
    document.getElementById('btnSubmit').addEventListener('click', async () => {
      const selected = voucherApi.getSelectedRows();
      if (selected.length === 0) {
        alert("제출할 전표를 선택하세요.");
        return;
      }

      // ✅ 이미 제출/승인/역분개 된 전표는 막기
      const invalid = selected.filter(r => ["submit","closed","reverse"].includes((r.status || "").toLowerCase()));
      if (invalid.length > 0) {
        alert("이미 제출/승인/역분개된 전표는 다시 제출할 수 없습니다.");
        return;
      }

      const jrnNoList = selected.map(r => r.jrnNo);
      await axios.put('/api/account/journal/status', { jrnNoList, status: 'submit', loginName: loginName });

      alert("제출 완료되었습니다.");
      loadVoucherList();
    });

 
 // 승인 , 역분개시 canvasAPI
    async function saveClose(signPath) {
	 	const selected = voucherApi.getSelectedRows();
	 	const pendingIds = selected[0].jrnNo;
    	  // 2) approve / reverse API 분기
    	  try {
    	    if (signMode === "approve") {
    	      await axios.put('/api/approval/journal/approve', {
    	        ids: [pendingIds],
    	        signPath: signPath
    	      });
    	      alert('승인 완료');
    	    } else if (signMode === "reverse") {
    	      await axios.post('/api/account/journal/reverse', {
    	    	  originJrnNos: pendingIds,
    	    	  signPath: signPath
    	      }); 
    	    }
    	    bootstrap.Modal.getOrCreateInstance(document.getElementById('signModal')).hide();
    	    loadVoucherList();
    	  } catch (e) {
    	    console.error(e);
    	    alert('처리 실패');
    	  }
    	}
    
 // 제출 버튼은 기존 그대로 (상태만 바꾸면 됨)

 // 승인 버튼
document.getElementById('btnApprove').addEventListener('click', async() => {

  const selected = voucherApi.getSelectedRows();
  if (!selected.length) return alert("승인할 전표를 선택하세요.");
  if (selected.some(r => ["closed","reverse"].includes((r.status||"").toLowerCase())))
    return alert("이미 승인/역분개된 전표 포함");
  await openSignModal("approve",saveClose);
  
});

// 역분개 버튼
document.getElementById('btnReverse').addEventListener('click', async () => {
  const selected = voucherApi.getSelectedRows();
  if (!selected.length) return alert("역분개할 전표를 선택하세요.");
//✅ reverseYn 값도 같이 체크
  if (selected.some(r => (r.status||"").toLowerCase()==="reverse" || (r.reversedYn||"").toUpperCase()==="Y")) {
    return alert("이미 역분개된 전표가 포함되어 있습니다.");
  }
  await openSignModal("reverse",saveClose);

});

async function loadLogByDate(dateStr) {
	  try {
	    const { data } = await axios.get(`/api/account/journalClose/logs/date/${dateStr}`);
	    let rows = Array.isArray(data) ? data : [];

	    // ✅ 건수 계산
	    rows = rows.map(r => {
	      if (r.jrnRange) {
	        const [start, end] = r.jrnRange.split("~").map(x => parseInt(x, 10));
	        if (!isNaN(start) && !isNaN(end)) {
	          r.count = (end - start + 1);
	        } else {
	          r.count = 1;
	        }
	      } else {
	        r.count = 0;
	      }
	      return r;
	    });

	    logApi.setGridOption("rowData", rows);
	  } catch (e) {
	    console.error(e);
	    alert("오늘자 마감 로그 조회 실패");
	  }
	}
  </script>
	</section>
</body>
</html>
