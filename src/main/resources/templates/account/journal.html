<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/base}">
<head>
<title layout:fragment="title">일반 전표</title>
<th:block layout:fragment="head_extra">
	<!-- AG Grid -->
	<link rel="stylesheet"
		href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/styles/ag-grid.css" />
	<link rel="stylesheet"
		href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/styles/ag-theme-quartz.css" />
	<style>
#generalVoucherGrid.ag-theme-quartz {
  height: 34rem;
  width: 100%;
  margin-top: 1rem;
}

.btn-bar {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 0.75rem;
}

.badge-debit {
  background: #fee2e2;
  color: #b91c1c;
  font-weight: 600;
  border-radius: 8px;
  padding: 2px 8px;
}
.badge-credit {
  background: #dbeafe;
  color: #1d4ed8;
  font-weight: 600;
  border-radius: 8px;
  padding: 2px 8px;
}

/* 입력 고정행 스타일 */
.ag-theme-quartz .ag-floating-top .ag-row {
  background: #fafafa;
  font-weight: 500;
  border-bottom: 1px solid #e5e7eb;
}
</style>

</th:block>
</head>
<body>
	<section layout:fragment="content">
		<div class="card shadow mb-3">
			<div
				class="card-header py-3 d-flex align-items-center justify-content-between">
				<h6 class="m-0 font-weight-bold text-primary">일반 전표</h6>
			</div>
			<div class="card-body">
				<!-- 조회 영역 -->
				<div class="btn-bar">
					<button class="btn btn-outline-secondary btn-sm" id="btnPeriod">기간별</button>
					<button class="btn btn-outline-secondary btn-sm" id="btnMonth">월별</button>
					<input type="date" class="form-control form-control-sm"
						id="fromDate" style="max-width: 180px" /> <span class="mx-1">~</span>
					<input type="date" class="form-control form-control-sm" id="toDate"
						style="max-width: 180px" />
					<button class="btn btn-dark btn-sm" id="btnSearch">조회</button>
				</div>

				<!-- 일반전표 목록 Grid -->
				<div id="generalVoucherGrid" class="ag-theme-quartz"></div>
			</div>
		</div>
		<div th:replace="~{stock/modals/businessModal :: businessModal}"></div>
	</section>

	<th:block layout:fragment="body_extra">
		<script
			src="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/dist/ag-grid-community.min.js"></script>
		<script
			src="https://cdn.jsdelivr.net/npm/axios@1.7.7/dist/axios.min.js"></script>

	<script th:inline="none">
	  let gvApi;

	  // ===== 유틸 =====
	  const toNumber = (v) => {
	    if (v === null || v === undefined || v === "") return null;
	    const n = Number(String(v).replaceAll(",", "").trim());
	    return Number.isFinite(n) ? n : null;
	  };
	  const todayStr = () => {
	    const d = new Date();
	    const mm = String(d.getMonth()+1).padStart(2,'0');
	    const dd = String(d.getDate()).padStart(2,'0');
	    return `${d.getFullYear()}-${mm}-${dd}`; // yyyy-MM-dd
	  };
	  const getMonthStr = (dateStr) => (dateStr?.substring(5,7) ? Number(dateStr.substring(5,7)) : "");
	  const getDayStr   = (dateStr) => (dateStr?.substring(8,10)? Number(dateStr.substring(8,10)) : "");

	  // 입력 전용 고정행
	  function newInputRow(){
	    return {
	      _isInput: true,
	
	      jrnNo: null,
	      lineNo: null,
	      jrnDate: todayStr(), // ✅ 오늘 날짜 자동 세팅
	      acctCode: "",
	      acctName: "",        // ✅ 새 컬럼
	      dcType: "",
	      amount: null,

	      remarks: "",
	      status: "",
	      createdAt: null,
	      createdBy: "",
	      cusCode: "",
	      cusName: "",         // ✅ 새 컬럼
	      closeNo: null
	    };
	  }

	  // 목록 로드
	  async function loadList(){
	    const { data } = await axios.get("/api/account/journal");
	    gvApi.setGridOption("rowData", Array.isArray(data) ? data : []);
	    gvApi.refreshClientSideRowModel('sort');
	  }

	  // 필수값 검증 (행 단위)
	  function isSavable(d){
	    return !!d && d.jrnDate && (d.dcType === 'D' || d.dcType === 'C') && d.acctCode && toNumber(d.amount) !== null;
	  }

	  // 저장 (입력행→INSERT / 본문행→UPDATE)
	  async function saveRow(data, isPinnedTop){
	    const payload = {
	     
	      jrnNo: data.jrnNo || null,
	      lineNo: data.lineNo || null,
	      jrnDate: data.jrnDate || null,
	      acctCode: data.acctCode || "",
	      dcType: (data.dcType || "").toUpperCase(),
	      amount: toNumber(data.amount),

	      remarks: data.remarks || "",
	      status: data.status || "",
	      createdAt: data.createdAt || null,
	      createdBy: data.createdBy || "",
	      cusCode: data.cusCode || "",
	      closeNo: data.closeNo ?? null,
	      // 참고: acctName, cusName은 서버에서 관리한다면 payload에서 제외 가능
	    };

	    if (!isSavable(payload)) return;

	    if (isPinnedTop) {
	      // INSERT
	      const { data: res } = await axios.post("/api/account/journal", payload);
	      await loadList();                                  // 서버 정렬 기준으로 재배치
	      gvApi.setGridOption("pinnedTopRowData", [ newInputRow() ]); // 입력행 리셋(오늘 날짜)
	    } else {
	      // UPDATE
	      if (data.jrnNo == null || data.lineNo == null) return;
	      await axios.put(`/api/account/journal/${data.jrnNo}/${data.lineNo}`, payload);
	      gvApi.refreshClientSideRowModel('sort');
	    }
	  }

	  document.addEventListener("DOMContentLoaded", async () => {
	    const columnDefs = [
	      { headerName: "월", valueGetter: p => getMonthStr(p.data?.jrnDate), editable: false, flex: .5 },
	      { headerName: "일", valueGetter: p => getDayStr(p.data?.jrnDate),   editable: false, flex: .5 },

	      // 전표번호: 숫자 PK를 보여주거나, 사람이 읽는 코드 보여줄거면 field: "jrnCode"로 변경
	      { headerName: "전표번호", field: "jrnNo", editable: false, flex: 1 },

	      { headerName: "구분", field: "dcType", flex: .9, editable: true,
	        cellEditor: "agSelectCellEditor",
	        cellEditorParams: { values: ["D","C"] },
	        cellRenderer: p => {
	          const v = (p.value || "").toUpperCase();
	          if (v === "D") return `<span class="badge-debit">차변</span>`;
	          if (v === "C") return `<span class="badge-credit">대변</span>`;
	          return v || "";
	        }
	      },

	      { headerName: "계정코드", field: "acctCode", editable: true, flex: 1.1 },
	      { headerName: "계정",     field: "acctName", editable: true, flex: 1.2 },  // ✅ 추가

	      // ✅ 거래처 코드/명 클릭 시 모달 열기
	      { headerName: "거래처코드", field: "cusCode", editable: true, flex: 1,
	        onCellClicked: () => {
	          const businessModal = bootstrap.Modal.getOrCreateInstance(document.getElementById("businessModal"));
	          businessModal.show();
	        }
	      },
	      { headerName: "거래처", field: "cusName", editable: true, flex: 1.2,
	        onCellClicked: () => {
	          const businessModal = bootstrap.Modal.getOrCreateInstance(document.getElementById("businessModal"));
	          businessModal.show();
	        }
	      },
	      { headerName: "적요", field: "remarks", editable: true, flex: 1.5 },

	      { headerName: "금액", field: "amount", flex: 1, editable: true,
	        valueParser: p => toNumber(p.newValue),
	        valueFormatter: p => p.value ? Number(p.value).toLocaleString() : ""
	      },



	      { headerName: "일자", field: "jrnDate", flex: 1.2, editable: true,
	        valueFormatter: p => p.value || ""
	      },

	      { headerName: "상태", field: "status", editable: true, flex: .8 }
	    ];

	    gvApi = agGrid.createGrid(document.querySelector("#generalVoucherGrid"), {
	      columnDefs,
	      rowData: [],
	      pagination: true,
	      paginationPageSize: 15,
	      defaultColDef: { resizable: true, filter: true },
	      // ✅ 핵심: 행 단위 편집 + 행 단위 저장
	      editType: 'fullRow',
	      singleClickEdit: true,
	      stopEditingWhenCellsLoseFocus: true,

	      // 기본 정렬
	      sortModel: [
	        { colId: "jrnDate", sort: "desc" },
	        { colId: "jrnNo",   sort: "desc" },
	        { colId: "lineNo",  sort: "asc"  }
	      ],

	      // ✅ 행 편집 종료 시(다른 행 클릭, 엔터 등) 저장
	      onRowValueChanged: (ev) => {
	        const isPinnedTop = ev.node.rowPinned === 'top';
	        saveRow(ev.data, isPinnedTop).catch(err => {
	          console.error(err);
	          alert("저장 실패: 입력값을 확인하세요.");
	        });
	      },

	      // 최초 준비
	      onGridReady: async () => {
	        // 입력 고정행 1줄(오늘 날짜) + 본문 데이터 로드
	        gvApi.setGridOption("pinnedTopRowData", [ newInputRow() ]);
	        await loadList();
	      }
	    });

	    // 조회 버튼(필요 시 기간 파라미터 붙여 확장)
	    document.getElementById("btnSearch").addEventListener("click", async () => {
	      await loadList();
	    });
	  });
	</script>
<script th:inline="none">
let businessGridApi = null;

async function loadBusinessData() {
  try {
    const res = await axios.get("/api/v1/stock/cusList");
    if (businessGridApi) {
      businessGridApi.setRowData(res.data);
      businessGridApi.sizeColumnsToFit();
    }
  } catch (err) {
    console.error("cusList 로드 실패:", err);
  }
}

function initBusinessGrid() {
  const gridDiv = document.querySelector("#businessModal #myGrid") || document.querySelector("#myGrid");
  if (!gridDiv) {
    console.error("거래처 그리드 컨테이너(#myGrid)를 찾을 수 없습니다.");
    return;
  }

  const columnDefs = [
    { headerName: "거래처코드", field: "cusCode" },
    { headerName: "거래처명", field: "cusName" },
    { headerName: "담당자명", field: "empName" },
    { headerName: "사업자번호", field: "bizNo" },
    { headerName: "대표명", field: "ceoName" },
    { headerName: "업태", field: "bizType" },
    { headerName: "종목", field: "bizCategory" },
    { headerName: "거래처주소", field: "addr" }
  ];

  const gridOptions = {
    columnDefs,
    rowSelection: "single",
    pagination: true,
    rowData: [],
    defaultColDef: { resizable: true, sortable: true, minWidth: 100 },
    onGridReady: (e) => {
      businessGridApi = e.api;
      businessGridApi.sizeColumnsToFit();
      loadBusinessData();
    },
    onRowDoubleClicked: (e) => {
      // 값 반영
      document.getElementById("cusCodeInput").value = e.data.cusCode ?? "";
      document.getElementById("cusNameInput").value = e.data.cusName ?? "";
    }
  };

  new agGrid.Grid(gridDiv, gridOptions);
}

// DOM 렌더링시 
document.addEventListener("DOMContentLoaded", () => {
  const invoiceModalEl = document.getElementById("invoiceModal");
  const businessModalEl = document.getElementById("businessModal");

  
  if (!invoiceModalEl || !businessModalEl) {
    console.error("invoiceModal 또는 businessModal 요소가 없습니다.");
    return;
  }

  const invoiceModal = bootstrap.Modal.getOrCreateInstance(invoiceModalEl);
  const businessModal = bootstrap.Modal.getOrCreateInstance(businessModalEl);

  
  // 버튼 클릭 → 전표모달 닫고 → 닫힌 후 거래처 모달 열기 (연쇄)
  document.getElementById("openBusinessModalBtn").addEventListener("click", () => {
    const openBusinessAfterHide = () => {
      // 한 번만 실행하고 핸들러 제거
      invoiceModalEl.removeEventListener("hidden.bs.modal", openBusinessAfterHide);

      // 거래처 모달 열기
      businessModal.show();
    };

    // 전표 모달이 완전히 닫힌 뒤 실행
    invoiceModalEl.addEventListener("hidden.bs.modal", openBusinessAfterHide);
    invoiceModal.hide(); // 먼저 닫는다
  });

  // 거래처 모달이 보여질 때 그리드 준비/리사이즈/로딩
  businessModalEl.addEventListener("shown.bs.modal", () => {
    if (!businessGridApi) initBusinessGrid();
    else {
      businessGridApi.sizeColumnsToFit();
      loadBusinessData();
    }
  });
});
</script>

	</th:block>
</body>
</html>
