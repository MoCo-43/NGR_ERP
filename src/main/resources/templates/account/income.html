<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layout/base}">
<head>
<title layout:fragment="title">월별 손익계산서 (전월 비교)</title>
<th:block layout:fragment="head_extra">

  <!-- AG Grid -->
  <link rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/styles/ag-grid.css" />
  <link rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/styles/ag-theme-quartz.css" />

  <style>
h2 { margin: 0 0 .75rem; }
.btn-bar { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem; }
.btn-outline { background: #fff; color: #111827; }

.note { color: #9ca3af; font-size: .85rem; }
#profitGrid.ag-theme-quartz { height: 38rem; width: 100%; }

.row-header { background: #e5e7eb !important; font-weight: 800; }
.row-subtotal { background: #f8fafc !important; font-weight: 700; }
.row-total { background: #374151 !important; color: #fff; font-weight: 800; border-top: 2px solid #111827; }

.indent-0 { padding-left: 0; }
.indent-1 { padding-left: 16px; }
.indent-2 { padding-left: 32px; }

.code-badge {
  font-variant-numeric: tabular-nums;
  background: #eef2ff; color: #3730a3;
  padding: .05rem .35rem; border-radius: 6px; margin-left: .4rem; font-size: .72rem;
}
  </style>
</th:block>
</head>
<body>
<section layout:fragment="content">

  <!-- jsPDF & AutoTable -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

  <div class="card shadow mb-3">
    <div class="card-header py-3 d-flex align-items-center justify-content-between">
      <h6 class="m-0 font-weight-bold text-primary">월별 손익계산서 (전월 비교)</h6>
    </div>

    <div class="card-body">
      <div class="btn-bar">
        <label class="form-label">기준</label>
        <input type="month" id="srchMonth" class="form-control form-control-sm" style="max-width: 180px">
        <button id="btnRecalc" class="btn btn-dark btn-sm">조회</button>
        <button id="btnCsv" class="btn btn-outline-success btn-sm">CSV</button>
        <button id="btnPdf" class="btn btn-outline-danger btn-sm" >PDF</button>
      </div>
		<div id="profitGridWrapper" style="position:relative;">
      <div id="profitGrid" class="ag-theme-quartz"></div>
      </div>
    </div>
  </div>
<input id="profit" type="text"><input id="curProfit" type="text"><input id="prvProfit" type="text">

</section>
<th:block layout:fragment="body_extra">
  <script src="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/dist/ag-grid-community.min.noStyle.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios@1.7.7/dist/axios.min.js"></script>

  <script th:inline="none">
  // ===== 한글 폰트 (NotoSansKR) Base64 로드/캐시 =====
  let __krFontBase64 = null;
  const KR_FONT_URL = '/fonts/NotoSansKR-Regular.ttf';

  async function fetchAsBase64(url) {
    const res = await fetch(url, { cache: 'force-cache' });
    const buf = await res.arrayBuffer();
    let binary = '';
    const bytes = new Uint8Array(buf);
    for (let i = 0; i < bytes.byteLength; i++) binary += String.fromCharCode(bytes[i]);
    return btoa(binary);
  }

  async function ensureKoreanFont() {
    if (__krFontBase64) return __krFontBase64;
    __krFontBase64 = await fetchAsBase64(KR_FONT_URL);
    return __krFontBase64;
  }

  // ===== 유틸 =====
  const fmt = n => (n ?? n===0) ? n.toLocaleString() : "";
  const sum = arr => arr.reduce((a,b)=>a+b,0);
  const prevMonth = ym => {
    const [y,m] = ym.split('-').map(Number);
    const d = new Date(y, m - 2, 1);
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
  };

  // ===== 손익계산서 계층 구조 구축 =====
  function buildRows(cur, prev) {
    function makeRow(label, curVal, prevVal, code, level=0, rowType='') {
      return { code, label, amountCur:curVal||0, amountPrev:prevVal||0,
               diffAmt:(curVal||0)-(prevVal||0), level, rowType };
    }

    const rows = [];
    const sumCur = v => sum(Object.values(v).map(x=>x.cur||0));
    const sumPrev = v => sum(Object.values(v).map(x=>x.prev||0));

    const salesCur = sumCur(cur.sales);
    const salesPrev = sumPrev(prev.sales);
    const cogsCur = sumCur(cur.cogs);
    const cogsPrev = sumPrev(prev.cogs);
    const sgaCur = sumCur(cur.sga);
    const sgaPrev = sumPrev(prev.sga);

    const gpCur = salesCur - cogsCur;
    const gpPrev = salesPrev - cogsPrev;
    const opCur = gpCur - sgaCur;
    const opPrev = gpPrev - sgaPrev;

    const noiCur = sumCur(cur.nonOpIncome);
    const noiPrev = sumPrev(prev.nonOpIncome);
    const noeCur = sumCur(cur.nonOpExpense);
    const noePrev = sumPrev(prev.nonOpExpense);
    const ordCur = opCur + noiCur - noeCur;
    const ordPrev = opPrev + noiPrev - noePrev;
    const netCur = ordCur - (cur.tax.corporate.cur||0);
    const netPrev = ordPrev - (prev.tax.corporate.prev||0);

    rows.push({rowType:'header', label:'영업 수익', level:0});
    rows.push(makeRow('Ⅰ. 매출액', salesCur, salesPrev, '01', 0, 'subtotal'));
    Object.entries(cur.sales).forEach(([k,v])=>{
      const p = prev.sales[k] || {prev:0};
      rows.push(makeRow(v.label, v.cur, p.prev, v.code, 1));
    });

    rows.push({rowType:'header', label:'영업 비용', level:0});
    rows.push(makeRow('Ⅱ. 매출원가', cogsCur, cogsPrev, '09', 0, 'subtotal'));
    Object.entries(cur.cogs).forEach(([k,v])=>{
      const p = prev.cogs[k] || {prev:0};
      rows.push(makeRow(v.label, v.cur, p.prev, v.code, 1));
    });

    rows.push(makeRow('Ⅲ. 판매비와관리비', sgaCur, sgaPrev, '20', 0, 'subtotal'));
    Object.entries(cur.sga).forEach(([k,v])=>{
      const p = prev.sga[k] || {prev:0};
      rows.push(makeRow(v.label, v.cur, p.prev, v.code, 1));
    });

    rows.push(makeRow('Ⅳ. 영업이익 (Ⅰ-Ⅱ-Ⅲ)', opCur, opPrev, '30', 0, 'subtotal'));

    rows.push({rowType:'header', label:'영업 외', level:0});
    rows.push(makeRow('Ⅴ. 영업외수익', noiCur, noiPrev, '60', 0, 'subtotal'));
    Object.entries(cur.nonOpIncome).forEach(([k,v])=>{
      const p = prev.nonOpIncome[k] || {prev:0};
      rows.push(makeRow(v.label, v.cur, p.prev, v.code, 1));
    });

    rows.push(makeRow('Ⅵ. 영업외비용', noeCur, noePrev, '80', 0, 'subtotal'));
    Object.entries(cur.nonOpExpense).forEach(([k,v])=>{
      const p = prev.nonOpExpense[k] || {prev:0};
      rows.push(makeRow(v.label, v.cur, p.prev, v.code, 1));
    });

    rows.push(makeRow('Ⅶ. 법인세차감전순이익', ordCur, ordPrev, '95', 0, 'subtotal'));
    rows.push(makeRow(cur.tax.corporate.label, cur.tax.corporate.cur, prev.tax.corporate.prev, cur.tax.corporate.code, 1));
    rows.push(makeRow('Ⅷ. 당기순손익', netCur, netPrev, '99', 0, 'total'));
	document.querySelector("#prvProfit").value = netPrev;
	document.querySelector("#curProfit").value = netCur;
	document.querySelector("#profit").value = "당기순손익";
    return rows;
  }

  // ===== AG-Grid 초기화 =====
  let gridApi;
  document.addEventListener('DOMContentLoaded', ()=>{
	  const now = new Date();
	  const ym = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
	  document.getElementById('srchMonth').value = ym;

    const columnDefs=[
      { headerName:'계정과목', field:'label', flex:2,
        cellRenderer:p=>{
          const code=p.data?.code?`<span class="code-badge">${p.data.code}</span>`:"";
          return `<span class="indent-${p.data.level||0}">${p.value}</span>${code}`;
        }},
      { headerName:'당월 금액', field:'amountCur', flex:1, valueFormatter:p=>fmt(p.value), cellStyle:{textAlign:'right'} },
      { headerName:'전월 금액', field:'amountPrev', flex:1, valueFormatter:p=>fmt(p.value), cellStyle:{textAlign:'right'} },
      { headerName:'증감액', field:'diffAmt', flex:1, valueFormatter:p=>fmt(p.value), cellStyle:{textAlign:'right', color:'#2563eb'} }
    ];

    const gridOptions={
      columnDefs,
      rowData:[],
      getRowClass:p=>{
        if(p.data?.rowType==="header")return"row-header";
        if(p.data?.rowType==="subtotal")return"row-subtotal";
        if(p.data?.rowType==="total")return"row-total";
      },
      defaultColDef:{resizable:true}
    };

    gridApi=agGrid.createGrid(document.getElementById('profitGrid'),gridOptions);

    // ===== 조회 버튼 이벤트 =====
    document.getElementById('btnRecalc').addEventListener('click', async ()=>{
      const ym = document.getElementById('srchMonth').value;
      const prevYm = prevMonth(ym);
      showLoader("profitGridWrapper", "데이터를 불러오는 중입니다...");
      try {
        const { data } = await axios.get('/api/account/profit-statement', {
          params: { curYm: ym.replace('-', ''), prevYm: prevYm.replace('-', '') }
        });

        const cur = { sales:{}, cogs:{}, sga:{}, nonOpIncome:{}, nonOpExpense:{}, tax:{corporate:{cur:0,prev:0,label:'법인세 등',code:'90'}} };
        const prev = JSON.parse(JSON.stringify(cur));

        data.forEach(row => {
          const g = row.acctGroup;
          const code = row.acctCode;
          const name = row.acctName;
          const curAmt = row.currAmt ?? 0;
          const prevAmt = row.prevAmt ?? 0;

          if (g==='4'){ cur.sales[code]={code,label:name,cur:curAmt}; prev.sales[code]={code,label:name,prev:prevAmt}; }
          else if (g==='5'){ cur.cogs[code]={code,label:name,cur:curAmt}; prev.cogs[code]={code,label:name,prev:prevAmt}; }
          else if (g==='8'){ cur.sga[code]={code,label:name,cur:curAmt}; prev.sga[code]={code,label:name,prev:prevAmt}; }
          else if (g==='6'){ cur.nonOpIncome[code]={code,label:name,cur:curAmt}; prev.nonOpIncome[code]={code,label:name,prev:prevAmt}; }
          else if (g==='7'){ cur.nonOpExpense[code]={code,label:name,cur:curAmt}; prev.nonOpExpense[code]={code,label:name,prev:prevAmt}; }
          else if (g==='9'){ cur.tax.corporate.cur+=curAmt; prev.tax.corporate.prev+=prevAmt; }
        });

        gridApi.setGridOption('rowData', buildRows(cur, prev));
      } catch (err) {
        console.error(err);
        alert('손익계산서 데이터 조회 실패');
      }
      hideLoader("profitGridWrapper")
    });

    // CSV Export
    document.getElementById('btnCsv').addEventListener('click',()=>{
      gridApi.exportDataAsCsv({fileName:`월별_손익계산서_${Date.now()}.csv`});
    });

    // PDF Export
    document.getElementById('btnPdf').addEventListener('click', async ()=>{
      const jsPDFCtor = (window.jspdf && window.jspdf.jsPDF) || window.jsPDF;
      if (!jsPDFCtor) return alert('jsPDF가 로드되지 않았습니다.');
      if (!('autoTable' in (jsPDFCtor.API || {}))) return alert('jspdf-autotable이 로드되지 않았습니다.');

      const ym = document.getElementById('srchMonth').value || '2025-10';
      const rows = gridApi.getModel().rowsToDisplay.map(n=>n.data);
      const tableBody = rows.map(r => [
        `${'　'.repeat(r.level || 0)}${r.label}`,
        fmt(r.amountCur), fmt(r.amountPrev), fmt(r.diffAmt)
      ]);

      const doc = new jsPDFCtor({ orientation: 'portrait', unit: 'pt', format: 'a4' });
      const base64 = await ensureKoreanFont();
      doc.addFileToVFS('NotoSansKR-Regular.ttf', base64);
      doc.addFont('NotoSansKR-Regular.ttf', 'NotoSansKR', 'normal');
      doc.setFont('NotoSansKR');
      doc.setFontSize(14);
      doc.text(`월별 손익계산서 ${ym} (전월 비교)`, 40, 40);
      doc.autoTable({
        startY: 60,
        head: [['계정과목','당월 금액','전월 금액','증감액']],
        body: tableBody,
        styles: { font:'NotoSansKR', fontSize:9, cellPadding:4 },
        headStyles: { fillColor:[55,65,81], textColor:255 },
        columnStyles:{ 0:{cellWidth:250}, 1:{halign:'right'}, 2:{halign:'right'}, 3:{halign:'right'} }
      });
      doc.save(`월별_손익계산서_${ym.replace('-','')}.pdf`);
    });
    
    // ✅ 페이지 로드시 자동 조회 실행
    document.getElementById('btnRecalc').click();
  });
  </script>
</th:block>
</body>
</html>
