<div th:fragment="orderModal">
	<div class="modal fade" id="orderModal" tabindex="-1"
		aria-hidden="true">
		<div class="modal-dialog modal-lg">
			<div class="modal-content">

				<div class="modal-header">
					<h5 class="modal-title">입고 조회</h5>
					<button type="button" class="btn btn-light btn-sm border-0"
						data-bs-dismiss="modal">
						<i class="fas fa-times"></i>
					</button>
				</div>

				<div class="modal-body">
					<!-- AG Grid -->
					<div id="orderGridWrapper" style="position:relative;">
					<div id="orderListGrid" class="ag-theme-quartz mb-2"
						style="height: 250px;"></div>
					<div id="orderDetailGrid" class="ag-theme-quartz"
						style="height: 200px;"></div>
				</div>

			</div>
		</div>
	
	</div>

	<style>
#orderListGrid.ag-theme-quartz {
	width: 100%;
	height: 260px; /* 목록 */
}

#orderDetailGrid.ag-theme-quartz {
	width: 100%;
	height: 220px; /* 상세 */
	margin-top: 8px;
}
</style>

	<script th:inline="none">
	
	
//====== orderModal ←→ invoiceModal 연결용 전역 ======
  let orderModal;        // bootstrap modal instance
  let orderGridApi;      // 목록(list) 그리드 API (id: #orderListGrid)
  let orderDetailApi;    // 상세(detail) 그리드 API (id: #orderDetailGrid)
  let selectedOrderCode; // 입고번호(inboundCode)

  // ====== 그리드 초기화 (모달 내부) ======
  function initOrderGrid() {
	
    const listDiv   = document.getElementById("orderListGrid");
    const detailDiv = document.getElementById("orderDetailGrid");
    if (!listDiv || !detailDiv) return;

    const listOptions = {
      columnDefs: [
    	  { headerName: "No.", valueGetter: "node.rowIndex + 1", width: 70 },
          { headerName: "입고일자", field: "inboundDate" },
          { headerName: "LOT번호", field: "lotCode" },
          { headerName: "공급처", field: "businessPartner" },
          { headerName: "납기예정일자", field: "dueDate" }
      ],
      rowSelection: "single",
      pagination: true,
      paginationPageSize: 10,
      onRowClicked: async (e) => {
        selectedOrderCode = e.data?.lotCode;
        if (selectedOrderCode) await loadOrderDetail(selectedOrderCode);
      },
      onRowDoubleClicked: async (e) => {
        selectedOrderCode = e.data?.lotCode;
        if (!selectedOrderCode) return;
        const res = await axios.get(`/api/v1/stock/inDetailList/${selectedOrderCode}`, { withCredentials: true });
        // ✅ invoiceModal로 반영
        console.log(res.data);
        applyOrderToInvoiceModal(e.data, res.data);
        document.getElementById('memoInput').value = e.data.businessPartner + " 매입";
        // 닫기
        bootstrap.Modal.getOrCreateInstance(document.getElementById("orderModal")).hide();
      },
      onGridReady: (e) => {
        orderGridApi = e.api;
        loadOrderData(); // 최초 로드
      },
      defaultColDef: { resizable: true, sortable: true, minWidth: 100 },
    };

    const detailOptions = {
      columnDefs: [
        { headerName: "제품코드", field: "productCode",   flex: 1 },
        { headerName: "제품명",   field: "productName",   flex: 1 },
        { headerName: "규격",     field: "specification", flex: 1 },
        { headerName: "입고수량", field: "qty",           flex: 1 },
      ],
      pagination: false,
      onGridReady: (e) => (orderDetailApi = e.api),
      defaultColDef: { resizable: true, sortable: true, minWidth: 100 },
    };

    new agGrid.Grid(listDiv, listOptions);
    new agGrid.Grid(detailDiv, detailOptions);
  }

  // 목록 재로딩(입고 헤더)
  async function loadOrderData() {
	  showLoader("orderGridWrapper", "입고 데이터를 불러오는 중입니다...");
    if (!orderGridApi) return;
    try {
      const res = await axios.get("/api/v1/stock/inboundList", { withCredentials: true });
      orderGridApi.setRowData(Array.isArray(res.data) ? res.data : []);
      orderGridApi.sizeColumnsToFit();
    } catch (err) {
      console.error("입고 목록 로드 실패", err);
    } finally {
      hideLoader("orderGridWrapper");
    }
  }

  // 상세 로딩(입고 상세)
  async function loadOrderDetail(orderCode) {
    if (!orderDetailApi) return;
    try {
      const res = await axios.get(`/api/v1/stock/inDetailList/${orderCode}`, { withCredentials: true });
      orderDetailApi.setRowData(Array.isArray(res.data) ? res.data : []);
    } catch (err) {
      console.error("입고 상세 로드 실패", err);
    }
  }

  // invoiceModal에 적용 (이름/ID/변수 모두 order 그대로 유지)
  async function applyOrderToInvoiceModal(header, detailList) {
    try {
      // 입고시 로그인 회사 은행, 계좌 불러오기
     console.log(compCode.value);
     const { data } = await axios.get(`/api/account/invoice/tax/${compCode.value}`);
      // 헤더 반영
      document.getElementById("orderCode").value   = header?.inboundCode ?? "";
      document.getElementById("invoiceDate").value = header?.inboundDate ?? "";
      document.getElementById("cusCodeInput").value = header?.businessCode ?? "";
      document.getElementById("cusNameInput").value = header?.businessPartner ?? "";
      document.getElementById("bankNameInput").value = data?.bank ?? "";
      document.getElementById("accountNoInput").value = data?.bizAccount ?? "";

      // 라인 반영
      if (window.invoiceGridApi && Array.isArray(detailList)) {
        const rows = detailList.map(d => ({
          productCode: d.productCode,
          productName: d.productName,
          qty:         d.qty,
          price: d.purchasePrice,
          supply: d.qty * d.purchasePrice,
          vat: d.qty * d.purchasePrice * 0.1,
        }));
        window.invoiceGridApi.setRowData(rows);
      }
    } catch (err) {
      console.error("invoiceModal 적용 중 오류", err);
    }
  }

 
  document.addEventListener("DOMContentLoaded", () => {
    const orderModalEl = document.getElementById("orderModal");
    if (!orderModalEl) return;

    orderModal = bootstrap.Modal.getOrCreateInstance(orderModalEl);

    orderModalEl.addEventListener("shown.bs.modal", () => {
      if (!orderGridApi) {
        initOrderGrid();  // 최초 초기화
      } else {
        orderGridApi.sizeColumnsToFit();
        loadOrderData();  // ✅ 다시 열릴 때마다 최신 데이터
      }
    });
  });
  </script>
</div>
