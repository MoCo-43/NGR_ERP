<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layout/base}">
<head>
<title layout:fragment="title">급여대장 리스트</title>

<th:block layout:fragment="head_extra">
  <link rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/styles/ag-grid.css" />
  <link rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/styles/ag-theme-quartz.css" />
  <style>
    .toolbar { padding: 1rem 1rem .25rem 1rem; }
    #payrollGrid.ag-theme-quartz { height: 32rem; width: 100%; }
    .status-wait { color: red; font-weight: bold; }
    .status-confirm { color: blue; font-weight: bold; }
  </style>
</th:block>
</head>

<body>
  <section layout:fragment="content">
    <div class="card shadow mb-3">
      <div class="card-header py-3 d-flex justify-content-between align-items-center">
        <h6 class="m-0 font-weight-bold text-primary">급여대장 리스트</h6>
        <button class="btn btn-primary btn-sm" id="btnRegister">등록</button>
      </div>

      <div class="toolbar btn-bar">
        <div class="row g-2 align-items-center">
          <div class="col-12 col-sm-4 col-xl-3">
            <input id="srchMonth" type="month" class="form-control" placeholder="귀속연월">
          </div>
          <div class="col-12 col-xl-auto">
            <div class="actions">
              <button class="btn btn-dark btn-sm" id="btnSearch">조회</button>
              <button class="btn btn-danger btn-sm" id="btnReset">초기화</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card-body pt-3">
      	<div id="payrollGridWrapper" style="position:relative;">
        <div id="payrollGrid" class="ag-theme-quartz"></div>
        </div>
      </div>
    </div>

    <th:block th:replace="~{hr/payrollModal :: payrollModal}"></th:block>
  </section>

  <th:block layout:fragment="body_extra">
    <script src="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/dist/ag-grid-community.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.7.7/dist/axios.min.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {    // 문서가 모두 로드되면 콜백 실행
      const API_BASE = '/api/v1/payrolls';                    // 급여대장 관련 백엔드 API 
      const gridDiv = document.getElementById('payrollGrid'); // ag-Grid를 붙일 DOM 요소
      const btnSearch = document.getElementById('btnSearch'); // 조회 버튼
      const btnReset = document.getElementById('btnReset');   // 초기화 버튼
      const btnRegister = document.getElementById('btnRegister'); // 등록 버튼
      const srchMonth = document.getElementById('srchMonth'); // 월 입력 요소

      let gridApi = null;             // ag-Grid API 참조를 보관할 변수
      let rowDataCache = [];          // 서버에서 받아온 급여대장 리스트 데이터를 캐시

      const formatDate = (v) => v ? String(v).slice(0,10) : ''; // 날짜 'YYYY-MM-DD' 형태

      // 그리드 컬럼 정의
      const columnDefs = [
        { headerName:'귀속연월', field:'yearMonth', width:120 }, // 연월
        { headerName:'대장 명칭', field:'title', flex:1, minWidth:220 }, // 제목
        { headerName:'부서', width:140, valueGetter:(p)=> p.data?.deptName ?? p.data?.dept_code ?? '' }, // 부서명
        { headerName:'지급일', field:'payDate', width:140, valueFormatter:(p)=>formatDate(p.value) },    // 지급일
        { headerName:'인원수', field:'empCount', width:100 }, // 인원수
        { headerName:'상태', field:'status', width:100,  // 확정/대기 상태 표시
          cellRenderer:(p)=> p.value==='CONFIRMED'
            ? '<span class="status-confirm">확정</span>'
            : '<span class="status-wait">대기</span>' },
        { headerName:'급여대장', width:100,  // '보기' 링크(모달 오픈)
          cellRenderer:(p)=> {
            const no = p.data?.payrollNo ?? p.data?.payroll_no;   // 급여대장 번호
            if (!no) return ''; // 번호 없으면 표시 안 함
            const a = document.createElement('a');  // a 태그 생성
            a.href = 'javascript:void(0)';  // 페이지 이동 방지
            a.textContent = '보기';  // 링크 텍스트
            a.addEventListener('click', (e)=>{    // 클릭 시
              e.preventDefault();
              window.PayrollDetail?.open?.(Number(no));  // 급여대장 상세 모달 열기
            });
            return a;   // 생성한 a 요소를 그리드 셀에 렌더
          } }
      ];

      // ag-Grid 옵션 생성
      const gridOptions = {
        columnDefs,                              //  컬럼
        rowData: [],                             // 초기 데이터는 비움
        pagination: true,                        // 페이지네이션 사용
        paginationPageSize: 10,                  // 페이지당 10건
        defaultColDef: { sortable:true, resizable:true, filter:false, suppressMenu:true }, // 기본 컬럼 옵션
        onGridReady: (params) => { gridApi = params.api; initLoad(); } // 그리드 준비되면 API 보관하고 초기 로드 실행
      };

      new agGrid.Grid(gridDiv, gridOptions);  // 실제 그리드를 DOM에 생성

      async function initLoad(){
        // 페이지 처음 로드 시: 이번달로 채우고 서버에서 데이터 조회
        const now = new Date();
        srchMonth.value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`; // YYYY-MM 형태
        await loadFromServer();                  // 서버에서 목록 조회
      }

      async function loadFromServer(){
    	  showLoader("payrollGridWrapper", "급여대장 데이터를 불러오는 중입니다..."); 
    	  try {
    	    const monthVal  = srchMonth.value;                                    // 입력된 월 값(YYYY-MM)
    	    const yearMonth = monthVal ? monthVal.replace('-','') : '';           // API용(YYYYMM)으로 변환
    	    const url = yearMonth
    	      ? `${API_BASE}?yearMonth=${encodeURIComponent(yearMonth)}`          // 연월이 있으면 쿼리로 전달
    	      : `${API_BASE}`;                                                    // 없으면 전체 조회
    	    const { data } = await axios.get(url);                                // 서버 호출
    	    rowDataCache = Array.isArray(data) ? data : (data?.data ?? []);       // 배열 형태로 정규화
    	    gridApi.setRowData(rowDataCache);                                     // 그리드에 데이터 바인딩
    	    gridApi.paginationGoToFirstPage();                                    // 페이지네이션 첫 페이지로 이동
    	  } catch (e) {
    	    console.error('급여대장 조회 실패', e);    // 에러 로그
    	    toastr.error('급여대장 조회 중 오류가 발생했습니다.');   // 사용자 알림
    	    gridApi.setRowData([]);   // 실패 시 빈 배열 표시
    	  } 
    	    hideLoader("payrollGridWrapper");  
    	}

      function doReset(){
        // 초기화: 월을 현재 월로 되돌리고 재조회
        const now = new Date();
        srchMonth.value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`; // 다시 이번달
        loadFromServer();   // 서버에서 재조회
      }

      btnSearch.addEventListener('click', loadFromServer); // [조회] 버튼 클릭 → 서버 재조회
      btnReset.addEventListener('click', doReset);         // [초기화] 버튼 클릭 → 이번달로 되돌리고 재조회

      btnRegister.addEventListener('click', async ()=>{    // [등록] 버튼 클릭 → 급여대장 생성 요청
        const monthVal = srchMonth.value;                  //월(YYYY-MM)
        if (!monthVal) {
        	 toastr.warning('귀속연월을 먼저 선택해주세요.');         // 월 미입력 시 안내
          return;
        }

        const yearMonth = monthVal.replace('-', '');       // YYYYMM
        const payDate = `${monthVal}-25`;                  // 기본 지급일을 매달 25일로 설정(요구사항에 따라 조정 가능)
        const payload = { yearMonth, payDate };            // 생성에 필요한 데이터

        try {
          await axios.post(API_BASE, payload);  // 급여대장 등록 API 호출(POST)
          toastr.success('급여대장이 등록되었습니다.');             // 성공 알림
          await loadFromServer();  // 등록 후 목록 재조회
        } catch (e) {
          console.error(e);// 에러 로그
          toastr.error('등록 중 오류가 발생했습니다.');  // 실패 알림
        }
      });
    });
    </script>
  </th:block>
</body>
</html>
