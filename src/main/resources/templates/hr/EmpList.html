<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/base}">
<head>
<title layout:fragment="title">사원 리스트</title>

<th:block layout:fragment="head_extra">
	<!-- AG Grid CSS -->
	<link rel="stylesheet"
		href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/styles/ag-grid.css" />
	<link rel="stylesheet"
		href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/styles/ag-theme-quartz.css" />

	<style>
#empGrid.ag-theme-quartz {
	height: 600px;
	width: 100%;
}

.form-label, label {
	color: #212529 !important;
}

.form-label {
	font-weight: 600;
}

@media ( min-width :576px) {
	.form-label {
		text-align: right;
	}
}

.ag-theme-quartz {
	--ag-row-height: 42px;
	--ag-font-size: 13px;
}

.ag-header-cell-label {
	white-space: nowrap;
}

/* 버튼 색상 커스텀 */
#btnSearch {
	background-color: #000;
	color: #fff;
	border: none;
}

#btnSearch:hover {
	background-color: #333;
}

#btnReset {
	background-color: #dc3545;
	color: #fff;
	border: none;
}

#btnReset:hover {
	background-color: #b02a37;
}

.gap-2 {
	gap: .5rem !important;
}
</style>
</th:block>
</head>

<body>
	<section layout:fragment="content">

		<!-- ******** 검색 영역 ******** -->
		<div class="card shadow mb-4">
			<div class="card-header py-3">
				<h6 class="m-0 font-weight-bold text-primary">사원 리스트</h6>
			</div>

			<div class="card-body">
				<div class="row g-2 align-items-center">
					<!-- 키워드 -->
					<div class="col-12 col-md-4">
						<input id="keyword" class="form-control" placeholder="사번/성명 검색">
					</div>
					<!-- 부서명 -->
					<div class="col-6 col-md-2">
						<input id="srchDept" class="form-control"
							placeholder="부서명 (예: 인사팀)">
					</div>
					<!-- 직급 -->
					<div class="col-6 col-md-2">
						<input id="srchPosition" class="form-control"
							placeholder="직급 (예: 과장)">
					</div>
					<!-- 직책 -->
					<div class="col-6 col-md-2">
						<input id="srchTitle" class="form-control"
							placeholder="직책 (예: 팀장)">
					</div>

					<!-- 검색/초기화 -->
					<div class="col-6 col-md-2 d-flex justify-content-md-end">
						<div class="d-flex gap-2 w-100 justify-content-end">
							<button id="btnSearch" class="btn w-50">검색</button>
							<button id="btnReset" class="btn w-50">초기화</button>
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- ******** 목록 ******** -->
		<div class="card shadow mb-0">
			<div class="card-header py-3">
				<h6 class="m-0 font-weight-bold text-primary">목록</h6>
			</div>
			<div class="card-body">
				<div id="empGrid" class="ag-theme-quartz"></div>

				<!-- 등록/수정 버튼 -->
				<div class="d-flex justify-content-end gap-2 mt-3">
					<button id="btnCreateOpen" class="btn btn-primary">등록</button>
					<button id="btnEditOpen" class="btn btn-success" disabled>수정</button>
				</div>
			</div>
		</div>

		<!-- 모달 include -->
		<div th:replace="~{hr/empModal :: empModal}"></div>
		<div th:replace="~{hr/eduForm :: eduFormModal}"></div>
		<div th:replace="~{hr/certForm :: certFormModal}"></div>
	</section>

	<th:block layout:fragment="body_extra">
		<script defer
			src="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/dist/ag-grid-community.min.js"></script>
		<script defer
			src="https://cdn.jsdelivr.net/npm/axios@1.7.7/dist/axios.min.js"></script>

		<script th:inline="none">
  document.addEventListener('DOMContentLoaded', async () => {
    const gridDiv = document.getElementById('empGrid');

    const btnSearch = document.getElementById('btnSearch');
    const btnReset  = document.getElementById('btnReset');
    const btnCreateOpen = document.getElementById('btnCreateOpen');
    const btnEditOpen   = document.getElementById('btnEditOpen');

    const keyword   = document.getElementById('keyword');
    const srchDept  = document.getElementById('srchDept');
    const srchPos   = document.getElementById('srchPosition');
    const srchTitle = document.getElementById('srchTitle');

    const empModalEl = document.getElementById('empModal');
    const empModal   = new bootstrap.Modal(empModalEl);

    let gridApi = null;
    let rowDataCache = []; // 서버에서 가져온 전체 데이터 캐시

    const columnDefs = [
      { headerName:'선택', width:70, checkboxSelection:true, pinned:'left' },
      { headerName:'사번', field:'emp_id', width:130 },
      { headerName:'성명', field:'name', width:140 },
      { headerName:'부서', field:'dept_name', width:160 },
      { headerName:'직급', field:'position', width:120 },
      { headerName:'직책', field:'title', width:160 },
      { headerName:'전화번호', field:'phone', width:160 },
      { headerName:'이메일', field:'email', flex:1, minWidth:220 },
      { headerName:'주소', field:'address', flex:1, minWidth:220 },
      { headerName:'입사일자', field:'joinDate', width:140,
        valueFormatter:(p)=>formatDate(p.value) }
    ];

    const gridOptions = {
      columnDefs,
      rowData: [],
      rowSelection: 'single',
      pagination: true,
      paginationPageSize: 10,
      animateRows: true,
      defaultColDef: { sortable:true, resizable:true, filter:true },
      onGridReady: (params) => { gridApi = params.api; }
    };

    new agGrid.Grid(gridDiv, gridOptions);
    gridApi = gridOptions.api;

    // === 서버에서 전체 데이터 한번만 가져오기 ===
    try {
      const { data } = await axios.get('/api/v1/emps');
      rowDataCache = Array.isArray(data) ? data : (data?.data ?? []);
      gridApi.setRowData(rowDataCache);
    } catch(err){
      console.error(err);
      alert('사원 목록 조회 실패');
    }

    // === 프론트 필터링 ===
    function applyFrontFilter(){
      const kw   = keyword.value.trim().toLowerCase();
      const dept = srchDept.value.trim().toLowerCase();
      const pos  = srchPos.value.trim().toLowerCase();
      const tit  = srchTitle.value.trim().toLowerCase();

      const filtered = rowDataCache.filter(r=>{
        const matchKw   = !kw   || (r.emp_id?.toLowerCase().includes(kw) || r.name?.toLowerCase().includes(kw));
        const matchDept = !dept || (r.dept_name?.toLowerCase().includes(dept));
        const matchPos  = !pos  || (r.position?.toLowerCase().includes(pos));
        const matchTit  = !tit  || (r.title?.toLowerCase().includes(tit));
        return matchKw && matchDept && matchPos && matchTit;
      });
      gridApi.setRowData(filtered);
    }

    btnSearch.addEventListener('click', applyFrontFilter);
    btnReset.addEventListener('click', ()=>{
      keyword.value=''; srchDept.value=''; srchPos.value=''; srchTitle.value='';
      gridApi.setRowData(rowDataCache);
    });

    // Enter로도 필터링 가능
    [keyword,srchDept,srchPos,srchTitle].forEach(el=>{
      el.addEventListener('keydown', e=>{
        if(e.key==='Enter'){ e.preventDefault(); applyFrontFilter(); }
      });
    });

    // === 기타 ===
    function formatDate(v){ return v ? String(v).slice(0,10) : ''; }

    btnCreateOpen.addEventListener('click', ()=>empModal.show());
    btnEditOpen.addEventListener('click', ()=>{
      const sel = gridApi.getSelectedRows();
      if(!sel.length){ alert('수정할 사원을 선택하세요.'); return; }
      empModal.show();
    });
  });
  </script>
	</th:block>
</body>
</html>
