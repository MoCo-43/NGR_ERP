<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/base}">
<head>
<title layout:fragment="title">사원 리스트</title>

<th:block layout:fragment="head_extra">
	<link rel="stylesheet"
		href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/styles/ag-grid.css" />
	<link rel="stylesheet"
		href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/styles/ag-theme-quartz.css" />
	<style>
.toolbar {
	padding: 1rem 1rem .25rem 1rem;
}

#empGrid.ag-theme-quartz {
	height: 32rem;
	width: 100%;
}

/* ▼ 인풋/셀렉트 스타일 통일 */
.toolbar .form-control, .toolbar .form-select {
	height: 38px;
	font-size: 0.95rem;
	line-height: 1.4;
}
	</style>

</th:block>
</head>

<body>
	<section layout:fragment="content">
		<div class="card shadow mb-3">
			<div class="card-header py-3">
				<h6 class="m-0 font-weight-bold text-primary">사원 목록</h6>
			</div>
			<div class="toolbar">
				<div class="row g-2 align-items-center flex-xl-nowrap">
					<div class="col-12 col-sm-4 col-xl-2">
						<input id="keyword" class="form-control" placeholder="사번/성명 검색">
					</div>
					<div class="col-12 col-sm-4 col-xl-2">
						<input id="srchDept" class="form-control" placeholder="부서명">
					</div>
					<div class="col-12 col-sm-4 col-xl-2">
						<input id="srchPosition" class="form-control" placeholder="직급">
					</div>
					<div class="col-12 col-sm-4 col-xl-2">
						<input id="srchTitle" class="form-control" placeholder="직책">
					</div>
					<div class="col-12 col-sm-4 col-xl-2">
						<select id="srchStatus" class="form-control">							
							<option value="EMPLOYED">재직자</option>
							<option value="RESIGNED">퇴사자</option>
							<option value="ALL" selected>재직상태(전체)</option>
						</select>
					</div>
					<div class="col-12 col-xl-auto">
						<div>
							<button class="btn btn-dark btn-sm" id="btnSearch">조회</button>
							<button id="btnReset" class="btn btn-danger btn-sm">초기화</button>
						</div>
					</div>
				</div>
			</div>

			<div class="card-body pt-3">
				<div id="empGridWrapper" style="position:relative;">
				<div id="empGrid" class="ag-theme-quartz"></div>
			</div>
			</div>

			<div class="d-flex justify-content-end gap-2 my-2 mr-3">
				<button id="btnCreateOpen" class="btn btn-primary mr-3">등록</button>
				<button id="btnEditOpen" class="btn btn-success" disabled>수정</button>
			</div>

			<!-- 프래그먼트-->
			<div th:replace="~{hr/empModal :: empModal}"></div>
			<div th:replace="~{hr/eduForm  :: eduFormModal}"></div>
			<div th:replace="~{hr/certForm :: certFormModal}"></div>
		</div>
	</section>

	<th:block layout:fragment="body_extra">
		<script defer
			src="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/dist/ag-grid-community.min.js"></script>
		<script defer
			src="https://cdn.jsdelivr.net/npm/axios@1.7.7/dist/axios.min.js"></script>
		<script>
      document.addEventListener('DOMContentLoaded', () => {
        const $ = (id)=>document.getElementById(id);

        // 컬럼 정의 
        const columnDefs = [
          { headerName:'선택', width:70, checkboxSelection:true, headerCheckboxSelection:false, filter:false, suppressMenu:true, pinned:'left' },
          { headerName:'사번', field:'emp_id', width:130 },
          { headerName:'성명', field:'name', width:140 },
          { headerName:'부서', field:'dept_name', width:160 },
          { headerName:'직급', field:'position', width:120 },
          { headerName:'직책', field:'title', width:160 },
          { headerName:'전화번호', field:'phone', width:160 },
          { headerName:'이메일', field:'email', flex:1, minWidth:220 },
          { headerName:'주소', field:'address', flex:1, minWidth:220 },
          { headerName:'입사일자', field:'joinDate', width:140, valueFormatter:(p)=>p.value?String(p.value).slice(0,10):'' }
        ];

        let gridApi=null, rowDataCache=[];
        const gridOptions={
          columnDefs, rowData:[], rowSelection:'single', pagination:true, paginationPageSize:10,
          defaultColDef:{ sortable:true, resizable:true, filter:false, suppressMenu:true },
          onGridReady:(p)=>{ gridApi=p.api;  $('srchStatus').value = 'EMPLOYED';  initLoad(); },
          onSelectionChanged:()=>{ const sel=gridApi?.getSelectedRows?.()||[]; $('btnEditOpen').disabled = sel.length===0; },
          onRowDoubleClicked:(e)=>openEdit(e.data)
        };

        // 그리드 생성
        const gridDiv=$('empGrid');
        if (window.agGrid?.createGrid) gridApi=window.agGrid.createGrid(gridDiv, gridOptions);
        else { new agGrid.Grid(gridDiv, gridOptions); gridApi=gridOptions.api; }

        // API 초기 로드 
        async function initLoad(){
        	showLoader("empGridWrapper", "사원 데이터를 불러오는 중입니다...");
          try{
            const {data}=await axios.get('/api/v1/emps');
            rowDataCache = Array.isArray(data) ? data : (data?.data ?? []);
            applyFrontFilter();  
          }catch(e){
        	  console.error(e);
        	  toastr.error('사원 목록 조회 중 오류가 발생했습니다.');
        	  setRows([]);
          }
            hideLoader("empGridWrapper");
          gridApi?.deselectAll?.(); $('btnEditOpen').disabled=true;
        }
        function setRows(rows){
          if (!gridApi) return;
          if (gridApi.setGridOption) gridApi.setGridOption('rowData', rows);
          else gridApi.setRowData?.(rows);
        }

        // ▼ 퇴사 여부
        function isResigned(row){
          return !!(row && row.leaveDate);
        }

        // 조회,초기화
        function applyFrontFilter(){
          const kw=($('keyword').value||'').trim().toLowerCase();
          const dept=($('srchDept').value||'').trim().toLowerCase();
          const pos=($('srchPosition').value||'').trim().toLowerCase();
          const tit=($('srchTitle').value||'').trim().toLowerCase();
          const status=($('srchStatus')?.value)||'EMPLOYED';

          const filtered=rowDataCache.filter(r=>{
            const mKw=!kw||(String(r.emp_id||'').toLowerCase().includes(kw)||String(r.name||'').toLowerCase().includes(kw));
            const mDept=!dept||String(r.dept_name||'').toLowerCase().includes(dept);
            const mPos=!pos||String(r.position||'').toLowerCase().includes(pos);
            const mTit=!tit||String(r.title||'').toLowerCase().includes(tit);

            let mStatus=true;
            if (status==='RESIGNED')   mStatus = isResigned(r);
            else if (status==='EMPLOYED') mStatus = !isResigned(r);

            return mKw&&mDept&&mPos&&mTit&&mStatus;
          });
          setRows(filtered); gridApi?.paginationGoToFirstPage?.();
        }
        function doReset(){
          ['keyword','srchDept','srchPosition','srchTitle'].forEach(id=>{$(id).value='';});
          if ($('srchStatus')) $('srchStatus').value='EMPLOYED';
          applyFrontFilter();   
          setRows(rowDataCache); gridApi?.paginationGoToFirstPage?.(); gridApi?.deselectAll?.(); $('btnEditOpen').disabled=true;
        }
        $('btnSearch').addEventListener('click', applyFrontFilter);
        $('btnReset').addEventListener('click', doReset);
        ['keyword','srchDept','srchPosition','srchTitle'].forEach(id=>{
          $(id).addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); applyFrontFilter(); } });
        });
        $('srchStatus')?.addEventListener('change', applyFrontFilter);

        // 모달 열기
        function openCreate(){ window.EmpModal?.openCreate?.(); }
        async function openEdit(row){
          const r=row || (gridApi?.getSelectedRows?.()[0]);
          if (!r){
        		  toastr.warning('수정할 사원을 선택하세요.');
        		  return;
        		}
          await window.EmpModal?.openEdit?.(r);
        }
        $('btnCreateOpen').addEventListener('click', openCreate);
        $('btnEditOpen').addEventListener('click', ()=>openEdit());

        // 저장 후 재조회 
        document.addEventListener('emp:saved', ()=>{ initLoad(); });
      });
    </script>
	</th:block>
</body>
</html>
