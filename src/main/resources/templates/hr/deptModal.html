<th:block th:fragment="deptManagerLookupModal">
  <div class="modal fade" id="deptManagerLookupModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">

        <div class="modal-header">
          <h5 class="modal-title">부서장(팀장) 선택</h5>
          <button type="button" class="btn btn-light btn-sm border-0" data-bs-dismiss="modal" aria-label="닫기">
            <i class="fas fa-times"></i>
          </button>
        </div>

        <div class="modal-body p-2">
          <div id="deptManagerGrid" class="ag-theme-quartz" style="height:400px;width:100%;"></div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
        </div>

      </div>
    </div>
  </div>

  <script>
    //  네임스페이스 고정 
    window.DeptManagerLookup = (function () {
      let bsModal = null;
      let gridApi = null;

      const API = '/api/v1/emps/managers';
      const MODAL_ID = 'deptManagerLookupModal';
      const GRID_ID  = 'deptManagerGrid';

      // 외부에서 호출
      async function open({ targetId = 'manager_emp_id' } = {}) {
        const modalEl = document.getElementById(MODAL_ID);
        if (!bsModal) bsModal = new bootstrap.Modal(modalEl);
        bsModal.show();
        await refresh(targetId);
      }

      // 데이터 로드
      async function refresh(targetId) {
        let rows = [];
        try {
          const res = await fetch(API);
          rows = res.ok ? await res.json() : [];
        } catch (e) {
          console.error('manager list error:', e);
        }
        initGrid(rows, targetId);
      }

      // 그리드 초기화
      function initGrid(rows, targetId) {
        const gridDiv = document.getElementById(GRID_ID);
        const columnDefs = [
          { headerName:'사번', field:'emp_id',   width:140 },
          { headerName:'이름', field:'name',     flex:1, minWidth:120 },
          { headerName:'부서', field:'dept_name',flex:1, minWidth:140 },
          { headerName:'직책', field:'title',    width:100 }
        ];

        const gridOptions = {
          columnDefs,
          rowData: rows,
          pagination: true,
          paginationPageSize: 10,
          defaultColDef: { resizable:true, sortable:true },
          onRowDoubleClicked: (p) => pick(p.data, targetId)
        };

        // 기존 인스턴스 정리
        if (gridApi && typeof gridApi.destroy === 'function') {
          gridApi.destroy();
          gridApi = null;
        }

        // ag grid 적용
        if (window.agGrid?.createGrid) {
          gridApi = window.agGrid.createGrid(gridDiv, gridOptions);
        } else {
          new agGrid.Grid(gridDiv, gridOptions);
          gridApi = gridOptions.api;
        }
      }

      // 더블클릭 선택
      function pick(row, targetId) {
        if (!row) return;
        const t = document.getElementById(targetId);
        if (t) {
          t.value = row.emp_id;
          t.dispatchEvent(new Event('change'));
        }
        if (bsModal) bsModal.hide();
      }

      return { open };
    })();
  </script>
</th:block>
