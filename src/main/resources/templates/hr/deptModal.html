<th:block th:fragment="deptManagerLookupModal">
	<div class="modal fade" id="deptManagerLookupModal" tabindex="-1"
		aria-hidden="true">
		<div class="modal-dialog modal-lg modal-dialog-scrollable">
			<div class="modal-content">

				<div class="modal-header">
					<h5 class="modal-title">부서장(팀장) 선택</h5>
					<button type="button" class="btn btn-light btn-sm border-0"
						data-bs-dismiss="modal" aria-label="닫기">
						<i class="fas fa-times"></i>
					</button>
				</div>

				<div class="modal-body p-2">
					<div id="deptManagerGrid" class="ag-theme-quartz"
						style="height: 400px; width: 100%;"></div>
				</div>

				<div class="modal-footer">
					<button type="button" class="btn btn-secondary"
						data-bs-dismiss="modal">닫기</button>
				</div>

			</div>
		</div>
	</div>

	<script>
    window.DeptManagerLookup = (function () {
      // 모달,그리드 인스턴스 저장할 변수
      let bsModal = null;
      let gridApi = null;

      // 고정값: API 경로, 요소 id
      const API = '/api/v1/emps/managers';
      const MODAL_ID = 'deptManagerLookupModal';
      const GRID_ID  = 'deptManagerGrid';

      // 외부에서 호출하는 함수
      async function open({ targetId = 'manager_emp_id' } = {}) {
        // 모달 인스턴스 생성(최초 1회만)
        const modalEl = document.getElementById(MODAL_ID);
        if (!bsModal) bsModal = new bootstrap.Modal(modalEl);

        // 모달 보여주기
        bsModal.show();

        // 그리드 데이터 로드 후 그리드 초기화
        await refresh(targetId);
      }

      // 서버에서 데이터 불러오기
      async function refresh(targetId) {
        let rows = [];
        try {
          const res = await fetch(API);
          rows = res.ok ? await res.json() : [];
        } catch (_) {
          rows = [];
        }
        initGrid(rows, targetId);
      }

      // ag-Grid 생성
      function initGrid(rows, targetId) {
        const gridDiv = document.getElementById(GRID_ID);

        // 컬럼 설정: 보여줄 필드들만 간단히 지정
        const columnDefs = [
          { headerName:'사번', field:'emp_id',    width:140 },
          { headerName:'이름', field:'name',      flex:1, minWidth:120 },
          { headerName:'부서', field:'dept_name', flex:1, minWidth:140 },
          { headerName:'직책', field:'title',     width:100 }
        ];

        // 그리드 옵션
        const gridOptions = {
          columnDefs,
          rowData: rows,
          pagination: true,
          paginationPageSize: 10,
          defaultColDef: { resizable:true, sortable:true },
          // 행을 더블클릭하면 선택 처리
          onRowDoubleClicked: (p) => pick(p.data, targetId)
        };

        // 이전에 만들어진 그리드가 있으면 정리
        if (gridApi && typeof gridApi.destroy === 'function') {
          gridApi.destroy();
          gridApi = null;
        }

        // ag-Grid 생성
        if (window.agGrid?.createGrid) {
          gridApi = window.agGrid.createGrid(gridDiv, gridOptions);
        } else {
          new agGrid.Grid(gridDiv, gridOptions);
          gridApi = gridOptions.api;
        }
      }

      // 행 선택 시 실행: target 입력칸에 사번 채우고 모달 닫기
      function pick(row, targetId) {
        if (!row) return;
        const t = document.getElementById(targetId);
        if (t) {
          t.value = row.emp_id;                 // 선택된 사번 채우기
          t.dispatchEvent(new Event('change')); // 변경 이벤트 발생
        }
        bsModal?.hide();
      }
      return { open };
    })();
  </script>
</th:block>
