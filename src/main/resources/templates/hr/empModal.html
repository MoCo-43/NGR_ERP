<div th:fragment="empModal">
	<div class="modal fade" id="empModal" tabindex="-1" aria-hidden="true">
		<div class="modal-dialog modal-lg modal-dialog-scrollable">
			<div class="modal-content">

				<!-- Header -->
				<div class="modal-header">
					<h5 class="modal-title title-highlight" id="empModalTitle">사원
						등록 기본사항</h5>
					<button type="button" class="btn btn-light btn-sm border-0"
						data-bs-dismiss="modal" aria-label="닫기">
						<i class="fas fa-times"></i>
					</button>
				</div>

				<div class="modal-body">
			
					<th:block th:replace="~{hr/codeLookup :: codeLookupModal}"></th:block>

					<ul class="nav nav-tabs mb-3" id="empTabs" role="tablist">
						<li class="nav-item" role="presentation">
							<button class="nav-link active" data-bs-toggle="tab"
								data-bs-target="#tab-basic" type="button" role="tab">기본사항</button>
						</li>
						<li class="nav-item" role="presentation">
							<button class="nav-link" data-bs-toggle="tab"
								data-bs-target="#tab-pay" type="button" role="tab">급여지급사항</button>
						</li>
						<li class="nav-item" role="presentation">
							<button class="nav-link" data-bs-toggle="tab"
								data-bs-target="#tab-edu" type="button" role="tab">교육</button>
						</li>
						<li class="nav-item" role="presentation">
							<button class="nav-link" data-bs-toggle="tab"
								data-bs-target="#tab-cert" type="button" role="tab">자격증</button>
						</li>
					</ul>

					<div class="tab-content">
						<!-- 기본사항 -->
						<div class="tab-pane fade show active" id="tab-basic"
							role="tabpanel">
							<form id="empForm" onsubmit="return false;">
								<div class="container-fluid">
									<div class="row g-3">
										<div class="col-md-6">
											<label for="f_emp_id" class="form-label">사번</label> <input
												id="f_emp_id" name="emp_id" class="form-control"
												placeholder="EMP-****-###" readonly>
										</div>
											<div class="col-md-6">
											<label for="f_name" class="form-label">성명 <span
												class="text-danger">*</span></label> <input id="f_name" name="name"
												class="form-control" required>
										</div>

										<div class="col-md-6">
											<label for="f_dept_code" class="form-label">부서 <span
												class="text-danger">*</span></label>
											<div class="input-group">
												<input id="f_dept_code" name="dept_code"
													class="form-control" placeholder="DEPT-001" required>
												<button class="btn btn-outline-secondary" type="button"
													id="btnDeptLookup">
													<i class="fas fa-search"></i>
												</button>
											</div>
										</div>

										<div class="col-md-6">
											<label for="f_position" class="form-label">직급</label>
											<div class="input-group">
												<input id="f_position" name="position" class="form-control"
													placeholder="과장/대리 등">
												<button class="btn btn-outline-secondary" type="button"
													id="btnPositionLookup">
													<i class="fas fa-search"></i>
												</button>
											</div>
											<input type="hidden" id="f_position_code" name="positionCode">
										</div>

										<div class="col-md-6">
											<label for="f_title" class="form-label">직책</label>
											<div class="input-group">
												<input id="f_title" name="title" class="form-control"
													placeholder="팀장/팀원 등">
												<button class="btn btn-outline-secondary" type="button"
													id="btnTitleLookup">
													<i class="fas fa-search"></i>
												</button>
											</div>
											<input type="hidden" id="f_title_code" name="titleCode">
										</div>

										<div class="col-md-6">
											<label for="f_birth" class="form-label">생년월일</label> <input
												id="f_birth" name="birth" type="date" class="form-control">
										</div>

										<div class="col-md-6">
											<label for="f_phone" class="form-label">전화번호</label> <input
												id="f_phone" name="phone" class="form-control"
												placeholder="010-0000-0000">
										</div>
										<div class="col-md-6">
											<label for="f_family_cnt" class="form-label">부양가족수</label> <input
												id="f_family_cnt" name="familyCnt" type="number" min="0"
												step="1" class="form-control" value="0">
										</div>

										<div class="col-md-6">
											<label for="f_marital_status" class="form-label">결혼
												여부</label> <select id="f_marital_status" name="maritalStatus"
												class="form-control">
												<option value="SINGLE">미혼</option>
												<option value="MARRIED">기혼</option>
											</select>
										</div>

										<div class="col-md-6">
											<label for="f_children_cnt" class="form-label">자녀 수</label> <input
												id="f_children_cnt" name="childrenCnt" type="number" min="0"
												step="1" class="form-control" value="0" disabled>
										</div>

										<div class="col-md-6">
											<label for="f_email" class="form-label">이메일 <span
												class="text-danger">*</span></label> <input id="f_email"
												name="email" type="email" class="form-control" required>
										</div>

										<div class="col-md-6">
											<label for="f_joinDate" class="form-label">입사일자 <span
												class="text-danger">*</span></label> <input id="f_joinDate"
												name="joinDate" type="date" class="form-control" required>
										</div>

										<div class="col-md-6">
											<label for="f_leaveDate" class="form-label">퇴사일자</label> <input
												id="f_leaveDate" name="leaveDate" type="date"
												class="form-control">
										</div>

										<div class="col-12">
											<label for="f_leaveReason" class="form-label">퇴사 사유</label> <input
												id="f_leaveReason" name="leaveReason" class="form-control">
										</div>

										<div class="col-md-6">
											<label for="f_bankName" class="form-label">은행</label>
											<div class="input-group">
												<input id="f_bankName" name="bankName" class="form-control"
													placeholder="신한은행" readonly> <input type="hidden"
													id="f_bankCode" name="bankCode">
												<button class="btn btn-outline-secondary" type="button"
													id="btnBankLookup">
													<i class="fas fa-search"></i>
												</button>
											</div>
										</div>

										<div class="col-md-5">
											<label for="f_accountNo" class="form-label">계좌번호</label> <input
												id="f_accountNo" name="accountNo" class="form-control">
										</div>
										<div class="col-md-3">
											<label for="f_accountName" class="form-label">예금주</label> <input
												id="f_accountName" name="accountName" class="form-control">
										</div>

										<div class="col-md-4">
											<label for="f_zipCode" class="form-label">우편번호</label>
											<div class="input-group">
												<input id="f_zipCode" name="zipCode" class="form-control">
												<button class="btn btn-outline-secondary" type="button"
													id="btnZipSearch">찾기</button>
											</div>
										</div>

										<div class="col-md-8">
											<label for="f_address" class="form-label">주소</label> <input
												id="f_address" name="address" class="form-control">
										</div>

										<div class="col-12">
											<input id="f_address_detail" name="addressDetail"
												class="form-control mt-2" placeholder="상세주소(동/호)">
										</div>
									</div>
								</div>
							</form>
						</div>

						<div class="tab-pane fade" id="tab-pay"
							th:insert="~{hr/payFix :: payFix}" role="tabpanel"></div>
						<div class="tab-pane fade" id="tab-edu" role="tabpanel">
							<div th:insert="~{hr/eduList :: eduList}"></div>
						</div>
						<div class="tab-pane fade" id="tab-cert" role="tabpanel">
							<div th:insert="~{hr/certList :: certList}"></div>
						</div>
					</div>
				</div>

				<div class="modal-footer" id="empModalFooter">
					<button type="button" class="btn btn-success" id="btnSave">저장</button>
					<button type="button" class="btn btn-secondary"
						data-bs-dismiss="modal">닫기</button>
				</div>
			</div>
		</div>
	</div>

	<style>
#empModal .nav-tabs {
	display: flex;
	flex-direction: row;
	gap: .5rem;
	border-bottom: 1px solid #dee2e6;
}

#empModal .nav-tabs .nav-item {
	flex: 1 1 0;
}

#empModal .nav-tabs .nav-link {
	width: 100%;
	display: flex;
	align-items: center;
	justify-content: center;
	font-weight: 600;
	height: 40px;
}

#empModal .modal-dialog {
	max-width: 1200px;
}
</style>

	<script
		src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>

<script>
  (function(){
    const $  = (id)=>document.getElementById(id);
    const qs = (sel,root=document)=>root.querySelector(sel);
    let mode='create';

    // CSRF/헤더
    (function setupAxios(){
      try{
        const token  = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
        const header = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');
        if(token && header){ axios.defaults.headers.common[header]=token; }
        axios.defaults.headers.post['Content-Type']='application/json';
        axios.defaults.headers.put ['Content-Type']='application/json';
      }catch(e){}
    })();

    //기본사항 저장 유틸 
    function readForm(includeId){
      const v=(id)=>$(id)?.value||'';
      const p={
        name:v('f_name').trim(),
        dept_code:v('f_dept_code').trim(),
        position:v('f_position').trim(),
        title:v('f_title').trim(),
        birth:v('f_birth')||null,
        phone:v('f_phone').trim(),
        email:v('f_email').trim(),
        joinDate:v('f_joinDate')||null,
        leaveDate:v('f_leaveDate')||null,
        leaveReason:v('f_leaveReason').trim(),
        bankCode:v('f_bankCode').trim(),
        accountNo:v('f_accountNo').trim(),
        accountName:v('f_accountName').trim(),
        zipCode:v('f_zipCode').trim(),
        address:v('f_address').trim(),
        addressDetail:v('f_address_detail').trim(),
        familyCnt: Number(v('f_family_cnt')) || 0,
        maritalStatus: v('f_marital_status') || 'SINGLE',
        childrenCnt: Number(v('f_children_cnt')) || 0,
      };
      if(includeId) p.emp_id=v('f_emp_id');
      return p;
    }
    function validate(p){
      if(!p.name)      return alert('성명을 입력하세요.'),false;
      if(!p.dept_code) return alert('부서를 입력하세요.'),false;	
      if(!p.email)     return alert('이메일을 입력하세요.'),false;
      if(!p.joinDate)  return alert('입사일자를 입력하세요.'),false;
      return true;
    }
    async function saveBasic(){
      const payload=readForm(true);
      const isEdit=!!(payload.emp_id && payload.emp_id.trim().length>0);
      if(!validate(payload)) return;

      const url   = isEdit ? `/api/v1/emps/${encodeURIComponent(payload.emp_id)}` : `/api/v1/emps`;
      const method= isEdit ? 'PUT' : 'POST';

      const res=await fetch(url,{method,headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
      if(!res.ok) throw new Error('저장 실패');

      (bootstrap.Modal.getInstance($('empModal'))||new bootstrap.Modal($('empModal'))).hide();
      document.dispatchEvent(new CustomEvent('emp:saved'));
      alert('저장되었습니다.');
    }

    // 저장 버튼 라우팅
    $('btnSave')?.addEventListener('click', async ()=>{
      if($('pf_emp_id')) $('pf_emp_id').value = $('f_emp_id')?.value || '';

      const target=qs('#empTabs .nav-link.active')?.getAttribute('data-bs-target');
      if(target==='#tab-pay'){
        try{
          await window.__payFix?.save?.();
          (bootstrap.Modal.getInstance($('empModal'))||new bootstrap.Modal($('empModal'))).hide();
          document.dispatchEvent(new CustomEvent('emp:saved'));
          alert('저장되었습니다.');
        }catch(_e){}
        return;
      }
      if(target==='#tab-edu')  return $('btnEduSave')?.click();
      if(target==='#tab-cert') return $('btnCertSave')?.click();
      await saveBasic();
    });

    // 모달 열림
    $('empModal')?.addEventListener('shown.bs.modal', async ()=>{
      const id=$('f_emp_id')?.value||'';
      window.EduForm?.setEmpId?.(id);
      window.CertForm?.setEmpId?.(id);
      if($('pf_emp_id')) $('pf_emp_id').value = id; 
      await window.__payFix?.init?.(id);
    });

    // 탭 전환
    $('empTabs')?.addEventListener('shown.bs.tab', async (e)=>{
      const id=$('f_emp_id')?.value||'';
      const target=e.target.getAttribute('data-bs-target');
      if(target==='#tab-edu'){  window.EduForm?.setEmpId?.(id);  window.EduForm?.refresh?.(); }
      if(target==='#tab-cert'){ window.CertForm?.setEmpId?.(id); window.CertForm?.refresh?.(); }
      if(target==='#tab-pay'){
        if($('pf_emp_id')) $('pf_emp_id').value = id; 
        await window.__payFix?.init?.(id);
      }
    });

    // 외부 API
    window.EmpModal={
      openCreate(){
        mode='create';
        $('empModalTitle').textContent='사원 등록 기본사항';
        [
          'f_emp_id','f_name','f_dept_code','f_position','f_title','f_birth','f_phone','f_email',
          'f_joinDate','f_leaveDate','f_leaveReason','f_bankCode', 'f_bankName','f_accountNo','f_accountName',
          'f_zipCode','f_address','f_family_cnt','f_address_detail','f_marital_status','f_children_cnt'
        ].forEach(id=>{ const el=$(id); if(el) el.value=''; });
        $('f_joinDate').value=new Date().toISOString().slice(0,10);
        // 결혼 여부/자녀 수 기본값
        if($('f_marital_status')) $('f_marital_status').value='SINGLE';
        if($('f_children_cnt')){ $('f_children_cnt').value=0; $('f_children_cnt').disabled=true; }
        window.__payFix?.clear?.(); window.EduForm?.clear?.(); window.CertForm?.clear?.();
        const t=document.querySelector('#empTabs button[data-bs-target="#tab-basic"]');
        if(t) new bootstrap.Tab(t).show();
        window.__payFix?.init?.('');
        (new bootstrap.Modal($('empModal'))).show();
      },
      async openEdit(row){
        mode='edit';
        $('empModalTitle').textContent='사원 수정 기본사항';
        const set=(id,v)=>{ const el=$(id); if(el) el.value=v??''; };
        set('f_emp_id',row.emp_id||''); set('f_name',row.name||'');
        set('f_dept_code',row.dept_code||''); set('f_position',row.position||'');
        set('f_title',row.title||'');
        set('f_birth', row.birth?String(row.birth).slice(0,10):'');
        set('f_phone',row.phone||''); set('f_email',row.email||'');
        set('f_joinDate',row.joinDate?String(row.joinDate).slice(0,10):'');
        set('f_leaveDate',row.leaveDate?String(row.leaveDate).slice(0,10):'');
        set('f_leaveReason',row.leaveReason||'');
        set('f_bankCode',row.bankCode||''); set('f_bankName', row.bankName || ''); set('f_accountNo',row.accountNo||''); set('f_accountName',row.accountName||'');
        set('f_zipCode',row.zipCode||''); set('f_address',row.address||'');
        // 결혼 여부/자녀 수 값 세팅
        set('f_marital_status', row.maritalStatus || 'SINGLE');
        set('f_children_cnt',   row.childrenCnt ?? 0);
        
        const d=$('f_address_detail'); if(d) d.value=row.addressDetail||'';

        // 결혼 여부에 따른 자녀 수 활성/비활성
        const msVal=$('f_marital_status')?.value || 'SINGLE';
        const childEl=$('f_children_cnt');
        if(childEl) childEl.disabled = (msVal !== 'MARRIED');

        window.EduForm?.setEmpId?.(row.emp_id||'');
        window.CertForm?.setEmpId?.(row.emp_id||'');

        const t=document.querySelector('#empTabs button[data-bs-target="#tab-basic"]');
        if(t) new bootstrap.Tab(t).show();

        await window.__payFix?.init?.(row.emp_id||'');
        (new bootstrap.Modal($('empModal'))).show();
      }
    };

    window.openZipSearch = function({ onSelect } = {}) {
    	  if (!window.daum || !daum.Postcode) {
    	    alert('주소 검색 스크립트가 로드되지 않았습니다.');
    	    return;
    	  }
    	  new daum.Postcode({
    	    oncomplete: function(data) {
    	      var road = data.roadAddress;
    	      var jibun = data.jibunAddress;
    	      var addr = road && road.trim().length ? road : jibun;

    	      var zipEl = document.getElementById('f_zipCode');
    	      var addrEl = document.getElementById('f_address');
    	      var detailEl = document.getElementById('f_address_detail');

    	      if (zipEl)  zipEl.value  = data.zonecode || '';
    	      if (addrEl) addrEl.value = addr || '';
    	      
    	
    	      if (detailEl) {
    	        detailEl.disabled = false;
    	        detailEl.readOnly = false;
    	        detailEl.focus();
    	        detailEl.select();
    	      }

    	      // 기존 콜백 유지
    	      if (typeof onSelect === 'function') {
    	        onSelect({
    	          zonecode: data.zonecode,
    	          roadAddress: data.roadAddress,
    	          jibunAddress: data.jibunAddress,
    	          address: addr,
    	          data
    	        });
    	      }
    	    }
    	  }).open();
    	};

    function bindLookupButtons(){
      const open = window.CodeLookup?.open;
      if (!open) {
        console.warn('CodeLookup.open 이 없습니다. codeLookupModal fragment가 포함되었는지 확인하세요.');
      }

      // 1) 부서
      $('btnDeptLookup')?.addEventListener('click', ()=>{
        open?.({
          source: 'dept',
          title: '부서 선택',
          targetId: 'f_dept_code',
          targetNameId: null
        });
      });

      // 2) 직급
      $('btnPositionLookup')?.addEventListener('click', ()=>{
        open?.({
          groupId: 'RK',
          title: '직급 선택',
          targetId: 'f_position_code',
          targetNameId: 'f_position'
        });
      });

      // 3) 직책
      $('btnTitleLookup')?.addEventListener('click', ()=>{
        open?.({
          groupId: 'PO',
          title: '직책 선택',
          targetId: 'f_title_code',
          targetNameId: 'f_title'
        });
      });

      // 4) 은행
      $('btnBankLookup')?.addEventListener('click', ()=>{
        open?.({
          groupId: 'BK',
          title: '은행 선택',
          targetId: 'f_bankCode',
          targetNameId: 'f_bankName'
        });
      });

      // 5) 우편번호
      $('btnZipSearch')?.addEventListener('click', ()=>{
        window.openZipSearch({
          onSelect: ({ zonecode, address }) => {
          }
        });
      });
    }

    // 결혼 여부 변경 시 자녀 수 활성/비활성 토글
    function bindMaritalToggle(){
      const ms = $('f_marital_status');
      const cc = $('f_children_cnt');
      if (!ms || !cc) return;
      const toggle = ()=>{
        if (ms.value === 'MARRIED') {
          cc.disabled = false;
        } else {
          cc.disabled = true;
          cc.value = 0;
        }
      };
      ms.addEventListener('change', toggle);
      toggle();
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', ()=>{
        bindLookupButtons();
        bindMaritalToggle();
      }, { once:true });
    } else {
      bindLookupButtons();
      bindMaritalToggle();
    }

  })();
  </script>

</div>
