<!-- templates/hr/empModal.html -->
<div th:fragment="empModal">
  <div class="modal fade" id="empModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title title-highlight" id="empModalTitle">사원 등록 기본사항</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="닫기">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>

        <div class="modal-body">
          <!-- 가로 탭 (Bootstrap 4: data-toggle="tab", href 또는 data-target 사용) -->
          <ul class="nav nav-tabs mb-3" id="empTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <a class="nav-link active" data-toggle="tab" href="#tab-basic" role="tab">기본사항</a>
            </li>
            <li class="nav-item" role="presentation">
              <a class="nav-link" data-toggle="tab" href="#tab-pay" role="tab">급여지급사항</a>
            </li>
            <!-- ✅ 교육 탭 -->
            <li class="nav-item" role="presentation">
              <a class="nav-link" data-toggle="tab" href="#tab-edu" role="tab">교육</a>
            </li>
            <li class="nav-item" role="presentation">
              <a class="nav-link disabled" tabindex="-1" aria-disabled="true">자격증</a>
            </li>
          </ul>

          <div class="tab-content">
            <!-- 기본사항 -->
            <div class="tab-pane fade show active" id="tab-basic" role="tabpanel">
              <form id="empForm" onsubmit="return false;">
                <div class="container-fluid">
                  <div class="row g-3">
                    <div class="col-md-6">
                      <label for="f_emp_id" class="form-label">사번(자동)</label>
                      <input id="f_emp_id" name="emp_id" class="form-control" placeholder="EMP-YYYY-###" readonly>
                    </div>
                    <div class="col-md-6">
                      <label for="f_name" class="form-label">성명 <span class="text-danger">*</span></label>
                      <input id="f_name" name="name" class="form-control" required>
                    </div>

                    <div class="col-md-6">
                      <label for="f_dept_code" class="form-label">부서 <span class="text-danger">*</span></label>
                      <div class="input-group">
                        <input id="f_dept_code" name="dept_code" class="form-control" placeholder="DEPT-001" required>
                        <button class="btn btn-outline-secondary" type="button" id="btnDeptLookup"><i class="fas fa-search"></i></button>
                      </div>
                    </div>

                    <div class="col-md-6">
                      <label for="f_position" class="form-label">직급</label>
                      <div class="input-group">
                        <input id="f_position" name="position" class="form-control" placeholder="과장/대리 등">
                        <button class="btn btn-outline-secondary" type="button" id="btnPositionLookup"><i class="fas fa-search"></i></button>
                      </div>
                    </div>

                    <div class="col-md-6">
                      <label for="f_title" class="form-label">직책</label>
                      <div class="input-group">
                        <input id="f_title" name="title" class="form-control" placeholder="팀장/팀원 등">
                        <button class="btn btn-outline-secondary" type="button" id="btnTitleLookup"><i class="fas fa-search"></i></button>
                      </div>
                    </div>

                    <div class="col-md-6">
                      <label for="f_birth" class="form-label">생년월일</label>
                      <input id="f_birth" name="birth" type="date" class="form-control">
                    </div>

                    <div class="col-md-6">
                      <label for="f_phone" class="form-label">전화번호</label>
                      <input id="f_phone" name="phone" class="form-control" placeholder="010-0000-0000">
                    </div>
                    <div class="col-md-6">
                      <label for="f_email" class="form-label">이메일 <span class="text-danger">*</span></label>
                      <input id="f_email" name="email" type="email" class="form-control" required>
                    </div>

                    <div class="col-md-6">
                      <label for="f_joinDate" class="form-label">입사일자 <span class="text-danger">*</span></label>
                      <input id="f_joinDate" name="joinDate" type="date" class="form-control" required>
                    </div>
                    <div class="col-md-6">
                      <label for="f_leaveDate" class="form-label">퇴사일자</label>
                      <input id="f_leaveDate" name="leaveDate" type="date" class="form-control">
                    </div>

                    <div class="col-12">
                      <label for="f_leaveReason" class="form-label">퇴사 사유</label>
                      <input id="f_leaveReason" name="leaveReason" class="form-control">
                    </div>

                    <div class="col-md-4">
                      <label for="f_bankCode" class="form-label">은행코드</label>
                      <div class="input-group">
                        <input id="f_bankCode" name="bankCode" class="form-control" placeholder="088">
                        <button class="btn btn-outline-secondary" type="button" id="btnBankLookup"><i class="fas fa-search"></i></button>
                      </div>
                    </div>

                    <div class="col-md-5">
                      <label for="f_accountNo" class="form-label">계좌번호</label>
                      <input id="f_accountNo" name="accountNo" class="form-control">
                    </div>
                    <div class="col-md-3">
                      <label for="f_accountName" class="form-label">예금주</label>
                      <input id="f_accountName" name="accountName" class="form-control">
                    </div>

                    <div class="col-md-4">
                      <label for="f_zipCode" class="form-label">우편번호</label>
                      <div class="input-group">
                        <input id="f_zipCode" name="zipCode" class="form-control">
                        <button class="btn btn-outline-secondary" type="button" id="btnZipSearch">찾기</button>
                      </div>
                    </div>
                    <div class="col-md-8">
                      <label for="f_address" class="form-label">주소</label>
                      <input id="f_address" name="address" class="form-control">
                    </div>
                    <div class="col-12">
                      <input id="f_address_detail" name="addressDetail" class="form-control mt-2" placeholder="상세주소(동/호)">
                    </div>
                  </div>
                </div>
              </form>
            </div>

            <!-- ✅ 급여지급사항: 프래그먼트 정적 포함 -->
            <div class="tab-pane fade" id="tab-pay" th:insert="hr/payFix :: payFix" role="tabpanel"></div>

            <!-- ✅ 교육: 리스트 + 폼모달 프래그먼트 포함 (분리 유지) -->
            <div class="tab-pane fade" id="tab-edu" role="tabpanel">
              <div th:insert="~{hr/eduList :: eduList}"></div>
              <div th:insert="~{hr/eduForm :: eduFormModal}"></div>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-success" id="btnSave">저장</button>
          <button type="button" class="btn btn-secondary" data-dismiss="modal">닫기</button>
        </div>
      </div>
    </div>
  </div>

  <style>
    #empModal .nav-tabs{
      display:flex !important; flex-direction:row !important;
      gap:.5rem; border-bottom:1px solid #dee2e6;
    }
    #empModal .nav-tabs .nav-item{ flex:1 1 0; }
    #empModal .nav-tabs .nav-link{
      width:100%; display:flex; align-items:center; justify-content:center;
      font-weight:600; height:40px;
    }
    @media(max-width:576px){
      #empModal .nav-tabs{ flex-wrap:wrap; }
      #empModal .nav-tabs .nav-item{ flex:1 1 50%; }
    }
    #empModal .form-label{ font-weight:600; margin-bottom:.25rem; }
    #empModal .title-highlight{
      color:#0d6efd; font-weight:800; font-size:1.3rem;
      border-bottom:3px solid #0d6efd; padding-bottom:3px;
    }
  </style>

  <!-- ❌ 여기서 jQuery/Bootstrap JS를 다시 로드하지 마세요 (base.html에서 이미 로드됨) -->

  <!-- 모달 전용 스크립트 (Bootstrap 4) -->
  <script>
  (function(){
    var eduTbody  = document.getElementById('eduTbody');
    var eduRowCnt = document.getElementById('eduRowCount');

    function getCurrentEmpId(){
      return document.getElementById('f_emp_id')?.value
          || document.getElementById('eduEmpId')?.value
          || '';
    }

    async function apiList(empId){
      var res = await fetch('/api/hr/edu?empId=' + encodeURIComponent(empId));
      if(!res.ok) throw new Error('교육 리스트 조회 실패');
      return res.json();
    }

    function renderEdu(list){
      if(!list || list.length === 0){
        eduTbody.innerHTML =
          '<tr><td colspan="8" class="text-center text-secondary py-4">등록된 교육이 없습니다.</td></tr>';
        eduRowCnt.textContent = '0건';
        return;
      }
      eduTbody.innerHTML = list.map(function(r){
        return (
          '<tr data-id="'+ r.EDU_NO +'">' +
            '<td>'+ r.EDU_NO +'</td>' +
            '<td>'+ (r.EDU_NAME || '') +'</td>' +
            '<td>'+ (r.EDU_TYPE || '') +'</td>' +
            '<td>'+ (r.RESULT || '') +'</td>' +
            '<td class="text-end">'+ (r.SCORE ?? '') +'</td>' +
            '<td>'+ (r.COMPLETE_AT || '') +'</td>' +
            '<td>'+ (r.EXPIRES_AT || '') +'</td>' +
            '<td><button type="button" class="btn btn-sm btn-outline-danger btn-row-del">삭제</button></td>' +
          '</tr>'
        );
      }).join('');
      eduRowCnt.textContent = list.length + '건';
    }

    async function refreshEduList(){
      var empId = getCurrentEmpId();
      if(!empId){ renderEdu([]); return; }
      try{
        var data = await apiList(empId);
        renderEdu(data);
      }catch(e){ console.error(e); renderEdu([]); }
    }

    // ✅ 탭 전환 이벤트(BS4): e.target.getAttribute('href')로 타겟 확인
    $('#empTabs').on('shown.bs.tab', 'a[data-toggle="tab"]', function(e){
      var target = e.target.getAttribute('href'); // "#tab-edu"
      if (target === '#tab-edu') {
        var empId = getCurrentEmpId();
        var hidden = document.getElementById('eduEmpId');
        if (hidden) hidden.value = empId;
        refreshEduList();
      }
    });

    // 행별 삭제
    eduTbody?.addEventListener('click', async function(e){
      if(!e.target.classList.contains('btn-row-del')) return;
      var tr = e.target.closest('tr');
      var id = tr?.getAttribute('data-id');
      if(!id) return;
      if(!confirm('삭제하시겠습니까?')) return;
      try{
        var res = await fetch('/api/hr/edu/' + id, { method:'DELETE' });
        if(!res.ok) throw new Error('교육 삭제 실패');
        await refreshEduList();
      }catch(err){ alert(err.message || '삭제 실패'); }
    });

    // 저장
    document.addEventListener('click', async function(e){
      if(e.target?.id !== 'btnEduSave') return;

      var btn  = e.target;
      var form = document.getElementById('eduFormDetail');
      var payload = Object.fromEntries(new FormData(form).entries());
      if(!payload.empId){ alert('사번 없음. 사원 먼저 선택하세요'); return; }
      if(!payload.eduName){ form.eduName.focus(); return; }

      btn.disabled = true;
      try{
        var res = await fetch('/api/hr/edu', {
          method:'POST',
          headers:{ 'Content-Type':'application/x-www-form-urlencoded' },
          body: new URLSearchParams(payload)
        });
        if(!res.ok) throw new Error('교육 저장 실패');

        // Bootstrap 4: jQuery API로 닫기
        $('#eduFormModal').modal('hide');
        await refreshEduList();
      }catch(err){
        alert(err.message || '저장 실패');
      }finally{
        btn.disabled = false;
      }
    });
  })();
  </script>
</div>
