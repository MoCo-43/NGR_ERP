<!-- templates/hr/empModal.html -->
<div th:fragment="empModal">
	<div class="modal fade" id="empModal" tabindex="-1" aria-hidden="true">
		<div class="modal-dialog modal-lg modal-dialog-scrollable">
			<div class="modal-content">

				<!-- Header -->
				<div class="modal-header">
					<h5 class="modal-title title-highlight" id="empModalTitle">사원
						등록 기본사항</h5>
					<button type="button" class="btn btn-light btn-sm border-0" data-bs-dismiss="modal" aria-label="닫기">
            <i class="fas fa-times"></i>
          </button>
				</div>

				<!-- Body -->
				<div class="modal-body">
					<!-- 공통코드 선택 모달(재사용 프래그먼트) -->
					<th:block th:replace="~{hr/codeLookup :: codeLookupModal}"></th:block>

					<!-- 탭 -->
					<ul class="nav nav-tabs mb-3" id="empTabs" role="tablist">
						<li class="nav-item" role="presentation">
							<button class="nav-link active" data-bs-toggle="tab"
								data-bs-target="#tab-basic" type="button" role="tab">기본사항</button>
						</li>
						<li class="nav-item" role="presentation">
							<button class="nav-link" data-bs-toggle="tab"
								data-bs-target="#tab-pay" type="button" role="tab">급여지급사항</button>
						</li>
						<li class="nav-item" role="presentation">
							<button class="nav-link" data-bs-toggle="tab"
								data-bs-target="#tab-edu" type="button" role="tab">교육</button>
						</li>
						<li class="nav-item" role="presentation">
							<button class="nav-link" data-bs-toggle="tab"
								data-bs-target="#tab-cert" type="button" role="tab">자격증</button>
						</li>
					</ul>

					<div class="tab-content">
						<!-- 기본사항 -->
						<div class="tab-pane fade show active" id="tab-basic"
							role="tabpanel">
							<form id="empForm" onsubmit="return false;">
								<div class="container-fluid">
									<div class="row g-3">
										<div class="col-md-6">
											<label for="f_emp_id" class="form-label">사번(자동)</label> <input
												id="f_emp_id" name="emp_id" class="form-control"
												placeholder="EMP-YYYY-###" readonly>
										</div>
										<div class="col-md-6">
											<label for="f_name" class="form-label">성명 <span
												class="text-danger">*</span></label> <input id="f_name" name="name"
												class="form-control" required>
										</div>

										<div class="col-md-6">
											<label for="f_dept_code" class="form-label">부서 <span
												class="text-danger">*</span></label>
											<div class="input-group">
												<input id="f_dept_code" name="dept_code"
													class="form-control" placeholder="DEPT-001" required>
												<button class="btn btn-outline-secondary" type="button"
													id="btnDeptLookup">
													<i class="fas fa-search"></i>
												</button>
											</div>
										</div>

										<div class="col-md-6">
											<label for="f_position" class="form-label">직급</label>
											<div class="input-group">
												<input id="f_position" name="position" class="form-control"
													placeholder="과장/대리 등">
												<button class="btn btn-outline-secondary" type="button"
													id="btnPositionLookup">
													<i class="fas fa-search"></i>
												</button>
											</div>
											<input type="hidden" id="f_position_code" name="positionCode">
										</div>

										<div class="col-md-6">
											<label for="f_title" class="form-label">직책</label>
											<div class="input-group">
												<input id="f_title" name="title" class="form-control"
													placeholder="팀장/팀원 등">
												<button class="btn btn-outline-secondary" type="button"
													id="btnTitleLookup">
													<i class="fas fa-search"></i>
												</button>
											</div>
											<input type="hidden" id="f_title_code" name="titleCode">
										</div>

										<div class="col-md-6">
											<label for="f_birth" class="form-label">생년월일</label> <input
												id="f_birth" name="birth" type="date" class="form-control">
										</div>

										<div class="col-md-6">
											<label for="f_phone" class="form-label">전화번호</label> <input
												id="f_phone" name="phone" class="form-control"
												placeholder="010-0000-0000">
										</div>
										<div class="col-md-6">
											<label for="f_email" class="form-label">이메일 <span
												class="text-danger">*</span></label> <input id="f_email"
												name="email" type="email" class="form-control" required>
										</div>

										<div class="col-md-6">
											<label for="f_joinDate" class="form-label">입사일자 <span
												class="text-danger">*</span></label> <input id="f_joinDate"
												name="joinDate" type="date" class="form-control" required>
										</div>
										<div class="col-md-6">
											<label for="f_leaveDate" class="form-label">퇴사일자</label> <input
												id="f_leaveDate" name="leaveDate" type="date"
												class="form-control">
										</div>

										<div class="col-12">
											<label for="f_leaveReason" class="form-label">퇴사 사유</label> <input
												id="f_leaveReason" name="leaveReason" class="form-control">
										</div>

										<!-- 은행: 화면에는 은행명만 표시, hidden으로 코드 보관 -->
										<div class="col-md-6">
											<label for="f_bankName" class="form-label">은행</label>
											<div class="input-group">
												<input id="f_bankName" name="bankName" class="form-control"
													placeholder="신한은행" readonly> <input type="hidden"
													id="f_bankCode" name="bankCode">
												<button class="btn btn-outline-secondary" type="button"
													id="btnBankLookup">
													<i class="fas fa-search"></i>
												</button>
											</div>
										</div>

										<div class="col-md-5">
											<label for="f_accountNo" class="form-label">계좌번호</label> <input
												id="f_accountNo" name="accountNo" class="form-control">
										</div>
										<div class="col-md-3">
											<label for="f_accountName" class="form-label">예금주</label> <input
												id="f_accountName" name="accountName" class="form-control">
										</div>

										<div class="col-md-4">
											<label for="f_zipCode" class="form-label">우편번호</label>
											<div class="input-group">
												<input id="f_zipCode" name="zipCode" class="form-control">
												<button class="btn btn-outline-secondary" type="button"
													id="btnZipSearch">찾기</button>
											</div>
										</div>
										<div class="col-md-8">
											<label for="f_address" class="form-label">주소</label> <input
												id="f_address" name="address" class="form-control">
										</div>
										<div class="col-12">
											<input id="f_address_detail" name="addressDetail"
												class="form-control mt-2" placeholder="상세주소(동/호)">
										</div>
									</div>
								</div>
							</form>
						</div>

						<!-- 급여지급사항 -->
						<div class="tab-pane fade" id="tab-pay"
							th:insert="hr/payFix :: payFix" role="tabpanel"></div>

						<!-- 교육 -->
						<div class="tab-pane fade" id="tab-edu" role="tabpanel">
							<div th:insert="~{hr/eduList :: eduList}"></div>
						</div>

						<!-- 자격증 -->
						<div class="tab-pane fade" id="tab-cert" role="tabpanel">
							<div th:insert="~{hr/certList :: certList}"></div>
						</div>
					</div>
				</div>

				<!-- Footer -->
				<div class="modal-footer" id="empModalFooter">
					<button type="button" class="btn btn-success" id="btnSave">저장</button>
					<button type="button" class="btn btn-secondary"
						data-bs-dismiss="modal">닫기</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Styles -->
	<style>
#empModal .nav-tabs {
	display: flex !important;
	flex-direction: row !important;
	gap: .5rem;
	border-bottom: 1px solid #dee2e6;
}
#empModal .nav-tabs .nav-item { flex: 1 1 0; }
#empModal .nav-tabs .nav-link {
	width: 100%;
	display: flex;
	align-items: center;
	justify-content: center;
	font-weight: 600;
	height: 40px;
}
@media (max-width:576px) {
	#empModal .nav-tabs { flex-wrap: wrap; }
	#empModal .nav-tabs .nav-item { flex: 1 1 50%; }
}
#empModal .form-label { font-weight: 600; margin-bottom: .25rem; }
#empModal .title-highlight {
	color: #0d6efd; font-weight: 800; font-size: 1.3rem; padding-bottom: 3px;
}
#empModal .modal-dialog { max-width: 1200px; }

#empModal #tab-pay .tab-footer{
  border-top: 1px solid #dee2e6; /* 밑줄 */
  padding-top: .75rem;           /* 윗여백 */
  margin-top: .25rem;            /* 위쪽 살짝 간격 */
}
</style>

	<!-- Script -->
	<script>
    (function(){
      const $ = (id)=>document.getElementById(id);
      const empTabs = $('empTabs');

      const getEmpId = () =>
        $('f_emp_id')?.value || $('eduEmpId')?.value || $('certEmpId')?.value || '';

      // ===== footer 토글 (급여 탭이면 숨김, 나머지 보임) =====
      function toggleFooterByTab(activeTarget){
        const footer = $('empModalFooter');
        if(!footer) return;
        const isPay = (activeTarget === '#tab-pay');
        footer.classList.toggle('d-none', isPay);
      }

      // =======================
      // 공통코드 모달 연결
      // =======================
      document.addEventListener('click', (e)=>{
        const el = e.target instanceof Element ? e.target.closest('button') : null;
        if(!el) return;

        // 부서
        if (el.id === 'btnDeptLookup') {
          CodeLookup.open({
            source: 'dept',
            title:  '부서 선택',
            targetId: 'f_dept_code'
          });
        }
        // 직급
        if(el.id === 'btnPositionLookup'){
          CodeLookup.open({
            groupId: 'RK',
            title: '직급 선택',
            targetNameId: 'f_position',
            targetId: 'f_position_code'
          });
        }
        // 직책
        if(el.id === 'btnTitleLookup'){
          CodeLookup.open({
            groupId: 'PO',
            title: '직책 선택',
            targetNameId: 'f_title',
            targetId: 'f_title_code'
          });
        }
        // 은행
        if(el.id === 'btnBankLookup'){
          CodeLookup.open({
            groupId: 'BK',
            title: '은행 선택',
            targetId: 'f_bankCode',
            targetNameId: 'f_bankName'
          });
        }
      });

      // =======================
      // [교육] 리스트/삭제/저장
      // =======================
      const eduTbody  = $('eduTbody');
      const eduRowCnt = $('eduRowCount');

      async function fetchEdu(empId){
        const res = await fetch('/api/hr/edu?empId=' + encodeURIComponent(empId));
        if(!res.ok) throw new Error('교육 조회 실패');
        return res.json();
      }
      function renderEdu(list){
        if(!eduTbody) return;
        if(!list?.length){
          eduTbody.innerHTML = '<tr><td colspan="8" class="text-center text-secondary py-4">등록된 교육이 없습니다.</td></tr>';
          if(eduRowCnt) eduRowCnt.textContent = '0건';
          return;
        }
        eduTbody.innerHTML = list.map(r=>`
          <tr data-id="${r.eduNo ?? r.EDU_NO}">
            <td>${r.eduNo ?? r.EDU_NO}</td>
            <td>${r.eduName ?? r.EDU_NAME ?? ''}</td>
            <td>${r.eduType ?? r.EDU_TYPE ?? ''}</td>
            <td>${r.result  ?? r.RESULT   ?? ''}</td>
            <td class="text-end">${r.score ?? r.SCORE ?? ''}</td>
            <td>${r.completeAt ?? r.COMPLETE_AT ?? ''}</td>
            <td>${r.expiresAt  ?? r.EXPIRES_AT  ?? ''}</td>
            <td><button type="button" class="btn btn-sm btn-outline-danger edu-del">삭제</button></td>
          </tr>`).join('');
        if(eduRowCnt) eduRowCnt.textContent = `${list.length}건`;
      }
      async function refreshEdu(){
        const id=getEmpId();
        if(!id) return renderEdu([]);
        renderEdu(await fetchEdu(id));
      }

      eduTbody?.addEventListener('click', async (e)=>{
        const btn = e.target;
        if(!(btn instanceof Element) || !btn.classList.contains('edu-del')) return;
        const no = btn.closest('tr')?.dataset.id;
        if(!no) return;
        if(!confirm('삭제하시겠습니까?')) return;
        const res = await fetch('/api/hr/edu/'+no,{method:'DELETE'});
        if(!res.ok) return alert('삭제 실패');
        refreshEdu();
      });

      document.addEventListener('click', async (e)=>{
        const el = e.target;
        if(!(el instanceof Element)) return;

        // 교육 저장
        if(el.id==='btnEduSave'){
          const form = $('eduFormDetail');
          const payload = Object.fromEntries(new FormData(form).entries());
          if(!payload.empId) return alert('사번이 없습니다.');
          if(!payload.eduName) return form.eduName.focus();
          el.setAttribute('disabled','true');
          try{
            const res = await fetch('/api/hr/edu',{
              method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)
            });
            if(!res.ok) throw new Error('저장 실패');
            (bootstrap.Modal.getInstance($('eduFormModal'))||new bootstrap.Modal($('eduFormModal'))).hide();
            await refreshEdu();
            alert('저장되었습니다.');
          }catch(err){ alert(err.message||'저장 실패'); }
          finally{ el.removeAttribute('disabled'); }
        }

        // 우편번호
        if(el.id==='btnZipSearch'){ openPostcodeApi(); }
      });

      // =======================
      // [자격증] 리스트/삭제/저장
      // =======================
      const certTbody  = $('certTbody');
      const certRowCnt = $('certRowCount');

      async function fetchCert(empId){
        const res = await fetch('/api/hr/cert?empId=' + encodeURIComponent(empId));
        if(!res.ok) throw new Error('자격증 조회 실패');
        return res.json();
      }
      function renderCert(list){
        if(!certTbody) return;
        if(!list?.length){
          certTbody.innerHTML = '<tr><td colspan="8" class="text-center text-secondary py-4">등록된 자격증이 없습니다.</td></tr>';
          if(certRowCnt) certRowCnt.textContent = '0건';
          return;
        }
        certTbody.innerHTML = list.map(r=>`
          <tr data-id="${r.certNo ?? r.CERT_NO}">
            <td>${r.certNo ?? r.CERT_NO}</td>
            <td class="flex-grow-2">${r.certName ?? r.CERT_NAME ?? ''}</td>
            <td>${r.grade ?? r.GRADE ?? ''}</td>
            <td>${r.orgName ?? r.ORG_NAME ?? ''}</td>
            <td>${r.acquiredAt ?? r.ACQUIRED_AT ?? ''}</td>
            <td>${r.expiresAt  ?? r.EXPIRES_AT  ?? ''}</td>
            <td>${r.remarks ?? r.REMARKS ?? ''}</td>
            <td><button type="button" class="btn btn-sm btn-outline-danger cert-del">삭제</button></td>
          </tr>`).join('');
        if(certRowCnt) certRowCnt.textContent = `${list.length}건`;
      }
      async function refreshCert(){
        const id=getEmpId();
        if(!id) return renderCert([]);
        renderCert(await fetchCert(id));
      }

      certTbody?.addEventListener('click', async (e)=>{
        const btn = e.target;
        if(!(btn instanceof Element) || !btn.classList.contains('cert-del')) return;
        const no = btn.closest('tr')?.dataset.id;
        if(!no) return;
        if(!confirm('삭제하시겠습니까?')) return;
        const res = await fetch('/api/hr/cert/'+no,{method:'DELETE'});
        if(!res.ok) return alert('삭제 실패');
        refreshCert();
      });

      document.addEventListener('click', async (e)=>{
        const el = e.target;
        if(!(el instanceof Element)) return;

        // 자격증 저장
        if(el.id==='btnCertSave'){
          const form = $('certFormDetail');
          const payload = Object.fromEntries(new FormData(form).entries());
          if(!payload.empId) return alert('사번이 없습니다.');
          if(!payload.certName) return form.certName.focus();
          el.setAttribute('disabled','true');
          try{
            const res = await fetch('/api/hr/cert',{
              method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)
            });
            if(!res.ok) throw new Error('저장 실패');
            (bootstrap.Modal.getInstance($('certFormModal'))||new bootstrap.Modal($('certFormModal'))).hide();
            await refreshCert();
            alert('저장되었습니다.');
          }catch(err){ alert(err.message||'저장 실패'); }
          finally{ el.removeAttribute('disabled'); }
        }
      });

      // =======================
      // 모달 열릴 때: 사번 동기화 + footer 토글
      // =======================
      $('empModal')?.addEventListener('shown.bs.modal', ()=>{
        const id = $('f_emp_id')?.value || '';
        if($('eduEmpId') && !$('eduEmpId').value)  $('eduEmpId').value  = id;
        if($('certEmpId') && !$('certEmpId').value) $('certEmpId').value = id;
        // 급여 폼 hidden 사번도 보정
        if($('pf_emp_id') && !$('pf_emp_id').value) $('pf_emp_id').value = id;

        const activeTarget = document
          .querySelector('#empTabs .nav-link.active')
          ?.getAttribute('data-bs-target');
        toggleFooterByTab(activeTarget);
      });

      // =======================
      // 탭 전환 시 리스트 로드 + 급여 사번 보정 + footer 토글
      // =======================
      empTabs?.addEventListener('shown.bs.tab', (e)=>{
        const target = e.target.getAttribute('data-bs-target');
        const id = getEmpId();

        if(target==='#tab-edu'){
          if($('eduEmpId')) $('eduEmpId').value = id;
          refreshEdu();
        }
        if(target==='#tab-cert'){
          if($('certEmpId')) $('certEmpId').value = id;
          refreshCert();
        }
        if(target==='#tab-pay'){
          if($('pf_emp_id') && !$('pf_emp_id').value) $('pf_emp_id').value = id;
        }
        toggleFooterByTab(target);
      });

      // =======================
      // 공용 저장 버튼 라우팅 (급여 탭 -> payFix 저장)
      // =======================
      $('btnSave')?.addEventListener('click', async ()=>{
        const activeTarget = document
          .querySelector('#empTabs .nav-link.active')
          ?.getAttribute('data-bs-target');

        if(activeTarget === '#tab-pay'){
          // 저장 직전 사번 방어 보정
          if($('pf_emp_id') && !$('pf_emp_id').value) $('pf_emp_id').value = $('f_emp_id')?.value || '';
          try{
            // payFix에서 window.__payFix.save()가 정의돼 있어야 함
            await window.__payFix?.save?.();
          }catch(err){
            console.error(err);
            alert(err?.message || '저장 실패');
          }
          return;
        }

        if(activeTarget === '#tab-basic'){
          // TODO: 기본사항 저장 로직 연결
          alert('기본사항 저장 로직을 연결하세요.');
          return;
        }

        if(activeTarget === '#tab-edu'){
          $('btnEduSave')?.click();
          return;
        }
        if(activeTarget === '#tab-cert'){
          $('btnCertSave')?.click();
          return;
        }
      });

      // 다음 우편번호 script 로드
      const SCRIPT_URL = "//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js";
      const tag  = document.createElement('script');
      tag.src    = SCRIPT_URL; document.head.appendChild(tag);
    })();

    // 주소 검색 (전역)
    function openPostcodeApi(){
      const $ = (id)=>document.getElementById(id);
      new daum.Postcode({
        oncomplete: function(data){
          const z=$('f_zipCode'), a=$('f_address'), d=$('f_address_detail');
          if(z) z.value = data.zonecode;
          if(a) a.value = data.roadAddress;
          d?.focus();
        }
      }).open();
    }
  </script>
</div>
