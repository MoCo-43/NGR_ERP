<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layout/base}">
<head>
<title layout:fragment="title">수당 등록</title>

<meta name="_csrf" th:content="${_csrf?.token}">
<meta name="_csrf_header" th:content="${_csrf?.headerName}">

<th:block layout:fragment="head_extra">
  <link rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/styles/ag-grid.css" />
  <link rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/styles/ag-theme-quartz.css" />
  <style>
  #allowGrid.ag-theme-quartz {
    height: 44rem;
    width: 100%;
    margin-top: .5rem;
  }

  .btn-use {
    padding: .2rem .6rem;
    font-size: 12px;
  }

  /* ===== cuteAlert 기본 스타일 ===== */
  .cute-alert-overlay {
    position: fixed; inset: 0;
    background: rgba(0,0,0,.45);
    display: flex; align-items: center; justify-content: center;
    opacity: 0; transition: opacity .25s ease;
    z-index: 1055; /* Bootstrap modal보다 위 */
  }
  .cute-alert-overlay.active { opacity: 1; }
  .cute-alert-box {
    width: min(92vw, 360px);
    background: #fff;
    border-radius: 14px;
    padding: 18px 18px 16px;
    text-align: center;
    box-shadow: 0 10px 26px rgba(0,0,0,.18);
  }
  .cute-alert-icon {
    font-size: 42px; line-height: 1; margin-bottom: 8px;
    width: 56px; height: 56px; object-fit: contain;
    margin-left: auto; margin-right: auto;
  }
  .cute-alert-title { font-weight: 700; font-size: 18px; margin-bottom: 6px; }
  .cute-alert-message { font-size: 14px; color: #444; white-space: pre-line; margin-bottom: 14px; }
  .cute-alert-buttons { display: flex; gap: 8px; justify-content: center; }
  .cute-alert-buttons .confirm-btn,
  .cute-alert-buttons .cancel-btn {
    border: none; border-radius: 8px; padding: 8px 14px; cursor: pointer;
    font-weight: 600;
  }
  .cute-alert-buttons .confirm-btn { background: #4c7cf3; color: #fff; }
  .cute-alert-buttons .cancel-btn  { background: #e9ecef; color: #222; }
  </style>
</th:block>
</head>
<body>
  <section layout:fragment="content">
    <div class="card shadow mb-3">
      <div class="card-header py-3 d-flex align-items-center justify-content-between">
        <h6 class="m-0 font-weight-bold text-primary">수당 등록</h6>
      </div>
      <div class="card-body">
      <div id="allowGridWrapper" style="position:relative;">
        <div id="allowGrid" class="ag-theme-quartz"></div>
        </div>
      </div>
    </div>
  </section>

  <th:block layout:fragment="body_extra">
    <script src="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/dist/ag-grid-community.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.7.7/dist/axios.min.js"></script>

    <!-- cuteAlert 함수 (사용자 정의 모달 알림) -->
    <script th:inline="none">
    // 중복 정의 방지
    if (!window.cuteAlert) {
      window.cuteAlert = function cuteAlert({ type='question', title='알림', message='', imgUrl=null, confirmText='확인', cancelText='취소' }) {
        return new Promise((resolve) => {
          const overlay = document.createElement('div');
          overlay.className = 'cute-alert-overlay';
          document.body.appendChild(overlay);

          const box = document.createElement('div');
          box.className = 'cute-alert-box';

          if (imgUrl) {
            const icon = document.createElement('img');
            icon.src = imgUrl;
            icon.className = 'cute-alert-icon';
            box.appendChild(icon);
          } else {
            const icon = document.createElement('div');
            icon.className = 'cute-alert-icon';
            icon.innerHTML = type === 'question' ? '❓' :
                             type === 'success'  ? '✅' :
                             type === 'warning'  ? '⚠️' :
                             type === 'error'    ? '❌' : '';
            box.appendChild(icon);
          }

          const t = document.createElement('div');
          t.className = 'cute-alert-title';
          t.innerText = title;
          box.appendChild(t);

          const m = document.createElement('div');
          m.className = 'cute-alert-message';
          m.innerText = message;
          box.appendChild(m);

          const btnContainer = document.createElement('div');
          btnContainer.className = 'cute-alert-buttons';

          const confirmBtn = document.createElement('button');
          confirmBtn.className = 'confirm-btn';
          confirmBtn.innerText = confirmText;

          const cancelBtn = document.createElement('button');
          cancelBtn.className = 'cancel-btn';
          cancelBtn.innerText = cancelText;

          btnContainer.appendChild(confirmBtn);
          btnContainer.appendChild(cancelBtn);
          box.appendChild(btnContainer);

          overlay.appendChild(box);

          requestAnimationFrame(() => overlay.classList.add('active'));

          confirmBtn.addEventListener('click', () => {
            overlay.classList.remove('active');
            setTimeout(() => { document.body.removeChild(overlay); resolve(true); }, 250);
          });
          cancelBtn.addEventListener('click', () => {
            overlay.classList.remove('active');
            setTimeout(() => { document.body.removeChild(overlay); resolve(false); }, 250);
          });
        });
      };
    }
    </script>

    <!-- ===== 페이지 스크립트 (alert → cuteAlert 치환) ===== -->
    <script th:inline="none">
    (() => {
      let gridApi;

      // ===== CSRF 설정 =====
      (function initCsrf(){
        try{
          const token  = document.querySelector('meta[name="_csrf"]')?.content;
          const header = document.querySelector('meta[name="_csrf_header"]')?.content || 'X-CSRF-TOKEN';
          if (token) axios.defaults.headers.common[header] = token;
        }catch(e){ console.warn('CSRF 메타 없음(무시 가능)'); }
      })();

      // 상수
      const TAX_TYPES = ['전액과세','비과세','부분비과세','식대','보육수당'];
      const PAY_TYPES = ['고정','변동'];

      // 유틸
      const isBlank = (v) => v === null || v === undefined || String(v).trim() === '';
      const trim = (v) => (v ?? '').toString().trim();

      function newInputRow(){
        return {
          _isInput: true,
          allowCode: '',
          allowName: '',
          taxType: TAX_TYPES[0],
          payType: PAY_TYPES[0],
          methodDesc: '',
          useYn: 'Y'
        };
      }
      function isInsertSavable(r){ return r?._isInput && !isBlank(r.allowCode) && !isBlank(r.allowName); }
      function isUpdateSavable(r){ return !r?._isInput && !isBlank(r.allowCode) && !isBlank(r.allowName); }

      // ===== API =====
      function ok(res){
        const s = res?.status ?? 0;
        if (s >= 200 && s < 300) return true;
        const d = res?.data;
        return d === 1 || d === '1' || d === true || d?.success === true;
      }

      async function fetchList() {
    	  showLoader("allowGridWrapper", "수당 데이터를 불러오는 중입니다...");
    	  try {
    	    const res = await axios.get('/api/hr/allow-codes');
    	    const payload = res.data;
    	    return Array.isArray(payload) ? payload : (payload?.data ?? []);
    	  } catch (e) {
    	    console.error('목록 조회 실패', e);
    	    await cuteAlert({
    	      type: 'error',
    	      title: '조회 실패',
    	      message: '수당 코드 목록 조회 중 오류가 발생했습니다.'
    	    });
    	    return [];
    	  } finally {
    	    hideLoader("allowGridWrapper");
    	  }
    	}
  
      async function insertRow(r){
        const payload = {
          allowCode: trim(r.allowCode),
          allowName: trim(r.allowName),
          taxType:   trim(r.taxType),
          payType:   trim(r.payType),
          methodDesc:trim(r.methodDesc),
          useYn:     trim(r.useYn || 'Y')
        };
        const res = await axios.post('/api/hr/allow-codes', payload, { validateStatus:s=>s>=200&&s<500 });
        return ok(res);
      }
      
     
      async function updateRow(r){
        const payload = {
          allowName: trim(r.allowName),
          taxType:   trim(r.taxType),
          payType:   trim(r.payType),
          methodDesc:trim(r.methodDesc),
          useYn:     trim(r.useYn || 'Y')
        };
        const res = await axios.put(`/api/hr/allow-codes/${encodeURIComponent(r.allowCode)}`, payload, { validateStatus:s=>s>=200&&s<500 });
        return ok(res);
      }
      async function patchUseYn(code, yn){
        const res = await axios.patch(`/api/hr/allow-codes/${encodeURIComponent(code)}/use-yn`, null, {
          params:{ useYn: yn }, validateStatus:s=>s>=200&&s<500
        });
        return ok(res);
      }

      // 사용/중지 토글 렌더러(입력행에는 버튼 X)
      function useToggleRenderer(p){
        if (p.data?._isInput) return document.createTextNode('');
        const btn = document.createElement('button');
        btn.type = 'button';
        const cur = (p.value ?? 'Y');
        btn.className = 'btn btn-sm btn-use ' + (cur === 'Y' ? 'btn-success' : 'btn-danger');
        btn.textContent = (cur === 'Y' ? '사용' : '중지');

        btn.addEventListener('click', async () => {
          const row = p.data;
          const next = (row.useYn ?? 'Y') === 'Y' ? 'N' : 'Y';

          // 화면 즉시 반영
          row.useYn = next;
          btn.className = 'btn btn-sm btn-use ' + (next === 'Y' ? 'btn-success' : 'btn-danger');
          btn.textContent = (next === 'Y' ? '사용' : '중지');

          try{
            const okk = await patchUseYn(row.allowCode, next);
            if(!okk) throw new Error();
          }catch(e){
            // 실패 시 원복 + 알림
            const prev = next === 'Y' ? 'N' : 'Y';
            row.useYn = prev;
            btn.className = 'btn btn-sm btn-use ' + (prev === 'Y' ? 'btn-success' : 'btn-danger');
            btn.textContent = (prev === 'Y' ? '사용' : '중지');
            console.error('사용여부 변경 실패', e);
            await cuteAlert({
              type: 'error',
              title: '실패',
              message: '사용여부 변경에 실패했습니다.'
            });
          }
        });

        return btn;
      }

      // 정렬 후 입력행을 항상 마지막으로 유지
      function keepInputRowAtEnd(params){
        const nodes = params.nodes;
        const inputNodes = [];
        for(let i = nodes.length - 1; i >= 0; i--){
          const n = nodes[i];
          if(n?.data?._isInput){
            inputNodes.push(n);
            nodes.splice(i, 1);
          }
        }
        inputNodes.forEach(n => nodes.push(n));
      }

      document.addEventListener('DOMContentLoaded', async () => {
        const columnDefs = [
          {
            headerName:'수당 항목코드',
            field:'allowCode',
            width:140,
            editable:(p)=> p.data?._isInput === true,
            valueSetter:(p)=>{ p.data.allowCode = trim(p.newValue).toUpperCase(); return true; }
          },
          {
            headerName:'수당 항목',
            field:'allowName',
            minWidth:160, flex:1, editable:true,
            valueSetter:(p)=>{ p.data.allowName = trim(p.newValue); return true; }
          },
          {
            headerName:'비과세 유형',
            field:'taxType',
            width:140, editable:true,
            cellEditor:'agSelectCellEditor',
            cellEditorParams:{ values:TAX_TYPES }
          },
          {
            headerName:'지급유형',
            field:'payType',
            width:110, editable:true,
            cellEditor:'agSelectCellEditor',
            cellEditorParams:{ values:PAY_TYPES }
          },
          {
            headerName:'산출방법',
            field:'methodDesc',
            minWidth:240, flex:1.5, editable:true,
            valueSetter:(p)=>{ p.data.methodDesc = trim(p.newValue); return true; }
          },
          {
            headerName:'사용 여부',
            field:'useYn',
            width:120,
            editable:(p)=> p.data?._isInput === true,  // 입력행만 수동 선택 가능
            cellEditor:'agSelectCellEditor',
            cellEditorParams:{ values:['Y','N'] },
            cellRenderer: useToggleRenderer
          }
        ];

        const gridOptions = {
          columnDefs,
          rowData: [],
          pagination: true,
          paginationPageSize: 20,
          defaultColDef: { resizable:true, filter:false, sortable:true },
          editType: 'fullRow',
          singleClickEdit: true,
          stopEditingWhenCellsLoseFocus: true,
          sortModel: [{ colId:'allowCode', sort:'asc' }],
          postSortRows: keepInputRowAtEnd,

          onCellKeyDown: (ev) => {
            if (ev.event?.key === 'Enter') {
              ev.api.stopEditing();
            }
          },

          onRowValueChanged: async (ev) => {
            const d = ev.data;
            try {
              if (isInsertSavable(d)) {
                const okk = await insertRow(d);
                if(!okk) throw new Error('insert fail');

                const rows = await fetchList();
                gridApi.setRowData([...rows, newInputRow()]);
                await cuteAlert({
                  type: 'success',
                  title: '등록 완료',
                  message: '수당 항목이 등록되었습니다.'
                });
              } else if (isUpdateSavable(d)) {
                const okk = await updateRow(d);
                if(!okk) throw new Error('update fail');

                gridApi.refreshClientSideRowModel('sort');
                await cuteAlert({
                  type: 'success',
                  title: '수정 완료',
                  message: '수당 항목이 수정되었습니다.'
                });
              } else {
                if (d?._isInput) {
                  await cuteAlert({
                    type: 'warning',
                    title: '입력 필요',
                    message: '코드와 항목명을 입력하세요.'
                  });
                }
              }
            } catch(err){
              console.error('저장 실패', err);
              await cuteAlert({
                type: 'error',
                title: '저장 실패',
                message: '서버 응답을 확인해주세요.'
              });
            }
          },

          onGridReady: async (params) => {
            gridApi = params.api;
            try{
              const rows = await fetchList();
              gridApi.setRowData([...rows, newInputRow()]);
            }catch(e){
              console.error('목록 조회 실패', e);
              gridApi.setRowData([newInputRow()]);
              await cuteAlert({
                type: 'error',
                title: '조회 실패',
                message: '목록 조회 중 오류가 발생했습니다.'
              });
            }
          }
        };

        new agGrid.Grid(document.getElementById('allowGrid'), gridOptions);
      });
    })();
    </script>
  </th:block>
</body>
</html>
