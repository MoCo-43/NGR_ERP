<!-- templates/hr/codeLookup.html -->
<th:block th:fragment="codeLookupModal">
	<!-- 공통코드 선택 모달 -->
	<div class="modal fade" id="codeLookupModal" tabindex="-1"
		aria-hidden="true">
		<div
			class="modal-dialog modal-lg modal-dialog-scrollable code-lookup-modal">
			<div class="modal-content">

				<div class="modal-header">
					<h5 class="modal-title" id="codeLookupTitle">공통코드 선택</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"
						aria-label="닫기"></button>
				</div>

				<div class="modal-body p-2">
					<!-- ag-Grid 컨테이너 -->
					<div id="lookupGrid" class="ag-theme-quartz"
						style="height: 300px; width: 100%;"></div>
				</div>

				<div class="modal-footer">
					<small class="text-secondary me-auto">행을 <b>더블클릭</b>하면
						선택됩니다.
					</small>
					<button type="button" class="btn btn-secondary"
						data-bs-dismiss="modal">닫기</button>
				</div>

			</div>
		</div>
	</div>

<style>

.code-lookup-dialog {
  max-width: 360px !important;  
}

#lookupGrid.ag-theme-quartz {
  --ag-row-height: 28px;
  --ag-header-height: 30px;
  font-size: 12px;
}
</style>


	<script>
    // 전역 네임스페이스
    window.CodeLookup = (function () {
      let bsModal;
      let gridApi;
      let gridInitialized = false;

      // 현재 컨텍스트: groupId=RK/PO/BK, targetId(코드ID 넣을 인풋), targetNameId(코드명 넣을 인풋)
      let current = { groupId:'RK', title:'공통코드 선택', targetId:null, targetNameId:null };

      // ====== 외부에서 호출: CodeLookup.open({...}) ======
    async function open(opts = {}) {
  current.groupId      = opts.groupId      || current.groupId;
  current.source       = opts.source       || null;   
  current.title        = opts.title        || titleByGroup(current.groupId);
  current.targetId     = opts.targetId     || null;
  current.targetNameId = opts.targetNameId || null;

        // 제목 세팅
        const titleEl = document.getElementById('codeLookupTitle');
        if (titleEl) titleEl.textContent = current.title;

        // 모달 준비 및 표시
        const modalEl = document.getElementById('codeLookupModal');
        bsModal = bsModal || new bootstrap.Modal(modalEl);
        bsModal.show();

        await refresh();
      }

      // ====== 유틸: 그룹별 기본 타이틀 ======
      function titleByGroup(gid){
        if(gid === 'RK') return '직급 선택';
        if(gid === 'PO') return '직책 선택';
        if(gid === 'BK') return '은행 선택';
        return '공통코드 선택';
      }

      // ====== 그리드 초기화 / 재생성 ======
      function initGrid(rows){
        const gridDiv = document.getElementById('lookupGrid');

        // 컬럼: 기본(코드ID/코드명/사용), BK(은행명만)
        const defaultCols = [
          { headerName:'코드(ID)', field:'codeId', width:120 },
          { headerName:'코드명',   field:'codeName', flex:1, minWidth:200 },
          { headerName:'사용',     field:'useYn', width:100 }
        ];
        const bankCols = [
          { headerName:'은행명', field:'codeName', flex:1, minWidth:240 }
        ];
        const columnDefs = (current.groupId === 'BK') ? bankCols : defaultCols;

        const gridOptions = {
          columnDefs,
          rowData: rows || [],
          pagination: true,
          paginationPageSize: 10,
          animateRows: true,
          defaultColDef: { resizable:true, sortable:true },
          onRowDoubleClicked: (p)=> pick(p.data)
        };

        // 이전 인스턴스 있으면 정리
        if (gridApi && typeof gridApi.destroy === 'function') {
          gridApi.destroy();
          gridApi = null;
        }

        // ag-Grid v31+: createGrid, 구버전: new Grid
        if (window.agGrid && typeof window.agGrid.createGrid === 'function') {
          gridApi = window.agGrid.createGrid(gridDiv, gridOptions);
        } else {
          new agGrid.Grid(gridDiv, gridOptions);
          gridApi = gridOptions.api;
        }
        gridInitialized = true;
      }

      // ====== 선택 처리 (더블클릭) ======
      function pick(row){
        if (!row) return;

        // 코드ID(예: BK는 숫자코드), 코드명(예: 신한은행/과장/팀장)
        if (current.targetId) {
          const t = document.getElementById(current.targetId);
          if (t) { t.value = row.codeId ?? ''; t.dispatchEvent(new Event('change')); }
        }
        if (current.targetNameId) {
          const n = document.getElementById(current.targetNameId);
          if (n) { n.value = row.codeName ?? ''; n.dispatchEvent(new Event('change')); }
        }

        // 외부에서 필요하면 이벤트 구독
        window.dispatchEvent(new CustomEvent('code-picked', { detail: { ...row, ...current }}));

        if (bsModal) bsModal.hide();
      }

      async function refresh(){
    	  let rows = [];
    	  if (current.source === 'dept') {
    	    const res = await fetch('/api/hr/dept');
    	    const raw = res.ok ? await res.json() : [];
    	    rows = raw.map(r => ({
    	      codeId:   r.dept_code,
    	      codeName: r.dept_name,
    	      useYn:    r.use_yn
    	    }));
    	  } else {
    	    const url = '/api/common-codes?groupId=' + encodeURIComponent(current.groupId);
    	    const res = await fetch(url);
    	    rows = res.ok ? await res.json() : [];
    	  }

    	  // ✅ 꼭 필요
    	  initGrid(rows);
    	}
      

      return { open };
    })();
  </script>
</th:block>
