<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/base}">
<head>
<title layout:fragment="title">부서관리</title>

<th:block layout:fragment="head_extra">
	<link rel="stylesheet"
		href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/styles/ag-grid.css" />
	<link rel="stylesheet"
		href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/styles/ag-theme-quartz.css" />
	<meta name="_csrf" th:content="${_csrf?.token}" />
	<meta name="_csrf_header" th:content="${_csrf?.headerName}" />

	<style>
.two-col {
	display: grid;
	gap: var(--gap);
	grid-template-columns: minmax(520px, 1fr) minmax(420px, 480px);
}

#deptGrid.ag-theme-quartz {
	height: 32rem;
	width: 100%;
}

.ag-theme-quartz {
	--ag-row-height: 42px;
	--ag-font-size: 13px;
}

.ag-header-cell-label {
	white-space: nowrap;
}

.form-label {
	font-weight: 600;
}

.btn-use {
	padding: .2rem .6rem;
	font-size: 12px;
}

.two-col>.card {
	margin-bottom: 0 !important;
}
</style>
</th:block>
</head>

<body>
	<section layout:fragment="content">
		<div class="two-col">
			<div class="card shadow mb-0">
				<div class="card-header py-3">
					<h6 class="m-0 font-weight-bold text-primary">부서 목록</h6>
				</div>
				<div class="card-body">
					<div id="deptGrid" class="ag-theme-quartz"></div>
				</div>
			</div>
			<div class="card shadow mb-3">
				<div class="card-header py-3">
					<h6 class="m-0 font-weight-bold text-primary">부서 등록/수정</h6>
				</div>

				<div class="card-body">
					<form id="deptForm" onsubmit="return false;">
						<input type="hidden" id="mode" value="create" /> <input
							type="hidden" id="use_yn" value="Y" />
						<div class="row g-3">
							<div class="col-md-6">
								<label class="form-label" for="dept_code">부서코드</label> <input
									id="dept_code" type="text" class="form-control"
									placeholder="자동생성" disabled>
							</div>
							<div class="col-md-6">
								<label class="form-label" for="dept_name">부서명</label> <input
									id="dept_name" type="text" class="form-control" required>
							</div>
							<div class="col-md-6">
								<label class="form-label" for="member_cnt">인원수</label> <input
									id="member_cnt" type="number" class="form-control" value="0"
									min="0">
							</div>
							<div class="col-md-6">
								<label class="form-label" for="manager_emp_id">부서장 사번</label>
								<div class="input-group">
									<input id="manager_emp_id" type="text" class="form-control"
										placeholder="예) EMP-2025-001">
									<button class="btn btn-outline-secondary" type="button"
										id="btnFindManager" title="사원검색">
										<i class="fa fa-magnifying-glass"></i>
									</button>
								</div>
							</div>
						</div>
					</form>
				</div>

				<div class="d-flex justify-content-end gap-3 my-2 mr-2">
					<button type="button" class="btn btn-success mr-2" id="btnSave">저장</button>
					<button type="button" class="btn btn-danger" id="btnFormReset">초기화</button>
				</div>
			</div>
		</div>

		<!-- 부서장 선택 모달 -->
		<th:block th:replace="~{hr/deptModal :: deptManagerLookupModal}"></th:block>
	</section>

	<th:block layout:fragment="body_extra">
		<script defer
			src="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/dist/ag-grid-community.min.js"></script>
		<script defer
			src="https://cdn.jsdelivr.net/npm/axios@1.7.7/dist/axios.min.js"></script>

		<script th:inline="none">
  document.addEventListener('DOMContentLoaded', () => {
    // 기본 상수/DOM
    const API_BASE = '/api/hr/dept'; // 서버 REST 엔드포인트 기본 경로
    const CSRF_TOKEN  = document.querySelector('meta[name="_csrf"]')?.content;
    const CSRF_HEADER = document.querySelector('meta[name="_csrf_header"]')?.content;

    const gridDiv        = document.getElementById('deptGrid');      // 그리드 컨테이너
    const btnFormReset   = document.getElementById('btnFormReset');  // 폼 초기화 버튼
    const btnSave        = document.getElementById('btnSave');       // 저장 버튼
    const btnFindManager = document.getElementById('btnFindManager');// 부서장 검색 버튼

    let gridApi = null; // ag-Grid API 참조

    // 공통 함수
    // CSRF 헤더를 axios 요청에 붙일 때 사용
    function buildHeaders() {
      const headers = { 'Content-Type':'application/json' };
      if (CSRF_TOKEN && CSRF_HEADER) headers[CSRF_HEADER] = CSRF_TOKEN;
      return { headers };
    }

    // DOM 헬퍼: id로 요소 가져오기/값 읽기/쓰기
    const $ = (id) => document.getElementById(id);
    const getVal = (id) => $(id)?.value;
    const setVal = (id, v = '') => { const el = $(id); if (el) el.value = v ?? ''; };
    
    // 셀 렌더러: 사용여부 토글 버튼
    // 그리드에서 "사용(Y)" / "중지(N)" 상태를 클릭 으로 서버에 반영
    function useToggleRenderer(p){
      const btn = document.createElement('button');
      btn.type = 'button';
      const yn = (p.value ?? 'Y');                                      // 현재 값(Y/N)
      btn.className  = 'btn btn-sm btn-use ' + (yn === 'Y' ? 'btn-success' : 'btn-danger');
      btn.textContent = (yn === 'Y' ? '사용' : '중지');

      btn.addEventListener('click', async () => {
        const row  = p.data;                                            // 현재 행 데이터
        const next = (row.use_yn ?? 'Y') === 'Y' ? 'N' : 'Y';           // 토글 이후 값

        // 클릭 즉시 화면에 먼저 반영(속도 ↑)
        row.use_yn = next;
        btn.className  = 'btn btn-sm btn-use ' + (next === 'Y' ? 'btn-success' : 'btn-danger');
        btn.textContent = (next === 'Y' ? '사용' : '중지');

        try{
          // 서버에 변경 요청
          await axios.put(`${API_BASE}/${encodeURIComponent(row.dept_code)}`, { use_yn: next }, buildHeaders());
        }catch(e){
          const prev = next === 'Y' ? 'N' : 'Y';
          row.use_yn = prev;
          btn.className  = 'btn btn-sm btn-use ' + (prev === 'Y' ? 'btn-success' : 'btn-danger');
          btn.textContent = (prev === 'Y' ? '사용' : '중지');
          alert('사용여부 변경에 실패했습니다.');
        }
      });
      return btn;
    }
	
    //그리드
    const columnDefs = [
      // 체크박스 컬럼
      { headerName:'', width:60, checkboxSelection:true, filter:false, suppressMenu:true, pinned:'left' },
      // 실제 데이터 컬럼들
      { headerName:'부서코드', field:'dept_code',   width:140, sortable:true },
      { headerName:'부서명',   field:'dept_name',   flex:1, minWidth:160, sortable:true },
      { headerName:'사용',     field:'use_yn',      width:100, sortable:false, cellRenderer: useToggleRenderer },
      { headerName:'부서장',   field:'manager_name',width:140, sortable:true },
      { headerName:'인원수',   field:'member_cnt',  width:100, sortable:true, type:'numericColumn' }
    ];

    const gridOptions = {
      columnDefs,
      rowData: [],
      rowSelection: 'single',                            // 한 행만 선택
      pagination: true,
      paginationPageSize: 12,
      defaultColDef: { sortable:true, resizable:true, filter:false, suppressMenu:true },
      onGridReady: (params) => {                         // 그리드 준비되면 목록 조회
        gridApi = params.api;
        fetchList();
      },
      onSelectionChanged: () => {                        // 선택이 바뀌면 폼에 채워넣기
        const rows = gridApi.getSelectedRows();
        if (rows && rows[0]) fillForm(rows[0]);
      },
      onRowDoubleClicked: (e) => fillForm(e.data)        // 더블클릭으로도 폼 채우기
    };

 	//ag-Grid
    if (window.agGrid?.createGrid) {
      gridApi = agGrid.createGrid(gridDiv, gridOptions);
    } else {
      new agGrid.Grid(gridDiv, gridOptions);
      gridApi = gridOptions.api;
    }

    // 부서 목록을 서버에서 가져와 그리드에 표시
    async function fetchList(){
      try{
        const { data } = await axios.get(API_BASE);
        const rows = Array.isArray(data) ? data : (data?.data ?? []);
        if (gridApi?.setGridOption) gridApi.setGridOption('rowData', rows);
        else gridApi.setRowData(rows);
      }catch(e){
        alert('부서 목록 조회 중 오류가 발생했습니다.');
        if (gridApi?.setGridOption) gridApi.setGridOption('rowData', []);
        else gridApi.setRowData([]);
      }
    }

    // 현재 폼의 값으로 신규 생성 또는 수정 저장
    async function save(){
      const mode = getVal('mode');                       
      const payload = {
        dept_name: (getVal('dept_name') || '').trim(),
        use_yn: getVal('use_yn') || 'Y',
        member_cnt: Number(getVal('member_cnt') || 0),
        manager_emp_id: (getVal('manager_emp_id') || '').trim() || null
      };
      if(!payload.dept_name){ alert('부서명을 입력하세요.'); return; }

      try{
        if(mode === 'create'){
          // 신규 등록
          await axios.post(API_BASE, payload, buildHeaders());
        } else {
          // 수정
          const code = getVal('dept_code');
          await axios.put(`${API_BASE}/${encodeURIComponent(code)}`, payload, buildHeaders());
        }
        await fetchList();   // 저장 후 목록 갱신
        openCreate();        // 폼 초기화
        alert('저장되었습니다.');
      }catch(e){
        alert('저장 중 오류가 발생했습니다.');
      }
    }

    // 신규 입력모드로 폼 비우기
    function openCreate(){
      setVal('mode','create');        // 신규모드
      setVal('dept_code');            // 자동생성(비활성 입력)
      setVal('dept_name');            // 부서명
      setVal('use_yn','Y');           // 기본값 Y
      setVal('member_cnt', 0);        // 인원수 0
      setVal('manager_emp_id');       // 부서장 사번
      gridApi?.deselectAll?.();       // 그리드 선택 해제
    }

    // 선택한 행 데이터를 폼에 채우기(수정모드)
    function fillForm(r){
      setVal('mode','update');
      setVal('dept_code',      r.dept_code || '');
      setVal('dept_name',      r.dept_name || '');
      setVal('use_yn',         r.use_yn ?? 'Y');
      setVal('member_cnt',     r.member_cnt ?? 0);
      setVal('manager_emp_id', r.manager_emp_id || '');
    }

    // 이벤트 바인딩
    btnFormReset.addEventListener('click', openCreate);         // 초기화 클릭 → 신규모드
    btnSave.addEventListener('click', save);                    // 저장 클릭 → 저장 API 호출
    btnFindManager.addEventListener('click', () => {            // 부서장 찾기 모달 열기
      window.DeptManagerLookup?.open?.({ targetId: 'manager_emp_id' });
    });
    openCreate();
  });
  </script>
	</th:block>
</body>
</html>
