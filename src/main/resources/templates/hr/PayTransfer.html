<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layout/base}">
<head>
<title layout:fragment="title">급여 이체현황</title>

<th:block layout:fragment="head_extra">
  <link rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/styles/ag-grid.css" />
  <link rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/styles/ag-theme-quartz.css" />
  <style>
.toolbar {
  padding: 1rem 1rem .25rem 1rem;
}

#transferGrid.ag-theme-quartz {
  height: 32rem;
  width: 100%;
}

.toolbar .form-control {
  height: 38px;
  font-size: .95rem;
  line-height: 1.4;
}

#total-area {
  padding: .75rem 1rem;
  background: #f8f9fa;
  font-weight: bold;
  text-align: right;
  color: navy;
}

.ag-row-pinned.ag-row {
  font-weight: 700;
  background: #f8fafc;
  border-bottom: 2px solid #e5e7eb;
}
  </style>
</th:block>
</head>

<body>
  <section layout:fragment="content">
    <div class="card shadow mb-3">
      <div class="card-header py-3 d-flex justify-content-between align-items-center">
        <h6 class="m-0 font-weight-bold text-primary">급여 이체현황</h6>
        <button id="btnExportPdf" class="btn btn-outline-danger btn-sm"  >PDF</button>
      </div>

      <!-- 검색 영역 -->
      <div class="toolbar">
        <div class="row g-2 align-items-center">
          <div class="col-12 col-sm-4 col-xl-3">
            <input id="srchMonth" type="month" class="form-control" placeholder="귀속연월">
          </div>
          <div class="col-12 col-sm-4 col-xl-3">
            <input id="srchDept" class="form-control" placeholder="부서명">
          </div>
          <div class="col-12 col-xl-auto">
            <div class="actions">
              <button class="btn btn-dark btn-sm" id="btnSearch">조회</button>
              <button class="btn btn-danger btn-sm" id="btnReset">초기화</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card-body pt-3">
        <div id="paytransferGridWrapper" style="position:relative;">
          <div id="transferGrid" class="ag-theme-quartz"></div>
        </div>
      </div>
      <div id="total-area">총 합계: 0 원</div>
    </div>

  </section>

  <th:block layout:fragment="body_extra">
    <script src="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/dist/ag-grid-community.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.7.7/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

    <script th:inline="none">
  document.addEventListener('DOMContentLoaded', () => {
    // API: 회사코드 
    const API_VIEW = '/api/hr/pay-transfer/view'; // 급여 이체현황을 조회할 백엔드 API 엔드포인트

    const gridDiv = document.getElementById('transferGrid'); // ag-Grid가 렌더링될 컨테이너
    const btnSearch = document.getElementById('btnSearch'); // 조회 
    const btnReset = document.getElementById('btnReset'); // 초기화 
    const btnExportPdf = document.getElementById('btnExportPdf'); // PDF 
    const srchMonth = document.getElementById('srchMonth'); // 월 입력
    const srchDept = document.getElementById('srchDept'); // 부서명 입력

    let gridApi = null; // ag-Grid API 핸들(데이터/페이지 이동 등 제어용)
    let rowDataCache = []; // 서버에서 가져온 원본 데이터 캐시(월 기준 전체)

    const columnDefs = [
      { headerName:'은행명', field:'bankName', flex:1 }, // 은행명
      { headerName:'계좌번호', field:'accountNo', flex:1 }, // 계좌번호
      { headerName:'예금주', field:'accountHolder', flex:1 }, // 예금주
      { headerName:'부서명', field:'deptName', flex:1 }, // 부서명
      { headerName:'실지급액', field:'netPay', flex:1,
        valueFormatter:(p)=> p.value ? Number(p.value).toLocaleString() + ' 원' : '' }, // 실지급액
      { headerName:'사원번호', field:'empId', flex:1 }, // 사원번호
      { headerName:'급여연월', field:'payYm', flex:1 }, // 급여연월
    ];

    const gridOptions = {
      columnDefs, // 컬럼 정의
      rowData: [], // 초기 데이터 없음
      pagination: true, // 페이지네이션 사용
      paginationPageSize: 50, // 페이지당 
      defaultColDef: { sortable:true, resizable:true, filter:false, suppressMenu:true }, // 기본 컬럼 옵션
      onGridReady: (params) => { gridApi = params.api; initLoad(); } // 그리드 준비 시 초기 로드 실행
    };

    new agGrid.Grid(gridDiv, gridOptions); // 그리드 인스턴스 생성

    async function initLoad(){
      const now = new Date(); // 현재 날짜
      srchMonth.value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`; // 기본 월 값을 현재월로 세팅(yyyy-MM)
      await loadFromServer(); // 서버에서 해당 월 데이터 최초 조회
    }

    //이체현황 조회
    async function loadFromServer(){
      showLoader("paytransferGridWrapper", "급여이체 데이터를 불러오는 중입니다...");
      try {
        const payYm = srchMonth.value.replace('-', '');
        const url = `${API_VIEW}?payYm=${encodeURIComponent(payYm)}`;
        const { data } = await axios.get(url);
        rowDataCache = Array.isArray(data) ? data : (data?.data ?? []);
        applyRows(); // 데이터 적용
      } catch (e) {
        console.error('이체현황 조회 실패', e);
        toastr.error('이체현황 조회 중 오류가 발생했습니다.');
        rowDataCache = [];
        applyRows();
      } finally {
        hideLoader("paytransferGridWrapper"); 
      }
    }
    
    function getFilteredRows(){
      const deptVal = (srchDept?.value || '').trim().toLowerCase(); // 부서명 검색어
      return (rowDataCache || []).filter(r => { // 원본 캐시에서 프론트 필터  
        const deptName = (r.deptName ?? r.DEPT_NAME ?? '').toString().toLowerCase();
        return !deptVal || deptName.includes(deptVal); // 검색어 없으면 통과, 있으면 포함 여부 검사
      });
    }
    
    function applyRows(){
      const filtered = getFilteredRows();  // 부서명으로 필터링
      gridApi.setRowData(filtered); // 그리드에 필터된 데이터 반영
      gridApi.paginationGoToFirstPage(); // 첫 페이지로 이동
      updateTotal(filtered);             // 필터 결과 기준으로 합계 갱신
    }

    function updateTotal(rows){
      const list = rows || []; // 합계를 계산할 대상 배열
      const total = list.reduce((sum, r) => sum + (Number(r.netPay) || 0), 0); // netPay 합계
      document.getElementById('total-area').textContent = `총 합계: ${total.toLocaleString()} 원`; // 합계 표시
    }

    function doReset(){
      const now = new Date(); // 현재 날짜
      srchMonth.value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`; // 월을 현재월로 리셋
      if (srchDept) srchDept.value = '';    // 부서 검색어 리셋
      loadFromServer(); // 현재월 기준으로 서버 재조회
    }

    btnSearch.addEventListener('click', loadFromServer); // 조회 버튼: 서버에서 선택 월 데이터 다시 가져오기
    btnReset.addEventListener('click', doReset); // 초기화 버튼: 월/부서 리셋 후 서버 재조회

    // PDF 
    let __krFontBase64 = null; // 폰트
    const KR_FONT_URL = '/fonts/NotoSansKR-Regular.ttf'; // 한글 폰트 경로

    async function __fetchAsBase64(url) {
      const res = await fetch(url, { cache: 'force-cache' }); // 폰트 파일을 fetch로 가져오기
      if (!res.ok) throw new Error('Font fetch failed: ' + res.status); // 응답 실패 시 에러
      const buf = await res.arrayBuffer(); // 바이너리 버퍼로 변환
      let binary = '';
      const bytes = new Uint8Array(buf);
      for (let i = 0; i < bytes.byteLength; i++) binary += String.fromCharCode(bytes[i]); // 바이너리를 문자열로 변환
      return btoa(binary); // Base64 인코딩
    }
    async function __ensureKoreanFont() {
      if (__krFontBase64) return __krFontBase64; // 이미 로드되어 있으면 그대로 반환
      __krFontBase64 = await __fetchAsBase64(KR_FONT_URL); // 없으면 로드
      return __krFontBase64;
    }

    // PDF 
    btnExportPdf.addEventListener('click', async () => {
      const jsPDFCtor = (window.jspdf && window.jspdf.jsPDF) || window.jsPDF; // jsPDF 생성자
      if (!jsPDFCtor) {  toastr.warning('jsPDF가 로드되지 않았습니다.'); return; } // jsPDF 로드 확인
      if (!('autoTable' in (jsPDFCtor.API || {}))) {  toastr.warning('jspdf-autotable이 로드되지 않았습니다.'); return; }

      // 제목 라벨
      const monthVal = srchMonth.value; // 현재 선택된 월
      const payYm = monthVal ? monthVal.replace('-', '') : ''; 
      const label = payYm ? `${payYm.slice(0,4)}-${payYm.slice(4)} 기준` : ''; // 제목(yyyy-mm 기준)

      // 표 데이터 
      const body = (rowDataCache || []).map(r => ([ // 현재는 원본 전체를 PDF로 출력
        r.bankName ??  '',
        r.accountNo ?? '',
        r.accountHolder ?? '',
        r.deptName ?? r.DEPT_NAME ?? '',
        r.netPay ? Number(r.netPay).toLocaleString() : '',
        r.empId ?? '',
        r.payYm ?? ''
      ]));
      
      const total = (rowDataCache || []).reduce((sum, r) => sum + (Number(r.netPay) || 0), 0); // PDF 하단에 표기할 총 합계

      const doc = new jsPDFCtor({ orientation: 'landscape', unit: 'pt', format: 'a4' }); // 가로방향 A4 PDF 문서

      try {
        // 한글 폰트 등록
        const base64 = await __ensureKoreanFont(); // 폰트 Base64 확보
        doc.addFileToVFS('NotoSansKR-Regular.ttf', base64); // 가상 파일 시스템에 폰트 추가
        doc.addFont('NotoSansKR-Regular.ttf', 'NotoSansKR', 'normal'); // 폰트 이름 등록
        doc.setFont('NotoSansKR'); // 폰트 적용

        // 제목
        doc.setFontSize(14); // 제목 폰트 크기
        doc.text(`급여 이체현황 ${label ? '(' + label + ')' : ''}`, 40, 40); // 제목 텍스트 출력

        // 표
        doc.setFontSize(10); // 표 기본 폰트 크기
        doc.autoTable({
          startY: 60, 
          head: [['은행명', '계좌번호', '예금주', '부서명', '실지급액', '사원번호', '급여연월']], // 헤더
          body, // 본문 
          theme: 'striped', // 스트라이프 테마
          styles: { font: 'NotoSansKR', fontSize: 9, cellPadding: 4 }, // 표 스타일(폰트/크기/패딩)
          headStyles: { font: 'NotoSansKR', fillColor: [55, 65, 81], textColor: 255 }, // 헤더 스타일(배경/글자색)
          columnStyles: {
            0: { cellWidth: 90 },   // 은행명
            1: { cellWidth: 180 },  // 계좌번호
            2: { cellWidth: 120 },  // 예금주
            3: { cellWidth: 120 },  // 부서명
            4: { halign: 'left', cellWidth: 110 }, // 실지급액
            5: { cellWidth: 120 },  // 사원번호
            6: { cellWidth: 90 }    // 급여연월
          },
          didDrawPage: () => { // 각 페이지가 그려질 때마다 실행되는 콜백
            const y = doc.internal.pageSize.getHeight() - 20; // 페이지 하단 여백 위치 계산
            doc.setFontSize(9);
            doc.text(`총 합계: ${total.toLocaleString()} 원`, 40, y); // 총 합계 텍스트 출력
          }
        });

        // 저장
        doc.save(`급여이체현황_${payYm || ''}.pdf`); // 파일명: 급여이체현황_yyyymm.pdf
      } catch (e) {
        console.error(e); // 콘솔에 에러 출력
        toastr.error('PDF 생성 중 오류가 발생했습니다.'); // 사용자 알림
      }
    });   
  });
    </script>
  </th:block>
</body>
</html>
