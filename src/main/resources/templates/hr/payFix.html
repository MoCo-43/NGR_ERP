<div th:fragment="payFix">
  <input type="hidden" id="pf_emp_id">
  <div id="payfix-list" class="container-fluid"></div>

  <script>
  ;(function(){
    // 중복 include 방지 
    if (window.__payFix) return;

    const $ = (id)=>document.getElementById(id);
    const area = ()=> $('payfix-list');

    // 초기화 함수: empId 기준으로 수당 목록 조회 후 렌더링
    async function init(empId){
      try{
        const box = area(); 
        if(!box) return;

        // 현재 사번을 hidden input에 저장 
        if ($('pf_emp_id')) $('pf_emp_id').value = empId || '';

        // 서버에서 수당 목록 조회
        const { data } = await axios.get('/api/v1/emp-pay-fix/allow-list', { params:{ empId } });

        // 기존 항목 제거 후 새로 렌더링
        box.innerHTML = '';
        data.forEach(item=>{
          const has = item.payFixNo != null ? 'true' : 'false';
          const row = document.createElement('div');
          row.className = 'row mb-2';
          row.innerHTML = `
            <div class="col-md-6"><label class="form-label fw-bold">${item.empAllowLabel}</label></div>
            <div class="col-md-6">
              <input type="number" class="form-control"
                     data-code="${item.empAllowCode}"
                     data-has-value="${has}"
                     value="${item.empAllowPay || 0}">
            </div>`;
          box.appendChild(row);
        });
      }catch(err){
        console.error('allow-list error:', err?.response?.status, err?.response?.data || err);
        alert('수당 목록 조회 중 오류가 발생했습니다.');
      }
    }

    // 저장 함수: 신규 → POST, 기존 → PUT (empId 기준으로 동작)
    async function save(){
      const box = area(); 
      if(!box) return;

      let empId = ($('pf_emp_id')?.value || '').trim();
      if (!empId) empId = (document.getElementById('f_emp_id')?.value || '').trim();

      // empId 없으면 저장 불가
      if(!empId){
        alert('사번이 없습니다.');
        return;
      }

      const inputs = box.querySelectorAll('input[data-code]');
      const errors = [];
      for (const input of inputs){
        const code  = input.getAttribute('data-code');
        const pay   = Number(input.value) || 0;
        const label = input.closest('.row').querySelector('label')?.textContent || '';
        const body  = { empId, empAllowCode: code, empAllowLabel: label, empAllowPay: pay };
        const isUpdate = input.getAttribute('data-has-value') === 'true';

        try{
          // 기존 값이 있으면 PUT, 없으면 POST 
          if (isUpdate) await axios.put('/api/v1/emp-pay-fix', body);
          else {
            await axios.post('/api/v1/emp-pay-fix', body);
            input.setAttribute('data-has-value', 'true');
          }
        }catch(e){
          console.error(`[pay-fix save error] code=${code}, isUpdate=${isUpdate}`,
                        e?.response?.status, e?.response?.data || e);
          errors.push(code);
        }
      }

      // 하나라도 오류 발생 시 예외 처리
      if (errors.length){
        alert(`저장 중 오류가 발생했습니다.\n문제 코드: ${errors.join(', ')}`);
        throw new Error('pay-fix save failed');
      }
    }

    // 초기화 함수
    function clear(){
      const box = area(); if(box) box.innerHTML = '';
      const hid = $('pf_emp_id'); if(hid) hid.value = '';
    }

    // 전역 객체로 
    window.__payFix = { init, save, clear };
  })();
  </script>
</div>
