<div id="payFix" th:fragment="payFix">
  <form id="payFixForm" onsubmit="return false;">
    <input type="hidden" id="pf_emp_id" name="emp_id" />

    <div class="container-fluid">
      <div class="row g-3" id="pf_row">
        <div class="col-12">
          <div class="fw-bold small text-secondary">고정 수당</div>
        </div>

        <!-- 동적 필드가 여기 삽입됨 -->

        <div class="col-md-6">
          <label for="pf_total" class="form-label fw-bold">월정 금액</label>
          <input type="text" id="pf_total" class="form-control" readonly>
        </div>

        <!-- 모달 푸터: 바깥 모달 푸터와 ID 중복 방지 -->
        <div class="modal-footer" id="pf_footer">
          <button type="button" class="btn btn-success" id="pf_saveBtn">저장</button>
          <button type="button" class="btn btn-secondary" id="pf_closeBtn" data-bs-dismiss="modal">닫기</button>
        </div>
      </div>
    </div>
  </form>

  <script>
  (function(){
    // 숫자 포맷
    const nf = new Intl.NumberFormat('ko-KR');
    const toNum = (s)=> Number(String(s||'').replace(/,/g,'')) || 0;

    // CSRF 헤더(있으면 붙임)
    const CSRF_TOKEN  = document.querySelector('meta[name="_csrf"]')?.content;
    const CSRF_HEADER = document.querySelector('meta[name="_csrf_header"]')?.content;
    const hdr = () => {
      const h = { 'Content-Type': 'application/json' };
      if (CSRF_TOKEN && CSRF_HEADER) h[CSRF_HEADER] = CSRF_TOKEN;
      return h;
    };

    // 합계
    function calcTotal(){
      let sum = 0;
      document.querySelectorAll('#payFixForm input[data-allow-code]').forEach(el=>{
        sum += toNum(el.value);
      });
      const out = document.getElementById('pf_total');
      if (out) out.value = sum ? nf.format(sum) : '';
    }

    // 금액 입력 이벤트
    function bindMoneyInput(el){
      el.addEventListener('keydown', e=>{ if (e.key === 'Enter') e.preventDefault(); });
      el.addEventListener('input',  e=>{
        e.target.value = toNum(e.target.value) ? nf.format(toNum(e.target.value)) : '';
        calcTotal();
      });
      el.addEventListener('blur',   e=>{
        e.target.value = toNum(e.target.value) ? nf.format(toNum(e.target.value)) : '';
      });
    }

    // 안내 배지
    function badge(kind, text){
      const div = document.createElement('div');
      div.className = 'col-12';
      div.dataset.dynamic = 'payfix';
      div.innerHTML = `<div class="alert alert-${kind} py-2 mb-0 small">${text}</div>`;
      return div;
    }

    // 동적 필드 초기화
    function clearDynamic(){
      const row = document.getElementById('pf_row');
      row?.querySelectorAll('[data-dynamic="payfix"]').forEach(el => el.remove());
    }

    // 단일 엔드포인트에서 코드+값 받아 필드 렌더
    async function renderFromItems(empId){
      const row = document.getElementById('pf_row');
      const footer = document.getElementById('pf_footer');
      clearDynamic();

      if (!empId) {
        // 신규 사원: 사번 아직 없으면 안내만
        row.insertBefore(badge('info','사번을 먼저 저장한 뒤 급여지급사항을 등록하세요.'), footer);
        document.getElementById('pf_saveBtn')?.setAttribute('disabled','disabled');
        document.getElementById('pf_total').value = '';
        return;
      }
      document.getElementById('pf_saveBtn')?.removeAttribute('disabled');

      // 로딩
      const loading = badge('secondary','항목 불러오는 중…');
      row.insertBefore(loading, footer);

      // 호출 (⭐ 이 엔드포인트 하나만 사용)
      const url = `/api/v1/emps/${encodeURIComponent(empId)}/pay-fix/items`;
      let items = [];
      try{
        const res = await fetch(url, { headers: hdr() });
        if (!res.ok) throw new Error(`조회 실패 (HTTP ${res.status})`);
        items = await res.json(); // [{empAllowCode, empAllowLabel, empAllowPay, ...}]
      }catch(e){
        console.error(e);
        loading.replaceWith(badge('danger', e.message || '항목 조회 실패'));
        return;
      }
      loading.remove();

      if (!Array.isArray(items) || items.length === 0){
        row.insertBefore(badge('warning','표시할 고정 수당 코드가 없습니다.'), footer);
        return;
      }

      // 필드 렌더
      items.forEach(it=>{
        const code  = String(it.empAllowCode ?? it.allowCode ?? '').trim();
        const label = String(it.empAllowLabel ?? it.allowName ?? code).trim();
        const val   = Number(it.empAllowPay ?? 0);

        const col = document.createElement('div');
        col.className = 'col-md-6';
        col.dataset.dynamic = 'payfix';
        col.innerHTML = `
          <label for="pf_${code}" class="form-label">${label}</label>
          <input type="text"
                 id="pf_${code}"
                 class="form-control"
                 data-allow-code="${code}"
                 data-allow-label="${label}"
                 value="${val ? nf.format(val) : ''}">
        `;
        row.insertBefore(col, footer);
        bindMoneyInput(col.querySelector('input'));
      });

      calcTotal();
    }

    // 저장
    async function saveAll(){
      const hid = document.getElementById('pf_emp_id');
      if (hid && !hid.value) hid.value = document.getElementById('f_emp_id')?.value || '';
      const empId = hid?.value || '';
      if (!empId) throw new Error('사번이 없습니다. 기본사항을 먼저 저장하세요.');

      const items = Array.from(document.querySelectorAll('#payFixForm input[data-allow-code]')).map(el => ({
        empId,
        empAllowCode:  el.dataset.allowCode,
        empAllowLabel: el.dataset.allowLabel || '',
        empAllowPay:   toNum(el.value)
      }));

      const url = `/api/v1/emps/${encodeURIComponent(empId)}/pay-fix/items`;
      const res = await fetch(url, { method:'PUT', headers: hdr(), body: JSON.stringify(items) });
      if (!res.ok) throw new Error(`저장 실패 (HTTP ${res.status})`);
    }

    // 공개 API
    window.__payFix = {
      async init(empId){
        const finalId = empId || (document.getElementById('f_emp_id')?.value || '');
        (document.getElementById('pf_emp_id')).value = finalId;
        await renderFromItems(finalId); // ✅ 이 한 방으로 렌더+값 채움
      },
      clear(){
        clearDynamic();
        document.querySelector('#pf_total')?.value = '';
      },
      async save(){
        await saveAll(); // 알림은 버튼/모달 쪽에서
      }
    };

    // 버튼
    document.getElementById('pf_saveBtn')?.addEventListener('click', async ()=>{
      try{
        await window.__payFix.save();
        alert('저장되었습니다.');
      }catch(e){
        alert(e?.message || '저장 중 오류');
      }
    });
    document.getElementById('pf_closeBtn')?.addEventListener('click', (e)=>{
      const modalEl = e.target.closest('.modal');
      try{
        const inst = (window.bootstrap && bootstrap.Modal.getInstance(modalEl)) || (modalEl ? new bootstrap.Modal(modalEl) : null);
        inst?.hide();
      }catch(_){}
    });
  })();
  </script>
</div>
