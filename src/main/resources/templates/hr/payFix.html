<div id="payFix" th:fragment="payFix">
  <form id="payFixForm" onsubmit="return false;">
    <input type="hidden" id="pf_emp_id" name="emp_id" />

    <div class="container-fluid">
      <div class="row g-3" id="pf_row">
        <div class="col-12">
          <div class="fw-bold small text-secondary">고정 수당</div>
        </div>

        <!-- 동적 필드가 여기 삽입됨 -->

        <div class="col-md-6">
          <label for="pf_total" class="form-label fw-bold">월정 금액</label>
          <input type="text" id="pf_total" class="form-control" readonly>
        </div>

        <!-- ⚠️ 모달 푸터 ID 중복 방지: empModalFooter 사용 금지 -->
        <div class="modal-footer" id="pf_footer">
          <button type="button" class="btn btn-success" id="pf_saveBtn">저장</button>
          <button type="button" class="btn btn-secondary" id="pf_closeBtn" data-bs-dismiss="modal">닫기</button>
        </div>
      </div>
    </div>
  </form>

  <script>
  (function(){
    // 숫자 포맷
    const formatter = new Intl.NumberFormat('ko-KR');

    // CSRF
    const CSRF_TOKEN  = document.querySelector('meta[name="_csrf"]')?.content;
    const CSRF_HEADER = document.querySelector('meta[name="_csrf_header"]')?.content;
    const hdr = () => {
      const h = { 'Content-Type': 'application/json' };
      if (CSRF_TOKEN && CSRF_HEADER) h[CSRF_HEADER] = CSRF_TOKEN;
      return h;
    };

    const toNum = (s)=> Number(String(s||'').replace(/,/g,'')) || 0;

    function calcTotal(){
      let sum = 0;
      document.querySelectorAll('#payFixForm input[data-allow-code]').forEach(el=>{
        sum += toNum(el.value);
      });
      const out = document.getElementById('pf_total');
      if(out) out.value = sum ? formatter.format(sum) : '';
    }

    function attachNumeric(el){
      el.addEventListener('keydown', e => { if (e.key === 'Enter') e.preventDefault(); });
      el.addEventListener('input', e => {
        e.target.value = toNum(e.target.value) ? formatter.format(toNum(e.target.value)) : '';
        calcTotal();
      });
      el.addEventListener('blur', e => {
        e.target.value = toNum(e.target.value) ? formatter.format(toNum(e.target.value)) : '';
      });
    }

    // ✅ 고정 코드 조회 (백엔드에서 세션의 회사코드(String, 예: COM001)로 필터링되어야 함)
    async function fetchFixedCodes(){
      const res = await fetch('/api/v1/pay-allow-codes/fixed', { headers: hdr() });
      if (!res.ok) {
        const msg = `코드 조회 실패 (HTTP ${res.status})`;
        throw new Error(msg);
      }
      return res.json(); // [{allowCode, allowName, ...}]
    }

    async function fetchEmpItems(empId){
      if (!empId) return [];
      const url = `/api/v1/emps/${encodeURIComponent(empId)}/pay-fix/items`;
      const res = await fetch(url, { headers: hdr() });
      if (!res.ok) return [];
      return res.json(); // [{empAllowCode, empAllowPay, ...}]
    }

    function badge(kind, text){
      const div = document.createElement('div');
      div.className = 'col-12';
      div.dataset.dynamic = 'payfix';
      div.innerHTML = `<div class="alert alert-${kind} py-2 mb-0 small">${text}</div>`;
      return div;
    }

    async function renderFields(){
      const row = document.getElementById('pf_row');
      const footer = document.getElementById('pf_footer');
      // 기존 동적 요소 제거
      row.querySelectorAll('[data-dynamic="payfix"]').forEach(el => el.remove());

      const loading = badge('secondary','코드 불러오는 중…');
      row.insertBefore(loading, footer);

      let codes = [];
      try {
        codes = await fetchFixedCodes();
      } catch (e) {
        console.error(e);
        loading.replaceWith(badge('danger', e.message || '코드 조회 실패'));
        return;
      }

      loading.remove();

      if (!Array.isArray(codes) || codes.length === 0) {
        row.insertBefore(badge('warning','표시할 고정 수당 코드가 없습니다.'), footer);
        return;
      }

      codes.forEach(c => {
        const code  = c.allowCode || c.allow_code;
        const label = (c.allowLabel || c.allowName || c.allow_name || code || '').trim();
        const col = document.createElement('div');
        col.className = 'col-md-6';
        col.dataset.dynamic = 'payfix';
        col.innerHTML = `
          <label for="pf_${code}" class="form-label">${label}</label>
          <input type="text"
                 id="pf_${code}"
                 class="form-control"
                 data-allow-code="${code}"
                 data-allow-label="${label}">
        `;
        row.insertBefore(col, footer);
        attachNumeric(col.querySelector('input'));
      });

      calcTotal();
    }

    async function fillValues(empId){
      try {
        const items = await fetchEmpItems(empId);
        const map = new Map(items.map(it => [String(it.empAllowCode), Number(it.empAllowPay || 0)]));
        document.querySelectorAll('#payFixForm input[data-allow-code]').forEach(el=>{
          const v = map.get(el.dataset.allowCode) || 0;
          el.value = v ? formatter.format(v) : '';
        });
        calcTotal();
      } catch (e) {
        console.error(e);
      }
    }

    async function saveAll(){
      const hid = document.getElementById('pf_emp_id');
      if (hid && !hid.value) hid.value = document.getElementById('f_emp_id')?.value || '';
      const empId = hid?.value || '';
      if (!empId) return alert('사번이 없습니다.');

      const items = Array.from(document.querySelectorAll('#payFixForm input[data-allow-code]')).map(el => ({
        empId,
        empAllowCode:  el.dataset.allowCode,
        empAllowLabel: el.dataset.allowLabel || '',
        empAllowPay:   toNum(el.value)
      }));

      const url = `/api/v1/emps/${encodeURIComponent(empId)}/pay-fix/items`;
      const res = await fetch(url, { method:'PUT', headers: hdr(), body: JSON.stringify(items) });
      if (!res.ok) throw new Error(`저장 실패 (HTTP ${res.status})`);
    }

    // 외부에서 쓰는 API
    window.__payFix = {
      async init(empId){
        const finalId = empId || (document.getElementById('f_emp_id')?.value || '');
        (document.getElementById('pf_emp_id')).value = finalId;
        await renderFields();
        await fillValues(finalId);
      },
      clear(){
        document.querySelectorAll('#payFixForm input[data-allow-code], #pf_total')
          .forEach(el => el.value = '');
      },
      async save(){
        try{
          await saveAll();
          alert('저장되었습니다.');
        }catch(e){
          console.error(e);
          alert(e.message || '저장 중 오류');
        }
      }
    };

    document.getElementById('pf_saveBtn')?.addEventListener('click', ()=>window.__payFix.save());
    document.getElementById('pf_closeBtn')?.addEventListener('click', (e)=>{
      const modalEl = e.target.closest('.modal');
      try {
        const inst = (window.bootstrap && bootstrap.Modal.getInstance(modalEl)) || (modalEl ? new bootstrap.Modal(modalEl) : null);
        inst?.hide();
      } catch {}
    });
  })();
  </script>
</div>
