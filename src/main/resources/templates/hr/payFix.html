<div th:fragment="payFix">
	<input type="hidden" id="pf_emp_id">

	<div class="container-fluid mb-4">
		<h6 class="fw-bold mb-2">수당</h6>
		<div id="payfix-list"></div>
	</div>

	<div class="container-fluid">
		<h6 class="fw-bold mb-2">공제</h6>
		<div id="deductfix-list"></div>
	</div>

	<style>
h6.fw-bold {
	color: navy;
	font-weight: bold;
}
</style>

	<script>
  ;(function(){
    // include 방지
    if (window.__payFix) return;  //payFix가 있으면 즉시 종료
    
 // 천단위 콤마 붙이기
    function formatWithComma(value) {
      const onlyNumber = value.toString().replace(/[^0-9]/g, ''); // 숫자만 남기기
      if (!onlyNumber) return '';
      return Number(onlyNumber).toLocaleString(); // 1,000 처럼 콤마 붙이기
    }

    // 콤마 제거
    function unformatComma(value) {
      return value.replace(/,/g, '');
    }

    // 계산용 환경설정 
    const CONFIG = {
      // 국민연금
      NPS_RATE_EMP: 0.045,        // 근로자요율 4.5%
      NPS_BASE_MIN: 350000,       // 기준소득월액 하한
      NPS_BASE_MAX: 5900000,      // 기준소득월액 상한
      // 건강보험
      HI_RATE_EMP: 0.03545,       // 근로자요율
      // 장기요양(건강보험료 × 요율)
      LTC_RATE: 0.1295,           // 장기요양 요율
      // 고용보험
      EI_RATE_EMP: 0.009,         // 근로자요율 0.9%
      // 반올림/절사 규칙
      ROUND_UNIT: 10,             // 10원 단위
      ROUND_MODE: 'floor',        // 내림 사용

      // 가족/자녀 수당 규칙
      FAMILY_ALLOW_PER: 50000,    // 부양가족 1명당 5만원
      CHILD_TIER: [               // 자녀 수당 
        { max: 2,        per: 20000 }, // 1~2명: 인당 2만원
        { max: Infinity, per: 50000 }  // 3명 이상: 인당 5만원
      ],
      // 해당 수당의 화면 라벨 
      LABEL_FAMILY_ALLOW: '부양가족수당', // 화면에서 찾을 라벨명
      LABEL_CHILD_ALLOW: '출산보육수당'   // 화면에서 찾을 라벨명
    };

    const $ = (id)=>document.getElementById(id);        // DOM 헬퍼
    const allowArea  = ()=>$('payfix-list');            // 수당 영역 컨테이너 반환
    const deductArea = ()=>$('deductfix-list');         // 공제 영역 컨테이너 반환

    // 공통: empId 보관/획득
    function setEmpIdHidden(empId){ if($('pf_emp_id')) $('pf_emp_id').value = empId || ''; } // 숨김 input에 empId 저장
    function getEmpId(){
      let v = ($('pf_emp_id')?.value || '').trim();   // 숨김 input에서 우선 가져옴
      if(!v) v = (document.getElementById('f_emp_id')?.value || '').trim(); // 없으면 기본 정보 탭의 f_emp_id에서
      return v;
    }

    //반올림/절사 
    function roundToUnit(val, unit, mode){
      const x = Number(val) || 0;   // 숫자 변환 실패 시 0
      const u = unit || 1;          // 단위 기본 1
      const q = x / u;              // 단위로 나눈 값
      if (mode === 'round') return Math.round(q) * u; // 반올림
      if (mode === 'ceil')  return Math.ceil(q)  * u; // 올림
      return Math.floor(q) * u;                       // 기본은 내림
    }

    // 유틸: 숫자변환
     function num(v){
    	   const n = Number(unformatComma(v));
    	   return Number.isFinite(n) ? n : 0;
    	 }

    // 수당/공제 한 섹션 렌더 
    function renderList(box, rows, kind ){
      box.innerHTML = '';               // 기존 목록 비우기
      rows.forEach(item=>{
        const has  = item.payFixNo != null ? 'true' : 'false'; // 기존 저장 여부
        const lbl  = item.empAllowLabel || '';                  // 라벨
        const code = item.empAllowCode  || '';                  // 코드
        const isTax = (item.taxType?.toUpperCase?.() === '과세' || item.taxType === 'Y') // 과세 여부 판정
                      ? 'Y'
                      : (lbl.includes('식대') ? 'N' : (item.taxType === 'N' ? 'N' : 'Y'));

        const row = document.createElement('div');  // 행 컨테이너
        row.className = 'row mb-2';
        row.innerHTML = `
          <div class="col-md-6">
            <label class="form-label fw-bold">${lbl}</label>
          </div>
          <div class="col-md-6">
          <input type="text" class="form-control payfix-input"
                   data-kind="${kind}"
                   data-code="${code}"
                   data-name="${lbl}"
                   data-tax="${kind==='ALLOW' ? isTax : ''}"
                   data-has-value="${has}"
                   value="${formatWithComma(item.empAllowPay || 0)}">
          </div>`;                                  // 각 항목의 입력 상자 생성
        box.appendChild(row);                       // 섹션에 추가
      });
    }

    // 기본급 가져오기: ALLOW 중 '기본급' 라벨 또는 코드로 식별
    function getBasePay(){
      const el = document.querySelector('#payfix-list input[data-kind="ALLOW"][data-name="기본급"]'); // 라벨 '기본급'
      return num(el?.value);                                                                        // 숫자 변환
    }

    // 과세 수당 합계 
    function getTaxableAllowSum(){
      const nodes = document.querySelectorAll('#payfix-list input[data-kind="ALLOW"][data-code]'); // 모든 수당 입력
      let sum = 0;
      nodes.forEach(n=>{
        const tax = n.getAttribute('data-tax') || 'Y';                                              // 과세/비과세
        // 기본급 제외
        const isBase = (n.getAttribute('data-name') === '기본급') || (n.getAttribute('data-code') === '01'); // 기본급 제외
        if (tax === 'Y' && !isBase) sum += num(n.value);                                            // 과세 수당만 합산
      });
      return sum;
    }

    // 보수월액 = 기본급 + 과세수당합 
    function getWageBase(){
      return getBasePay() + getTaxableAllowSum(); // 4대보험 계산의 기준 소득
    }

    //공제 Input 찾기(라벨 우선, 코드 보조)
    function findDeductInput(nameHints = [], codeHints = []){
      for (const h of nameHints){
        const el = Array.from(document.querySelectorAll('#deductfix-list input[data-kind="DEDUCT"]'))
                        .find(n => (n.getAttribute('data-name') || '').includes(h)); // 라벨 포함 검색
        if (el) return el;
      }
      for (const c of codeHints){
        const el = document.querySelector(`#deductfix-list input[data-kind="DEDUCT"][data-code="${c}"]`); // 코드 정확 일치
        if (el) return el;
      }
      return null; // 못 찾으면 null
    }

    // ALLOW 인풋 찾기(라벨/코드 힌트)
    function findAllowInput(nameHints = [], codeHints = []){
      for (const h of nameHints){
        const el = Array.from(document.querySelectorAll('#payfix-list input[data-kind="ALLOW"]'))
                        .find(n => (n.getAttribute('data-name') || '').includes(h)); // 라벨 포함 검색
        if (el) return el;
      }
      for (const c of codeHints){
        const el = document.querySelector(`#payfix-list input[data-kind="ALLOW"][data-code="${c}"]`); // 코드 정확 일치
        if (el) return el;
      }
      return null; // 못 찾으면 null
    }

    //  가족/자녀 입력값
    function getFamilyCnt()   { return num(document.getElementById('f_family_cnt')?.value); }   // 부양가족 수
    function getChildrenCnt() { return num(document.getElementById('f_children_cnt')?.value); } // 자녀 수

    // 자녀 수에 따른 단가 결정
    function getPerChildAmount(cnt){
      for (const tier of CONFIG.CHILD_TIER){
        if (cnt <= tier.max) return tier.per; //단가 반환
      }
      return 0; // 기본 0
    }

    //부양가족/자녀 수당 자동 계산 & 반영
    function recalcFamilyAllowances(){
      const famCnt   = getFamilyCnt();    // 부양가족 수
      const childCnt = getChildrenCnt();  // 자녀 수

      const familyAmount = famCnt   * (CONFIG.FAMILY_ALLOW_PER || 0); // 가족 수당 총액
      const childPer     = getPerChildAmount(childCnt);               // 자녀 1인당 단가
      const childAmount  = childCnt * childPer;                       // 자녀 수당 총액

      const $family = findAllowInput([CONFIG.LABEL_FAMILY_ALLOW]); // 라벨로 수당 input 찾음
      const $child  = findAllowInput([CONFIG.LABEL_CHILD_ALLOW]);  // 라벨로 수당 input 찾음

      if ($family) $family.value = formatWithComma(familyAmount);
      if ($child)  $child.value  = formatWithComma(childAmount);

      // 가족/자녀 수당이 과세면 보수월액 변동 
      recalcDeductions();
    }

    //4대보험 계산 후 화면 세팅
    function recalcDeductions(){
      const base = getWageBase(); // 보수월액

      // 1) 국민연금
      const npsBase = Math.max(CONFIG.NPS_BASE_MIN, Math.min(CONFIG.NPS_BASE_MAX, base)); // 하한/상한 적용
      let nps = npsBase * CONFIG.NPS_RATE_EMP;                                            // 요율 적용
      nps = roundToUnit(nps, CONFIG.ROUND_UNIT, CONFIG.ROUND_MODE);                       // 반올림 규칙 적용

      // 2) 건강보험
      let hi = base * CONFIG.HI_RATE_EMP;                   // 요율 적용
      hi = roundToUnit(hi, CONFIG.ROUND_UNIT, CONFIG.ROUND_MODE); // 반올림 규칙

      // 3) 장기요양 
      let ltc = hi * CONFIG.LTC_RATE;                       // 건강보험료 기준
      ltc = roundToUnit(ltc, CONFIG.ROUND_UNIT, CONFIG.ROUND_MODE); // 반올림 규칙

      // 4) 고용보험
      let ei = base * CONFIG.EI_RATE_EMP;                   // 요율 적용
      ei = roundToUnit(ei, CONFIG.ROUND_UNIT, CONFIG.ROUND_MODE); // 반올림 규칙

      //  input 매핑
      const $nps = findDeductInput(['국민연금'], ['03']);
      const $hi  = findDeductInput(['건강보험'], ['04']);
      const $ltc = findDeductInput(['장기요양'], ['05']);
      const $ei  = findDeductInput(['고용보험'], ['06']);

       if ($nps) $nps.value = formatWithComma(nps); //국민연금
       if ($hi)  $hi.value  = formatWithComma(hi); //건강보험
       if ($ltc) $ltc.value = formatWithComma(ltc); //장기요양
       if ($ei)  $ei.value  = formatWithComma(ei); //고용보험
    }

    function bindAutoRecalc(){
    	  //콤마 자동 붙이기
    	  document.querySelectorAll('#payfix-list input, #deductfix-list input').forEach(inp=>{
    	    inp.addEventListener('input', (e)=>{
    	      e.target.value = formatWithComma(e.target.value);
    	      recalcDeductions();   // 입력 즉시 4대보험 재계산
    	    });
    	  });

    	  //수당 값 변경 시 재계산 
    	  document.querySelectorAll('#payfix-list input[data-kind="ALLOW"]').forEach(inp=>{
    	    ['change','blur','keyup'].forEach(ev=>inp.addEventListener(ev, recalcDeductions));
    	  });

    	  // 외부 기본급 필드 있을 경우
    	  const extBase = document.querySelector('#f_base_pay');
    	  if (extBase){
    	    ['input','change','blur','keyup'].forEach(ev=>extBase.addEventListener(ev, recalcDeductions));
    	  }

    	  //초기 1회 계산
    	  recalcDeductions();
    	}

    // 초기화
    async function init(empId){
      try{
        setEmpIdHidden(empId); // 숨김 input에 empId 저장
        const [allowRes, deductRes] = await Promise.all([
          axios.get('/api/v1/emp-pay-fix/allow-list',  { params:{ empId } }), // 수당 항목 조회
          axios.get('/api/v1/emp-pay-fix/deduct-list', { params:{ empId } })  // 공제 항목 조회
        ]);
        const allowBox  = allowArea();  if (allowBox)  renderList(allowBox,  allowRes.data||[],  'ALLOW');  // 수당 섹션 렌더
        const deductBox = deductArea(); if (deductBox) renderList(deductBox, deductRes.data||[], 'DEDUCT'); // 공제 섹션 렌더

        // 렌더 완료 후 바인딩 & 1회 계산
        bindAutoRecalc();          // 입력 이벤트 바인딩(자동 계산 연결)
        recalcDeductions();        // 4대보험 1회 계산
        //가족/자녀 수당 초기 계산 1회
        recalcFamilyAllowances();
      }catch(err){
        console.error('init error:', err?.response?.status, err?.response?.data || err); 
        alert('급여지급/공제 목록 조회 중 오류가 발생했습니다.');                         
      }
    }

    // 저장
    async function save(){
      const empId = getEmpId(); // 현재 사번
      if(!empId){ alert('사번이 없습니다.'); return; }// 사번 없으면 저장 불가

      const inputs = document.querySelectorAll('#payfix-list input[data-code], #deductfix-list input[data-code]'); // 모든 항목 입력
      const errors = []; // 실패 항목 수집
      for (const input of inputs){
        const code  = input.getAttribute('data-code'); // 코드
        const kind  = input.getAttribute('data-kind'); // ALLOW/DEDUCT
        const pay = Number(unformatComma(input.value));       
        const label = input.closest('.row').querySelector('label')?.textContent || ''; // 라벨(항목명)
        const body  = {
          empId,
          empAllowCode:  code,
          empAllowLabel: label,
          empAllowPay:   pay,
          payType:       kind
        };
        const isUpdate = input.getAttribute('data-has-value') === 'true'; // 기존 존재 여부

        try{
          if (isUpdate) await axios.put('/api/v1/emp-pay-fix', body); // 수정
          else {
            await axios.post('/api/v1/emp-pay-fix', body);            // 신규
            input.setAttribute('data-has-value', 'true');             // 저장 후 상태 갱신
          }
        }catch(e){
          console.error(`[pay-fix save error] code=${code}, kind=${kind}, isUpdate=${isUpdate}`,
                        e?.response?.status, e?.response?.data || e); 
          errors.push(`${kind}:${code}`); 
        }
      }

      if (errors.length){
        alert(`저장 중 오류가 발생했습니다. 문제 항목: ${errors.join(', ')}`); // 실패 항목 안내
        throw new Error('pay-fix save failed'); // 호출측에서 감지 가능하도록 에러 throw
      }
    }

    function clear(){
      const a = allowArea();  if (a) a.innerHTML = ''; // 수당 섹션 비우기
      const d = deductArea(); if (d) d.innerHTML = ''; // 공제 섹션 비우기
      const hid = $('pf_emp_id'); if (hid) hid.value = ''; // 숨김 empId 초기화
    }

    window.__payFix = { init, save, clear }; //API: 초기화/저장/초기화(클리어)
  })();
  </script>
</div>
