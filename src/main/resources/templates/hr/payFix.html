<div th:fragment="payFix">
  <input type="hidden" id="pf_emp_id">

  <div class="container-fluid mb-4">
    <h6 class="fw-bold mb-2">수당</h6>
    <div id="payfix-list"></div>
  </div>

  <div class="container-fluid">
    <h6 class="fw-bold mb-2">공제</h6>
    <div id="deductfix-list"></div>
  </div>
  
  <style>
  h6.fw-bold {
    color: navy;
    font-weight: bold;
  }
  </style>

  <script>
  ;(function(){
    // include 방지
    if (window.__payFix) return;

    // 계산용 환경설정 
    const CONFIG = {
      // 국민연금
      NPS_RATE_EMP: 0.045,        // 근로자요율 4.5%
      NPS_BASE_MIN: 350000,       // 기준소득월액 하한(예시)
      NPS_BASE_MAX: 5900000,      // 기준소득월액 상한(예시)
      // 건강보험
      HI_RATE_EMP: 0.03545,       // 근로자요율
      // 장기요양(건강보험료 × 요율)
      LTC_RATE: 0.1295,           // 장기요양 요율
      // 고용보험
      EI_RATE_EMP: 0.009,         // 근로자요율 0.9%
      // 반올림/절사 규칙
      ROUND_UNIT: 10,             // 10원 단위
      ROUND_MODE: 'floor',

      // 가족/자녀 수당 규칙
      FAMILY_ALLOW_PER: 50000,    // 부양가족 1명당 5만원
      CHILD_TIER: [               // 자녀 수당 
        { max: 2,        per: 20000 }, // 1~2명: 인당 2만원
        { max: Infinity, per: 50000 }  // 3명 이상: 인당 5만원
      ],
      // 해당 수당의 화면 라벨 
      LABEL_FAMILY_ALLOW: '부양가족수당',
      LABEL_CHILD_ALLOW: '출산보육수당'
    };

    const $ = (id)=>document.getElementById(id);
    const allowArea  = ()=>$('payfix-list');
    const deductArea = ()=>$('deductfix-list');

    // 공통: empId 보관/획득
    function setEmpIdHidden(empId){ if($('pf_emp_id')) $('pf_emp_id').value = empId || ''; }
    function getEmpId(){
      let v = ($('pf_emp_id')?.value || '').trim();
      if(!v) v = (document.getElementById('f_emp_id')?.value || '').trim();
      return v;
    }

    //반올림/절사 
    function roundToUnit(val, unit, mode){
      const x = Number(val) || 0;
      const u = unit || 1;
      const q = x / u;
      if (mode === 'round') return Math.round(q) * u;
      if (mode === 'ceil')  return Math.ceil(q)  * u;
      return Math.floor(q) * u; 
    }

    // 유틸: 숫자 안전 변환
    function num(v){ const n = Number(v); return isFinite(n) ? n : 0; }

    // 수당/공제 한 섹션 렌더 
    function renderList(box, rows, kind ){
      box.innerHTML = '';
      rows.forEach(item=>{
        const has  = item.payFixNo != null ? 'true' : 'false';
        const lbl  = item.empAllowLabel || '';
        const code = item.empAllowCode  || '';
        const isTax = (item.taxType?.toUpperCase?.() === '과세' || item.taxType === 'Y')
                      ? 'Y'
                      : (lbl.includes('식대') ? 'N' : (item.taxType === 'N' ? 'N' : 'Y'));

        const row = document.createElement('div');
        row.className = 'row mb-2';
        row.innerHTML = `
          <div class="col-md-6">
            <label class="form-label fw-bold">${lbl}</label>
          </div>
          <div class="col-md-6">
            <input type="number" class="form-control"
                   data-kind="${kind}"
                   data-code="${code}"
                   data-name="${lbl}"
                   data-tax="${kind==='ALLOW' ? isTax : ''}"
                   data-has-value="${has}"
                   value="${item.empAllowPay || 0}">
          </div>`;
        box.appendChild(row);
      });
    }

    // 기본급 가져오기: ALLOW 중 '기본급' 라벨 또는 코드로 식별
    function getBasePay(){
      const el = document.querySelector('#payfix-list input[data-kind="ALLOW"][data-name="기본급"]');
      return num(el?.value);
    }

    // 과세 수당 합계 
    function getTaxableAllowSum(){
      const nodes = document.querySelectorAll('#payfix-list input[data-kind="ALLOW"][data-code]');
      let sum = 0;
      nodes.forEach(n=>{
        const tax = n.getAttribute('data-tax') || 'Y';
        // 기본급 제외
        const isBase = (n.getAttribute('data-name') === '기본급') || (n.getAttribute('data-code') === '01');
        if (tax === 'Y' && !isBase) sum += num(n.value);
      });
      return sum;
    }

    // 보수월액 = 기본급 + 과세수당합 
    function getWageBase(){
      return getBasePay() + getTaxableAllowSum();
    }

    //공제 Input 찾기(라벨 우선, 코드 보조)
    function findDeductInput(nameHints = [], codeHints = []){
      for (const h of nameHints){
        const el = Array.from(document.querySelectorAll('#deductfix-list input[data-kind="DEDUCT"]'))
                        .find(n => (n.getAttribute('data-name') || '').includes(h));
        if (el) return el;
      }
      for (const c of codeHints){
        const el = document.querySelector(`#deductfix-list input[data-kind="DEDUCT"][data-code="${c}"]`);
        if (el) return el;
      }
      return null;
    }

    // ALLOW 인풋 찾기(라벨/코드 힌트)
    function findAllowInput(nameHints = [], codeHints = []){
      for (const h of nameHints){
        const el = Array.from(document.querySelectorAll('#payfix-list input[data-kind="ALLOW"]'))
                        .find(n => (n.getAttribute('data-name') || '').includes(h));
        if (el) return el;
      }
      for (const c of codeHints){
        const el = document.querySelector(`#payfix-list input[data-kind="ALLOW"][data-code="${c}"]`);
        if (el) return el;
      }
      return null;
    }

    // ===== [추가] 가족/자녀 입력값
    function getFamilyCnt()   { return num(document.getElementById('f_family_cnt')?.value); }
    function getChildrenCnt() { return num(document.getElementById('f_children_cnt')?.value); }

    // ===== [추가] 자녀 수에 따른 단가 결정
    function getPerChildAmount(cnt){
      for (const tier of CONFIG.CHILD_TIER){
        if (cnt <= tier.max) return tier.per;
      }
      return 0;
    }

    // ===== [추가] 부양가족/자녀 수당 자동 계산 & 반영
    function recalcFamilyAllowances(){
      const famCnt   = getFamilyCnt();
      const childCnt = getChildrenCnt();

      const familyAmount = famCnt   * (CONFIG.FAMILY_ALLOW_PER || 0);
      const childPer     = getPerChildAmount(childCnt);
      const childAmount  = childCnt * childPer;

      const $family = findAllowInput([CONFIG.LABEL_FAMILY_ALLOW]); // 라벨로 찾음
      const $child  = findAllowInput([CONFIG.LABEL_CHILD_ALLOW]);

      if ($family) $family.value = familyAmount;
      if ($child)  $child.value  = childAmount;

      // 가족/자녀 수당이 과세면 보수월액 변동 → 4대보험 재계산
      recalcDeductions();
    }

    //4대보험 계산 후 화면 세팅
    function recalcDeductions(){
      const base = getWageBase();

      // 1) 국민연금
      const npsBase = Math.max(CONFIG.NPS_BASE_MIN, Math.min(CONFIG.NPS_BASE_MAX, base));
      let nps = npsBase * CONFIG.NPS_RATE_EMP;
      nps = roundToUnit(nps, CONFIG.ROUND_UNIT, CONFIG.ROUND_MODE);

      // 2) 건강보험
      let hi = base * CONFIG.HI_RATE_EMP;
      hi = roundToUnit(hi, CONFIG.ROUND_UNIT, CONFIG.ROUND_MODE);

      // 3) 장기요양 
      let ltc = hi * CONFIG.LTC_RATE;
      ltc = roundToUnit(ltc, CONFIG.ROUND_UNIT, CONFIG.ROUND_MODE);

      // 4) 고용보험
      let ei = base * CONFIG.EI_RATE_EMP;
      ei = roundToUnit(ei, CONFIG.ROUND_UNIT, CONFIG.ROUND_MODE);

      // 대상 input 매핑
      const $nps = findDeductInput(['국민연금'], ['03']);
      const $hi  = findDeductInput(['건강보험'], ['04']);
      const $ltc = findDeductInput(['장기요양'], ['05']);
      const $ei  = findDeductInput(['고용보험'], ['06']);

      if ($nps) $nps.value = nps;
      if ($hi)  $hi.value  = hi;
      if ($ltc) $ltc.value = ltc;
      if ($ei)  $ei.value  = ei;
    }

    // 수당/기본급 변경 시 자동계산 바인딩 
    function bindAutoRecalc(){
      document.querySelectorAll('#payfix-list input[data-kind="ALLOW"]').forEach(inp=>{
        ['change','blur','keyup'].forEach(ev=>inp.addEventListener(ev, recalcDeductions));
      });
      const extBase = document.querySelector('#f_base_pay');
      if (extBase){
        ['change','blur','keyup'].forEach(ev=>extBase.addEventListener(ev, recalcDeductions));
      }

      // ===== [추가] 가족/자녀 입력 변경 시 자동 반영
      ['f_family_cnt','f_children_cnt'].forEach(id=>{
        const el = document.getElementById(id);
        if (el){
          ['change','blur','keyup'].forEach(ev=> el.addEventListener(ev, recalcFamilyAllowances));
        }
      });

      // 초기 1회 세팅
      recalcFamilyAllowances();
    }

    // 초기화
    async function init(empId){
      try{
        setEmpIdHidden(empId);
        const [allowRes, deductRes] = await Promise.all([
          axios.get('/api/v1/emp-pay-fix/allow-list',  { params:{ empId } }),
          axios.get('/api/v1/emp-pay-fix/deduct-list', { params:{ empId } })
        ]);
        const allowBox  = allowArea();  if (allowBox)  renderList(allowBox,  allowRes.data||[],  'ALLOW');
        const deductBox = deductArea(); if (deductBox) renderList(deductBox, deductRes.data||[], 'DEDUCT');

        // 렌더 완료 후 바인딩 & 1회 계산
        bindAutoRecalc();
        recalcDeductions();
        // ===== [추가] 가족/자녀 수당 초기 계산 1회
        recalcFamilyAllowances();
      }catch(err){
        console.error('init error:', err?.response?.status, err?.response?.data || err);
        alert('급여지급/공제 목록 조회 중 오류가 발생했습니다.');
      }
    }

    // 저장
    async function save(){
      const empId = getEmpId();
      if(!empId){ alert('사번이 없습니다.'); return; }

      const inputs = document.querySelectorAll('#payfix-list input[data-code], #deductfix-list input[data-code]');
      const errors = [];
      for (const input of inputs){
        const code  = input.getAttribute('data-code');
        const kind  = input.getAttribute('data-kind');
        const pay   = Number(input.value) || 0;
        const label = input.closest('.row').querySelector('label')?.textContent || '';
        const body  = {
          empId,
          empAllowCode:  code,
          empAllowLabel: label,
          empAllowPay:   pay,
          payType:       kind
        };
        const isUpdate = input.getAttribute('data-has-value') === 'true';

        try{
          if (isUpdate) await axios.put('/api/v1/emp-pay-fix', body);
          else {
            await axios.post('/api/v1/emp-pay-fix', body);
            input.setAttribute('data-has-value', 'true');
          }
        }catch(e){
          console.error(`[pay-fix save error] code=${code}, kind=${kind}, isUpdate=${isUpdate}`,
                        e?.response?.status, e?.response?.data || e);
          errors.push(`${kind}:${code}`);
        }
      }

      if (errors.length){
        alert(`저장 중 오류가 발생했습니다. 문제 항목: ${errors.join(', ')}`);
        throw new Error('pay-fix save failed');
      }
    }

    function clear(){
      const a = allowArea();  if (a) a.innerHTML = '';
      const d = deductArea(); if (d) d.innerHTML = '';
      const hid = $('pf_emp_id'); if (hid) hid.value = '';
    }

    window.__payFix = { init, save, clear };
  })();
  </script>
</div>
