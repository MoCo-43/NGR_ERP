<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- 인터페이스 FQN과 100% 일치 -->
<mapper namespace="com.yedam.erp.mapper.account.JournalMapper">
	<!-- resultMap 은 참조보다 ‘위’에 두세요 -->
	<resultMap id="journalMap"
		type="com.yedam.erp.vo.account.JournalVO">
		<id property="jrnCode" column="JRN_CODE" />
		<result property="lineNo" column="LINE_NO" />
		<result property="jrnNo" column="JRN_NO" />
		<result property="jrnDate" column="JRN_DATE" />
		<result property="acctCode" column="ACCT_CODE" />
		<result property="dcType" column="DC_TYPE" />
		<result property="amount" column="AMOUNT" />
		<result property="deptCode" column="DEPT_CODE" />
		<result property="remarks" column="REMARKS" />
		<result property="status" column="STATUS" />
		<result property="createdAt" column="CREATED_AT" />
		<result property="createdBy" column="CREATED_BY" />
		<result property="cusCode" column="CUS_CODE" />
		<result property="closeNo" column="CLOSE_NO" />
	</resultMap>

	<select id="selectJournalList" resultType="JournalNamesVO">
    SELECT
        J.JRN_CODE,
        J.LINE_NO,
        J.JRN_NO,
        J.JRN_DATE,
        J.ACCT_CODE,
        A.ACCT_NAME,   -- 계정명
        J.DC_TYPE,
        J.AMOUNT,
        J.REMARKS,
        J.STATUS,
        J.CREATED_AT,
        J.CREATED_BY,
        J.CUS_CODE,
        C.CUS_NAME,    -- 거래처명
        J.CLOSE_NO
    FROM JOURNAL J
    LEFT JOIN ACCOUNT A
           ON J.ACCT_CODE = A.ACCT_CODE
    LEFT JOIN CUSTOMER C
           ON J.CUS_CODE = C.CUS_CODE
    ORDER BY J.JRN_DATE DESC, J.JRN_NO DESC, J.LINE_NO ASC
</select>

	
<insert id="insertJournal" parameterType="com.yedam.erp.vo.account.JournalVO">
    INSERT INTO JOURNAL (
        JRN_NO,
        LINE_NO,
        JRN_DATE,
        ACCT_CODE,
        DC_TYPE,
        AMOUNT,
        REMARKS,
        STATUS,
        CREATED_AT,
        CREATED_BY,
        CUS_CODE,
        CLOSE_NO
    )
    VALUES (
        FN_NEXT_JRN_NO(SYSDATE),
        NVL((SELECT MAX(LINE_NO) FROM JOURNAL WHERE JRN_NO = FN_NEXT_JRN_NO(SYSDATE)), 0) + 1, 
        #{jrnDate},
        #{acctCode},
        #{dcType},
        #{amount},
        #{remarks},
        #{status},
        SYSDATE,
        #{createdBy},
        #{cusCode},
        #{closeNo}
    )
</insert>
</mapper>
