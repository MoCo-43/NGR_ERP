<th:block th:fragment="codeLookupModal">
	<!-- 공통코드 선택 모달 -->
	<div class="modal fade" id="codeLookupModal" tabindex="-1"
		aria-hidden="true">
		<div
			class="modal-dialog modal-lg modal-dialog-scrollable code-lookup-modal">
			<div class="modal-content">

				<div class="modal-header">
					<h5 class="modal-title" id="codeLookupTitle">공통코드 선택</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"
						aria-label="닫기"></button>
				</div>

				<div class="modal-body p-2">
					<div id="lookupGrid" class="ag-theme-quartz"
						style="height: 300px; width: 100%;"></div>
				</div>

				<div class="modal-footer">
					<button type="button" class="btn btn-secondary"
						data-bs-dismiss="modal">닫기</button>
				</div>

			</div>
		</div>
	</div>

	<style>
#lookupGrid.ag-theme-quartz {
	--ag-row-height: 28px;
	--ag-header-height: 30px;
	font-size: 12px;
}
</style>

	<script>
    // 전역 네임스페이스 유지 
    window.CodeLookup = (function () {
      let bsModal = null;
      let gridApi  = null;

      const MODAL_ID = 'codeLookupModal';
      const GRID_ID  = 'lookupGrid';
      const API_COMMON = '/api/common-codes';
      const API_DEPT   = '/api/hr/dept';

      // 현재 컨텍스트
      const current = {
        groupId: 'RK',   
        source:  null,   
        title:   '공통코드 선택',
        targetId: null,
        targetNameId: null
      };

      async function open(opts = {}) {
        current.groupId      = opts.groupId      || current.groupId;
        current.source       = opts.source       || null;
        current.title        = opts.title        || titleByGroup(current.groupId);
        current.targetId     = opts.targetId     || null;
        current.targetNameId = opts.targetNameId || null;

        const titleEl = document.getElementById('codeLookupTitle');
        if (titleEl) titleEl.textContent = current.title;

        const modalEl = document.getElementById(MODAL_ID);
        if (!bsModal) bsModal = new bootstrap.Modal(modalEl);
        bsModal.show();

        await refresh();
      }

      // 그룹별 기본 타이틀
      function titleByGroup(gid) {
        switch (gid) {
          case 'RK': return '직급 선택';
          case 'PO': return '직책 선택';
          case 'BK': return '은행 선택';
          default:   return '공통코드 선택';
        }
      }

      // 그리드 초기화
      function initGrid(rows) {
        const gridDiv = document.getElementById(GRID_ID);

        const defaultCols = [
          { headerName:'코드(ID)', field:'codeId',   width:120 },
          { headerName:'코드명',   field:'codeName', flex:1, minWidth:200 },
          { headerName:'사용',     field:'useYn',    width:100 }
        ];
        const bankCols = [
          { headerName:'은행코드', field:'codeId', width:120 },
          { headerName:'은행명',   field:'codeName', flex:1, minWidth:240 }
        ];
        const columnDefs = (current.groupId === 'BK') ? bankCols : defaultCols;

        const gridOptions = {
          columnDefs,
          rowData: rows || [],
          pagination: true,
          paginationPageSize: 10,
          animateRows: true,
          defaultColDef: { resizable:true, sortable:true },
          onRowDoubleClicked: (p) => pick(p.data)
        };

        if (gridApi?.destroy) {
          gridApi.destroy();
          gridApi = null;
        }

        // ag-Grid
        if (window.agGrid?.createGrid) {
          gridApi = window.agGrid.createGrid(gridDiv, gridOptions);
        } else {
          new agGrid.Grid(gridDiv, gridOptions);
          gridApi = gridOptions.api;
        }
      }

      // 더블클릭 선택
      function pick(row) {
        if (!row) return;

        if (current.targetId) {
          const t = document.getElementById(current.targetId);
          if (t) { t.value = row.codeId ?? ''; t.dispatchEvent(new Event('change')); }
        }
        if (current.targetNameId) {
          const n = document.getElementById(current.targetNameId);
          if (n) { n.value = row.codeName ?? ''; n.dispatchEvent(new Event('change')); }
        }

        window.dispatchEvent(new CustomEvent('code-picked', { detail: { ...row, ...current } }));
        if (bsModal) bsModal.hide();
      }

      // 데이터 로드
      async function refresh() {
        try {
          if (current.source === 'dept') {
            const res = await fetch(API_DEPT);
            const raw = res.ok ? await res.json() : [];
            const rows = Array.isArray(raw) ? raw.map(r => ({
              codeId:   r.dept_code,
              codeName: r.dept_name,
              useYn:    r.use_yn
            })) : [];
            initGrid(rows);
          } else {
            const url = `${API_COMMON}?groupId=${encodeURIComponent(current.groupId)}`;
            const res = await fetch(url);
            const rows = res.ok ? await res.json() : [];
            initGrid(rows);
          }
        } catch (e) {
          console.error('code lookup load error:', e);
          initGrid([]);
        }
      }

      return { open };
    })();
  </script>
</th:block>
