<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main_auth_base}">
<head>
  <title layout:fragment="title">ERP 로그인</title>
  
  <th:block layout:fragment="head_extra">
    <style>
      .auth-forms h2 { text-align: center; margin-bottom: 1.5rem; color: #4d341e; }
      .auth-forms .input-field { width: 100%; margin-bottom: 1rem; }
      .auth-forms .input-field input { width: 100%; padding: 10px; border: none; border-bottom: 2px solid #ccc; background: transparent; outline: none; }
      .auth-forms .btn-primary { width: 100%; padding: 12px; background: #4d341e; color: #fff; border: none; cursor: pointer; margin-top: 10px; }
      .role-picker { text-align: center; margin-bottom: 1rem; }
      .role-btn { background: transparent; border: 2px solid #4d341e; color: #4d341e; padding: 5px 15px; cursor: pointer; margin: 0 5px; border-radius: 4px; }
      .role-btn.active { background: #4d341e; color: #fff; font-weight: bold; }
      .captcha-img { margin-bottom: 0.5rem; display: block; }
      .link-small { font-size: 0.9rem; text-align: center; margin-top: 1rem; }
      .link-small a { color: #4d341e; }
      .auth-section { display: none; }
      .auth-section.active { display: block; }
    </style>
  </th:block>
</head>
<body>
<th:block layout:fragment="content">
<div class="auth-forms">
  <div id="login" class="auth-section active">
    <h2>로그인</h2>

    <!-- 역할 선택 -->
    <div class="role-picker">
      <button type="button" class="role-btn active" data-role="USER">일반</button>
      <button type="button" class="role-btn" data-role="ADMIN">관리자</button>
    </div>

    <!-- 로그인 폼 -->
    <form th:action="@{/login}" method="post">
      <input type="hidden" name="role" id="role-input" value="USER">
      <div class="input-field">
        <input type="text" name="comCode" placeholder="회사아이디" required value="n001">
      </div>
      <div class="input-field">
        <input type="text" name="empId" placeholder="아이디" required value="kim_user">
      </div>
      <div class="input-field">
        <input type="password" name="empPw" placeholder="비밀번호" required value="1234">
      </div>
      <div class="input-field">
        <label>
          <input type="checkbox" name="remember-me"> 로그인 상태 유지
        </label>
      </div>

      <!-- Google reCAPTCHA
      <div id="recaptcha-section" class="input-field">
        <div class="g-recaptcha" th:attr="data-sitekey=${@environment.getProperty('recaptcha.key.site')}"></div>
      </div> -->

      <!-- Naver CAPTCHA 
      <div id="naver-captcha-section" class="input-field" style="display:none;">
        <div style="display: flex; align-items: center; justify-content: space-between;">
          <img id="captchaImage" alt="CAPTCHA" class="captcha-img" style="width: 150px; height: 50px;">
          <button type="button" onclick="refreshCaptcha()" style="margin-left: 10px; padding: 5px 10px; font-size: 12px;">새로고침</button>
        </div>
        <input type="hidden" name="captchaKey" id="captchaKey">
        <input type="text" name="captchaValue" placeholder="보안문자 입력" style="margin-top: 10px;">
      </div>-->

      <button type="submit" class="btn-primary">로그인</button>
    </form>

    <div class="link-small">
      <a th:href="@{/findpw}">비밀번호 찾기</a> | 
      <a th:href="@{/register}">회원가입</a>
    </div>
  </div>
</div>
</th:block>

<th:block layout:fragment="body_extra">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://www.google.com/recaptcha/api.js" async defer></script>

<script>
  function showSection(targetId) {
    document.querySelectorAll('.auth-section').forEach(section => section.classList.remove('active'));
    document.getElementById(targetId).classList.add('active');
  }

  document.addEventListener('DOMContentLoaded', function() {
    const roleButtons = document.querySelectorAll('.role-btn');
    const roleInput = document.getElementById('role-input');
    const recaptchaSection = document.getElementById('recaptcha-section');
    const naverCaptchaSection = document.getElementById('naver-captcha-section');

    roleButtons.forEach(button => {
      button.addEventListener('click', function() {
        const role = this.getAttribute('data-role');
        roleInput.value = role;

        if (role === 'ADMIN') {
          recaptchaSection.style.display = 'none';
          naverCaptchaSection.style.display = 'block';

          // 관리자 클릭 시 한 번만 CAPTCHA 생성
          if (!naverCaptchaSection.dataset.loaded) {
            refreshCaptcha();
            naverCaptchaSection.dataset.loaded = true;
          }

        } else {
          recaptchaSection.style.display = 'block';
          naverCaptchaSection.style.display = 'none';
        }

        roleButtons.forEach(btn => btn.classList.remove('active'));
        this.classList.add('active');
      });
    });
  });

  // Naver CAPTCHA 새로고침
  function refreshCaptcha() {
    $.ajax({
      url: '/refreshCaptcha', // 캡차 전용 컨트롤러 URL
      method: 'GET',
      success: function(response) {
        $('#captchaKey').val(response.key);
        $('#captchaImage').attr('src', 'data:image/png;base64,' + response.image);
        $('input[name="captchaValue"]').val(''); // 입력 초기화
      },
      error: function(error) {
        console.error("CAPTCHA 새로고침 실패:", error);
        alert("CAPTCHA 새로고침에 실패했습니다.");
      }
    });
  }
</script>
</th:block>
</body>
</html>
