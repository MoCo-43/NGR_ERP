<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8" />

<!-- Bootstrap & FontAwesome (UI용) -->

<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
	rel="stylesheet" />
<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" />

</head>
<body>
	<div th:fragment="invoiceModal">
		<input class="form-control" id="compCode" name="compCode"
			type="hidden">
		<div class="modal fade" id="invoiceModal" tabindex="-1"
			aria-hidden="true">
			<div class="modal-dialog modal-lg">
				<div class="modal-content">

					<div class="modal-header">
						<h5 class="modal-title">매출/매입 전표</h5>
						<button type="button" class="btn btn-light btn-sm border-0"
							data-bs-dismiss="modal" aria-label="닫기">
							<i class="fas fa-times"></i>
						</button>
					</div>

					<div class="modal-body">
						<!-- 전표 기본정보 -->
						<div class="row mb-2">
							<!-- 전표일자 -->
							<div class="col-md-3">
								<label class="form-label">전표일자</label> <input type="date"
									class="form-control" id="invoiceDate"
									th:value="${invoiceHeader?.invoiceDate}" />
							</div>

							<!-- 주문서 -->
							<div class="col-md-4">
								<label class="form-label">발주서</label>
								<div class="input-group">
									<input type="text" class="form-control"
										th:value="${invoiceHeader?.orderCode}" readonly id="orderCode" />
									<button class="btn btn-outline-secondary btn-icon"
										type="button" id="btnOrderLookup">
										<i class="fas fa-search"></i>
									</button>

								</div>
							</div>

							<!-- 부서명 -->
							<div class="col-md-5">
								<label class="form-label">부서명</label>
								<div class="input-group">
									<input type="text" id="deptNameInput"
										class="form-control text-center"
										th:value="${invoiceHeader?.deptName}" readonly />
									<button class="btn btn-outline-secondary btn-icon"
										type="button" id="btnDeptLookup">
										<i class="fas fa-search"></i>
									</button>
								</div>
							</div>
						</div>
						<!-- 🔥 여기서 첫 row 닫기 -->

						<div class="row mb-2">
							<!-- 부가세 유형 -->
							<div class="col-md-4">
								<label class="form-label">부가세 유형</label> <select
									class="form-select-invoice"
									th:value="${invoiceHeader?.vatType}">
									<option value="과세">세금계산서</option>
									<option value="영세">영세율</option>
									<option value="면세">면세</option>
								</select>
							</div>

							<!-- 거래처 -->
							<div class="col-md-8">
								<label class="form-label">거래처</label>
								<div class="row mb-2">
									<!-- 코드 (주문서와 같은 폭: col-md-4) -->
									<div class="col-md-6">
										<div class="input-group">
											<input type="text" class="form-control" id="cusCodeInput"
												th:value="${invoiceHeader?.cusCode}" placeholder="코드" />
											<button class="btn btn-outline-secondary btn-icon"
												type="button" id="openBusinessModalBtn">
												<i class="fas fa-search"></i>
											</button>
										</div>
									</div>
									<!-- 거래처명 (부서명 input 폭과 동일: col-md-8) -->
									<div class="col-md-6">
										<input type="text" class="form-control text-center"
											id="cusNameInput" th:value="${invoiceHeader?.cusName}"
											placeholder="거래처명" />
									</div>
								</div>
							</div>
						</div>
						<!-- 🔥 두 번째 row 닫기 -->

						<!-- 품목 Grid -->
						<div id="invoiceGrid" class="ag-theme-quartz"></div>

						<!-- 세부내역 -->
						<div class="mb-2 mt-3">
							<label class="form-label">세부내역</label>
						</div>

						<!-- 결제방식 / 적요 -->
						<div class="row mb-2">
							<div class="col-md-6">
								<label class="form-label">결제방식</label> <input type="text"
									class="form-control" th:value="${invoiceHeader?.payMethod}"
									id="payMethodInput" />
							</div>
							<div class="col-md-6">
								<label class="form-label">적요</label> <input type="text"
									class="form-control" th:value="${invoiceHeader?.note}"
									id="memoInput" />
							</div>
						</div>
						<div class="row mb-2">
							<div class="col-md-6">
								<label class="form-label">은행</label>
								<div class="input-group">
									<input type="text" class="form-control"
										th:value="${invoiceHeader?.bankCode}" id="bankNameInput" />
									<button class="btn btn-outline-secondary btn-icon"
										type="button" id="btnBankLookup">
										<i class="fas fa-search"></i>
									</button>
								</div>
							</div>

							<!-- 부서명 -->
							<div class="col-md-6">
								<label class="form-label">계좌번호</label>
								<div class="input-group">
									<input type="text" id="accountNoInput"
										class="form-control text-center"
										th:value="${invoiceHeader?.accountNo}" />
								</div>
							</div>
						</div>
						<div class="modal-footer">
							<button class="btn btn-danger" type="button" id="resetInvoiceBtn">초기화</button>
							<button class="btn btn-success" type="button"
								id="insertInvoiceBtn">저장</button>

						</div>
					</div>
				</div>
			</div>
		</div>
		<div th:replace="~{account/orderModal :: orderModal}"></div>
		<div th:replace="~{stock/modals/productModal :: productModal}"></div>

			<!--  매입매출 모달 -->
			<script th:inline="none">
let invoiceGridApi = null;
let invoiceGridCreated = false; // 전역에서 관리
let selectedInvoiceRow = null; // ✅ 클릭한 그리드 행 저장
let productGridApi = null;     // productModal 내부 grid api

document.addEventListener("DOMContentLoaded", () => {
  const modalEl = document.getElementById('invoiceModal');

  modalEl.addEventListener('shown.bs.modal', () => {
    const gridDiv = document.querySelector("#invoiceGrid");

    if (!invoiceGridCreated) {
    	let vatTypeSelect = document.querySelector(".form-select-invoice"); // 부가세 유형 selectbox

    	const gridOptions = {
    			  columnDefs: [
    			    { headerName: "품목코드", field: "productCode", flex: 1,
    			      onCellClicked: (params) => {
    			        if (params.colDef.field === "productCode") {
    			          selectedInvoiceRow = params.node;
    			          const productModalEl = document.getElementById("productModal");
    			          const productModal = bootstrap.Modal.getOrCreateInstance(productModalEl);
    			          productModal.show();
    			          if (!productGridApi) {
    			            initProductGrid();
    			          } else {
    			            loadProductData();
    			          }
    			        }
    			      }
    			    },
    			    { headerName: "품목명", field: "productName", flex: 1, editable: true },
    			    { headerName: "단가", field: "price", flex: 1, editable: true,
    			      valueFormatter: p => p.value ? p.value.toLocaleString() : ""
    			    },
    			    { headerName: "수량", field: "qty", flex: 1, editable: true },
    			    { headerName: "공급가액", field: "supply", flex: 1,
    			      valueFormatter: p => p.value ? p.value.toLocaleString() : ""
    			    },
    			    { headerName: "부가세", field: "vat", flex: 1,
    			      valueFormatter: p => p.value ? p.value.toLocaleString() : ""
    			    },
    			    { headerName: "비고", field: "note", flex: 1, editable: true }
    			  ],
    			  rowData: [],
    			  defaultColDef: { resizable: true, filter: true, editable: true },

    			  // 👉 셀 값 변경될 때 이벤트
    			  onCellValueChanged: (params) => {
    			    if (params.colDef.field === "price" || params.colDef.field === "qty") {
    			      let price = Number(params.data.price) || 0;
    			      let qty = Number(params.data.qty) || 0;
    			      let supply = price * qty;

    			      // 부가세 유형 체크
    			      let vatType = vatTypeSelect.value;
    			      let vat = 0;
    			      if (vatType === "과세") {
    			        vat = Math.floor(supply * 0.1);
    			      }

    			      params.node.setData({
    			        ...params.data,
    			        supply: supply,
    			        vat: vat
    			      });
    			    }

    			    // ✅ 현재 행이 다 채워졌으면 마지막 행인지 확인 후 새 빈행 추가
    			    const isRowFilled =
    			      params.data.productCode &&
    			      params.data.productName &&
    			      (params.data.price || params.data.price === 0) &&
    			      (params.data.qty || params.data.qty === 0);

    			    const allRows = [];
    			    invoiceGridApi.forEachNode(node => allRows.push(node));

    			    const isLastRow = allRows[allRows.length - 1].id === params.node.id;

    			    if (isRowFilled && isLastRow) {
    			      invoiceGridApi.applyTransaction({
    			        add: [{
    			          productCode: "",
    			          productName: "",
    			          price: null,
    			          qty: null,
    			          supply: null,
    			          vat: null,
    			          note: ""
    			        }]
    			      });
    			    }
    			    // ✅ 합계 다시 계산
    			    let subtotal = 0;
    			    let vatTotal = 0;
    			    invoiceGridApi.forEachNode(node => {
    			      subtotal += Number(node.data.supply) || 0;
    			      vatTotal += Number(node.data.vat) || 0;
    			    });

    			    invoiceGridApi.setPinnedBottomRowData([{
    			      supply: "합계",
    			      vat: subtotal + vatTotal,
    			    
    			    }]);
    			  },
        defaultColDef: { resizable: true, filter:true },
        pinnedBottomRowData: [
          {
        	  supply: "합계",
        	  vat: /*[[${invoiceHeader?.subtotalAmt}]]*/ +/*[[${invoiceHeader?.vatAmt}]]*/+ "원" ,
          }
        ]
      };
      new agGrid.Grid(gridDiv, gridOptions);
      invoiceGridApi = gridOptions.api;  // 여기서 api를 꺼내야 함
      invoiceGridCreated = true;
      
      // 빈행 추가
      invoiceGridApi.applyTransaction({
        add: [{ productCode:"", productName:"", price:null, qty:null, supply:null, vat:null, note:"" }]
      });
    } else {
      // 기존 그리드만 refresh
      invoiceGridApi.resetRowHeights();
    }
  });
});
// === productModal 내부 Grid 초기화 ===
function initProductGrid() {
  const gridDiv = document.querySelector("#productGrid");
  if (!gridDiv) return;

  const gridOptions = {
    columnDefs: [
      { headerName: "제품코드", field: "productCode" },
      { headerName: "제품명", field: "productName" },
      { headerName: "규격", field: "specification" }
    ],
    rowData: [],
    rowSelection: "single",
    onGridReady: e => {
      productGridApi = e.api;
      productGridApi.sizeColumnsToFit();
      loadProductData();
    },
    onRowDoubleClicked: e => {
      if (!selectedInvoiceRow) return;
      // ✅ 선택된 제품 데이터를 현재 행에 반영
      selectedInvoiceRow.setData({
        ...selectedInvoiceRow.data,
        productCode: e.data.productCode,
        productName: e.data.productName,
        specification: e.data.specification
      });
      bootstrap.Modal.getOrCreateInstance(
        document.getElementById("productModal")
      ).hide();
    }
  };

  new agGrid.Grid(gridDiv, gridOptions);
  
}

// === 상품 데이터 로드 ===
async function loadProductData() {
  const compCode = Number(document.getElementById('compCode').value);
  if (!productGridApi) return;
  try {
    const res = await axios.get(`/api/v1/stock/productList/${compCode}`, { withCredentials: true });
    productGridApi.setRowData(res.data);
  } catch (err) {
    console.error("상품 조회 실패", err);
  }
};

//✅ 초기화 버튼 동작
document.getElementById("resetInvoiceBtn")?.addEventListener("click", () => {
  const modalEl = document.getElementById("invoiceModal");

  // 모든 input, textarea, select 초기화
  modalEl.querySelectorAll("input, textarea, select").forEach(el => {
    if (el.type === "date") {
      el.value = ""; // 날짜는 공백 처리
    } else if (el.tagName === "SELECT") {
      el.selectedIndex = 0; // 첫번째 옵션으로
    } else {
      el.value = "";
    }
  });

  // ag-grid 초기화 (gridDiv.api ❌ → invoiceGridApi ✅)
  if (invoiceGridApi) {
    invoiceGridApi.setRowData([]); // 행 비우기
    // 필요하면 초기 한 줄 다시 추가
    invoiceGridApi.applyTransaction({
      add: [{ productCode:"", productName:"", price:null, qty:null, supply:null, vat:null, note:"" }]
    });
  }
});

document.getElementById("insertInvoiceBtn")?.addEventListener("click", async () => {
	let subtotal = 0;
	let vatTotal = 0;

	invoiceGridApi.forEachNode(node => {
	  subtotal += Number(node.data.supply) || 0;
	  vatTotal += Number(node.data.vat) || 0;
	});
	
	  try {
	    // 📌 헤더 값 수집
	    const header = {
	    		invoiceDate: document.getElementById("invoiceDate").value,
	    		  orderCode: document.getElementById("orderCode")?.value ,
	    		  deptCode: null,
	    		  deptName: document.getElementById("deptNameInput").value,
	    		  cusCode: document.getElementById("cusCodeInput").value,
	    		  cusName: document.getElementById("cusNameInput").value,
	    		  vatType: document.querySelector(".form-select-invoice").value,
	    		  payMethod: document.getElementById("payMethodInput").value,
	    		  memo: document.getElementById("memoInput").value,
	    		  bankCode: document.getElementById("bankNameInput").value,
	    		  accountNo: document.getElementById("accountNoInput").value,
	    		  type: "P",  // 대소문자 주의 (자바 VO랑 일치시켜야 함)
	    		  subtotalAmt: subtotal,
	    		  vatAmt: vatTotal,
	    		  totalAmt: subtotal + vatTotal,
	    		  lines: []
	    };

	    // 📌 라인 데이터 수집
	    const lines = [];
	    invoiceGridApi.forEachNode(node => {
	      if (node.data.productCode && node.data.qty && node.data.price) {
	        lines.push({
	          productName: node.data.productName,
	          qty: node.data.qty,
	          unitPrice: node.data.price,
	          supAmt: node.data.supply,
	          vatAmt: node.data.vat
	        });
	      }
	    });
	    header.lines = lines;

	    if (lines.length === 0) {
	      alert("저장할 품목이 없습니다.");
	      return;
	    }

	    // 📌 서버 전송
	    const res = await axios.post("/api/account/invoice", header, {
	      withCredentials: true
	    });

	    if (res.data.success) {
	      alert(`저장 완료! 전표번호: ${res.data.invoiceNo}`);
	      bootstrap.Modal.getOrCreateInstance(document.getElementById("invoiceModal")).hide();
	      // 저장 후 전표 목록 다시 로딩
	      if (typeof loadAndRenderVoucher === "function") loadAndRenderVoucher();
	    } else {
	      alert("저장 실패: " + res.data.message);
	    }
	  } catch (err) {
	    console.error(err);
	    alert("저장 중 오류 발생");
	  }
	});
</script>

<script th:inline="none">
let businessGridApi = null;


async function loadBusinessData() {
	const compCode = Number(document.getElementById('compCode').value);
    try {
        const res = await axios.get(`/api/v1/stock/cusList/${compCode}`, {
            
            withCredentials: true           // 세션 쿠키 포함
        });
        if (businessGridApi) {
        	businessGridApi.setGridOption("rowData", res.data);
        	businessGridApi.sizeColumnsToFit();
        }
    } catch (err) { console.error(err); }
}

function initBusinessGrid() {
  const gridDiv = document.querySelector("#businessModal #myGrid") || document.querySelector("#myGrid");
  if (!gridDiv) {
    console.error("거래처 그리드 컨테이너(#myGrid)를 찾을 수 없습니다.");
    return;
  }

  const columnDefs = [
    { headerName: "거래처코드", field: "cusCode" },
    { headerName: "거래처명", field: "cusName" },
    { headerName: "담당자명", field: "empName" },
    { headerName: "사업자번호", field: "bizNo" },
    { headerName: "대표명", field: "ceoName" },
    { headerName: "업태", field: "bizType" },
    { headerName: "종목", field: "bizCategory" },
    { headerName: "거래처주소", field: "addr" }
  ];

  const gridOptions = {
    columnDefs,
    rowSelection: "single",
    pagination: true,
    rowData: [],
    defaultColDef: { resizable: true, sortable: true, minWidth: 100 },
    onGridReady: (e) => {
      businessGridApi = e.api;
      businessGridApi.sizeColumnsToFit();
      loadBusinessData();
    },
    onRowDoubleClicked: (e) => {
      // 값 반영
      document.getElementById("cusCodeInput").value = e.data.cusCode ?? "";
      document.getElementById("cusNameInput").value = e.data.cusName ?? "";

      // 거래처 모달 닫고 → 전표 모달 다시 열기
      const businessModal = bootstrap.Modal.getOrCreateInstance(document.getElementById("businessModal"));
      businessModal.hide();

      const invoiceModal = bootstrap.Modal.getOrCreateInstance(document.getElementById("invoiceModal"));
      invoiceModal.show();
    }
  };

  new agGrid.Grid(gridDiv, gridOptions);
}


// DOM 렌더링시 
document.addEventListener("DOMContentLoaded", () => {
  const invoiceModalEl = document.getElementById("invoiceModal");
  const businessModalEl = document.getElementById("businessModal");

  if (!invoiceModalEl || !businessModalEl) {
    console.error("invoiceModal 또는 businessModal 요소가 없습니다.");
    return;
  }

  const invoiceModal = bootstrap.Modal.getOrCreateInstance(invoiceModalEl);
  const businessModal = bootstrap.Modal.getOrCreateInstance(businessModalEl);

  
  // 버튼 클릭 → 전표모달 닫고 → 닫힌 후 거래처 모달 열기 (연쇄)
  document.getElementById("openBusinessModalBtn").addEventListener("click", () => {
    const openBusinessAfterHide = () => {
      // 한 번만 실행하고 핸들러 제거
      invoiceModalEl.removeEventListener("hidden.bs.modal", openBusinessAfterHide);

      // 거래처 모달 열기
      businessModal.show();
    };

    // 전표 모달이 완전히 닫힌 뒤 실행
    invoiceModalEl.addEventListener("hidden.bs.modal", openBusinessAfterHide);
    invoiceModal.hide(); // 먼저 닫는다
  });

  // 거래처 모달이 보여질 때 그리드 준비/리사이즈/로딩
  businessModalEl.addEventListener("shown.bs.modal", () => {
    if (!businessGridApi) initBusinessGrid();
    else {
      businessGridApi.sizeColumnsToFit();	
      loadBusinessData();
    }
  });
 });
document.addEventListener("DOMContentLoaded", () => {
	  const dateInput = document.getElementById("invoiceDate");
	  if (dateInput && !dateInput.value) {
	    const today = new Date();
	    const yyyy = today.getFullYear();
	    const mm = String(today.getMonth() + 1).padStart(2, "0");
	    const dd = String(today.getDate()).padStart(2, "0");
	    dateInput.value = `${yyyy}-${mm}-${dd}`;
	  }
	});

</script>
</div>
</body>
</html>
