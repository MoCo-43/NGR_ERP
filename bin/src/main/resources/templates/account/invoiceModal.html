<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8" />

<!-- Bootstrap & FontAwesome (UIìš©) -->

<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
	rel="stylesheet" />
<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" />

</head>
<body>
	<div th:fragment="invoiceModal">
		<input class="form-control" id="compCode" name="compCode"
			type="hidden">
		<div class="modal fade" id="invoiceModal" tabindex="-1"
			aria-hidden="true">
			<div class="modal-dialog modal-lg">
				<div class="modal-content">

					<div class="modal-header">
						<h5 class="modal-title">ë§¤ì¶œ/ë§¤ì… ì „í‘œ</h5>
						<button type="button" class="btn btn-light btn-sm border-0"
							data-bs-dismiss="modal" aria-label="ë‹«ê¸°">
							<i class="fas fa-times"></i>
						</button>
					</div>

					<div class="modal-body">
						<!-- ì „í‘œ ê¸°ë³¸ì •ë³´ -->
						<div class="row mb-2">
							<!-- ì „í‘œì¼ì -->
							<div class="col-md-3">
								<label class="form-label">ì „í‘œì¼ì</label> <input type="date"
									class="form-control" id="invoiceDate"
									th:value="${invoiceHeader?.invoiceDate}" />
							</div>

							<!-- ì£¼ë¬¸ì„œ -->
							<div class="col-md-4">
								<label class="form-label">ë°œì£¼ì„œ</label>
								<div class="input-group">
									<input type="text" class="form-control"
										th:value="${invoiceHeader?.orderCode}" readonly id="orderCode" />
									<button class="btn btn-outline-secondary btn-icon"
										type="button" id="btnOrderLookup">
										<i class="fas fa-search"></i>
									</button>

								</div>
							</div>

							<!-- ë¶€ì„œëª… -->
							<div class="col-md-5">
								<label class="form-label">ë¶€ì„œëª…</label>
								<div class="input-group">
									<input type="text" id="deptNameInput"
										class="form-control text-center"
										th:value="${invoiceHeader?.deptName}" readonly />
									<button class="btn btn-outline-secondary btn-icon"
										type="button" id="btnDeptLookup">
										<i class="fas fa-search"></i>
									</button>
								</div>
							</div>
						</div>
						<!-- ğŸ”¥ ì—¬ê¸°ì„œ ì²« row ë‹«ê¸° -->

						<div class="row mb-2">
							<!-- ë¶€ê°€ì„¸ ìœ í˜• -->
							<div class="col-md-4">
								<label class="form-label">ë¶€ê°€ì„¸ ìœ í˜•</label> <select
									class="form-select-invoice"
									th:value="${invoiceHeader?.vatType}">
									<option value="ê³¼ì„¸">ì„¸ê¸ˆê³„ì‚°ì„œ</option>
									<option value="ì˜ì„¸">ì˜ì„¸ìœ¨</option>
									<option value="ë©´ì„¸">ë©´ì„¸</option>
								</select>
							</div>

							<!-- ê±°ë˜ì²˜ -->
							<div class="col-md-8">
								<label class="form-label">ê±°ë˜ì²˜</label>
								<div class="row mb-2">
									<!-- ì½”ë“œ (ì£¼ë¬¸ì„œì™€ ê°™ì€ í­: col-md-4) -->
									<div class="col-md-6">
										<div class="input-group">
											<input type="text" class="form-control" id="cusCodeInput"
												th:value="${invoiceHeader?.cusCode}" placeholder="ì½”ë“œ" />
											<button class="btn btn-outline-secondary btn-icon"
												type="button" id="openBusinessModalBtn">
												<i class="fas fa-search"></i>
											</button>
										</div>
									</div>
									<!-- ê±°ë˜ì²˜ëª… (ë¶€ì„œëª… input í­ê³¼ ë™ì¼: col-md-8) -->
									<div class="col-md-6">
										<input type="text" class="form-control text-center"
											id="cusNameInput" th:value="${invoiceHeader?.cusName}"
											placeholder="ê±°ë˜ì²˜ëª…" />
									</div>
								</div>
							</div>
						</div>
						<!-- ğŸ”¥ ë‘ ë²ˆì§¸ row ë‹«ê¸° -->

						<!-- í’ˆëª© Grid -->
						<div id="invoiceGrid" class="ag-theme-quartz"></div>

						<!-- ì„¸ë¶€ë‚´ì—­ -->
						<div class="mb-2 mt-3">
							<label class="form-label">ì„¸ë¶€ë‚´ì—­</label>
						</div>

						<!-- ê²°ì œë°©ì‹ / ì ìš” -->
						<div class="row mb-2">
							<div class="col-md-6">
								<label class="form-label">ê²°ì œë°©ì‹</label> <input type="text"
									class="form-control" th:value="${invoiceHeader?.payMethod}"
									id="payMethodInput" />
							</div>
							<div class="col-md-6">
								<label class="form-label">ì ìš”</label> <input type="text"
									class="form-control" th:value="${invoiceHeader?.note}"
									id="memoInput" />
							</div>
						</div>
						<div class="row mb-2">
							<div class="col-md-6">
								<label class="form-label">ì€í–‰</label>
								<div class="input-group">
									<input type="text" class="form-control"
										th:value="${invoiceHeader?.bankCode}" id="bankNameInput" />
									<button class="btn btn-outline-secondary btn-icon"
										type="button" id="btnBankLookup">
										<i class="fas fa-search"></i>
									</button>
								</div>
							</div>

							<!-- ë¶€ì„œëª… -->
							<div class="col-md-6">
								<label class="form-label">ê³„ì¢Œë²ˆí˜¸</label>
								<div class="input-group">
									<input type="text" id="accountNoInput"
										class="form-control text-center"
										th:value="${invoiceHeader?.accountNo}" />
								</div>
							</div>
						</div>
						<div class="modal-footer">
							<button class="btn btn-danger" type="button" id="resetInvoiceBtn">ì´ˆê¸°í™”</button>
							<button class="btn btn-success" type="button"
								id="insertInvoiceBtn">ì €ì¥</button>

						</div>
					</div>
				</div>
			</div>
		</div>
		<div th:replace="~{account/orderModal :: orderModal}"></div>
		<div th:replace="~{stock/modals/productModal :: productModal}"></div>

			<!--  ë§¤ì…ë§¤ì¶œ ëª¨ë‹¬ -->
			<script th:inline="none">
let invoiceGridApi = null;
let invoiceGridCreated = false; // ì „ì—­ì—ì„œ ê´€ë¦¬
let selectedInvoiceRow = null; // âœ… í´ë¦­í•œ ê·¸ë¦¬ë“œ í–‰ ì €ì¥
let productGridApi = null;     // productModal ë‚´ë¶€ grid api

document.addEventListener("DOMContentLoaded", () => {
  const modalEl = document.getElementById('invoiceModal');

  modalEl.addEventListener('shown.bs.modal', () => {
    const gridDiv = document.querySelector("#invoiceGrid");

    if (!invoiceGridCreated) {
    	let vatTypeSelect = document.querySelector(".form-select-invoice"); // ë¶€ê°€ì„¸ ìœ í˜• selectbox

    	const gridOptions = {
    			  columnDefs: [
    			    { headerName: "í’ˆëª©ì½”ë“œ", field: "productCode", flex: 1,
    			      onCellClicked: (params) => {
    			        if (params.colDef.field === "productCode") {
    			          selectedInvoiceRow = params.node;
    			          const productModalEl = document.getElementById("productModal");
    			          const productModal = bootstrap.Modal.getOrCreateInstance(productModalEl);
    			          productModal.show();
    			          if (!productGridApi) {
    			            initProductGrid();
    			          } else {
    			            loadProductData();
    			          }
    			        }
    			      }
    			    },
    			    { headerName: "í’ˆëª©ëª…", field: "productName", flex: 1, editable: true },
    			    { headerName: "ë‹¨ê°€", field: "price", flex: 1, editable: true,
    			      valueFormatter: p => p.value ? p.value.toLocaleString() : ""
    			    },
    			    { headerName: "ìˆ˜ëŸ‰", field: "qty", flex: 1, editable: true },
    			    { headerName: "ê³µê¸‰ê°€ì•¡", field: "supply", flex: 1,
    			      valueFormatter: p => p.value ? p.value.toLocaleString() : ""
    			    },
    			    { headerName: "ë¶€ê°€ì„¸", field: "vat", flex: 1,
    			      valueFormatter: p => p.value ? p.value.toLocaleString() : ""
    			    },
    			    { headerName: "ë¹„ê³ ", field: "note", flex: 1, editable: true }
    			  ],
    			  rowData: [],
    			  defaultColDef: { resizable: true, filter: true, editable: true },

    			  // ğŸ‘‰ ì…€ ê°’ ë³€ê²½ë  ë•Œ ì´ë²¤íŠ¸
    			  onCellValueChanged: (params) => {
    			    if (params.colDef.field === "price" || params.colDef.field === "qty") {
    			      let price = Number(params.data.price) || 0;
    			      let qty = Number(params.data.qty) || 0;
    			      let supply = price * qty;

    			      // ë¶€ê°€ì„¸ ìœ í˜• ì²´í¬
    			      let vatType = vatTypeSelect.value;
    			      let vat = 0;
    			      if (vatType === "ê³¼ì„¸") {
    			        vat = Math.floor(supply * 0.1);
    			      }

    			      params.node.setData({
    			        ...params.data,
    			        supply: supply,
    			        vat: vat
    			      });
    			    }

    			    // âœ… í˜„ì¬ í–‰ì´ ë‹¤ ì±„ì›Œì¡Œìœ¼ë©´ ë§ˆì§€ë§‰ í–‰ì¸ì§€ í™•ì¸ í›„ ìƒˆ ë¹ˆí–‰ ì¶”ê°€
    			    const isRowFilled =
    			      params.data.productCode &&
    			      params.data.productName &&
    			      (params.data.price || params.data.price === 0) &&
    			      (params.data.qty || params.data.qty === 0);

    			    const allRows = [];
    			    invoiceGridApi.forEachNode(node => allRows.push(node));

    			    const isLastRow = allRows[allRows.length - 1].id === params.node.id;

    			    if (isRowFilled && isLastRow) {
    			      invoiceGridApi.applyTransaction({
    			        add: [{
    			          productCode: "",
    			          productName: "",
    			          price: null,
    			          qty: null,
    			          supply: null,
    			          vat: null,
    			          note: ""
    			        }]
    			      });
    			    }
    			    // âœ… í•©ê³„ ë‹¤ì‹œ ê³„ì‚°
    			    let subtotal = 0;
    			    let vatTotal = 0;
    			    invoiceGridApi.forEachNode(node => {
    			      subtotal += Number(node.data.supply) || 0;
    			      vatTotal += Number(node.data.vat) || 0;
    			    });

    			    invoiceGridApi.setPinnedBottomRowData([{
    			      supply: "í•©ê³„",
    			      vat: subtotal + vatTotal,
    			    
    			    }]);
    			  },
        defaultColDef: { resizable: true, filter:true },
        pinnedBottomRowData: [
          {
        	  supply: "í•©ê³„",
        	  vat: /*[[${invoiceHeader?.subtotalAmt}]]*/ +/*[[${invoiceHeader?.vatAmt}]]*/+ "ì›" ,
          }
        ]
      };
      new agGrid.Grid(gridDiv, gridOptions);
      invoiceGridApi = gridOptions.api;  // ì—¬ê¸°ì„œ apië¥¼ êº¼ë‚´ì•¼ í•¨
      invoiceGridCreated = true;
      
      // ë¹ˆí–‰ ì¶”ê°€
      invoiceGridApi.applyTransaction({
        add: [{ productCode:"", productName:"", price:null, qty:null, supply:null, vat:null, note:"" }]
      });
    } else {
      // ê¸°ì¡´ ê·¸ë¦¬ë“œë§Œ refresh
      invoiceGridApi.resetRowHeights();
    }
  });
});
// === productModal ë‚´ë¶€ Grid ì´ˆê¸°í™” ===
function initProductGrid() {
  const gridDiv = document.querySelector("#productGrid");
  if (!gridDiv) return;

  const gridOptions = {
    columnDefs: [
      { headerName: "ì œí’ˆì½”ë“œ", field: "productCode" },
      { headerName: "ì œí’ˆëª…", field: "productName" },
      { headerName: "ê·œê²©", field: "specification" }
    ],
    rowData: [],
    rowSelection: "single",
    onGridReady: e => {
      productGridApi = e.api;
      productGridApi.sizeColumnsToFit();
      loadProductData();
    },
    onRowDoubleClicked: e => {
      if (!selectedInvoiceRow) return;
      // âœ… ì„ íƒëœ ì œí’ˆ ë°ì´í„°ë¥¼ í˜„ì¬ í–‰ì— ë°˜ì˜
      selectedInvoiceRow.setData({
        ...selectedInvoiceRow.data,
        productCode: e.data.productCode,
        productName: e.data.productName,
        specification: e.data.specification
      });
      bootstrap.Modal.getOrCreateInstance(
        document.getElementById("productModal")
      ).hide();
    }
  };

  new agGrid.Grid(gridDiv, gridOptions);
  
}

// === ìƒí’ˆ ë°ì´í„° ë¡œë“œ ===
async function loadProductData() {
  const compCode = Number(document.getElementById('compCode').value);
  if (!productGridApi) return;
  try {
    const res = await axios.get(`/api/v1/stock/productList/${compCode}`, { withCredentials: true });
    productGridApi.setRowData(res.data);
  } catch (err) {
    console.error("ìƒí’ˆ ì¡°íšŒ ì‹¤íŒ¨", err);
  }
};

//âœ… ì´ˆê¸°í™” ë²„íŠ¼ ë™ì‘
document.getElementById("resetInvoiceBtn")?.addEventListener("click", () => {
  const modalEl = document.getElementById("invoiceModal");

  // ëª¨ë“  input, textarea, select ì´ˆê¸°í™”
  modalEl.querySelectorAll("input, textarea, select").forEach(el => {
    if (el.type === "date") {
      el.value = ""; // ë‚ ì§œëŠ” ê³µë°± ì²˜ë¦¬
    } else if (el.tagName === "SELECT") {
      el.selectedIndex = 0; // ì²«ë²ˆì§¸ ì˜µì…˜ìœ¼ë¡œ
    } else {
      el.value = "";
    }
  });

  // ag-grid ì´ˆê¸°í™” (gridDiv.api âŒ â†’ invoiceGridApi âœ…)
  if (invoiceGridApi) {
    invoiceGridApi.setRowData([]); // í–‰ ë¹„ìš°ê¸°
    // í•„ìš”í•˜ë©´ ì´ˆê¸° í•œ ì¤„ ë‹¤ì‹œ ì¶”ê°€
    invoiceGridApi.applyTransaction({
      add: [{ productCode:"", productName:"", price:null, qty:null, supply:null, vat:null, note:"" }]
    });
  }
});

document.getElementById("insertInvoiceBtn")?.addEventListener("click", async () => {
	let subtotal = 0;
	let vatTotal = 0;

	invoiceGridApi.forEachNode(node => {
	  subtotal += Number(node.data.supply) || 0;
	  vatTotal += Number(node.data.vat) || 0;
	});
	
	  try {
	    // ğŸ“Œ í—¤ë” ê°’ ìˆ˜ì§‘
	    const header = {
	    		invoiceDate: document.getElementById("invoiceDate").value,
	    		  orderCode: document.getElementById("orderCode")?.value ,
	    		  deptCode: null,
	    		  deptName: document.getElementById("deptNameInput").value,
	    		  cusCode: document.getElementById("cusCodeInput").value,
	    		  cusName: document.getElementById("cusNameInput").value,
	    		  vatType: document.querySelector(".form-select-invoice").value,
	    		  payMethod: document.getElementById("payMethodInput").value,
	    		  memo: document.getElementById("memoInput").value,
	    		  bankCode: document.getElementById("bankNameInput").value,
	    		  accountNo: document.getElementById("accountNoInput").value,
	    		  type: "P",  // ëŒ€ì†Œë¬¸ì ì£¼ì˜ (ìë°” VOë‘ ì¼ì¹˜ì‹œì¼œì•¼ í•¨)
	    		  subtotalAmt: subtotal,
	    		  vatAmt: vatTotal,
	    		  totalAmt: subtotal + vatTotal,
	    		  lines: []
	    };

	    // ğŸ“Œ ë¼ì¸ ë°ì´í„° ìˆ˜ì§‘
	    const lines = [];
	    invoiceGridApi.forEachNode(node => {
	      if (node.data.productCode && node.data.qty && node.data.price) {
	        lines.push({
	          productName: node.data.productName,
	          qty: node.data.qty,
	          unitPrice: node.data.price,
	          supAmt: node.data.supply,
	          vatAmt: node.data.vat
	        });
	      }
	    });
	    header.lines = lines;

	    if (lines.length === 0) {
	      alert("ì €ì¥í•  í’ˆëª©ì´ ì—†ìŠµë‹ˆë‹¤.");
	      return;
	    }

	    // ğŸ“Œ ì„œë²„ ì „ì†¡
	    const res = await axios.post("/api/account/invoice", header, {
	      withCredentials: true
	    });

	    if (res.data.success) {
	      alert(`ì €ì¥ ì™„ë£Œ! ì „í‘œë²ˆí˜¸: ${res.data.invoiceNo}`);
	      bootstrap.Modal.getOrCreateInstance(document.getElementById("invoiceModal")).hide();
	      // ì €ì¥ í›„ ì „í‘œ ëª©ë¡ ë‹¤ì‹œ ë¡œë”©
	      if (typeof loadAndRenderVoucher === "function") loadAndRenderVoucher();
	    } else {
	      alert("ì €ì¥ ì‹¤íŒ¨: " + res.data.message);
	    }
	  } catch (err) {
	    console.error(err);
	    alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
	  }
	});
</script>

<script th:inline="none">
let businessGridApi = null;


async function loadBusinessData() {
	const compCode = Number(document.getElementById('compCode').value);
    try {
        const res = await axios.get(`/api/v1/stock/cusList/${compCode}`, {
            
            withCredentials: true           // ì„¸ì…˜ ì¿ í‚¤ í¬í•¨
        });
        if (businessGridApi) {
        	businessGridApi.setGridOption("rowData", res.data);
        	businessGridApi.sizeColumnsToFit();
        }
    } catch (err) { console.error(err); }
}

function initBusinessGrid() {
  const gridDiv = document.querySelector("#businessModal #myGrid") || document.querySelector("#myGrid");
  if (!gridDiv) {
    console.error("ê±°ë˜ì²˜ ê·¸ë¦¬ë“œ ì»¨í…Œì´ë„ˆ(#myGrid)ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  const columnDefs = [
    { headerName: "ê±°ë˜ì²˜ì½”ë“œ", field: "cusCode" },
    { headerName: "ê±°ë˜ì²˜ëª…", field: "cusName" },
    { headerName: "ë‹´ë‹¹ìëª…", field: "empName" },
    { headerName: "ì‚¬ì—…ìë²ˆí˜¸", field: "bizNo" },
    { headerName: "ëŒ€í‘œëª…", field: "ceoName" },
    { headerName: "ì—…íƒœ", field: "bizType" },
    { headerName: "ì¢…ëª©", field: "bizCategory" },
    { headerName: "ê±°ë˜ì²˜ì£¼ì†Œ", field: "addr" }
  ];

  const gridOptions = {
    columnDefs,
    rowSelection: "single",
    pagination: true,
    rowData: [],
    defaultColDef: { resizable: true, sortable: true, minWidth: 100 },
    onGridReady: (e) => {
      businessGridApi = e.api;
      businessGridApi.sizeColumnsToFit();
      loadBusinessData();
    },
    onRowDoubleClicked: (e) => {
      // ê°’ ë°˜ì˜
      document.getElementById("cusCodeInput").value = e.data.cusCode ?? "";
      document.getElementById("cusNameInput").value = e.data.cusName ?? "";

      // ê±°ë˜ì²˜ ëª¨ë‹¬ ë‹«ê³  â†’ ì „í‘œ ëª¨ë‹¬ ë‹¤ì‹œ ì—´ê¸°
      const businessModal = bootstrap.Modal.getOrCreateInstance(document.getElementById("businessModal"));
      businessModal.hide();

      const invoiceModal = bootstrap.Modal.getOrCreateInstance(document.getElementById("invoiceModal"));
      invoiceModal.show();
    }
  };

  new agGrid.Grid(gridDiv, gridOptions);
}


// DOM ë Œë”ë§ì‹œ 
document.addEventListener("DOMContentLoaded", () => {
  const invoiceModalEl = document.getElementById("invoiceModal");
  const businessModalEl = document.getElementById("businessModal");

  if (!invoiceModalEl || !businessModalEl) {
    console.error("invoiceModal ë˜ëŠ” businessModal ìš”ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  const invoiceModal = bootstrap.Modal.getOrCreateInstance(invoiceModalEl);
  const businessModal = bootstrap.Modal.getOrCreateInstance(businessModalEl);

  
  // ë²„íŠ¼ í´ë¦­ â†’ ì „í‘œëª¨ë‹¬ ë‹«ê³  â†’ ë‹«íŒ í›„ ê±°ë˜ì²˜ ëª¨ë‹¬ ì—´ê¸° (ì—°ì‡„)
  document.getElementById("openBusinessModalBtn").addEventListener("click", () => {
    const openBusinessAfterHide = () => {
      // í•œ ë²ˆë§Œ ì‹¤í–‰í•˜ê³  í•¸ë“¤ëŸ¬ ì œê±°
      invoiceModalEl.removeEventListener("hidden.bs.modal", openBusinessAfterHide);

      // ê±°ë˜ì²˜ ëª¨ë‹¬ ì—´ê¸°
      businessModal.show();
    };

    // ì „í‘œ ëª¨ë‹¬ì´ ì™„ì „íˆ ë‹«íŒ ë’¤ ì‹¤í–‰
    invoiceModalEl.addEventListener("hidden.bs.modal", openBusinessAfterHide);
    invoiceModal.hide(); // ë¨¼ì € ë‹«ëŠ”ë‹¤
  });

  // ê±°ë˜ì²˜ ëª¨ë‹¬ì´ ë³´ì—¬ì§ˆ ë•Œ ê·¸ë¦¬ë“œ ì¤€ë¹„/ë¦¬ì‚¬ì´ì¦ˆ/ë¡œë”©
  businessModalEl.addEventListener("shown.bs.modal", () => {
    if (!businessGridApi) initBusinessGrid();
    else {
      businessGridApi.sizeColumnsToFit();	
      loadBusinessData();
    }
  });
 });
document.addEventListener("DOMContentLoaded", () => {
	  const dateInput = document.getElementById("invoiceDate");
	  if (dateInput && !dateInput.value) {
	    const today = new Date();
	    const yyyy = today.getFullYear();
	    const mm = String(today.getMonth() + 1).padStart(2, "0");
	    const dd = String(today.getDate()).padStart(2, "0");
	    dateInput.value = `${yyyy}-${mm}-${dd}`;
	  }
	});

</script>
</div>
</body>
</html>
