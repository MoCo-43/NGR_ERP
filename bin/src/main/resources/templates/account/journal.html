<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/base}">
<head>
<title layout:fragment="title">일반 전표</title>
<th:block layout:fragment="head_extra">
	<!-- AG Grid -->
	<link rel="stylesheet"
		href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/styles/ag-grid.css" />
	<link rel="stylesheet"
		href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/styles/ag-theme-quartz.css" />
	<style>
/* 차액행 전체 배경 (연한 빨강) */
.ag-theme-quartz .ag-row.row-diff {
	background-color: #feecec !important;
	font-weight: 600;
}

#generalVoucherGrid.ag-theme-quartz {
	height: 38rem;
	width: 100%;
	margin-top: 1rem;
}

.btn-bar {
	display: flex;
	gap: 0.5rem;
	margin-bottom: 0.75rem;
}

.badge-debit {
	background: #fee2e2;
	color: #b91c1c;
	font-weight: 600;
	border-radius: 8px;
	padding: 2px 8px;
}

.badge-credit {
	background: #dbeafe;
	color: #1d4ed8;
	font-weight: 600;
	border-radius: 8px;
	padding: 2px 8px;
}
/* 입력 고정행 스타일 */
.ag-theme-quartz .ag-floating-top .ag-row {
	background: #fafafa;
	font-weight: 500;
	border-bottom: 1px solid #e5e7eb;
}

.badge-status-open {
	background: #dcfce7; /* 연한 초록 */
	color: #15803d; /* 진한 초록 */
	font-weight: 600;
	border-radius: 8px;
	padding: 2px 8px;
}

.badge-status-closed {
	background: #fee2e2; /* 차변과 동일 */
	color: #b91c1c;
	font-weight: 600;
	border-radius: 8px;
	padding: 2px 8px;
}

.badge-status-submit {
	background: #fef9c3; /* 연노랑 */
	color: #ca8a04; /* 진한 노랑/주황 */
	font-weight: 600;
	border-radius: 8px;
	padding: 2px 8px;
}

.badge-status-approved {
	background: #dbeafe; /* 연한 파랑 */
	color: #1d4ed8; /* 진한 파랑 */
	font-weight: 600;
	border-radius: 8px;
	padding: 2px 8px;
}

.badge-status-reverse {
	background: #dbeafe; /* 연한 파랑 */
	color: #1d4ed8; /* 진한 파랑 */
	font-weight: 600;
	border-radius: 8px;
	padding: 2px 8px;
}
</style>
</th:block>
</head>
<body>
	<section layout:fragment="content">
		<div class="card shadow mb-3">
			<div
				class="card-header py-3 d-flex align-items-center justify-content-between">
				<h6 class="m-0 font-weight-bold text-primary">일반 전표</h6>
			</div>
			<div class="card-body">
				<!-- 조회 영역 -->
				<div class="btn-bar">
					<input type="date" class="form-control form-control-sm"
						id="fromDate" style="max-width: 180px" /> <span class="mx-1">~</span>
					<input type="date" class="form-control form-control-sm" id="toDate"
						style="max-width: 180px" />
					<button class="btn btn-dark btn-sm" id="btnSearch">조회</button>
					<button class="btn btn-outline-danger btn-sm" id="btnToggleDiff">차액별</button>
				</div>
				<!-- 일반전표 목록 Grid -->
				<div id="generalVoucherGrid" class="ag-theme-quartz"></div>
			</div>
		</div>
		<!-- 거래처 모달 fragment include -->
		<div th:replace="~{stock/modals/businessModal :: businessModal}"></div>
		<div th:replace="~{account/accountModal :: accountModal}"></div>
	</section>

	<th:block layout:fragment="body_extra">
		<script
			src="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/dist/ag-grid-community.min.js"></script>
		<script
			src="https://cdn.jsdelivr.net/npm/axios@1.7.7/dist/axios.min.js"></script>
		<script th:inline="none">

let gvApi;
let selectedRowNode = null;
let currentJrnNo = null; // 전역 전표번호 유지
let showDiffRows = false; // 차액합계 토글
// ===== 유틸 =====
const toNumber = (v) => {
  if (v === null || v === undefined || v === "") return null;
  const n = Number(String(v).replaceAll(",", "").trim());
  return Number.isFinite(n) ? n : null;
};
// 오늘
const todayStr = () => {
  const d = new Date();
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  return `${d.getFullYear()}-${mm}-${dd}`;
};
const getMonthStr = (dateStr) => (dateStr?.substring(5,7) ? Number(dateStr.substring(5,7)) : "");
const getDayStr   = (dateStr) => (dateStr?.substring(8,10)? Number(dateStr.substring(8,10)) : "");


// 입력 전용 고정행
function newInputRow(){
  return {
    _isInput: true,
    jrnNo: null,
    lineNo: null,
    jrnDate: todayStr(),
    acctCode: "",
    acctName: "",
    dcType: "",
    amount: null,
    remarks: "",
    status: "",
    createdAt: null,
    createdBy: "",
    cusCode: "",
    cusName: "",
    closeNo: null
  };
}

// 목록 로드 + 차액행 처리
async function loadList() {
	const today = todayStr();
    document.getElementById("fromDate").value = today;
    document.getElementById("toDate").value = today;
    
  const { data } = await axios.get("/api/account/journal");
  let rows = Array.isArray(data) ? data : [];

  // 오늘 날짜만 필터
  rows = rows.filter(r => r.jrnDate.substring(0,10) === today);

  // === 전표별 차변/대변 합계 계산 ===
  const grouped = {};
  rows.forEach(r => {
    if (!grouped[r.jrnNo]) grouped[r.jrnNo] = { rows: [], debit: 0, credit: 0 };
    grouped[r.jrnNo].rows.push(r);
    if (r.dcType === "D") grouped[r.jrnNo].debit += toNumber(r.amount) || 0;
    if (r.dcType === "C") grouped[r.jrnNo].credit += toNumber(r.amount) || 0;
  });

  // === 전표별 마지막 뒤에 차액행 추가 ===
   let finalRows = [];
  Object.entries(grouped).forEach(([jrnNo, g]) => {
    finalRows = finalRows.concat(g.rows); // 원래 행들 넣고
    if (showDiffRows) {   // ✅ 버튼 상태에 따라 보이기/숨기기
      const diff = g.debit - g.credit;
      const seq = jrnNo.substring(jrnNo.lastIndexOf("-") + 1);
      if (diff !== 0) {
        finalRows.push({
          jrnNo: "",
          lineNo: null,
          jrnDate: "",
          acctCode: "",
          acctName: "",
          dcType: `소계(${seq})`,
          amount: Math.abs(diff),
          remarks: diff > 0 ? "차변차액합계" : "대변차액합계",
          closeNo: null,
          _isDiffRow: true
        });
      }
    }
  });

  gvApi.setGridOption("rowData", finalRows);
  gvApi.refreshClientSideRowModel('sort');
  // ✅ 입력행 추가 보장
  gvApi.applyTransaction({ 
    add: [ newInputRow() ], 
    addIndex: gvApi.getDisplayedRowCount() 
  });
}
// 기간 필터링
async function loadFilteredList() {
  try {
    const fromDate = document.getElementById("fromDate").value;
    const toDate   = document.getElementById("toDate").value;
    const { data } = await axios.get("/api/account/journal");
    let rows = Array.isArray(data) ? data : [];
    if (fromDate) {
    	  const from = new Date(fromDate);
    	  rows = rows.filter(r => new Date(r.jrnDate) >= from);
    	}
    	if (toDate) {
    	  const to = new Date(toDate);
    	  rows = rows.filter(r => new Date(r.jrnDate) <= to);
    	}
    gvApi.setGridOption("rowData", rows);
    gvApi.refreshClientSideRowModel('sort');
  } catch(err) {
    console.error(err);
    alert("조회 실패");
  }
}

// 필수값 검증
function isSavable(d){
  return !!d && d.jrnDate && (d.dcType === 'D' || d.dcType === 'C') && d.acctCode && toNumber(d.amount) !== null;
}

// 저장
async function saveRow(data){
  console.log("▶ saveRow 호출됨, 원본 data:", data);

  if (data._isDiffRow) {
    alert("차액 행은 저장할 수 없습니다.");
    return;
  }

  if  (data.status.toLowerCase() === "closed" || data.status.toLowerCase() === "reverse") {
    alert("마감(CLOSE/REVERSE)된 전표는 수정할 수 없습니다.");
    return;
  }

  if (!currentJrnNo) {
    const { data: newNo } = await axios.get("/api/account/nextJrnNo");
    currentJrnNo = newNo;
  }
  data.jrnNo = currentJrnNo;

  const payload = {
    jrnCode: data.jrnCode || null,   // ✅ jrnCode 추가
    jrnNo: data.jrnNo,
    lineNo: data.lineNo || null,
    jrnDate: data.jrnDate || todayStr(),
    acctCode: data.acctCode || "",
    dcType: (data.dcType || "").toUpperCase(),
    amount: toNumber(data.amount),
    remarks: data.remarks || "",
    status: data.status || "open",
    createdBy: data.createdBy || "",
    cusCode: data.cusCode || "",
    closeNo: data.closeNo ?? null
  };

  console.log("▶ payload 준비 완료:", payload);

  if (!isSavable(payload)) {
    console.log("▶ 저장 불가: isSavable check 실패");
    return;
  }

  try {
    let res;
    if (!data.lineNo) {
      res = await axios.post("/api/account/journal", payload);
    } else {
      res = await axios.put(`/api/account/journal/${payload.jrnCode}/${payload.lineNo}`, payload);
    }
    console.log("▶ 서버 응답:", res.data);
  } catch (err) {
    console.error("▶ 저장 중 오류:", err);
  }
  await loadList();
 
}

// 
document.addEventListener("DOMContentLoaded", async () => {
  const columnDefs = [
    { headerName: "월", valueGetter: p => getMonthStr(p.data?.jrnDate), editable: false, flex: .5 },
    { headerName: "일", valueGetter: p => getDayStr(p.data?.jrnDate),   editable: false, flex: .5 },
    { headerName: "전표번호", field: "jrnNo", editable: false, flex: 1 },
    {
    	  headerName: "구분", field: "dcType", flex: .9, editable: true,
    	  valueSetter: (params) => {
    	    if (params.data?._isDiffRow) return false; // 차액행은 수정 불가
    	    let v = (params.newValue || "").trim().toUpperCase();
    	    if (v === "ㅇ" || v === "D" || v === "d") { params.data.dcType = "D"; return true; }
    	    if (v === "C" || v === "ㅊ" || v === "c") { params.data.dcType = "C"; return true; }
    	    return false;
    	  },
    	  cellRenderer: p => {
    	    if (p.data?._isDiffRow) {
    	      return `<span style="color:#b91c1c;font-weight:700">${p.value}</span>`;
    	    }
    	    const v = (p.value || "").toUpperCase();
    	    if (v === "D") return `<span class="badge-debit">차변</span>`;
    	    if (v === "C") return `<span class="badge-credit">대변</span>`;
    	    return "";
    	  },
    	  cellClass: params => params.data?._isDiffRow ? "diff-row" : ""
    	
    },
    { headerName: "계정코드", field: "acctCode", editable: true, flex: 1.1, onCellClicked: (params) => { 
    	 const status = (params.data?.status || "").toLowerCase();
 	    if (status === "closed" || status === "reverse") {
 	      alert("마감(CLOSED/REVERSE) 전표는 수정할 수 없습니다.");
 	      return;
 	    }selectedRowNode = params.node; 
    bootstrap.Modal.getOrCreateInstance(document.getElementById("accountModal")).show(); }},
    { headerName: "계정", field: "acctName", editable: true, flex: 1.2, onCellClicked: (params) => { 
    	 const status = (params.data?.status || "").toLowerCase();
 	    if (status === "closed" || status === "reverse") {
 	      alert("마감(CLOSED/REVERSE) 전표는 수정할 수 없습니다.");
 	      return;
 	    }selectedRowNode = params.node; 
    bootstrap.Modal.getOrCreateInstance(document.getElementById("accountModal")).show(); }},
    { 
    	  headerName: "거래처코드", field: "cusCode", editable: true, flex: 1,
    	  onCellClicked: (params) => { 
    	    const status = (params.data?.status || "").toLowerCase();
    	    if (status === "closed" || status === "reverse") {
    	      alert("마감(CLOSED/REVERSE) 전표는 수정할 수 없습니다.");
    	      return;
    	    }
    	    selectedRowNode = params.node; 
    	    bootstrap.Modal.getOrCreateInstance(document.getElementById("businessModal")).show();
    	  } 
    	},
    	{ 
      	  headerName: "거래처", field: "cusName", editable: true, flex: 1,
      	  onCellClicked: (params) => { 
      	    const status = (params.data?.status || "").toLowerCase();
      	    if (status === "closed" || status === "reverse") {
      	      alert("마감(CLOSED/REVERSE) 전표는 수정할 수 없습니다.");
      	      return;
      	    }
      	    selectedRowNode = params.node; 
      	    bootstrap.Modal.getOrCreateInstance(document.getElementById("businessModal")).show();
      	  } 
      	},
    { headerName: "적요", field: "remarks", editable: true, flex: 1.5 },
    { headerName: "금액", field: "amount", flex: 1, editable: true,
      valueParser: p => toNumber(p.newValue),
      valueFormatter: p => p.value ? Number(p.value).toLocaleString() : ""
    },
    
    { headerName: "상태", field: "status", editable: false, flex: .8,
      cellRenderer: p => {
        const v = (p.value || "").toLowerCase();
        if (v === "open")     return `<span class="badge-status-open">OPEN</span>`;
        if (v === "closed")    return `<span class="badge-status-closed">CLOSED</span>`;
        if (v === "submit")   return `<span class="badge-status-submit">SUBMIT</span>`;
        if (v === "reverse") return `<span class="badge-status-reverse">RESERVE</span>`;
        return v || "";
      }}
  ];

  gvApi = agGrid.createGrid(document.querySelector("#generalVoucherGrid"), {
	  columnDefs,
	  rowData: [],
	  pagination: false,
	
	  defaultColDef: { resizable: true, filter: true },
	  editType: 'fullRow',
	  singleClickEdit: true,
	  stopEditingWhenCellsLoseFocus: true,

	  // ✅ 차액행 전체 색상 처리
	  getRowClass: (params) => params.data?._isDiffRow ? "row-diff" : null,

	onRowValueChanged: (ev) => { saveRow(ev.data); },
	  onGridReady: async () => {
	    await loadList();
	  }
	});
  document.getElementById("btnSearch").addEventListener("click", loadFilteredList);
});


// 차액 토글

document.getElementById("btnToggleDiff").addEventListener("click", () => {
  showDiffRows = !showDiffRows;
  loadList();
});

// === 거래처 모달 ===
let businessGridApi = null;

async function loadBusinessData() {
  try {
    const res = await axios.get("/api/v1/stock/cusList");
    if (businessGridApi) {
      businessGridApi.setRowData(res.data);
      businessGridApi.sizeColumnsToFit();
    }
  } catch (err) {
    console.error("cusList 로드 실패:", err);
  }
}

function initBusinessGrid() {
  const gridDiv = document.querySelector("#businessModal #myGrid") || document.querySelector("#myGrid");
  if (!gridDiv) {
    console.error("거래처 그리드 컨테이너(#myGrid)를 찾을 수 없습니다.");
    return;
  }
  const columnDefs = [
    { headerName: "거래처코드", field: "cusCode" },
    { headerName: "거래처명", field: "cusName" },
    { headerName: "업태", field: "bizType" },
    { headerName: "종목", field: "bizCategory" },
    { headerName: "거래처주소", field: "addr" }
  ];
  const gridOptions = {
    columnDefs,
    rowSelection: "single",
    pagination: true,
    rowData: [],
    defaultColDef: { resizable: true, sortable: true, minWidth: 100 },
    onGridReady: (e) => {
      businessGridApi = e.api;
      businessGridApi.sizeColumnsToFit();
      loadBusinessData();
    },
    onRowDoubleClicked: (e) => {
    	  if (selectedRowNode) {
    	    const newData = {
    	      ...selectedRowNode.data,
    	      cusCode: e.data.cusCode,
    	      cusName: e.data.cusName
    	    };
    	    // 행 갱신
    	    gvApi.applyTransaction({ update: [newData] });

    	    // 바로 저장 로직 호출 (선택사항)
    	    saveRow(newData);
    	  }
    	  bootstrap.Modal.getOrCreateInstance(
    	    document.getElementById("businessModal")
    	  ).hide();
    	}
  };
  new agGrid.Grid(gridDiv, gridOptions);
}

document.addEventListener("DOMContentLoaded", () => {
  const businessModalEl = document.getElementById("businessModal");
  if (!businessModalEl) {
    console.error("businessModal 요소가 없습니다.");
    return;
  }
  businessModalEl.addEventListener("shown.bs.modal", () => {
    if (!businessGridApi) initBusinessGrid();
    else {
      businessGridApi.sizeColumnsToFit();	
      loadBusinessData();
    }
  });
});


</script>
	</th:block>
</body>
</html>
